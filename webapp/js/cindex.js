var karel=function(exports,bootstrap){"use strict";var global="undefined"!=typeof window?window:null,ssr=null===global,document$1=ssr?void 0:global.document,NOOP=function(){return!1},calc=ssr?"calc":["","-webkit-","-moz-","-o-"].filter((function(prefix){var el=document$1.createElement("div");return el.style.cssText="width:"+prefix+"calc(9px)",!!el.style.length})).shift()+"calc",isString=function(v){return"string"==typeof v||v instanceof String},elementOrSelector=function(el){if(isString(el)){var ele=document$1.querySelector(el);if(!ele)throw new Error("Selector "+el+" did not match a DOM element");return ele}return el},getOption=function(options,propName,def){var value=options[propName];return void 0!==value?value:def},getGutterSize=function(gutterSize,isFirst,isLast,gutterAlign){if(isFirst){if("end"===gutterAlign)return 0;if("center"===gutterAlign)return gutterSize/2}else if(isLast){if("start"===gutterAlign)return 0;if("center"===gutterAlign)return gutterSize/2}return gutterSize},defaultGutterFn=function(i,gutterDirection){var gut=document$1.createElement("div");return gut.className="gutter gutter-"+gutterDirection,gut},defaultElementStyleFn=function(dim,size,gutSize){var style={};return isString(size)?style[dim]=size:style[dim]=calc+"("+size+"% - "+gutSize+"px)",style},defaultGutterStyleFn=function(dim,gutSize){var obj;return(obj={})[dim]=gutSize+"px",obj},Split=function(idsOption,options){if(void 0===options&&(options={}),ssr)return{};var dimension,clientAxis,position,positionEnd,clientSize,elements,ids=idsOption;Array.from&&(ids=Array.from(ids));var parent=elementOrSelector(ids[0]).parentNode,parentStyle=getComputedStyle?getComputedStyle(parent):null,parentFlexDirection=parentStyle?parentStyle.flexDirection:null,sizes=getOption(options,"sizes")||ids.map((function(){return 100/ids.length})),minSize=getOption(options,"minSize",100),minSizes=Array.isArray(minSize)?minSize:ids.map((function(){return minSize})),maxSize=getOption(options,"maxSize",1/0),maxSizes=Array.isArray(maxSize)?maxSize:ids.map((function(){return maxSize})),expandToMin=getOption(options,"expandToMin",!1),gutterSize=getOption(options,"gutterSize",10),gutterAlign=getOption(options,"gutterAlign","center"),snapOffset=getOption(options,"snapOffset",30),snapOffsets=Array.isArray(snapOffset)?snapOffset:ids.map((function(){return snapOffset})),dragInterval=getOption(options,"dragInterval",1),direction=getOption(options,"direction","horizontal"),cursor=getOption(options,"cursor","horizontal"===direction?"col-resize":"row-resize"),gutter=getOption(options,"gutter",defaultGutterFn),elementStyle=getOption(options,"elementStyle",defaultElementStyleFn),gutterStyle=getOption(options,"gutterStyle",defaultGutterStyleFn);function setElementSize(el,size,gutSize,i){var style=elementStyle(dimension,size,gutSize,i);Object.keys(style).forEach((function(prop){el.style[prop]=style[prop]}))}function getSizes(){return elements.map((function(element){return element.size}))}function getMousePosition(e){return"touches"in e?e.touches[0][clientAxis]:e[clientAxis]}function adjust(offset){var a=elements[this.a],b=elements[this.b],percentage=a.size+b.size;a.size=offset/this.size*percentage,b.size=percentage-offset/this.size*percentage,setElementSize(a.element,a.size,this._b,a.i),setElementSize(b.element,b.size,this._c,b.i)}function drag(e){var offset,a=elements[this.a],b=elements[this.b];this.dragging&&(offset=getMousePosition(e)-this.start+(this._b-this.dragOffset),dragInterval>1&&(offset=Math.round(offset/dragInterval)*dragInterval),offset<=a.minSize+a.snapOffset+this._b?offset=a.minSize+this._b:offset>=this.size-(b.minSize+b.snapOffset+this._c)&&(offset=this.size-(b.minSize+this._c)),offset>=a.maxSize-a.snapOffset+this._b?offset=a.maxSize+this._b:offset<=this.size-(b.maxSize-b.snapOffset+this._c)&&(offset=this.size-(b.maxSize+this._c)),adjust.call(this,offset),getOption(options,"onDrag",NOOP)(getSizes()))}function calculateSizes(){var a=elements[this.a].element,b=elements[this.b].element,aBounds=a.getBoundingClientRect(),bBounds=b.getBoundingClientRect();this.size=aBounds[dimension]+bBounds[dimension]+this._b+this._c,this.start=aBounds[position],this.end=aBounds[positionEnd]}function trimToMin(sizesToTrim){var parentSize=function(element){if(!getComputedStyle)return null;var computedStyle=getComputedStyle(element);if(!computedStyle)return null;var size=element[clientSize];return 0===size?null:size-="horizontal"===direction?parseFloat(computedStyle.paddingLeft)+parseFloat(computedStyle.paddingRight):parseFloat(computedStyle.paddingTop)+parseFloat(computedStyle.paddingBottom)}(parent);if(null===parentSize)return sizesToTrim;if(minSizes.reduce((function(a,b){return a+b}),0)>parentSize)return sizesToTrim;var excessPixels=0,toSpare=[],pixelSizes=sizesToTrim.map((function(size,i){var pixelSize=parentSize*size/100,elementGutterSize=getGutterSize(gutterSize,0===i,i===sizesToTrim.length-1,gutterAlign),elementMinSize=minSizes[i]+elementGutterSize;return pixelSize<elementMinSize?(excessPixels+=elementMinSize-pixelSize,toSpare.push(0),elementMinSize):(toSpare.push(pixelSize-elementMinSize),pixelSize)}));return 0===excessPixels?sizesToTrim:pixelSizes.map((function(pixelSize,i){var newPixelSize=pixelSize;if(excessPixels>0&&toSpare[i]-excessPixels>0){var takenPixels=Math.min(excessPixels,toSpare[i]-excessPixels);excessPixels-=takenPixels,newPixelSize=pixelSize-takenPixels}return newPixelSize/parentSize*100}))}function stopDragging(){var a=elements[this.a].element,b=elements[this.b].element;this.dragging&&getOption(options,"onDragEnd",NOOP)(getSizes()),this.dragging=!1,global.removeEventListener("mouseup",this.stop),global.removeEventListener("touchend",this.stop),global.removeEventListener("touchcancel",this.stop),global.removeEventListener("mousemove",this.move),global.removeEventListener("touchmove",this.move),this.stop=null,this.move=null,a.removeEventListener("selectstart",NOOP),a.removeEventListener("dragstart",NOOP),b.removeEventListener("selectstart",NOOP),b.removeEventListener("dragstart",NOOP),a.style.userSelect="",a.style.webkitUserSelect="",a.style.MozUserSelect="",a.style.pointerEvents="",b.style.userSelect="",b.style.webkitUserSelect="",b.style.MozUserSelect="",b.style.pointerEvents="",this.gutter.style.cursor="",this.parent.style.cursor="",document$1.body.style.cursor=""}function startDragging(e){if(!("button"in e)||0===e.button){var a=elements[this.a].element,b=elements[this.b].element;this.dragging||getOption(options,"onDragStart",NOOP)(getSizes()),e.preventDefault(),this.dragging=!0,this.move=drag.bind(this),this.stop=stopDragging.bind(this),global.addEventListener("mouseup",this.stop),global.addEventListener("touchend",this.stop),global.addEventListener("touchcancel",this.stop),global.addEventListener("mousemove",this.move),global.addEventListener("touchmove",this.move),a.addEventListener("selectstart",NOOP),a.addEventListener("dragstart",NOOP),b.addEventListener("selectstart",NOOP),b.addEventListener("dragstart",NOOP),a.style.userSelect="none",a.style.webkitUserSelect="none",a.style.MozUserSelect="none",a.style.pointerEvents="none",b.style.userSelect="none",b.style.webkitUserSelect="none",b.style.MozUserSelect="none",b.style.pointerEvents="none",this.gutter.style.cursor=cursor,this.parent.style.cursor=cursor,document$1.body.style.cursor=cursor,calculateSizes.call(this),this.dragOffset=getMousePosition(e)-this.end}}"horizontal"===direction?(dimension="width",clientAxis="clientX",position="left",positionEnd="right",clientSize="clientWidth"):"vertical"===direction&&(dimension="height",clientAxis="clientY",position="top",positionEnd="bottom",clientSize="clientHeight"),sizes=trimToMin(sizes);var pairs=[];function adjustToMin(element){var isLast=element.i===pairs.length,pair=isLast?pairs[element.i-1]:pairs[element.i];calculateSizes.call(pair);var size=isLast?pair.size-element.minSize-pair._c:element.minSize+pair._b;adjust.call(pair,size)}return elements=ids.map((function(id,i){var pair,element={element:elementOrSelector(id),size:sizes[i],minSize:minSizes[i],maxSize:maxSizes[i],snapOffset:snapOffsets[i],i:i};if(i>0&&((pair={a:i-1,b:i,dragging:!1,direction:direction,parent:parent})._b=getGutterSize(gutterSize,i-1==0,!1,gutterAlign),pair._c=getGutterSize(gutterSize,!1,i===ids.length-1,gutterAlign),"row-reverse"===parentFlexDirection||"column-reverse"===parentFlexDirection)){var temp=pair.a;pair.a=pair.b,pair.b=temp}if(i>0){var gutterElement=gutter(i,direction,element.element);!function(gutterElement,gutSize,i){var style=gutterStyle(dimension,gutSize,i);Object.keys(style).forEach((function(prop){gutterElement.style[prop]=style[prop]}))}(gutterElement,gutterSize,i),pair._a=startDragging.bind(pair),gutterElement.addEventListener("mousedown",pair._a),gutterElement.addEventListener("touchstart",pair._a),parent.insertBefore(gutterElement,element.element),pair.gutter=gutterElement}return setElementSize(element.element,element.size,getGutterSize(gutterSize,0===i,i===ids.length-1,gutterAlign),i),i>0&&pairs.push(pair),element})),elements.forEach((function(element){var computedSize=element.element.getBoundingClientRect()[dimension];computedSize<element.minSize&&(expandToMin?adjustToMin(element):element.minSize=computedSize)})),{setSizes:function(newSizes){var trimmed=trimToMin(newSizes);trimmed.forEach((function(newSize,i){if(i>0){var pair=pairs[i-1],a=elements[pair.a],b=elements[pair.b];a.size=trimmed[i-1],b.size=newSize,setElementSize(a.element,a.size,pair._b,a.i),setElementSize(b.element,b.size,pair._c,b.i)}}))},getSizes:getSizes,collapse:function(i){adjustToMin(elements[i])},destroy:function(preserveStyles,preserveGutter){pairs.forEach((function(pair){if(!0!==preserveGutter?pair.parent.removeChild(pair.gutter):(pair.gutter.removeEventListener("mousedown",pair._a),pair.gutter.removeEventListener("touchstart",pair._a)),!0!==preserveStyles){var style=elementStyle(dimension,pair.a.size,pair._b);Object.keys(style).forEach((function(prop){elements[pair.a].element.style[prop]="",elements[pair.b].element.style[prop]=""}))}}))},parent:parent,pairs:pairs}};class Text{constructor(){}lineAt(pos){if(pos<0||pos>this.length)throw new RangeError(`Invalid position ${pos} in document of length ${this.length}`);return this.lineInner(pos,!1,1,0)}line(n){if(n<1||n>this.lines)throw new RangeError(`Invalid line number ${n} in ${this.lines}-line document`);return this.lineInner(n,!0,1,0)}replace(from,to,text){let parts=[];return this.decompose(0,from,parts,2),text.length&&text.decompose(0,text.length,parts,3),this.decompose(to,this.length,parts,1),TextNode.from(parts,this.length-(to-from)+text.length)}append(other){return this.replace(this.length,this.length,other)}slice(from,to=this.length){let parts=[];return this.decompose(from,to,parts,0),TextNode.from(parts,to-from)}eq(other){if(other==this)return!0;if(other.length!=this.length||other.lines!=this.lines)return!1;let start=this.scanIdentical(other,1),end=this.length-this.scanIdentical(other,-1),a=new RawTextCursor(this),b=new RawTextCursor(other);for(let skip=start,pos=start;;){if(a.next(skip),b.next(skip),skip=0,a.lineBreak!=b.lineBreak||a.done!=b.done||a.value!=b.value)return!1;if(pos+=a.value.length,a.done||pos>=end)return!0}}iter(dir=1){return new RawTextCursor(this,dir)}iterRange(from,to=this.length){return new PartialTextCursor(this,from,to)}iterLines(from,to){let inner;if(null==from)inner=this.iter();else{null==to&&(to=this.lines+1);let start=this.line(from).from;inner=this.iterRange(start,Math.max(start,to==this.lines+1?this.length:to<=1?0:this.line(to-1).to))}return new LineCursor(inner)}toString(){return this.sliceString(0)}toJSON(){let lines=[];return this.flatten(lines),lines}static of(text){if(0==text.length)throw new RangeError("A document must have at least one line");return 1!=text.length||text[0]?text.length<=32?new TextLeaf(text):TextNode.from(TextLeaf.split(text,[])):Text.empty}}class TextLeaf extends Text{constructor(text,length=function(text){let length=-1;for(let line of text)length+=line.length+1;return length}(text)){super(),this.text=text,this.length=length}get lines(){return this.text.length}get children(){return null}lineInner(target,isLine,line,offset){for(let i=0;;i++){let string=this.text[i],end=offset+string.length;if((isLine?line:end)>=target)return new Line(offset,end,line,string);offset=end+1,line++}}decompose(from,to,target,open){let text=from<=0&&to>=this.length?this:new TextLeaf(sliceText(this.text,from,to),Math.min(to,this.length)-Math.max(0,from));if(1&open){let prev=target.pop(),joined=appendText(text.text,prev.text.slice(),0,text.length);if(joined.length<=32)target.push(new TextLeaf(joined,prev.length+text.length));else{let mid=joined.length>>1;target.push(new TextLeaf(joined.slice(0,mid)),new TextLeaf(joined.slice(mid)))}}else target.push(text)}replace(from,to,text){if(!(text instanceof TextLeaf))return super.replace(from,to,text);let lines=appendText(this.text,appendText(text.text,sliceText(this.text,0,from)),to),newLen=this.length+text.length-(to-from);return lines.length<=32?new TextLeaf(lines,newLen):TextNode.from(TextLeaf.split(lines,[]),newLen)}sliceString(from,to=this.length,lineSep="\n"){let result="";for(let pos=0,i=0;pos<=to&&i<this.text.length;i++){let line=this.text[i],end=pos+line.length;pos>from&&i&&(result+=lineSep),from<end&&to>pos&&(result+=line.slice(Math.max(0,from-pos),to-pos)),pos=end+1}return result}flatten(target){for(let line of this.text)target.push(line)}scanIdentical(){return 0}static split(text,target){let part=[],len=-1;for(let line of text)part.push(line),len+=line.length+1,32==part.length&&(target.push(new TextLeaf(part,len)),part=[],len=-1);return len>-1&&target.push(new TextLeaf(part,len)),target}}class TextNode extends Text{constructor(children,length){super(),this.children=children,this.length=length,this.lines=0;for(let child of children)this.lines+=child.lines}lineInner(target,isLine,line,offset){for(let i=0;;i++){let child=this.children[i],end=offset+child.length,endLine=line+child.lines-1;if((isLine?endLine:end)>=target)return child.lineInner(target,isLine,line,offset);offset=end+1,line=endLine+1}}decompose(from,to,target,open){for(let i=0,pos=0;pos<=to&&i<this.children.length;i++){let child=this.children[i],end=pos+child.length;if(from<=end&&to>=pos){let childOpen=open&((pos<=from?1:0)|(end>=to?2:0));pos>=from&&end<=to&&!childOpen?target.push(child):child.decompose(from-pos,to-pos,target,childOpen)}pos=end+1}}replace(from,to,text){if(text.lines<this.lines)for(let i=0,pos=0;i<this.children.length;i++){let child=this.children[i],end=pos+child.length;if(from>=pos&&to<=end){let updated=child.replace(from-pos,to-pos,text),totalLines=this.lines-child.lines+updated.lines;if(updated.lines<totalLines>>4&&updated.lines>totalLines>>6){let copy=this.children.slice();return copy[i]=updated,new TextNode(copy,this.length-(to-from)+text.length)}return super.replace(pos,end,updated)}pos=end+1}return super.replace(from,to,text)}sliceString(from,to=this.length,lineSep="\n"){let result="";for(let i=0,pos=0;i<this.children.length&&pos<=to;i++){let child=this.children[i],end=pos+child.length;pos>from&&i&&(result+=lineSep),from<end&&to>pos&&(result+=child.sliceString(from-pos,to-pos,lineSep)),pos=end+1}return result}flatten(target){for(let child of this.children)child.flatten(target)}scanIdentical(other,dir){if(!(other instanceof TextNode))return 0;let length=0,[iA,iB,eA,eB]=dir>0?[0,0,this.children.length,other.children.length]:[this.children.length-1,other.children.length-1,-1,-1];for(;;iA+=dir,iB+=dir){if(iA==eA||iB==eB)return length;let chA=this.children[iA],chB=other.children[iB];if(chA!=chB)return length+chA.scanIdentical(chB,dir);length+=chA.length+1}}static from(children,length=children.reduce(((l,ch)=>l+ch.length+1),-1)){let lines=0;for(let ch of children)lines+=ch.lines;if(lines<32){let flat=[];for(let ch of children)ch.flatten(flat);return new TextLeaf(flat,length)}let chunk=Math.max(32,lines>>5),maxChunk=chunk<<1,minChunk=chunk>>1,chunked=[],currentLines=0,currentLen=-1,currentChunk=[];function add(child){let last;if(child.lines>maxChunk&&child instanceof TextNode)for(let node of child.children)add(node);else child.lines>minChunk&&(currentLines>minChunk||!currentLines)?(flush(),chunked.push(child)):child instanceof TextLeaf&&currentLines&&(last=currentChunk[currentChunk.length-1])instanceof TextLeaf&&child.lines+last.lines<=32?(currentLines+=child.lines,currentLen+=child.length+1,currentChunk[currentChunk.length-1]=new TextLeaf(last.text.concat(child.text),last.length+1+child.length)):(currentLines+child.lines>chunk&&flush(),currentLines+=child.lines,currentLen+=child.length+1,currentChunk.push(child))}function flush(){0!=currentLines&&(chunked.push(1==currentChunk.length?currentChunk[0]:TextNode.from(currentChunk,currentLen)),currentLen=-1,currentLines=currentChunk.length=0)}for(let child of children)add(child);return flush(),1==chunked.length?chunked[0]:new TextNode(chunked,length)}}function appendText(text,target,from=0,to=1e9){for(let pos=0,i=0,first=!0;i<text.length&&pos<=to;i++){let line=text[i],end=pos+line.length;end>=from&&(end>to&&(line=line.slice(0,to-pos)),pos<from&&(line=line.slice(from-pos)),first?(target[target.length-1]+=line,first=!1):target.push(line)),pos=end+1}return target}function sliceText(text,from,to){return appendText(text,[""],from,to)}Text.empty=new TextLeaf([""],0);class RawTextCursor{constructor(text,dir=1){this.dir=dir,this.done=!1,this.lineBreak=!1,this.value="",this.nodes=[text],this.offsets=[dir>0?1:(text instanceof TextLeaf?text.text.length:text.children.length)<<1]}nextInner(skip,dir){for(this.done=this.lineBreak=!1;;){let last=this.nodes.length-1,top=this.nodes[last],offsetValue=this.offsets[last],offset=offsetValue>>1,size=top instanceof TextLeaf?top.text.length:top.children.length;if(offset==(dir>0?size:0)){if(0==last)return this.done=!0,this.value="",this;dir>0&&this.offsets[last-1]++,this.nodes.pop(),this.offsets.pop()}else if((1&offsetValue)==(dir>0?0:1)){if(this.offsets[last]+=dir,0==skip)return this.lineBreak=!0,this.value="\n",this;skip--}else if(top instanceof TextLeaf){let next=top.text[offset+(dir<0?-1:0)];if(this.offsets[last]+=dir,next.length>Math.max(0,skip))return this.value=0==skip?next:dir>0?next.slice(skip):next.slice(0,next.length-skip),this;skip-=next.length}else{let next=top.children[offset+(dir<0?-1:0)];skip>next.length?(skip-=next.length,this.offsets[last]+=dir):(dir<0&&this.offsets[last]--,this.nodes.push(next),this.offsets.push(dir>0?1:(next instanceof TextLeaf?next.text.length:next.children.length)<<1))}}}next(skip=0){return skip<0&&(this.nextInner(-skip,-this.dir),skip=this.value.length),this.nextInner(skip,this.dir)}}class PartialTextCursor{constructor(text,start,end){this.value="",this.done=!1,this.cursor=new RawTextCursor(text,start>end?-1:1),this.pos=start>end?text.length:0,this.from=Math.min(start,end),this.to=Math.max(start,end)}nextInner(skip,dir){if(dir<0?this.pos<=this.from:this.pos>=this.to)return this.value="",this.done=!0,this;skip+=Math.max(0,dir<0?this.pos-this.to:this.from-this.pos);let limit=dir<0?this.pos-this.from:this.to-this.pos;skip>limit&&(skip=limit),limit-=skip;let{value:value}=this.cursor.next(skip);return this.pos+=(value.length+skip)*dir,this.value=value.length<=limit?value:dir<0?value.slice(value.length-limit):value.slice(0,limit),this.done=!this.value,this}next(skip=0){return skip<0?skip=Math.max(skip,this.from-this.pos):skip>0&&(skip=Math.min(skip,this.to-this.pos)),this.nextInner(skip,this.cursor.dir)}get lineBreak(){return this.cursor.lineBreak&&""!=this.value}}class LineCursor{constructor(inner){this.inner=inner,this.afterBreak=!0,this.value="",this.done=!1}next(skip=0){let{done:done,lineBreak:lineBreak,value:value}=this.inner.next(skip);return done?(this.done=!0,this.value=""):lineBreak?this.afterBreak?this.value="":(this.afterBreak=!0,this.next()):(this.value=value,this.afterBreak=!1),this}get lineBreak(){return!1}}"undefined"!=typeof Symbol&&(Text.prototype[Symbol.iterator]=function(){return this.iter()},RawTextCursor.prototype[Symbol.iterator]=PartialTextCursor.prototype[Symbol.iterator]=LineCursor.prototype[Symbol.iterator]=function(){return this});class Line{constructor(from,to,number,text){this.from=from,this.to=to,this.number=number,this.text=text}get length(){return this.to-this.from}}let extend="lc,34,7n,7,7b,19,,,,2,,2,,,20,b,1c,l,g,,2t,7,2,6,2,2,,4,z,,u,r,2j,b,1m,9,9,,o,4,,9,,3,,5,17,3,3b,f,,w,1j,,,,4,8,4,,3,7,a,2,t,,1m,,,,2,4,8,,9,,a,2,q,,2,2,1l,,4,2,4,2,2,3,3,,u,2,3,,b,2,1l,,4,5,,2,4,,k,2,m,6,,,1m,,,2,,4,8,,7,3,a,2,u,,1n,,,,c,,9,,14,,3,,1l,3,5,3,,4,7,2,b,2,t,,1m,,2,,2,,3,,5,2,7,2,b,2,s,2,1l,2,,,2,4,8,,9,,a,2,t,,20,,4,,2,3,,,8,,29,,2,7,c,8,2q,,2,9,b,6,22,2,r,,,,,,1j,e,,5,,2,5,b,,10,9,,2u,4,,6,,2,2,2,p,2,4,3,g,4,d,,2,2,6,,f,,jj,3,qa,3,t,3,t,2,u,2,1s,2,,7,8,,2,b,9,,19,3,3b,2,y,,3a,3,4,2,9,,6,3,63,2,2,,1m,,,7,,,,,2,8,6,a,2,,1c,h,1r,4,1c,7,,,5,,14,9,c,2,w,4,2,2,,3,1k,,,2,3,,,3,1m,8,2,2,48,3,,d,,7,4,,6,,3,2,5i,1m,,5,ek,,5f,x,2da,3,3x,,2o,w,fe,6,2x,2,n9w,4,,a,w,2,28,2,7k,,3,,4,,p,2,5,,47,2,q,i,d,,12,8,p,b,1a,3,1c,,2,4,2,2,13,,1v,6,2,2,2,2,c,,8,,1b,,1f,,,3,2,2,5,2,,,16,2,8,,6m,,2,,4,,fn4,,kh,g,g,g,a6,2,gt,,6a,,45,5,1ae,3,,2,5,4,14,3,4,,4l,2,fx,4,ar,2,49,b,4w,,1i,f,1k,3,1d,4,2,2,1x,3,10,5,,8,1q,,c,2,1g,9,a,4,2,,2n,3,2,,,2,6,,4g,,3,8,l,2,1l,2,,,,,m,,e,7,3,5,5f,8,2,3,,,n,,29,,2,6,,,2,,,2,,2,6j,,2,4,6,2,,2,r,2,2d,8,2,,,2,2y,,,,2,6,,,2t,3,2,4,,5,77,9,,2,6t,,a,2,,,4,,40,4,2,2,4,,w,a,14,6,2,4,8,,9,6,2,3,1a,d,,2,ba,7,,6,,,2a,m,2,7,,2,,2,3e,6,3,,,2,,7,,,20,2,3,,,,9n,2,f0b,5,1n,7,t4,,1r,4,29,,f5k,2,43q,,,3,4,5,8,8,2,7,u,4,44,3,1iz,1j,4,1e,8,,e,,m,5,,f,11s,7,,h,2,7,,2,,5,79,7,c5,4,15s,7,31,7,240,5,gx7k,2o,3k,6o".split(",").map((s=>s?parseInt(s,36):1));for(let i=1;i<extend.length;i++)extend[i]+=extend[i-1];function isExtendingChar(code){for(let i=1;i<extend.length;i+=2)if(extend[i]>code)return extend[i-1]<=code;return!1}function isRegionalIndicator(code){return code>=127462&&code<=127487}function findClusterBreak(str,pos,forward=!0,includeExtending=!0){return(forward?nextClusterBreak:prevClusterBreak)(str,pos,includeExtending)}function nextClusterBreak(str,pos,includeExtending){if(pos==str.length)return pos;pos&&surrogateLow(str.charCodeAt(pos))&&surrogateHigh(str.charCodeAt(pos-1))&&pos--;let prev=codePointAt(str,pos);for(pos+=codePointSize(prev);pos<str.length;){let next=codePointAt(str,pos);if(8205==prev||8205==next||includeExtending&&isExtendingChar(next))pos+=codePointSize(next),prev=next;else{if(!isRegionalIndicator(next))break;{let countBefore=0,i=pos-2;for(;i>=0&&isRegionalIndicator(codePointAt(str,i));)countBefore++,i-=2;if(countBefore%2==0)break;pos+=2}}}return pos}function prevClusterBreak(str,pos,includeExtending){for(;pos>0;){let found=nextClusterBreak(str,pos-2,includeExtending);if(found<pos)return found;pos--}return 0}function surrogateLow(ch){return ch>=56320&&ch<57344}function surrogateHigh(ch){return ch>=55296&&ch<56320}function codePointAt(str,pos){let code0=str.charCodeAt(pos);if(!surrogateHigh(code0)||pos+1==str.length)return code0;let code1=str.charCodeAt(pos+1);return surrogateLow(code1)?code1-56320+(code0-55296<<10)+65536:code0}function fromCodePoint(code){return code<=65535?String.fromCharCode(code):(code-=65536,String.fromCharCode(55296+(code>>10),56320+(1023&code)))}function codePointSize(code){return code<65536?1:2}const DefaultSplit=/\r\n?|\n/;var MapMode=function(MapMode){return MapMode[MapMode.Simple=0]="Simple",MapMode[MapMode.TrackDel=1]="TrackDel",MapMode[MapMode.TrackBefore=2]="TrackBefore",MapMode[MapMode.TrackAfter=3]="TrackAfter",MapMode}(MapMode||(MapMode={}));class ChangeDesc{constructor(sections){this.sections=sections}get length(){let result=0;for(let i=0;i<this.sections.length;i+=2)result+=this.sections[i];return result}get newLength(){let result=0;for(let i=0;i<this.sections.length;i+=2){let ins=this.sections[i+1];result+=ins<0?this.sections[i]:ins}return result}get empty(){return 0==this.sections.length||2==this.sections.length&&this.sections[1]<0}iterGaps(f){for(let i=0,posA=0,posB=0;i<this.sections.length;){let len=this.sections[i++],ins=this.sections[i++];ins<0?(f(posA,posB,len),posB+=len):posB+=ins,posA+=len}}iterChangedRanges(f,individual=!1){iterChanges(this,f,individual)}get invertedDesc(){let sections=[];for(let i=0;i<this.sections.length;){let len=this.sections[i++],ins=this.sections[i++];ins<0?sections.push(len,ins):sections.push(ins,len)}return new ChangeDesc(sections)}composeDesc(other){return this.empty?other:other.empty?this:composeSets(this,other)}mapDesc(other,before=!1){return other.empty?this:mapSet(this,other,before)}mapPos(pos,assoc=-1,mode=MapMode.Simple){let posA=0,posB=0;for(let i=0;i<this.sections.length;){let len=this.sections[i++],ins=this.sections[i++],endA=posA+len;if(ins<0){if(endA>pos)return posB+(pos-posA);posB+=len}else{if(mode!=MapMode.Simple&&endA>=pos&&(mode==MapMode.TrackDel&&posA<pos&&endA>pos||mode==MapMode.TrackBefore&&posA<pos||mode==MapMode.TrackAfter&&endA>pos))return null;if(endA>pos||endA==pos&&assoc<0&&!len)return pos==posA||assoc<0?posB:posB+ins;posB+=ins}posA=endA}if(pos>posA)throw new RangeError(`Position ${pos} is out of range for changeset of length ${posA}`);return posB}touchesRange(from,to=from){for(let i=0,pos=0;i<this.sections.length&&pos<=to;){let end=pos+this.sections[i++];if(this.sections[i++]>=0&&pos<=to&&end>=from)return!(pos<from&&end>to)||"cover";pos=end}return!1}toString(){let result="";for(let i=0;i<this.sections.length;){let len=this.sections[i++],ins=this.sections[i++];result+=(result?" ":"")+len+(ins>=0?":"+ins:"")}return result}toJSON(){return this.sections}static fromJSON(json){if(!Array.isArray(json)||json.length%2||json.some((a=>"number"!=typeof a)))throw new RangeError("Invalid JSON representation of ChangeDesc");return new ChangeDesc(json)}static create(sections){return new ChangeDesc(sections)}}class ChangeSet extends ChangeDesc{constructor(sections,inserted){super(sections),this.inserted=inserted}apply(doc){if(this.length!=doc.length)throw new RangeError("Applying change set to a document with the wrong length");return iterChanges(this,((fromA,toA,fromB,_toB,text)=>doc=doc.replace(fromB,fromB+(toA-fromA),text)),!1),doc}mapDesc(other,before=!1){return mapSet(this,other,before,!0)}invert(doc){let sections=this.sections.slice(),inserted=[];for(let i=0,pos=0;i<sections.length;i+=2){let len=sections[i],ins=sections[i+1];if(ins>=0){sections[i]=ins,sections[i+1]=len;let index=i>>1;for(;inserted.length<index;)inserted.push(Text.empty);inserted.push(len?doc.slice(pos,pos+len):Text.empty)}pos+=len}return new ChangeSet(sections,inserted)}compose(other){return this.empty?other:other.empty?this:composeSets(this,other,!0)}map(other,before=!1){return other.empty?this:mapSet(this,other,before,!0)}iterChanges(f,individual=!1){iterChanges(this,f,individual)}get desc(){return ChangeDesc.create(this.sections)}filter(ranges){let resultSections=[],resultInserted=[],filteredSections=[],iter=new SectionIter(this);done:for(let i=0,pos=0;;){let next=i==ranges.length?1e9:ranges[i++];for(;pos<next||pos==next&&0==iter.len;){if(iter.done)break done;let len=Math.min(iter.len,next-pos);addSection(filteredSections,len,-1);let ins=-1==iter.ins?-1:0==iter.off?iter.ins:0;addSection(resultSections,len,ins),ins>0&&addInsert(resultInserted,resultSections,iter.text),iter.forward(len),pos+=len}let end=ranges[i++];for(;pos<end;){if(iter.done)break done;let len=Math.min(iter.len,end-pos);addSection(resultSections,len,-1),addSection(filteredSections,len,-1==iter.ins?-1:0==iter.off?iter.ins:0),iter.forward(len),pos+=len}}return{changes:new ChangeSet(resultSections,resultInserted),filtered:ChangeDesc.create(filteredSections)}}toJSON(){let parts=[];for(let i=0;i<this.sections.length;i+=2){let len=this.sections[i],ins=this.sections[i+1];ins<0?parts.push(len):0==ins?parts.push([len]):parts.push([len].concat(this.inserted[i>>1].toJSON()))}return parts}static of(changes,length,lineSep){let sections=[],inserted=[],pos=0,total=null;function flush(force=!1){if(!force&&!sections.length)return;pos<length&&addSection(sections,length-pos,-1);let set=new ChangeSet(sections,inserted);total=total?total.compose(set.map(total)):set,sections=[],inserted=[],pos=0}return function process(spec){if(Array.isArray(spec))for(let sub of spec)process(sub);else if(spec instanceof ChangeSet){if(spec.length!=length)throw new RangeError(`Mismatched change set length (got ${spec.length}, expected ${length})`);flush(),total=total?total.compose(spec.map(total)):spec}else{let{from:from,to:to=from,insert:insert}=spec;if(from>to||from<0||to>length)throw new RangeError(`Invalid change range ${from} to ${to} (in doc of length ${length})`);let insText=insert?"string"==typeof insert?Text.of(insert.split(lineSep||DefaultSplit)):insert:Text.empty,insLen=insText.length;if(from==to&&0==insLen)return;from<pos&&flush(),from>pos&&addSection(sections,from-pos,-1),addSection(sections,to-from,insLen),addInsert(inserted,sections,insText),pos=to}}(changes),flush(!total),total}static empty(length){return new ChangeSet(length?[length,-1]:[],[])}static fromJSON(json){if(!Array.isArray(json))throw new RangeError("Invalid JSON representation of ChangeSet");let sections=[],inserted=[];for(let i=0;i<json.length;i++){let part=json[i];if("number"==typeof part)sections.push(part,-1);else{if(!Array.isArray(part)||"number"!=typeof part[0]||part.some(((e,i)=>i&&"string"!=typeof e)))throw new RangeError("Invalid JSON representation of ChangeSet");if(1==part.length)sections.push(part[0],0);else{for(;inserted.length<i;)inserted.push(Text.empty);inserted[i]=Text.of(part.slice(1)),sections.push(part[0],inserted[i].length)}}}return new ChangeSet(sections,inserted)}static createSet(sections,inserted){return new ChangeSet(sections,inserted)}}function addSection(sections,len,ins,forceJoin=!1){if(0==len&&ins<=0)return;let last=sections.length-2;last>=0&&ins<=0&&ins==sections[last+1]?sections[last]+=len:0==len&&0==sections[last]?sections[last+1]+=ins:forceJoin?(sections[last]+=len,sections[last+1]+=ins):sections.push(len,ins)}function addInsert(values,sections,value){if(0==value.length)return;let index=sections.length-2>>1;if(index<values.length)values[values.length-1]=values[values.length-1].append(value);else{for(;values.length<index;)values.push(Text.empty);values.push(value)}}function iterChanges(desc,f,individual){let inserted=desc.inserted;for(let posA=0,posB=0,i=0;i<desc.sections.length;){let len=desc.sections[i++],ins=desc.sections[i++];if(ins<0)posA+=len,posB+=len;else{let endA=posA,endB=posB,text=Text.empty;for(;endA+=len,endB+=ins,ins&&inserted&&(text=text.append(inserted[i-2>>1])),!(individual||i==desc.sections.length||desc.sections[i+1]<0);)len=desc.sections[i++],ins=desc.sections[i++];f(posA,endA,posB,endB,text),posA=endA,posB=endB}}}function mapSet(setA,setB,before,mkSet=!1){let sections=[],insert=mkSet?[]:null,a=new SectionIter(setA),b=new SectionIter(setB);for(let inserted=-1;;)if(-1==a.ins&&-1==b.ins){let len=Math.min(a.len,b.len);addSection(sections,len,-1),a.forward(len),b.forward(len)}else if(b.ins>=0&&(a.ins<0||inserted==a.i||0==a.off&&(b.len<a.len||b.len==a.len&&!before))){let len=b.len;for(addSection(sections,b.ins,-1);len;){let piece=Math.min(a.len,len);a.ins>=0&&inserted<a.i&&a.len<=piece&&(addSection(sections,0,a.ins),insert&&addInsert(insert,sections,a.text),inserted=a.i),a.forward(piece),len-=piece}b.next()}else{if(!(a.ins>=0)){if(a.done&&b.done)return insert?ChangeSet.createSet(sections,insert):ChangeDesc.create(sections);throw new Error("Mismatched change set lengths")}{let len=0,left=a.len;for(;left;)if(-1==b.ins){let piece=Math.min(left,b.len);len+=piece,left-=piece,b.forward(piece)}else{if(!(0==b.ins&&b.len<left))break;left-=b.len,b.next()}addSection(sections,len,inserted<a.i?a.ins:0),insert&&inserted<a.i&&addInsert(insert,sections,a.text),inserted=a.i,a.forward(a.len-left)}}}function composeSets(setA,setB,mkSet=!1){let sections=[],insert=mkSet?[]:null,a=new SectionIter(setA),b=new SectionIter(setB);for(let open=!1;;){if(a.done&&b.done)return insert?ChangeSet.createSet(sections,insert):ChangeDesc.create(sections);if(0==a.ins)addSection(sections,a.len,0,open),a.next();else if(0!=b.len||b.done){if(a.done||b.done)throw new Error("Mismatched change set lengths");{let len=Math.min(a.len2,b.len),sectionLen=sections.length;if(-1==a.ins){let insB=-1==b.ins?-1:b.off?0:b.ins;addSection(sections,len,insB,open),insert&&insB&&addInsert(insert,sections,b.text)}else-1==b.ins?(addSection(sections,a.off?0:a.len,len,open),insert&&addInsert(insert,sections,a.textBit(len))):(addSection(sections,a.off?0:a.len,b.off?0:b.ins,open),insert&&!b.off&&addInsert(insert,sections,b.text));open=(a.ins>len||b.ins>=0&&b.len>len)&&(open||sections.length>sectionLen),a.forward2(len),b.forward(len)}}else addSection(sections,0,b.ins,open),insert&&addInsert(insert,sections,b.text),b.next()}}class SectionIter{constructor(set){this.set=set,this.i=0,this.next()}next(){let{sections:sections}=this.set;this.i<sections.length?(this.len=sections[this.i++],this.ins=sections[this.i++]):(this.len=0,this.ins=-2),this.off=0}get done(){return-2==this.ins}get len2(){return this.ins<0?this.len:this.ins}get text(){let{inserted:inserted}=this.set,index=this.i-2>>1;return index>=inserted.length?Text.empty:inserted[index]}textBit(len){let{inserted:inserted}=this.set,index=this.i-2>>1;return index>=inserted.length&&!len?Text.empty:inserted[index].slice(this.off,null==len?void 0:this.off+len)}forward(len){len==this.len?this.next():(this.len-=len,this.off+=len)}forward2(len){-1==this.ins?this.forward(len):len==this.ins?this.next():(this.ins-=len,this.off+=len)}}class SelectionRange{constructor(from,to,flags){this.from=from,this.to=to,this.flags=flags}get anchor(){return 16&this.flags?this.to:this.from}get head(){return 16&this.flags?this.from:this.to}get empty(){return this.from==this.to}get assoc(){return 4&this.flags?-1:8&this.flags?1:0}get bidiLevel(){let level=3&this.flags;return 3==level?null:level}get goalColumn(){let value=this.flags>>5;return 33554431==value?void 0:value}map(change,assoc=-1){let from,to;return this.empty?from=to=change.mapPos(this.from,assoc):(from=change.mapPos(this.from,1),to=change.mapPos(this.to,-1)),from==this.from&&to==this.to?this:new SelectionRange(from,to,this.flags)}extend(from,to=from){if(from<=this.anchor&&to>=this.anchor)return EditorSelection.range(from,to);let head=Math.abs(from-this.anchor)>Math.abs(to-this.anchor)?from:to;return EditorSelection.range(this.anchor,head)}eq(other){return this.anchor==other.anchor&&this.head==other.head}toJSON(){return{anchor:this.anchor,head:this.head}}static fromJSON(json){if(!json||"number"!=typeof json.anchor||"number"!=typeof json.head)throw new RangeError("Invalid JSON representation for SelectionRange");return EditorSelection.range(json.anchor,json.head)}static create(from,to,flags){return new SelectionRange(from,to,flags)}}class EditorSelection{constructor(ranges,mainIndex){this.ranges=ranges,this.mainIndex=mainIndex}map(change,assoc=-1){return change.empty?this:EditorSelection.create(this.ranges.map((r=>r.map(change,assoc))),this.mainIndex)}eq(other){if(this.ranges.length!=other.ranges.length||this.mainIndex!=other.mainIndex)return!1;for(let i=0;i<this.ranges.length;i++)if(!this.ranges[i].eq(other.ranges[i]))return!1;return!0}get main(){return this.ranges[this.mainIndex]}asSingle(){return 1==this.ranges.length?this:new EditorSelection([this.main],0)}addRange(range,main=!0){return EditorSelection.create([range].concat(this.ranges),main?0:this.mainIndex+1)}replaceRange(range,which=this.mainIndex){let ranges=this.ranges.slice();return ranges[which]=range,EditorSelection.create(ranges,this.mainIndex)}toJSON(){return{ranges:this.ranges.map((r=>r.toJSON())),main:this.mainIndex}}static fromJSON(json){if(!json||!Array.isArray(json.ranges)||"number"!=typeof json.main||json.main>=json.ranges.length)throw new RangeError("Invalid JSON representation for EditorSelection");return new EditorSelection(json.ranges.map((r=>SelectionRange.fromJSON(r))),json.main)}static single(anchor,head=anchor){return new EditorSelection([EditorSelection.range(anchor,head)],0)}static create(ranges,mainIndex=0){if(0==ranges.length)throw new RangeError("A selection needs at least one range");for(let pos=0,i=0;i<ranges.length;i++){let range=ranges[i];if(range.empty?range.from<=pos:range.from<pos)return EditorSelection.normalized(ranges.slice(),mainIndex);pos=range.to}return new EditorSelection(ranges,mainIndex)}static cursor(pos,assoc=0,bidiLevel,goalColumn){return SelectionRange.create(pos,pos,(0==assoc?0:assoc<0?4:8)|(null==bidiLevel?3:Math.min(2,bidiLevel))|(null!=goalColumn?goalColumn:33554431)<<5)}static range(anchor,head,goalColumn){let goal=(null!=goalColumn?goalColumn:33554431)<<5;return head<anchor?SelectionRange.create(head,anchor,24|goal):SelectionRange.create(anchor,head,goal|(head>anchor?4:0))}static normalized(ranges,mainIndex=0){let main=ranges[mainIndex];ranges.sort(((a,b)=>a.from-b.from)),mainIndex=ranges.indexOf(main);for(let i=1;i<ranges.length;i++){let range=ranges[i],prev=ranges[i-1];if(range.empty?range.from<=prev.to:range.from<prev.to){let from=prev.from,to=Math.max(range.to,prev.to);i<=mainIndex&&mainIndex--,ranges.splice(--i,2,range.anchor>range.head?EditorSelection.range(to,from):EditorSelection.range(from,to))}}return new EditorSelection(ranges,mainIndex)}}function checkSelection(selection,docLength){for(let range of selection.ranges)if(range.to>docLength)throw new RangeError("Selection points outside of document")}let nextID=0;class Facet{constructor(combine,compareInput,compare,isStatic,enables){this.combine=combine,this.compareInput=compareInput,this.compare=compare,this.isStatic=isStatic,this.id=nextID++,this.default=combine([]),this.extensions="function"==typeof enables?enables(this):enables}static define(config={}){return new Facet(config.combine||(a=>a),config.compareInput||((a,b)=>a===b),config.compare||(config.combine?(a,b)=>a===b:sameArray$1),!!config.static,config.enables)}of(value){return new FacetProvider([],this,0,value)}compute(deps,get){if(this.isStatic)throw new Error("Can't compute a static facet");return new FacetProvider(deps,this,1,get)}computeN(deps,get){if(this.isStatic)throw new Error("Can't compute a static facet");return new FacetProvider(deps,this,2,get)}from(field,get){return get||(get=x=>x),this.compute([field],(state=>get(state.field(field))))}}function sameArray$1(a,b){return a==b||a.length==b.length&&a.every(((e,i)=>e===b[i]))}class FacetProvider{constructor(dependencies,facet,type,value){this.dependencies=dependencies,this.facet=facet,this.type=type,this.value=value,this.id=nextID++}dynamicSlot(addresses){var _a;let getter=this.value,compare=this.facet.compareInput,id=this.id,idx=addresses[id]>>1,multi=2==this.type,depDoc=!1,depSel=!1,depAddrs=[];for(let dep of this.dependencies)"doc"==dep?depDoc=!0:"selection"==dep?depSel=!0:1&(null!==(_a=addresses[dep.id])&&void 0!==_a?_a:1)||depAddrs.push(addresses[dep.id]);return{create:state=>(state.values[idx]=getter(state),1),update(state,tr){if(depDoc&&tr.docChanged||depSel&&(tr.docChanged||tr.selection)||ensureAll(state,depAddrs)){let newVal=getter(state);if(multi?!compareArray(newVal,state.values[idx],compare):!compare(newVal,state.values[idx]))return state.values[idx]=newVal,1}return 0},reconfigure:(state,oldState)=>{let newVal,oldAddr=oldState.config.address[id];if(null!=oldAddr){let oldVal=getAddr(oldState,oldAddr);if(this.dependencies.every((dep=>dep instanceof Facet?oldState.facet(dep)===state.facet(dep):!(dep instanceof StateField)||oldState.field(dep,!1)==state.field(dep,!1)))||(multi?compareArray(newVal=getter(state),oldVal,compare):compare(newVal=getter(state),oldVal)))return state.values[idx]=oldVal,0}else newVal=getter(state);return state.values[idx]=newVal,1}}}}function compareArray(a,b,compare){if(a.length!=b.length)return!1;for(let i=0;i<a.length;i++)if(!compare(a[i],b[i]))return!1;return!0}function ensureAll(state,addrs){let changed=!1;for(let addr of addrs)1&ensureAddr(state,addr)&&(changed=!0);return changed}function dynamicFacetSlot(addresses,facet,providers){let providerAddrs=providers.map((p=>addresses[p.id])),providerTypes=providers.map((p=>p.type)),dynamic=providerAddrs.filter((p=>!(1&p))),idx=addresses[facet.id]>>1;function get(state){let values=[];for(let i=0;i<providerAddrs.length;i++){let value=getAddr(state,providerAddrs[i]);if(2==providerTypes[i])for(let val of value)values.push(val);else values.push(value)}return facet.combine(values)}return{create(state){for(let addr of providerAddrs)ensureAddr(state,addr);return state.values[idx]=get(state),1},update(state,tr){if(!ensureAll(state,dynamic))return 0;let value=get(state);return facet.compare(value,state.values[idx])?0:(state.values[idx]=value,1)},reconfigure(state,oldState){let depChanged=ensureAll(state,providerAddrs),oldProviders=oldState.config.facets[facet.id],oldValue=oldState.facet(facet);if(oldProviders&&!depChanged&&sameArray$1(providers,oldProviders))return state.values[idx]=oldValue,0;let value=get(state);return facet.compare(value,oldValue)?(state.values[idx]=oldValue,0):(state.values[idx]=value,1)}}}const initField=Facet.define({static:!0});class StateField{constructor(id,createF,updateF,compareF,spec){this.id=id,this.createF=createF,this.updateF=updateF,this.compareF=compareF,this.spec=spec,this.provides=void 0}static define(config){let field=new StateField(nextID++,config.create,config.update,config.compare||((a,b)=>a===b),config);return config.provide&&(field.provides=config.provide(field)),field}create(state){let init=state.facet(initField).find((i=>i.field==this));return((null==init?void 0:init.create)||this.createF)(state)}slot(addresses){let idx=addresses[this.id]>>1;return{create:state=>(state.values[idx]=this.create(state),1),update:(state,tr)=>{let oldVal=state.values[idx],value=this.updateF(oldVal,tr);return this.compareF(oldVal,value)?0:(state.values[idx]=value,1)},reconfigure:(state,oldState)=>null!=oldState.config.address[this.id]?(state.values[idx]=oldState.field(this),0):(state.values[idx]=this.create(state),1)}}init(create){return[this,initField.of({field:this,create:create})]}get extension(){return this}}const Prec__lowest=4,Prec__low=3,Prec__default=2,Prec__high=1;function prec(value){return ext=>new PrecExtension(ext,value)}const Prec={highest:prec(0),high:prec(Prec__high),default:prec(Prec__default),low:prec(Prec__low),lowest:prec(Prec__lowest)};class PrecExtension{constructor(inner,prec){this.inner=inner,this.prec=prec}}class Compartment{of(ext){return new CompartmentInstance(this,ext)}reconfigure(content){return Compartment.reconfigure.of({compartment:this,extension:content})}get(state){return state.config.compartments.get(this)}}class CompartmentInstance{constructor(compartment,inner){this.compartment=compartment,this.inner=inner}}class Configuration{constructor(base,compartments,dynamicSlots,address,staticValues,facets){for(this.base=base,this.compartments=compartments,this.dynamicSlots=dynamicSlots,this.address=address,this.staticValues=staticValues,this.facets=facets,this.statusTemplate=[];this.statusTemplate.length<dynamicSlots.length;)this.statusTemplate.push(0)}staticFacet(facet){let addr=this.address[facet.id];return null==addr?facet.default:this.staticValues[addr>>1]}static resolve(base,compartments,oldState){let fields=[],facets=Object.create(null),newCompartments=new Map;for(let ext of function(extension,compartments,newCompartments){let result=[[],[],[],[],[]],seen=new Map;function inner(ext,prec){let known=seen.get(ext);if(null!=known){if(known<=prec)return;let found=result[known].indexOf(ext);found>-1&&result[known].splice(found,1),ext instanceof CompartmentInstance&&newCompartments.delete(ext.compartment)}if(seen.set(ext,prec),Array.isArray(ext))for(let e of ext)inner(e,prec);else if(ext instanceof CompartmentInstance){if(newCompartments.has(ext.compartment))throw new RangeError("Duplicate use of compartment in extensions");let content=compartments.get(ext.compartment)||ext.inner;newCompartments.set(ext.compartment,content),inner(content,prec)}else if(ext instanceof PrecExtension)inner(ext.inner,ext.prec);else if(ext instanceof StateField)result[prec].push(ext),ext.provides&&inner(ext.provides,prec);else if(ext instanceof FacetProvider)result[prec].push(ext),ext.facet.extensions&&inner(ext.facet.extensions,Prec__default);else{let content=ext.extension;if(!content)throw new Error(`Unrecognized extension value in extension set (${ext}). This sometimes happens because multiple instances of @codemirror/state are loaded, breaking instanceof checks.`);inner(content,prec)}}return inner(extension,Prec__default),result.reduce(((a,b)=>a.concat(b)))}(base,compartments,newCompartments))ext instanceof StateField?fields.push(ext):(facets[ext.facet.id]||(facets[ext.facet.id]=[])).push(ext);let address=Object.create(null),staticValues=[],dynamicSlots=[];for(let field of fields)address[field.id]=dynamicSlots.length<<1,dynamicSlots.push((a=>field.slot(a)));let oldFacets=null==oldState?void 0:oldState.config.facets;for(let id in facets){let providers=facets[id],facet=providers[0].facet,oldProviders=oldFacets&&oldFacets[id]||[];if(providers.every((p=>0==p.type)))if(address[facet.id]=staticValues.length<<1|1,sameArray$1(oldProviders,providers))staticValues.push(oldState.facet(facet));else{let value=facet.combine(providers.map((p=>p.value)));staticValues.push(oldState&&facet.compare(value,oldState.facet(facet))?oldState.facet(facet):value)}else{for(let p of providers)0==p.type?(address[p.id]=staticValues.length<<1|1,staticValues.push(p.value)):(address[p.id]=dynamicSlots.length<<1,dynamicSlots.push((a=>p.dynamicSlot(a))));address[facet.id]=dynamicSlots.length<<1,dynamicSlots.push((a=>dynamicFacetSlot(a,facet,providers)))}}let dynamic=dynamicSlots.map((f=>f(address)));return new Configuration(base,newCompartments,dynamic,address,staticValues,facets)}}function ensureAddr(state,addr){if(1&addr)return 2;let idx=addr>>1,status=state.status[idx];if(4==status)throw new Error("Cyclic dependency between fields and/or facets");if(2&status)return status;state.status[idx]=4;let changed=state.computeSlot(state,state.config.dynamicSlots[idx]);return state.status[idx]=2|changed}function getAddr(state,addr){return 1&addr?state.config.staticValues[addr>>1]:state.values[addr>>1]}const languageData=Facet.define(),allowMultipleSelections=Facet.define({combine:values=>values.some((v=>v)),static:!0}),lineSeparator=Facet.define({combine:values=>values.length?values[0]:void 0,static:!0}),changeFilter=Facet.define(),transactionFilter=Facet.define(),transactionExtender=Facet.define(),readOnly$1=Facet.define({combine:values=>!!values.length&&values[0]});class Annotation{constructor(type,value){this.type=type,this.value=value}static define(){return new AnnotationType}}class AnnotationType{of(value){return new Annotation(this,value)}}class StateEffectType{constructor(map){this.map=map}of(value){return new StateEffect(this,value)}}class StateEffect{constructor(type,value){this.type=type,this.value=value}map(mapping){let mapped=this.type.map(this.value,mapping);return void 0===mapped?void 0:mapped==this.value?this:new StateEffect(this.type,mapped)}is(type){return this.type==type}static define(spec={}){return new StateEffectType(spec.map||(v=>v))}static mapEffects(effects,mapping){if(!effects.length)return effects;let result=[];for(let effect of effects){let mapped=effect.map(mapping);mapped&&result.push(mapped)}return result}}StateEffect.reconfigure=StateEffect.define(),StateEffect.appendConfig=StateEffect.define();class Transaction{constructor(startState,changes,selection,effects,annotations,scrollIntoView){this.startState=startState,this.changes=changes,this.selection=selection,this.effects=effects,this.annotations=annotations,this.scrollIntoView=scrollIntoView,this._doc=null,this._state=null,selection&&checkSelection(selection,changes.newLength),annotations.some((a=>a.type==Transaction.time))||(this.annotations=annotations.concat(Transaction.time.of(Date.now())))}static create(startState,changes,selection,effects,annotations,scrollIntoView){return new Transaction(startState,changes,selection,effects,annotations,scrollIntoView)}get newDoc(){return this._doc||(this._doc=this.changes.apply(this.startState.doc))}get newSelection(){return this.selection||this.startState.selection.map(this.changes)}get state(){return this._state||this.startState.applyTransaction(this),this._state}annotation(type){for(let ann of this.annotations)if(ann.type==type)return ann.value}get docChanged(){return!this.changes.empty}get reconfigured(){return this.startState.config!=this.state.config}isUserEvent(event){let e=this.annotation(Transaction.userEvent);return!(!e||!(e==event||e.length>event.length&&e.slice(0,event.length)==event&&"."==e[event.length]))}}function joinRanges(a,b){let result=[];for(let iA=0,iB=0;;){let from,to;if(iA<a.length&&(iB==b.length||b[iB]>=a[iA]))from=a[iA++],to=a[iA++];else{if(!(iB<b.length))return result;from=b[iB++],to=b[iB++]}!result.length||result[result.length-1]<from?result.push(from,to):result[result.length-1]<to&&(result[result.length-1]=to)}}function mergeTransaction(a,b,sequential){var _a;let mapForA,mapForB,changes;return sequential?(mapForA=b.changes,mapForB=ChangeSet.empty(b.changes.length),changes=a.changes.compose(b.changes)):(mapForA=b.changes.map(a.changes),mapForB=a.changes.mapDesc(b.changes,!0),changes=a.changes.compose(mapForA)),{changes:changes,selection:b.selection?b.selection.map(mapForB):null===(_a=a.selection)||void 0===_a?void 0:_a.map(mapForA),effects:StateEffect.mapEffects(a.effects,mapForA).concat(StateEffect.mapEffects(b.effects,mapForB)),annotations:a.annotations.length?a.annotations.concat(b.annotations):b.annotations,scrollIntoView:a.scrollIntoView||b.scrollIntoView}}function resolveTransactionInner(state,spec,docSize){let sel=spec.selection,annotations=asArray$1(spec.annotations);return spec.userEvent&&(annotations=annotations.concat(Transaction.userEvent.of(spec.userEvent))),{changes:spec.changes instanceof ChangeSet?spec.changes:ChangeSet.of(spec.changes||[],docSize,state.facet(lineSeparator)),selection:sel&&(sel instanceof EditorSelection?sel:EditorSelection.single(sel.anchor,sel.head)),effects:asArray$1(spec.effects),annotations:annotations,scrollIntoView:!!spec.scrollIntoView}}function resolveTransaction(state,specs,filter){let s=resolveTransactionInner(state,specs.length?specs[0]:{},state.doc.length);specs.length&&!1===specs[0].filter&&(filter=!1);for(let i=1;i<specs.length;i++){!1===specs[i].filter&&(filter=!1);let seq=!!specs[i].sequential;s=mergeTransaction(s,resolveTransactionInner(state,specs[i],seq?s.changes.newLength:state.doc.length),seq)}let tr=Transaction.create(state,s.changes,s.selection,s.effects,s.annotations,s.scrollIntoView);return function(tr){let state=tr.startState,extenders=state.facet(transactionExtender),spec=tr;for(let i=extenders.length-1;i>=0;i--){let extension=extenders[i](tr);extension&&Object.keys(extension).length&&(spec=mergeTransaction(spec,resolveTransactionInner(state,extension,tr.changes.newLength),!0))}return spec==tr?tr:Transaction.create(state,tr.changes,tr.selection,spec.effects,spec.annotations,spec.scrollIntoView)}(filter?function(tr){let state=tr.startState,result=!0;for(let filter of state.facet(changeFilter)){let value=filter(tr);if(!1===value){result=!1;break}Array.isArray(value)&&(result=!0===result?value:joinRanges(result,value))}if(!0!==result){let changes,back;if(!1===result)back=tr.changes.invertedDesc,changes=ChangeSet.empty(state.doc.length);else{let filtered=tr.changes.filter(result);changes=filtered.changes,back=filtered.filtered.mapDesc(filtered.changes).invertedDesc}tr=Transaction.create(state,changes,tr.selection&&tr.selection.map(back),StateEffect.mapEffects(tr.effects,back),tr.annotations,tr.scrollIntoView)}let filters=state.facet(transactionFilter);for(let i=filters.length-1;i>=0;i--){let filtered=filters[i](tr);tr=filtered instanceof Transaction?filtered:Array.isArray(filtered)&&1==filtered.length&&filtered[0]instanceof Transaction?filtered[0]:resolveTransaction(state,asArray$1(filtered),!1)}return tr}(tr):tr)}Transaction.time=Annotation.define(),Transaction.userEvent=Annotation.define(),Transaction.addToHistory=Annotation.define(),Transaction.remote=Annotation.define();const none$1=[];function asArray$1(value){return null==value?none$1:Array.isArray(value)?value:[value]}var CharCategory=function(CharCategory){return CharCategory[CharCategory.Word=0]="Word",CharCategory[CharCategory.Space=1]="Space",CharCategory[CharCategory.Other=2]="Other",CharCategory}(CharCategory||(CharCategory={}));const nonASCIISingleCaseWordChar=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;let wordChar;try{wordChar=new RegExp("[\\p{Alphabetic}\\p{Number}_]","u")}catch(_){}function makeCategorizer(wordChars){return char=>{if(!/\S/.test(char))return CharCategory.Space;if(function(str){if(wordChar)return wordChar.test(str);for(let i=0;i<str.length;i++){let ch=str[i];if(/\w/.test(ch)||ch>""&&(ch.toUpperCase()!=ch.toLowerCase()||nonASCIISingleCaseWordChar.test(ch)))return!0}return!1}(char))return CharCategory.Word;for(let i=0;i<wordChars.length;i++)if(char.indexOf(wordChars[i])>-1)return CharCategory.Word;return CharCategory.Other}}class EditorState{constructor(config,doc,selection,values,computeSlot,tr){this.config=config,this.doc=doc,this.selection=selection,this.values=values,this.status=config.statusTemplate.slice(),this.computeSlot=computeSlot,tr&&(tr._state=this);for(let i=0;i<this.config.dynamicSlots.length;i++)ensureAddr(this,i<<1);this.computeSlot=null}field(field,require=!0){let addr=this.config.address[field.id];if(null!=addr)return ensureAddr(this,addr),getAddr(this,addr);if(require)throw new RangeError("Field is not present in this state")}update(...specs){return resolveTransaction(this,specs,!0)}applyTransaction(tr){let startValues,conf=this.config,{base:base,compartments:compartments}=conf;for(let effect of tr.effects)effect.is(Compartment.reconfigure)?(conf&&(compartments=new Map,conf.compartments.forEach(((val,key)=>compartments.set(key,val))),conf=null),compartments.set(effect.value.compartment,effect.value.extension)):effect.is(StateEffect.reconfigure)?(conf=null,base=effect.value):effect.is(StateEffect.appendConfig)&&(conf=null,base=asArray$1(base).concat(effect.value));if(conf)startValues=tr.startState.values.slice();else{conf=Configuration.resolve(base,compartments,this),startValues=new EditorState(conf,this.doc,this.selection,conf.dynamicSlots.map((()=>null)),((state,slot)=>slot.reconfigure(state,this)),null).values}new EditorState(conf,tr.newDoc,tr.newSelection,startValues,((state,slot)=>slot.update(state,tr)),tr)}replaceSelection(text){return"string"==typeof text&&(text=this.toText(text)),this.changeByRange((range=>({changes:{from:range.from,to:range.to,insert:text},range:EditorSelection.cursor(range.from+text.length)})))}changeByRange(f){let sel=this.selection,result1=f(sel.ranges[0]),changes=this.changes(result1.changes),ranges=[result1.range],effects=asArray$1(result1.effects);for(let i=1;i<sel.ranges.length;i++){let result=f(sel.ranges[i]),newChanges=this.changes(result.changes),newMapped=newChanges.map(changes);for(let j=0;j<i;j++)ranges[j]=ranges[j].map(newMapped);let mapBy=changes.mapDesc(newChanges,!0);ranges.push(result.range.map(mapBy)),changes=changes.compose(newMapped),effects=StateEffect.mapEffects(effects,newMapped).concat(StateEffect.mapEffects(asArray$1(result.effects),mapBy))}return{changes:changes,selection:EditorSelection.create(ranges,sel.mainIndex),effects:effects}}changes(spec=[]){return spec instanceof ChangeSet?spec:ChangeSet.of(spec,this.doc.length,this.facet(EditorState.lineSeparator))}toText(string){return Text.of(string.split(this.facet(EditorState.lineSeparator)||DefaultSplit))}sliceDoc(from=0,to=this.doc.length){return this.doc.sliceString(from,to,this.lineBreak)}facet(facet){let addr=this.config.address[facet.id];return null==addr?facet.default:(ensureAddr(this,addr),getAddr(this,addr))}toJSON(fields){let result={doc:this.sliceDoc(),selection:this.selection.toJSON()};if(fields)for(let prop in fields){let value=fields[prop];value instanceof StateField&&null!=this.config.address[value.id]&&(result[prop]=value.spec.toJSON(this.field(fields[prop]),this))}return result}static fromJSON(json,config={},fields){if(!json||"string"!=typeof json.doc)throw new RangeError("Invalid JSON representation for EditorState");let fieldInit=[];if(fields)for(let prop in fields)if(Object.prototype.hasOwnProperty.call(json,prop)){let field=fields[prop],value=json[prop];fieldInit.push(field.init((state=>field.spec.fromJSON(value,state))))}return EditorState.create({doc:json.doc,selection:EditorSelection.fromJSON(json.selection),extensions:config.extensions?fieldInit.concat([config.extensions]):fieldInit})}static create(config={}){let configuration=Configuration.resolve(config.extensions||[],new Map),doc=config.doc instanceof Text?config.doc:Text.of((config.doc||"").split(configuration.staticFacet(EditorState.lineSeparator)||DefaultSplit)),selection=config.selection?config.selection instanceof EditorSelection?config.selection:EditorSelection.single(config.selection.anchor,config.selection.head):EditorSelection.single(0);return checkSelection(selection,doc.length),configuration.staticFacet(allowMultipleSelections)||(selection=selection.asSingle()),new EditorState(configuration,doc,selection,configuration.dynamicSlots.map((()=>null)),((state,slot)=>slot.create(state)),null)}get tabSize(){return this.facet(EditorState.tabSize)}get lineBreak(){return this.facet(EditorState.lineSeparator)||"\n"}get readOnly(){return this.facet(readOnly$1)}phrase(phrase,...insert){for(let map of this.facet(EditorState.phrases))if(Object.prototype.hasOwnProperty.call(map,phrase)){phrase=map[phrase];break}return insert.length&&(phrase=phrase.replace(/\$(\$|\d*)/g,((m,i)=>{if("$"==i)return"$";let n=+(i||1);return!n||n>insert.length?m:insert[n-1]}))),phrase}languageDataAt(name,pos,side=-1){let values=[];for(let provider of this.facet(languageData))for(let result of provider(this,pos,side))Object.prototype.hasOwnProperty.call(result,name)&&values.push(result[name]);return values}charCategorizer(at){return makeCategorizer(this.languageDataAt("wordChars",at).join(""))}wordAt(pos){let{text:text,from:from,length:length}=this.doc.lineAt(pos),cat=this.charCategorizer(pos),start=pos-from,end=pos-from;for(;start>0;){let prev=findClusterBreak(text,start,!1);if(cat(text.slice(prev,start))!=CharCategory.Word)break;start=prev}for(;end<length;){let next=findClusterBreak(text,end);if(cat(text.slice(end,next))!=CharCategory.Word)break;end=next}return start==end?null:EditorSelection.range(start+from,end+from)}}function combineConfig(configs,defaults,combine={}){let result={};for(let config of configs)for(let key of Object.keys(config)){let value=config[key],current=result[key];if(void 0===current)result[key]=value;else if(current===value||void 0===value);else{if(!Object.hasOwnProperty.call(combine,key))throw new Error("Config merge conflict for field "+key);result[key]=combine[key](current,value)}}for(let key in defaults)void 0===result[key]&&(result[key]=defaults[key]);return result}EditorState.allowMultipleSelections=allowMultipleSelections,EditorState.tabSize=Facet.define({combine:values=>values.length?values[0]:4}),EditorState.lineSeparator=lineSeparator,EditorState.readOnly=readOnly$1,EditorState.phrases=Facet.define({compare(a,b){let kA=Object.keys(a),kB=Object.keys(b);return kA.length==kB.length&&kA.every((k=>a[k]==b[k]))}}),EditorState.languageData=languageData,EditorState.changeFilter=changeFilter,EditorState.transactionFilter=transactionFilter,EditorState.transactionExtender=transactionExtender,Compartment.reconfigure=StateEffect.define();class RangeValue{eq(other){return this==other}range(from,to=from){return Range$1.create(from,to,this)}}RangeValue.prototype.startSide=RangeValue.prototype.endSide=0,RangeValue.prototype.point=!1,RangeValue.prototype.mapMode=MapMode.TrackDel;let Range$1=class Range{constructor(from,to,value){this.from=from,this.to=to,this.value=value}static create(from,to,value){return new Range(from,to,value)}};function cmpRange(a,b){return a.from-b.from||a.value.startSide-b.value.startSide}class Chunk{constructor(from,to,value,maxPoint){this.from=from,this.to=to,this.value=value,this.maxPoint=maxPoint}get length(){return this.to[this.to.length-1]}findIndex(pos,side,end,startAt=0){let arr=end?this.to:this.from;for(let lo=startAt,hi=arr.length;;){if(lo==hi)return lo;let mid=lo+hi>>1,diff=arr[mid]-pos||(end?this.value[mid].endSide:this.value[mid].startSide)-side;if(mid==lo)return diff>=0?lo:hi;diff>=0?hi=mid:lo=mid+1}}between(offset,from,to,f){for(let i=this.findIndex(from,-1e9,!0),e=this.findIndex(to,1e9,!1,i);i<e;i++)if(!1===f(this.from[i]+offset,this.to[i]+offset,this.value[i]))return!1}map(offset,changes){let value=[],from=[],to=[],newPos=-1,maxPoint=-1;for(let i=0;i<this.value.length;i++){let newFrom,newTo,val=this.value[i],curFrom=this.from[i]+offset,curTo=this.to[i]+offset;if(curFrom==curTo){let mapped=changes.mapPos(curFrom,val.startSide,val.mapMode);if(null==mapped)continue;if(newFrom=newTo=mapped,val.startSide!=val.endSide&&(newTo=changes.mapPos(curFrom,val.endSide),newTo<newFrom))continue}else if(newFrom=changes.mapPos(curFrom,val.startSide),newTo=changes.mapPos(curTo,val.endSide),newFrom>newTo||newFrom==newTo&&val.startSide>0&&val.endSide<=0)continue;(newTo-newFrom||val.endSide-val.startSide)<0||(newPos<0&&(newPos=newFrom),val.point&&(maxPoint=Math.max(maxPoint,newTo-newFrom)),value.push(val),from.push(newFrom-newPos),to.push(newTo-newPos))}return{mapped:value.length?new Chunk(from,to,value,maxPoint):null,pos:newPos}}}class RangeSet{constructor(chunkPos,chunk,nextLayer,maxPoint){this.chunkPos=chunkPos,this.chunk=chunk,this.nextLayer=nextLayer,this.maxPoint=maxPoint}static create(chunkPos,chunk,nextLayer,maxPoint){return new RangeSet(chunkPos,chunk,nextLayer,maxPoint)}get length(){let last=this.chunk.length-1;return last<0?0:Math.max(this.chunkEnd(last),this.nextLayer.length)}get size(){if(this.isEmpty)return 0;let size=this.nextLayer.size;for(let chunk of this.chunk)size+=chunk.value.length;return size}chunkEnd(index){return this.chunkPos[index]+this.chunk[index].length}update(updateSpec){let{add:add=[],sort:sort=!1,filterFrom:filterFrom=0,filterTo:filterTo=this.length}=updateSpec,filter=updateSpec.filter;if(0==add.length&&!filter)return this;if(sort&&(add=add.slice().sort(cmpRange)),this.isEmpty)return add.length?RangeSet.of(add):this;let cur=new LayerCursor(this,null,-1).goto(0),i=0,spill=[],builder=new RangeSetBuilder;for(;cur.value||i<add.length;)if(i<add.length&&(cur.from-add[i].from||cur.startSide-add[i].value.startSide)>=0){let range=add[i++];builder.addInner(range.from,range.to,range.value)||spill.push(range)}else 1==cur.rangeIndex&&cur.chunkIndex<this.chunk.length&&(i==add.length||this.chunkEnd(cur.chunkIndex)<add[i].from)&&(!filter||filterFrom>this.chunkEnd(cur.chunkIndex)||filterTo<this.chunkPos[cur.chunkIndex])&&builder.addChunk(this.chunkPos[cur.chunkIndex],this.chunk[cur.chunkIndex])?cur.nextChunk():((!filter||filterFrom>cur.to||filterTo<cur.from||filter(cur.from,cur.to,cur.value))&&(builder.addInner(cur.from,cur.to,cur.value)||spill.push(Range$1.create(cur.from,cur.to,cur.value))),cur.next());return builder.finishInner(this.nextLayer.isEmpty&&!spill.length?RangeSet.empty:this.nextLayer.update({add:spill,filter:filter,filterFrom:filterFrom,filterTo:filterTo}))}map(changes){if(changes.empty||this.isEmpty)return this;let chunks=[],chunkPos=[],maxPoint=-1;for(let i=0;i<this.chunk.length;i++){let start=this.chunkPos[i],chunk=this.chunk[i],touch=changes.touchesRange(start,start+chunk.length);if(!1===touch)maxPoint=Math.max(maxPoint,chunk.maxPoint),chunks.push(chunk),chunkPos.push(changes.mapPos(start));else if(!0===touch){let{mapped:mapped,pos:pos}=chunk.map(start,changes);mapped&&(maxPoint=Math.max(maxPoint,mapped.maxPoint),chunks.push(mapped),chunkPos.push(pos))}}let next=this.nextLayer.map(changes);return 0==chunks.length?next:new RangeSet(chunkPos,chunks,next||RangeSet.empty,maxPoint)}between(from,to,f){if(!this.isEmpty){for(let i=0;i<this.chunk.length;i++){let start=this.chunkPos[i],chunk=this.chunk[i];if(to>=start&&from<=start+chunk.length&&!1===chunk.between(start,from-start,to-start,f))return}this.nextLayer.between(from,to,f)}}iter(from=0){return HeapCursor.from([this]).goto(from)}get isEmpty(){return this.nextLayer==this}static iter(sets,from=0){return HeapCursor.from(sets).goto(from)}static compare(oldSets,newSets,textDiff,comparator,minPointSize=-1){let a=oldSets.filter((set=>set.maxPoint>0||!set.isEmpty&&set.maxPoint>=minPointSize)),b=newSets.filter((set=>set.maxPoint>0||!set.isEmpty&&set.maxPoint>=minPointSize)),sharedChunks=findSharedChunks(a,b,textDiff),sideA=new SpanCursor(a,sharedChunks,minPointSize),sideB=new SpanCursor(b,sharedChunks,minPointSize);textDiff.iterGaps(((fromA,fromB,length)=>compare(sideA,fromA,sideB,fromB,length,comparator))),textDiff.empty&&0==textDiff.length&&compare(sideA,0,sideB,0,0,comparator)}static eq(oldSets,newSets,from=0,to){null==to&&(to=999999999);let a=oldSets.filter((set=>!set.isEmpty&&newSets.indexOf(set)<0)),b=newSets.filter((set=>!set.isEmpty&&oldSets.indexOf(set)<0));if(a.length!=b.length)return!1;if(!a.length)return!0;let sharedChunks=findSharedChunks(a,b),sideA=new SpanCursor(a,sharedChunks,0).goto(from),sideB=new SpanCursor(b,sharedChunks,0).goto(from);for(;;){if(sideA.to!=sideB.to||!sameValues(sideA.active,sideB.active)||sideA.point&&(!sideB.point||!sideA.point.eq(sideB.point)))return!1;if(sideA.to>to)return!0;sideA.next(),sideB.next()}}static spans(sets,from,to,iterator,minPointSize=-1){let cursor=new SpanCursor(sets,null,minPointSize).goto(from),pos=from,openRanges=cursor.openStart;for(;;){let curTo=Math.min(cursor.to,to);if(cursor.point){let active=cursor.activeForPoint(cursor.to),openCount=cursor.pointFrom<from?active.length+1:Math.min(active.length,openRanges);iterator.point(pos,curTo,cursor.point,active,openCount,cursor.pointRank),openRanges=Math.min(cursor.openEnd(curTo),active.length)}else curTo>pos&&(iterator.span(pos,curTo,cursor.active,openRanges),openRanges=cursor.openEnd(curTo));if(cursor.to>to)return openRanges+(cursor.point&&cursor.to>to?1:0);pos=cursor.to,cursor.next()}}static of(ranges,sort=!1){let build=new RangeSetBuilder;for(let range of ranges instanceof Range$1?[ranges]:sort?function(ranges){if(ranges.length>1)for(let prev=ranges[0],i=1;i<ranges.length;i++){let cur=ranges[i];if(cmpRange(prev,cur)>0)return ranges.slice().sort(cmpRange);prev=cur}return ranges}(ranges):ranges)build.add(range.from,range.to,range.value);return build.finish()}}RangeSet.empty=new RangeSet([],[],null,-1),RangeSet.empty.nextLayer=RangeSet.empty;class RangeSetBuilder{constructor(){this.chunks=[],this.chunkPos=[],this.chunkStart=-1,this.last=null,this.lastFrom=-1e9,this.lastTo=-1e9,this.from=[],this.to=[],this.value=[],this.maxPoint=-1,this.setMaxPoint=-1,this.nextLayer=null}finishChunk(newArrays){this.chunks.push(new Chunk(this.from,this.to,this.value,this.maxPoint)),this.chunkPos.push(this.chunkStart),this.chunkStart=-1,this.setMaxPoint=Math.max(this.setMaxPoint,this.maxPoint),this.maxPoint=-1,newArrays&&(this.from=[],this.to=[],this.value=[])}add(from,to,value){this.addInner(from,to,value)||(this.nextLayer||(this.nextLayer=new RangeSetBuilder)).add(from,to,value)}addInner(from,to,value){let diff=from-this.lastTo||value.startSide-this.last.endSide;if(diff<=0&&(from-this.lastFrom||value.startSide-this.last.startSide)<0)throw new Error("Ranges must be added sorted by `from` position and `startSide`");return!(diff<0)&&(250==this.from.length&&this.finishChunk(!0),this.chunkStart<0&&(this.chunkStart=from),this.from.push(from-this.chunkStart),this.to.push(to-this.chunkStart),this.last=value,this.lastFrom=from,this.lastTo=to,this.value.push(value),value.point&&(this.maxPoint=Math.max(this.maxPoint,to-from)),!0)}addChunk(from,chunk){if((from-this.lastTo||chunk.value[0].startSide-this.last.endSide)<0)return!1;this.from.length&&this.finishChunk(!0),this.setMaxPoint=Math.max(this.setMaxPoint,chunk.maxPoint),this.chunks.push(chunk),this.chunkPos.push(from);let last=chunk.value.length-1;return this.last=chunk.value[last],this.lastFrom=chunk.from[last]+from,this.lastTo=chunk.to[last]+from,!0}finish(){return this.finishInner(RangeSet.empty)}finishInner(next){if(this.from.length&&this.finishChunk(!1),0==this.chunks.length)return next;let result=RangeSet.create(this.chunkPos,this.chunks,this.nextLayer?this.nextLayer.finishInner(next):next,this.setMaxPoint);return this.from=null,result}}function findSharedChunks(a,b,textDiff){let inA=new Map;for(let set of a)for(let i=0;i<set.chunk.length;i++)set.chunk[i].maxPoint<=0&&inA.set(set.chunk[i],set.chunkPos[i]);let shared=new Set;for(let set of b)for(let i=0;i<set.chunk.length;i++){let known=inA.get(set.chunk[i]);null==known||(textDiff?textDiff.mapPos(known):known)!=set.chunkPos[i]||(null==textDiff?void 0:textDiff.touchesRange(known,known+set.chunk[i].length))||shared.add(set.chunk[i])}return shared}class LayerCursor{constructor(layer,skip,minPoint,rank=0){this.layer=layer,this.skip=skip,this.minPoint=minPoint,this.rank=rank}get startSide(){return this.value?this.value.startSide:0}get endSide(){return this.value?this.value.endSide:0}goto(pos,side=-1e9){return this.chunkIndex=this.rangeIndex=0,this.gotoInner(pos,side,!1),this}gotoInner(pos,side,forward){for(;this.chunkIndex<this.layer.chunk.length;){let next=this.layer.chunk[this.chunkIndex];if(!(this.skip&&this.skip.has(next)||this.layer.chunkEnd(this.chunkIndex)<pos||next.maxPoint<this.minPoint))break;this.chunkIndex++,forward=!1}if(this.chunkIndex<this.layer.chunk.length){let rangeIndex=this.layer.chunk[this.chunkIndex].findIndex(pos-this.layer.chunkPos[this.chunkIndex],side,!0);(!forward||this.rangeIndex<rangeIndex)&&this.setRangeIndex(rangeIndex)}this.next()}forward(pos,side){(this.to-pos||this.endSide-side)<0&&this.gotoInner(pos,side,!0)}next(){for(;;){if(this.chunkIndex==this.layer.chunk.length){this.from=this.to=1e9,this.value=null;break}{let chunkPos=this.layer.chunkPos[this.chunkIndex],chunk=this.layer.chunk[this.chunkIndex],from=chunkPos+chunk.from[this.rangeIndex];if(this.from=from,this.to=chunkPos+chunk.to[this.rangeIndex],this.value=chunk.value[this.rangeIndex],this.setRangeIndex(this.rangeIndex+1),this.minPoint<0||this.value.point&&this.to-this.from>=this.minPoint)break}}}setRangeIndex(index){if(index==this.layer.chunk[this.chunkIndex].value.length){if(this.chunkIndex++,this.skip)for(;this.chunkIndex<this.layer.chunk.length&&this.skip.has(this.layer.chunk[this.chunkIndex]);)this.chunkIndex++;this.rangeIndex=0}else this.rangeIndex=index}nextChunk(){this.chunkIndex++,this.rangeIndex=0,this.next()}compare(other){return this.from-other.from||this.startSide-other.startSide||this.rank-other.rank||this.to-other.to||this.endSide-other.endSide}}class HeapCursor{constructor(heap){this.heap=heap}static from(sets,skip=null,minPoint=-1){let heap=[];for(let i=0;i<sets.length;i++)for(let cur=sets[i];!cur.isEmpty;cur=cur.nextLayer)cur.maxPoint>=minPoint&&heap.push(new LayerCursor(cur,skip,minPoint,i));return 1==heap.length?heap[0]:new HeapCursor(heap)}get startSide(){return this.value?this.value.startSide:0}goto(pos,side=-1e9){for(let cur of this.heap)cur.goto(pos,side);for(let i=this.heap.length>>1;i>=0;i--)heapBubble(this.heap,i);return this.next(),this}forward(pos,side){for(let cur of this.heap)cur.forward(pos,side);for(let i=this.heap.length>>1;i>=0;i--)heapBubble(this.heap,i);(this.to-pos||this.value.endSide-side)<0&&this.next()}next(){if(0==this.heap.length)this.from=this.to=1e9,this.value=null,this.rank=-1;else{let top=this.heap[0];this.from=top.from,this.to=top.to,this.value=top.value,this.rank=top.rank,top.value&&top.next(),heapBubble(this.heap,0)}}}function heapBubble(heap,index){for(let cur=heap[index];;){let childIndex=1+(index<<1);if(childIndex>=heap.length)break;let child=heap[childIndex];if(childIndex+1<heap.length&&child.compare(heap[childIndex+1])>=0&&(child=heap[childIndex+1],childIndex++),cur.compare(child)<0)break;heap[childIndex]=cur,heap[index]=child,index=childIndex}}class SpanCursor{constructor(sets,skip,minPoint){this.minPoint=minPoint,this.active=[],this.activeTo=[],this.activeRank=[],this.minActive=-1,this.point=null,this.pointFrom=0,this.pointRank=0,this.to=-1e9,this.endSide=0,this.openStart=-1,this.cursor=HeapCursor.from(sets,skip,minPoint)}goto(pos,side=-1e9){return this.cursor.goto(pos,side),this.active.length=this.activeTo.length=this.activeRank.length=0,this.minActive=-1,this.to=pos,this.endSide=side,this.openStart=-1,this.next(),this}forward(pos,side){for(;this.minActive>-1&&(this.activeTo[this.minActive]-pos||this.active[this.minActive].endSide-side)<0;)this.removeActive(this.minActive);this.cursor.forward(pos,side)}removeActive(index){remove(this.active,index),remove(this.activeTo,index),remove(this.activeRank,index),this.minActive=findMinIndex(this.active,this.activeTo)}addActive(trackOpen){let i=0,{value:value,to:to,rank:rank}=this.cursor;for(;i<this.activeRank.length&&this.activeRank[i]<=rank;)i++;insert(this.active,i,value),insert(this.activeTo,i,to),insert(this.activeRank,i,rank),trackOpen&&insert(trackOpen,i,this.cursor.from),this.minActive=findMinIndex(this.active,this.activeTo)}next(){let from=this.to,wasPoint=this.point;this.point=null;let trackOpen=this.openStart<0?[]:null;for(;;){let a=this.minActive;if(a>-1&&(this.activeTo[a]-this.cursor.from||this.active[a].endSide-this.cursor.startSide)<0){if(this.activeTo[a]>from){this.to=this.activeTo[a],this.endSide=this.active[a].endSide;break}this.removeActive(a),trackOpen&&remove(trackOpen,a)}else{if(!this.cursor.value){this.to=this.endSide=1e9;break}if(this.cursor.from>from){this.to=this.cursor.from,this.endSide=this.cursor.startSide;break}{let nextVal=this.cursor.value;if(nextVal.point){if(!(wasPoint&&this.cursor.to==this.to&&this.cursor.from<this.cursor.to)){this.point=nextVal,this.pointFrom=this.cursor.from,this.pointRank=this.cursor.rank,this.to=this.cursor.to,this.endSide=nextVal.endSide,this.cursor.next(),this.forward(this.to,this.endSide);break}this.cursor.next()}else this.addActive(trackOpen),this.cursor.next()}}}if(trackOpen){this.openStart=0;for(let i=trackOpen.length-1;i>=0&&trackOpen[i]<from;i--)this.openStart++}}activeForPoint(to){if(!this.active.length)return this.active;let active=[];for(let i=this.active.length-1;i>=0&&!(this.activeRank[i]<this.pointRank);i--)(this.activeTo[i]>to||this.activeTo[i]==to&&this.active[i].endSide>=this.point.endSide)&&active.push(this.active[i]);return active.reverse()}openEnd(to){let open=0;for(let i=this.activeTo.length-1;i>=0&&this.activeTo[i]>to;i--)open++;return open}}function compare(a,startA,b,startB,length,comparator){a.goto(startA),b.goto(startB);let endB=startB+length,pos=startB,dPos=startB-startA;for(;;){let diff=a.to+dPos-b.to||a.endSide-b.endSide,end=diff<0?a.to+dPos:b.to,clipEnd=Math.min(end,endB);if(a.point||b.point?a.point&&b.point&&(a.point==b.point||a.point.eq(b.point))&&sameValues(a.activeForPoint(a.to+dPos),b.activeForPoint(b.to))||comparator.comparePoint(pos,clipEnd,a.point,b.point):clipEnd>pos&&!sameValues(a.active,b.active)&&comparator.compareRange(pos,clipEnd,a.active,b.active),end>endB)break;pos=end,diff<=0&&a.next(),diff>=0&&b.next()}}function sameValues(a,b){if(a.length!=b.length)return!1;for(let i=0;i<a.length;i++)if(a[i]!=b[i]&&!a[i].eq(b[i]))return!1;return!0}function remove(array,index){for(let i=index,e=array.length-1;i<e;i++)array[i]=array[i+1];array.pop()}function insert(array,index,value){for(let i=array.length-1;i>=index;i--)array[i+1]=array[i];array[index]=value}function findMinIndex(value,array){let found=-1,foundPos=1e9;for(let i=0;i<array.length;i++)(array[i]-foundPos||value[i].endSide-value[found].endSide)<0&&(found=i,foundPos=array[i]);return found}function countColumn(string,tabSize,to=string.length){let n=0;for(let i=0;i<to;)9==string.charCodeAt(i)?(n+=tabSize-n%tabSize,i++):(n++,i=findClusterBreak(string,i));return n}function findColumn(string,col,tabSize,strict){for(let i=0,n=0;;){if(n>=col)return i;if(i==string.length)break;n+=9==string.charCodeAt(i)?tabSize-n%tabSize:1,i=findClusterBreak(string,i)}return!0===strict?-1:string.length}const COUNT="undefined"==typeof Symbol?"__ͼ":Symbol.for("ͼ"),SET="undefined"==typeof Symbol?"__styleSet"+Math.floor(1e8*Math.random()):Symbol("styleSet"),top="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};class StyleModule{constructor(spec,options){this.rules=[];let{finish:finish}=options||{};function splitSelector(selector){return/^@/.test(selector)?[selector]:selector.split(/,\s*/)}function render(selectors,spec,target,isKeyframes){let local=[],isAt=/^@(\w+)\b/.exec(selectors[0]),keyframes=isAt&&"keyframes"==isAt[1];if(isAt&&null==spec)return target.push(selectors[0]+";");for(let prop in spec){let value=spec[prop];if(/&/.test(prop))render(prop.split(/,\s*/).map((part=>selectors.map((sel=>part.replace(/&/,sel))))).reduce(((a,b)=>a.concat(b))),value,target);else if(value&&"object"==typeof value){if(!isAt)throw new RangeError("The value of a property ("+prop+") should be a primitive value.");render(splitSelector(prop),value,local,keyframes)}else null!=value&&local.push(prop.replace(/_.*/,"").replace(/[A-Z]/g,(l=>"-"+l.toLowerCase()))+": "+value+";")}(local.length||keyframes)&&target.push((!finish||isAt||isKeyframes?selectors:selectors.map(finish)).join(", ")+" {"+local.join(" ")+"}")}for(let prop in spec)render(splitSelector(prop),spec[prop],this.rules)}getRules(){return this.rules.join("\n")}static newName(){let id=top[COUNT]||1;return top[COUNT]=id+1,"ͼ"+id.toString(36)}static mount(root,modules){(root[SET]||new StyleSet(root)).mount(Array.isArray(modules)?modules:[modules])}}let adoptedSet=null;class StyleSet{constructor(root){if(!root.head&&root.adoptedStyleSheets&&"undefined"!=typeof CSSStyleSheet){if(adoptedSet)return root.adoptedStyleSheets=[adoptedSet.sheet].concat(root.adoptedStyleSheets),root[SET]=adoptedSet;this.sheet=new CSSStyleSheet,root.adoptedStyleSheets=[this.sheet].concat(root.adoptedStyleSheets),adoptedSet=this}else{this.styleTag=(root.ownerDocument||root).createElement("style");let target=root.head||root;target.insertBefore(this.styleTag,target.firstChild)}this.modules=[],root[SET]=this}mount(modules){let sheet=this.sheet,pos=0,j=0;for(let i=0;i<modules.length;i++){let mod=modules[i],index=this.modules.indexOf(mod);if(index<j&&index>-1&&(this.modules.splice(index,1),j--,index=-1),-1==index){if(this.modules.splice(j++,0,mod),sheet)for(let k=0;k<mod.rules.length;k++)sheet.insertRule(mod.rules[k],pos++)}else{for(;j<index;)pos+=this.modules[j++].rules.length;pos+=mod.rules.length,j++}}if(!sheet){let text="";for(let i=0;i<this.modules.length;i++)text+=this.modules[i].getRules()+"\n";this.styleTag.textContent=text}}}for(var base={8:"Backspace",9:"Tab",10:"Enter",12:"NumLock",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",44:"PrintScreen",45:"Insert",46:"Delete",59:";",61:"=",91:"Meta",92:"Meta",106:"*",107:"+",108:",",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",160:"Shift",161:"Shift",162:"Control",163:"Control",164:"Alt",165:"Alt",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},shift={48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'},chrome$1="undefined"!=typeof navigator&&/Chrome\/(\d+)/.exec(navigator.userAgent),mac="undefined"!=typeof navigator&&/Mac/.test(navigator.platform),ie$1="undefined"!=typeof navigator&&/MSIE \d|Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent),brokenModifierNames=mac||chrome$1&&+chrome$1[1]<57,i=0;i<10;i++)base[48+i]=base[96+i]=String(i);for(i=1;i<=24;i++)base[i+111]="F"+i;for(i=65;i<=90;i++)base[i]=String.fromCharCode(i+32),shift[i]=String.fromCharCode(i);for(var code in base)shift.hasOwnProperty(code)||(shift[code]=base[code]);function getSelection(root){let target;return target=11==root.nodeType?root.getSelection?root:root.ownerDocument:root,target.getSelection()}function contains(dom,node){return!!node&&(dom==node||dom.contains(1!=node.nodeType?node.parentNode:node))}function hasSelection(dom,selection){if(!selection.anchorNode)return!1;try{return contains(dom,selection.anchorNode)}catch(_){return!1}}function clientRectsFor(dom){return 3==dom.nodeType?textRange(dom,0,dom.nodeValue.length).getClientRects():1==dom.nodeType?dom.getClientRects():[]}function isEquivalentPosition(node,off,targetNode,targetOff){return!!targetNode&&(scanFor(node,off,targetNode,targetOff,-1)||scanFor(node,off,targetNode,targetOff,1))}function domIndex(node){for(var index=0;;index++)if(!(node=node.previousSibling))return index}function scanFor(node,off,targetNode,targetOff,dir){for(;;){if(node==targetNode&&off==targetOff)return!0;if(off==(dir<0?0:maxOffset(node))){if("DIV"==node.nodeName)return!1;let parent=node.parentNode;if(!parent||1!=parent.nodeType)return!1;off=domIndex(node)+(dir<0?0:1),node=parent}else{if(1!=node.nodeType)return!1;if(1==(node=node.childNodes[off+(dir<0?-1:0)]).nodeType&&"false"==node.contentEditable)return!1;off=dir<0?maxOffset(node):0}}}function maxOffset(node){return 3==node.nodeType?node.nodeValue.length:node.childNodes.length}const Rect0={left:0,right:0,top:0,bottom:0};function flattenRect(rect,left){let x=left?rect.left:rect.right;return{left:x,right:x,top:rect.top,bottom:rect.bottom}}function windowRect(win){return{left:0,right:win.innerWidth,top:0,bottom:win.innerHeight}}class DOMSelectionState{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}eq(domSel){return this.anchorNode==domSel.anchorNode&&this.anchorOffset==domSel.anchorOffset&&this.focusNode==domSel.focusNode&&this.focusOffset==domSel.focusOffset}setRange(range){this.set(range.anchorNode,range.anchorOffset,range.focusNode,range.focusOffset)}set(anchorNode,anchorOffset,focusNode,focusOffset){this.anchorNode=anchorNode,this.anchorOffset=anchorOffset,this.focusNode=focusNode,this.focusOffset=focusOffset}}let scratchRange,preventScrollSupported=null;function focusPreventScroll(dom){if(dom.setActive)return dom.setActive();if(preventScrollSupported)return dom.focus(preventScrollSupported);let stack=[];for(let cur=dom;cur&&(stack.push(cur,cur.scrollTop,cur.scrollLeft),cur!=cur.ownerDocument);cur=cur.parentNode);if(dom.focus(null==preventScrollSupported?{get preventScroll(){return preventScrollSupported={preventScroll:!0},!0}}:void 0),!preventScrollSupported){preventScrollSupported=!1;for(let i=0;i<stack.length;){let elt=stack[i++],top=stack[i++],left=stack[i++];elt.scrollTop!=top&&(elt.scrollTop=top),elt.scrollLeft!=left&&(elt.scrollLeft=left)}}}function textRange(node,from,to=from){let range=scratchRange||(scratchRange=document.createRange());return range.setEnd(node,to),range.setStart(node,from),range}function dispatchKey(elt,name,code){let options={key:name,code:name,keyCode:code,which:code,cancelable:!0},down=new KeyboardEvent("keydown",options);down.synthetic=!0,elt.dispatchEvent(down);let up=new KeyboardEvent("keyup",options);return up.synthetic=!0,elt.dispatchEvent(up),down.defaultPrevented||up.defaultPrevented}function clearAttributes(node){for(;node.attributes.length;)node.removeAttributeNode(node.attributes[0])}class DOMPos{constructor(node,offset,precise=!0){this.node=node,this.offset=offset,this.precise=precise}static before(dom,precise){return new DOMPos(dom.parentNode,domIndex(dom),precise)}static after(dom,precise){return new DOMPos(dom.parentNode,domIndex(dom)+1,precise)}}const noChildren=[];class ContentView{constructor(){this.parent=null,this.dom=null,this.dirty=2}get editorView(){if(!this.parent)throw new Error("Accessing view in orphan content view");return this.parent.editorView}get overrideDOMText(){return null}get posAtStart(){return this.parent?this.parent.posBefore(this):0}get posAtEnd(){return this.posAtStart+this.length}posBefore(view){let pos=this.posAtStart;for(let child of this.children){if(child==view)return pos;pos+=child.length+child.breakAfter}throw new RangeError("Invalid child in posBefore")}posAfter(view){return this.posBefore(view)+view.length}coordsAt(_pos,_side){return null}sync(track){if(2&this.dirty){let next,parent=this.dom,prev=null;for(let child of this.children){if(child.dirty){if(!child.dom&&(next=prev?prev.nextSibling:parent.firstChild)){let contentView=ContentView.get(next);(!contentView||!contentView.parent&&contentView.canReuseDOM(child))&&child.reuseDOM(next)}child.sync(track),child.dirty=0}if(next=prev?prev.nextSibling:parent.firstChild,track&&!track.written&&track.node==parent&&next!=child.dom&&(track.written=!0),child.dom.parentNode==parent)for(;next&&next!=child.dom;)next=rm$1(next);else parent.insertBefore(child.dom,next);prev=child.dom}for(next=prev?prev.nextSibling:parent.firstChild,next&&track&&track.node==parent&&(track.written=!0);next;)next=rm$1(next)}else if(1&this.dirty)for(let child of this.children)child.dirty&&(child.sync(track),child.dirty=0)}reuseDOM(_dom){}localPosFromDOM(node,offset){let after;if(node==this.dom)after=this.dom.childNodes[offset];else{let bias=0==maxOffset(node)?0:0==offset?-1:1;for(;;){let parent=node.parentNode;if(parent==this.dom)break;0==bias&&parent.firstChild!=parent.lastChild&&(bias=node==parent.firstChild?-1:1),node=parent}after=bias<0?node:node.nextSibling}if(after==this.dom.firstChild)return 0;for(;after&&!ContentView.get(after);)after=after.nextSibling;if(!after)return this.length;for(let i=0,pos=0;;i++){let child=this.children[i];if(child.dom==after)return pos;pos+=child.length+child.breakAfter}}domBoundsAround(from,to,offset=0){let fromI=-1,fromStart=-1,toI=-1,toEnd=-1;for(let i=0,pos=offset,prevEnd=offset;i<this.children.length;i++){let child=this.children[i],end=pos+child.length;if(pos<from&&end>to)return child.domBoundsAround(from,to,pos);if(end>=from&&-1==fromI&&(fromI=i,fromStart=pos),pos>to&&child.dom.parentNode==this.dom){toI=i,toEnd=prevEnd;break}prevEnd=end,pos=end+child.breakAfter}return{from:fromStart,to:toEnd<0?offset+this.length:toEnd,startDOM:(fromI?this.children[fromI-1].dom.nextSibling:null)||this.dom.firstChild,endDOM:toI<this.children.length&&toI>=0?this.children[toI].dom:null}}markDirty(andParent=!1){this.dirty|=2,this.markParentsDirty(andParent)}markParentsDirty(childList){for(let parent=this.parent;parent;parent=parent.parent){if(childList&&(parent.dirty|=2),1&parent.dirty)return;parent.dirty|=1,childList=!1}}setParent(parent){this.parent!=parent&&(this.parent=parent,this.dirty&&this.markParentsDirty(!0))}setDOM(dom){this.dom&&(this.dom.cmView=null),this.dom=dom,dom.cmView=this}get rootView(){for(let v=this;;){let parent=v.parent;if(!parent)return v;v=parent}}replaceChildren(from,to,children=noChildren){this.markDirty();for(let i=from;i<to;i++){let child=this.children[i];child.parent==this&&child.destroy()}this.children.splice(from,to-from,...children);for(let i=0;i<children.length;i++)children[i].setParent(this)}ignoreMutation(_rec){return!1}ignoreEvent(_event){return!1}childCursor(pos=this.length){return new ChildCursor(this.children,pos,this.children.length)}childPos(pos,bias=1){return this.childCursor().findPos(pos,bias)}toString(){let name=this.constructor.name.replace("View","");return name+(this.children.length?"("+this.children.join()+")":this.length?"["+("Text"==name?this.text:this.length)+"]":"")+(this.breakAfter?"#":"")}static get(node){return node.cmView}get isEditable(){return!0}merge(from,to,source,hasStart,openStart,openEnd){return!1}become(other){return!1}canReuseDOM(other){return other.constructor==this.constructor}getSide(){return 0}destroy(){this.parent=null}}function rm$1(dom){let next=dom.nextSibling;return dom.parentNode.removeChild(dom),next}ContentView.prototype.breakAfter=0;class ChildCursor{constructor(children,pos,i){this.children=children,this.pos=pos,this.i=i,this.off=0}findPos(pos,bias=1){for(;;){if(pos>this.pos||pos==this.pos&&(bias>0||0==this.i||this.children[this.i-1].breakAfter))return this.off=pos-this.pos,this;let next=this.children[--this.i];this.pos-=next.length+next.breakAfter}}}function replaceRange(parent,fromI,fromOff,toI,toOff,insert,breakAtStart,openStart,openEnd){let{children:children}=parent,before=children.length?children[fromI]:null,last=insert.length?insert[insert.length-1]:null,breakAtEnd=last?last.breakAfter:breakAtStart;if(!(fromI==toI&&before&&!breakAtStart&&!breakAtEnd&&insert.length<2&&before.merge(fromOff,toOff,insert.length?last:null,0==fromOff,openStart,openEnd))){if(toI<children.length){let after=children[toI];after&&toOff<after.length?(fromI==toI&&(after=after.split(toOff),toOff=0),!breakAtEnd&&last&&after.merge(0,toOff,last,!0,0,openEnd)?insert[insert.length-1]=after:(toOff&&after.merge(0,toOff,null,!1,0,openEnd),insert.push(after))):(null==after?void 0:after.breakAfter)&&(last?last.breakAfter=1:breakAtStart=1),toI++}for(before&&(before.breakAfter=breakAtStart,fromOff>0&&(!breakAtStart&&insert.length&&before.merge(fromOff,before.length,insert[0],!1,openStart,0)?before.breakAfter=insert.shift().breakAfter:(fromOff<before.length||before.children.length&&0==before.children[before.children.length-1].length)&&before.merge(fromOff,before.length,null,!1,openStart,0),fromI++));fromI<toI&&insert.length;)if(children[toI-1].become(insert[insert.length-1]))toI--,insert.pop(),openEnd=insert.length?0:openStart;else{if(!children[fromI].become(insert[0]))break;fromI++,insert.shift(),openStart=insert.length?0:openEnd}!insert.length&&fromI&&toI<children.length&&!children[fromI-1].breakAfter&&children[toI].merge(0,0,children[fromI-1],!1,openStart,openEnd)&&fromI--,(fromI<toI||insert.length)&&parent.replaceChildren(fromI,toI,insert)}}function mergeChildrenInto(parent,from,to,insert,openStart,openEnd){let cur=parent.childCursor(),{i:toI,off:toOff}=cur.findPos(to,1),{i:fromI,off:fromOff}=cur.findPos(from,-1),dLen=from-to;for(let view of insert)dLen+=view.length;parent.length+=dLen,replaceRange(parent,fromI,fromOff,toI,toOff,insert,0,openStart,openEnd)}let nav="undefined"!=typeof navigator?navigator:{userAgent:"",vendor:"",platform:""},doc="undefined"!=typeof document?document:{documentElement:{style:{}}};const ie_edge=/Edge\/(\d+)/.exec(nav.userAgent),ie_upto10=/MSIE \d/.test(nav.userAgent),ie_11up=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(nav.userAgent),ie=!!(ie_upto10||ie_11up||ie_edge),gecko=!ie&&/gecko\/(\d+)/i.test(nav.userAgent),chrome=!ie&&/Chrome\/(\d+)/.exec(nav.userAgent),webkit="webkitFontSmoothing"in doc.documentElement.style,safari=!ie&&/Apple Computer/.test(nav.vendor),ios=safari&&(/Mobile\/\w+/.test(nav.userAgent)||nav.maxTouchPoints>2);var browser={mac:ios||/Mac/.test(nav.platform),windows:/Win/.test(nav.platform),linux:/Linux|X11/.test(nav.platform),ie:ie,ie_version:ie_upto10?doc.documentMode||6:ie_11up?+ie_11up[1]:ie_edge?+ie_edge[1]:0,gecko:gecko,gecko_version:gecko?+(/Firefox\/(\d+)/.exec(nav.userAgent)||[0,0])[1]:0,chrome:!!chrome,chrome_version:chrome?+chrome[1]:0,ios:ios,android:/Android\b/.test(nav.userAgent),webkit:webkit,safari:safari,webkit_version:webkit?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0,tabSize:null!=doc.documentElement.style.tabSize?"tab-size":"-moz-tab-size"};class TextView extends ContentView{constructor(text){super(),this.text=text}get length(){return this.text.length}createDOM(textDOM){this.setDOM(textDOM||document.createTextNode(this.text))}sync(track){this.dom||this.createDOM(),this.dom.nodeValue!=this.text&&(track&&track.node==this.dom&&(track.written=!0),this.dom.nodeValue=this.text)}reuseDOM(dom){3==dom.nodeType&&this.createDOM(dom)}merge(from,to,source){return(!source||source instanceof TextView&&!(this.length-(to-from)+source.length>256))&&(this.text=this.text.slice(0,from)+(source?source.text:"")+this.text.slice(to),this.markDirty(),!0)}split(from){let result=new TextView(this.text.slice(from));return this.text=this.text.slice(0,from),this.markDirty(),result}localPosFromDOM(node,offset){return node==this.dom?offset:offset?this.text.length:0}domAtPos(pos){return new DOMPos(this.dom,pos)}domBoundsAround(_from,_to,offset){return{from:offset,to:offset+this.length,startDOM:this.dom,endDOM:this.dom.nextSibling}}coordsAt(pos,side){return textCoords(this.dom,pos,side)}}class MarkView extends ContentView{constructor(mark,children=[],length=0){super(),this.mark=mark,this.children=children,this.length=length;for(let ch of children)ch.setParent(this)}setAttrs(dom){if(clearAttributes(dom),this.mark.class&&(dom.className=this.mark.class),this.mark.attrs)for(let name in this.mark.attrs)dom.setAttribute(name,this.mark.attrs[name]);return dom}reuseDOM(node){node.nodeName==this.mark.tagName.toUpperCase()&&(this.setDOM(node),this.dirty|=6)}sync(track){this.dom?4&this.dirty&&this.setAttrs(this.dom):this.setDOM(this.setAttrs(document.createElement(this.mark.tagName))),super.sync(track)}merge(from,to,source,_hasStart,openStart,openEnd){return(!source||!(!(source instanceof MarkView&&source.mark.eq(this.mark))||from&&openStart<=0||to<this.length&&openEnd<=0))&&(mergeChildrenInto(this,from,to,source?source.children:[],openStart-1,openEnd-1),this.markDirty(),!0)}split(from){let result=[],off=0,detachFrom=-1,i=0;for(let elt of this.children){let end=off+elt.length;end>from&&result.push(off<from?elt.split(from-off):elt),detachFrom<0&&off>=from&&(detachFrom=i),off=end,i++}let length=this.length-from;return this.length=from,detachFrom>-1&&(this.children.length=detachFrom,this.markDirty()),new MarkView(this.mark,result,length)}domAtPos(pos){return inlineDOMAtPos(this,pos)}coordsAt(pos,side){return coordsInChildren(this,pos,side)}}function textCoords(text,pos,side){let length=text.nodeValue.length;pos>length&&(pos=length);let from=pos,to=pos,flatten=0;0==pos&&side<0||pos==length&&side>=0?browser.chrome||browser.gecko||(pos?(from--,flatten=1):to<length&&(to++,flatten=-1)):side<0?from--:to<length&&to++;let rects=textRange(text,from,to).getClientRects();if(!rects.length)return Rect0;let rect=rects[(flatten?flatten<0:side>=0)?0:rects.length-1];return browser.safari&&!flatten&&0==rect.width&&(rect=Array.prototype.find.call(rects,(r=>r.width))||rect),flatten?flattenRect(rect,flatten<0):rect||null}class WidgetView extends ContentView{constructor(widget,length,side){super(),this.widget=widget,this.length=length,this.side=side,this.prevWidget=null}static create(widget,length,side){return new(widget.customView||WidgetView)(widget,length,side)}split(from){let result=WidgetView.create(this.widget,this.length-from,this.side);return this.length-=from,result}sync(){this.dom&&this.widget.updateDOM(this.dom)||(this.dom&&this.prevWidget&&this.prevWidget.destroy(this.dom),this.prevWidget=null,this.setDOM(this.widget.toDOM(this.editorView)),this.dom.contentEditable="false")}getSide(){return this.side}merge(from,to,source,hasStart,openStart,openEnd){return!(source&&(!(source instanceof WidgetView&&this.widget.compare(source.widget))||from>0&&openStart<=0||to<this.length&&openEnd<=0))&&(this.length=from+(source?source.length:0)+(this.length-to),!0)}become(other){return other.length==this.length&&other instanceof WidgetView&&other.side==this.side&&this.widget.constructor==other.widget.constructor&&(this.widget.eq(other.widget)||this.markDirty(!0),this.dom&&!this.prevWidget&&(this.prevWidget=this.widget),this.widget=other.widget,!0)}ignoreMutation(){return!0}ignoreEvent(event){return this.widget.ignoreEvent(event)}get overrideDOMText(){if(0==this.length)return Text.empty;let top=this;for(;top.parent;)top=top.parent;let view=top.editorView,text=view&&view.state.doc,start=this.posAtStart;return text?text.slice(start,start+this.length):Text.empty}domAtPos(pos){return 0==pos?DOMPos.before(this.dom):DOMPos.after(this.dom,pos==this.length)}domBoundsAround(){return null}coordsAt(pos,side){let rects=this.dom.getClientRects(),rect=null;if(!rects.length)return Rect0;for(let i=pos>0?rects.length-1:0;rect=rects[i],!(pos>0?0==i:i==rects.length-1||rect.top<rect.bottom);i+=pos>0?-1:1);return this.length?rect:flattenRect(rect,this.side>0)}get isEditable(){return!1}destroy(){super.destroy(),this.dom&&this.widget.destroy(this.dom)}}class CompositionView extends WidgetView{domAtPos(pos){let{topView:topView,text:text}=this.widget;return topView?scanCompositionTree(pos,0,topView,text,((v,p)=>v.domAtPos(p)),(p=>new DOMPos(text,Math.min(p,text.nodeValue.length)))):new DOMPos(text,Math.min(pos,text.nodeValue.length))}sync(){this.setDOM(this.widget.toDOM())}localPosFromDOM(node,offset){let{topView:topView,text:text}=this.widget;return topView?posFromDOMInCompositionTree(node,offset,topView,text):Math.min(offset,this.length)}ignoreMutation(){return!1}get overrideDOMText(){return null}coordsAt(pos,side){let{topView:topView,text:text}=this.widget;return topView?scanCompositionTree(pos,side,topView,text,((v,pos,side)=>v.coordsAt(pos,side)),((pos,side)=>textCoords(text,pos,side))):textCoords(text,pos,side)}destroy(){var _a;super.destroy(),null===(_a=this.widget.topView)||void 0===_a||_a.destroy()}get isEditable(){return!0}canReuseDOM(){return!0}}function scanCompositionTree(pos,side,view,text,enterView,fromText){if(view instanceof MarkView){for(let child=view.dom.firstChild;child;child=child.nextSibling){let desc=ContentView.get(child);if(!desc)return fromText(pos,side);let hasComp=contains(child,text),len=desc.length+(hasComp?text.nodeValue.length:0);if(pos<len||pos==len&&desc.getSide()<=0)return hasComp?scanCompositionTree(pos,side,desc,text,enterView,fromText):enterView(desc,pos,side);pos-=len}return enterView(view,view.length,-1)}return view.dom==text?fromText(pos,side):enterView(view,pos,side)}function posFromDOMInCompositionTree(node,offset,view,text){if(view instanceof MarkView)for(let child of view.children){let pos=0,hasComp=contains(child.dom,text);if(contains(child.dom,node))return pos+(hasComp?posFromDOMInCompositionTree(node,offset,child,text):child.localPosFromDOM(node,offset));pos+=hasComp?text.nodeValue.length:child.length}else if(view.dom==text)return Math.min(offset,text.nodeValue.length);return view.localPosFromDOM(node,offset)}class WidgetBufferView extends ContentView{constructor(side){super(),this.side=side}get length(){return 0}merge(){return!1}become(other){return other instanceof WidgetBufferView&&other.side==this.side}split(){return new WidgetBufferView(this.side)}sync(){if(!this.dom){let dom=document.createElement("img");dom.className="cm-widgetBuffer",dom.setAttribute("aria-hidden","true"),this.setDOM(dom)}}getSide(){return this.side}domAtPos(pos){return DOMPos.before(this.dom)}localPosFromDOM(){return 0}domBoundsAround(){return null}coordsAt(pos){let imgRect=this.dom.getBoundingClientRect(),siblingRect=function(view,side){let parent=view.parent,index=parent?parent.children.indexOf(view):-1;for(;parent&&index>=0;)if(side<0?index>0:index<parent.children.length){let next=parent.children[index+side];if(next instanceof TextView){let nextRect=next.coordsAt(side<0?next.length:0,side);if(nextRect)return nextRect}index+=side}else{if(!(parent instanceof MarkView&&parent.parent)){let last=parent.dom.lastChild;if(last&&"BR"==last.nodeName)return last.getClientRects()[0];break}index=parent.parent.children.indexOf(parent)+(side<0?0:1),parent=parent.parent}return}(this,this.side>0?-1:1);return siblingRect&&siblingRect.top<imgRect.bottom&&siblingRect.bottom>imgRect.top?{left:imgRect.left,right:imgRect.right,top:siblingRect.top,bottom:siblingRect.bottom}:imgRect}get overrideDOMText(){return Text.empty}}function inlineDOMAtPos(parent,pos){let dom=parent.dom,{children:children}=parent,i=0;for(let off=0;i<children.length;i++){let child=children[i],end=off+child.length;if(!(end==off&&child.getSide()<=0)){if(pos>off&&pos<end&&child.dom.parentNode==dom)return child.domAtPos(pos-off);if(pos<=off)break;off=end}}for(let j=i;j>0;j--){let prev=children[j-1];if(prev.dom.parentNode==dom)return prev.domAtPos(prev.length)}for(let j=i;j<children.length;j++){let next=children[j];if(next.dom.parentNode==dom)return next.domAtPos(0)}return new DOMPos(dom,0)}function joinInlineInto(parent,view,open){let last,{children:children}=parent;open>0&&view instanceof MarkView&&children.length&&(last=children[children.length-1])instanceof MarkView&&last.mark.eq(view.mark)?joinInlineInto(last,view.children[0],open-1):(children.push(view),view.setParent(parent)),parent.length+=view.length}function coordsInChildren(view,pos,side){let before=null,beforePos=-1,after=null,afterPos=-1;!function scan(view,pos){for(let i=0,off=0;i<view.children.length&&off<=pos;i++){let child=view.children[i],end=off+child.length;end>=pos&&(child.children.length?scan(child,pos-off):!after&&(end>pos||off==end&&child.getSide()>0)?(after=child,afterPos=pos-off):(off<pos||off==end&&child.getSide()<0)&&(before=child,beforePos=pos-off)),off=end}}(view,pos);let target=(side<0?before:after)||before||after;return target?target.coordsAt(Math.max(0,target==before?beforePos:afterPos),side):function(view){let last=view.dom.lastChild;if(!last)return view.dom.getBoundingClientRect();let rects=clientRectsFor(last);return rects[rects.length-1]||null}(view)}function combineAttrs(source,target){for(let name in source)"class"==name&&target.class?target.class+=" "+source.class:"style"==name&&target.style?target.style+=";"+source.style:target[name]=source[name];return target}function attrsEq(a,b){if(a==b)return!0;if(!a||!b)return!1;let keysA=Object.keys(a),keysB=Object.keys(b);if(keysA.length!=keysB.length)return!1;for(let key of keysA)if(-1==keysB.indexOf(key)||a[key]!==b[key])return!1;return!0}function updateAttrs(dom,prev,attrs){let changed=null;if(prev)for(let name in prev)attrs&&name in attrs||dom.removeAttribute(changed=name);if(attrs)for(let name in attrs)prev&&prev[name]==attrs[name]||dom.setAttribute(changed=name,attrs[name]);return!!changed}TextView.prototype.children=WidgetView.prototype.children=WidgetBufferView.prototype.children=noChildren;class WidgetType{eq(widget){return!1}updateDOM(dom){return!1}compare(other){return this==other||this.constructor==other.constructor&&this.eq(other)}get estimatedHeight(){return-1}ignoreEvent(event){return!0}get customView(){return null}destroy(dom){}}var BlockType=function(BlockType){return BlockType[BlockType.Text=0]="Text",BlockType[BlockType.WidgetBefore=1]="WidgetBefore",BlockType[BlockType.WidgetAfter=2]="WidgetAfter",BlockType[BlockType.WidgetRange=3]="WidgetRange",BlockType}(BlockType||(BlockType={}));class Decoration extends RangeValue{constructor(startSide,endSide,widget,spec){super(),this.startSide=startSide,this.endSide=endSide,this.widget=widget,this.spec=spec}get heightRelevant(){return!1}static mark(spec){return new MarkDecoration(spec)}static widget(spec){let side=spec.side||0,block=!!spec.block;return side+=block?side>0?3e8:-4e8:side>0?1e8:-1e8,new PointDecoration(spec,side,side,block,spec.widget||null,!1)}static replace(spec){let startSide,endSide,block=!!spec.block;if(spec.isBlockGap)startSide=-5e8,endSide=4e8;else{let{start:start,end:end}=getInclusive(spec,block);startSide=(start?block?-3e8:-1:5e8)-1,endSide=1+(end?block?2e8:1:-6e8)}return new PointDecoration(spec,startSide,endSide,block,spec.widget||null,!0)}static line(spec){return new LineDecoration(spec)}static set(of,sort=!1){return RangeSet.of(of,sort)}hasHeight(){return!!this.widget&&this.widget.estimatedHeight>-1}}Decoration.none=RangeSet.empty;class MarkDecoration extends Decoration{constructor(spec){let{start:start,end:end}=getInclusive(spec);super(start?-1:5e8,end?1:-6e8,null,spec),this.tagName=spec.tagName||"span",this.class=spec.class||"",this.attrs=spec.attributes||null}eq(other){return this==other||other instanceof MarkDecoration&&this.tagName==other.tagName&&this.class==other.class&&attrsEq(this.attrs,other.attrs)}range(from,to=from){if(from>=to)throw new RangeError("Mark decorations may not be empty");return super.range(from,to)}}MarkDecoration.prototype.point=!1;class LineDecoration extends Decoration{constructor(spec){super(-2e8,-2e8,null,spec)}eq(other){return other instanceof LineDecoration&&attrsEq(this.spec.attributes,other.spec.attributes)}range(from,to=from){if(to!=from)throw new RangeError("Line decoration ranges must be zero-length");return super.range(from,to)}}LineDecoration.prototype.mapMode=MapMode.TrackBefore,LineDecoration.prototype.point=!0;class PointDecoration extends Decoration{constructor(spec,startSide,endSide,block,widget,isReplace){super(startSide,endSide,widget,spec),this.block=block,this.isReplace=isReplace,this.mapMode=block?startSide<=0?MapMode.TrackBefore:MapMode.TrackAfter:MapMode.TrackDel}get type(){return this.startSide<this.endSide?BlockType.WidgetRange:this.startSide<=0?BlockType.WidgetBefore:BlockType.WidgetAfter}get heightRelevant(){return this.block||!!this.widget&&this.widget.estimatedHeight>=5}eq(other){return other instanceof PointDecoration&&(a=this.widget,b=other.widget,a==b||!!(a&&b&&a.compare(b)))&&this.block==other.block&&this.startSide==other.startSide&&this.endSide==other.endSide;var a,b}range(from,to=from){if(this.isReplace&&(from>to||from==to&&this.startSide>0&&this.endSide<=0))throw new RangeError("Invalid range for replacement decoration");if(!this.isReplace&&to!=from)throw new RangeError("Widget decorations can only have zero-length ranges");return super.range(from,to)}}function getInclusive(spec,block=!1){let{inclusiveStart:start,inclusiveEnd:end}=spec;return null==start&&(start=spec.inclusive),null==end&&(end=spec.inclusive),{start:null!=start?start:block,end:null!=end?end:block}}function addRange(from,to,ranges,margin=0){let last=ranges.length-1;last>=0&&ranges[last]+margin>=from?ranges[last]=Math.max(ranges[last],to):ranges.push(from,to)}PointDecoration.prototype.point=!0;class LineView extends ContentView{constructor(){super(...arguments),this.children=[],this.length=0,this.prevAttrs=void 0,this.attrs=null,this.breakAfter=0}merge(from,to,source,hasStart,openStart,openEnd){if(source){if(!(source instanceof LineView))return!1;this.dom||source.transferDOM(this)}return hasStart&&this.setDeco(source?source.attrs:null),mergeChildrenInto(this,from,to,source?source.children:[],openStart,openEnd),!0}split(at){let end=new LineView;if(end.breakAfter=this.breakAfter,0==this.length)return end;let{i:i,off:off}=this.childPos(at);off&&(end.append(this.children[i].split(off),0),this.children[i].merge(off,this.children[i].length,null,!1,0,0),i++);for(let j=i;j<this.children.length;j++)end.append(this.children[j],0);for(;i>0&&0==this.children[i-1].length;)this.children[--i].destroy();return this.children.length=i,this.markDirty(),this.length=at,end}transferDOM(other){this.dom&&(this.markDirty(),other.setDOM(this.dom),other.prevAttrs=void 0===this.prevAttrs?this.attrs:this.prevAttrs,this.prevAttrs=void 0,this.dom=null)}setDeco(attrs){attrsEq(this.attrs,attrs)||(this.dom&&(this.prevAttrs=this.attrs,this.markDirty()),this.attrs=attrs)}append(child,openStart){joinInlineInto(this,child,openStart)}addLineDeco(deco){let attrs=deco.spec.attributes,cls=deco.spec.class;attrs&&(this.attrs=combineAttrs(attrs,this.attrs||{})),cls&&(this.attrs=combineAttrs({class:cls},this.attrs||{}))}domAtPos(pos){return inlineDOMAtPos(this,pos)}reuseDOM(node){"DIV"==node.nodeName&&(this.setDOM(node),this.dirty|=6)}sync(track){var _a;this.dom?4&this.dirty&&(clearAttributes(this.dom),this.dom.className="cm-line",this.prevAttrs=this.attrs?null:void 0):(this.setDOM(document.createElement("div")),this.dom.className="cm-line",this.prevAttrs=this.attrs?null:void 0),void 0!==this.prevAttrs&&(updateAttrs(this.dom,this.prevAttrs,this.attrs),this.dom.classList.add("cm-line"),this.prevAttrs=void 0),super.sync(track);let last=this.dom.lastChild;for(;last&&ContentView.get(last)instanceof MarkView;)last=last.lastChild;if(!(last&&this.length&&("BR"==last.nodeName||0!=(null===(_a=ContentView.get(last))||void 0===_a?void 0:_a.isEditable)||browser.ios&&this.children.some((ch=>ch instanceof TextView))))){let hack=document.createElement("BR");hack.cmIgnore=!0,this.dom.appendChild(hack)}}measureTextSize(){if(0==this.children.length||this.length>20)return null;let totalWidth=0;for(let child of this.children){if(!(child instanceof TextView)||/[^ -~]/.test(child.text))return null;let rects=clientRectsFor(child.dom);if(1!=rects.length)return null;totalWidth+=rects[0].width}return totalWidth?{lineHeight:this.dom.getBoundingClientRect().height,charWidth:totalWidth/this.length}:null}coordsAt(pos,side){return coordsInChildren(this,pos,side)}become(_other){return!1}get type(){return BlockType.Text}static find(docView,pos){for(let i=0,off=0;i<docView.children.length;i++){let block=docView.children[i],end=off+block.length;if(end>=pos){if(block instanceof LineView)return block;if(end>pos)break}off=end+block.breakAfter}return null}}class BlockWidgetView extends ContentView{constructor(widget,length,type){super(),this.widget=widget,this.length=length,this.type=type,this.breakAfter=0,this.prevWidget=null}merge(from,to,source,_takeDeco,openStart,openEnd){return!(source&&(!(source instanceof BlockWidgetView&&this.widget.compare(source.widget))||from>0&&openStart<=0||to<this.length&&openEnd<=0))&&(this.length=from+(source?source.length:0)+(this.length-to),!0)}domAtPos(pos){return 0==pos?DOMPos.before(this.dom):DOMPos.after(this.dom,pos==this.length)}split(at){let len=this.length-at;this.length=at;let end=new BlockWidgetView(this.widget,len,this.type);return end.breakAfter=this.breakAfter,end}get children(){return noChildren}sync(){this.dom&&this.widget.updateDOM(this.dom)||(this.dom&&this.prevWidget&&this.prevWidget.destroy(this.dom),this.prevWidget=null,this.setDOM(this.widget.toDOM(this.editorView)),this.dom.contentEditable="false")}get overrideDOMText(){return this.parent?this.parent.view.state.doc.slice(this.posAtStart,this.posAtEnd):Text.empty}domBoundsAround(){return null}become(other){return other instanceof BlockWidgetView&&other.type==this.type&&other.widget.constructor==this.widget.constructor&&(other.widget.eq(this.widget)||this.markDirty(!0),this.dom&&!this.prevWidget&&(this.prevWidget=this.widget),this.widget=other.widget,this.length=other.length,this.breakAfter=other.breakAfter,!0)}ignoreMutation(){return!0}ignoreEvent(event){return this.widget.ignoreEvent(event)}destroy(){super.destroy(),this.dom&&this.widget.destroy(this.dom)}}class ContentBuilder{constructor(doc,pos,end,disallowBlockEffectsFor){this.doc=doc,this.pos=pos,this.end=end,this.disallowBlockEffectsFor=disallowBlockEffectsFor,this.content=[],this.curLine=null,this.breakAtStart=0,this.pendingBuffer=0,this.bufferMarks=[],this.atCursorPos=!0,this.openStart=-1,this.openEnd=-1,this.text="",this.textOff=0,this.cursor=doc.iter(),this.skip=pos}posCovered(){if(0==this.content.length)return!this.breakAtStart&&this.doc.lineAt(this.pos).from!=this.pos;let last=this.content[this.content.length-1];return!(last.breakAfter||last instanceof BlockWidgetView&&last.type==BlockType.WidgetBefore)}getLine(){return this.curLine||(this.content.push(this.curLine=new LineView),this.atCursorPos=!0),this.curLine}flushBuffer(active=this.bufferMarks){this.pendingBuffer&&(this.curLine.append(wrapMarks(new WidgetBufferView(-1),active),active.length),this.pendingBuffer=0)}addBlockWidget(view){this.flushBuffer(),this.curLine=null,this.content.push(view)}finish(openEnd){this.pendingBuffer&&openEnd<=this.bufferMarks.length?this.flushBuffer():this.pendingBuffer=0,this.posCovered()||this.getLine()}buildText(length,active,openStart){for(;length>0;){if(this.textOff==this.text.length){let{value:value,lineBreak:lineBreak,done:done}=this.cursor.next(this.skip);if(this.skip=0,done)throw new Error("Ran out of text content when drawing inline views");if(lineBreak){this.posCovered()||this.getLine(),this.content.length?this.content[this.content.length-1].breakAfter=1:this.breakAtStart=1,this.flushBuffer(),this.curLine=null,this.atCursorPos=!0,length--;continue}this.text=value,this.textOff=0}let take=Math.min(this.text.length-this.textOff,length,512);this.flushBuffer(active.slice(active.length-openStart)),this.getLine().append(wrapMarks(new TextView(this.text.slice(this.textOff,this.textOff+take)),active),openStart),this.atCursorPos=!0,this.textOff+=take,length-=take,openStart=0}}span(from,to,active,openStart){this.buildText(to-from,active,openStart),this.pos=to,this.openStart<0&&(this.openStart=openStart)}point(from,to,deco,active,openStart,index){if(this.disallowBlockEffectsFor[index]&&deco instanceof PointDecoration){if(deco.block)throw new RangeError("Block decorations may not be specified via plugins");if(to>this.doc.lineAt(this.pos).to)throw new RangeError("Decorations that replace line breaks may not be specified via plugins")}let len=to-from;if(deco instanceof PointDecoration)if(deco.block){let{type:type}=deco;type!=BlockType.WidgetAfter||this.posCovered()||this.getLine(),this.addBlockWidget(new BlockWidgetView(deco.widget||new NullWidget("div"),len,type))}else{let view=WidgetView.create(deco.widget||new NullWidget("span"),len,len?0:deco.startSide),cursorBefore=this.atCursorPos&&!view.isEditable&&openStart<=active.length&&(from<to||deco.startSide>0),cursorAfter=!view.isEditable&&(from<to||openStart>active.length||deco.startSide<=0),line=this.getLine();2!=this.pendingBuffer||cursorBefore||(this.pendingBuffer=0),this.flushBuffer(active),cursorBefore&&(line.append(wrapMarks(new WidgetBufferView(1),active),openStart),openStart=active.length+Math.max(0,openStart-active.length)),line.append(wrapMarks(view,active),openStart),this.atCursorPos=cursorAfter,this.pendingBuffer=cursorAfter?from<to||openStart>active.length?1:2:0,this.pendingBuffer&&(this.bufferMarks=active.slice())}else this.doc.lineAt(this.pos).from==this.pos&&this.getLine().addLineDeco(deco);len&&(this.textOff+len<=this.text.length?this.textOff+=len:(this.skip+=len-(this.text.length-this.textOff),this.text="",this.textOff=0),this.pos=to),this.openStart<0&&(this.openStart=openStart)}static build(text,from,to,decorations,dynamicDecorationMap){let builder=new ContentBuilder(text,from,to,dynamicDecorationMap);return builder.openEnd=RangeSet.spans(decorations,from,to,builder),builder.openStart<0&&(builder.openStart=builder.openEnd),builder.finish(builder.openEnd),builder}}function wrapMarks(view,active){for(let mark of active)view=new MarkView(mark,[view],view.length);return view}class NullWidget extends WidgetType{constructor(tag){super(),this.tag=tag}eq(other){return other.tag==this.tag}toDOM(){return document.createElement(this.tag)}updateDOM(elt){return elt.nodeName.toLowerCase()==this.tag}}const clickAddsSelectionRange=Facet.define(),dragMovesSelection$1=Facet.define(),mouseSelectionStyle=Facet.define(),exceptionSink=Facet.define(),updateListener=Facet.define(),inputHandler$1=Facet.define(),perLineTextDirection=Facet.define({combine:values=>values.some((x=>x))}),nativeSelectionHidden=Facet.define({combine:values=>values.some((x=>x))});class ScrollTarget{constructor(range,y="nearest",x="nearest",yMargin=5,xMargin=5){this.range=range,this.y=y,this.x=x,this.yMargin=yMargin,this.xMargin=xMargin}map(changes){return changes.empty?this:new ScrollTarget(this.range.map(changes),this.y,this.x,this.yMargin,this.xMargin)}}const scrollIntoView=StateEffect.define({map:(t,ch)=>t.map(ch)});function logException(state,exception,context){let handler=state.facet(exceptionSink);handler.length?handler[0](exception):window.onerror?window.onerror(String(exception),context,void 0,void 0,exception):context?console.error(context+":",exception):console.error(exception)}const editable=Facet.define({combine:values=>!values.length||values[0]});let nextPluginID=0;const viewPlugin=Facet.define();class ViewPlugin{constructor(id,create,domEventHandlers,buildExtensions){this.id=id,this.create=create,this.domEventHandlers=domEventHandlers,this.extension=buildExtensions(this)}static define(create,spec){const{eventHandlers:eventHandlers,provide:provide,decorations:deco}=spec||{};return new ViewPlugin(nextPluginID++,create,eventHandlers,(plugin=>{let ext=[viewPlugin.of(plugin)];return deco&&ext.push(decorations.of((view=>{let pluginInst=view.plugin(plugin);return pluginInst?deco(pluginInst):Decoration.none}))),provide&&ext.push(provide(plugin)),ext}))}static fromClass(cls,spec){return ViewPlugin.define((view=>new cls(view)),spec)}}class PluginInstance{constructor(spec){this.spec=spec,this.mustUpdate=null,this.value=null}update(view){if(this.value){if(this.mustUpdate){let update=this.mustUpdate;if(this.mustUpdate=null,this.value.update)try{this.value.update(update)}catch(e){if(logException(update.state,e,"CodeMirror plugin crashed"),this.value.destroy)try{this.value.destroy()}catch(_){}this.deactivate()}}}else if(this.spec)try{this.value=this.spec.create(view)}catch(e){logException(view.state,e,"CodeMirror plugin crashed"),this.deactivate()}return this}destroy(view){var _a;if(null===(_a=this.value)||void 0===_a?void 0:_a.destroy)try{this.value.destroy()}catch(e){logException(view.state,e,"CodeMirror plugin crashed")}}deactivate(){this.spec=this.value=null}}const editorAttributes=Facet.define(),contentAttributes=Facet.define(),decorations=Facet.define(),atomicRanges=Facet.define(),scrollMargins=Facet.define(),styleModule=Facet.define();class ChangedRange{constructor(fromA,toA,fromB,toB){this.fromA=fromA,this.toA=toA,this.fromB=fromB,this.toB=toB}join(other){return new ChangedRange(Math.min(this.fromA,other.fromA),Math.max(this.toA,other.toA),Math.min(this.fromB,other.fromB),Math.max(this.toB,other.toB))}addToSet(set){let i=set.length,me=this;for(;i>0;i--){let range=set[i-1];if(!(range.fromA>me.toA)){if(range.toA<me.fromA)break;me=me.join(range),set.splice(i-1,1)}}return set.splice(i,0,me),set}static extendWithRanges(diff,ranges){if(0==ranges.length)return diff;let result=[];for(let dI=0,rI=0,posA=0,posB=0;;dI++){let next=dI==diff.length?null:diff[dI],off=posA-posB,end=next?next.fromB:1e9;for(;rI<ranges.length&&ranges[rI]<end;){let from=ranges[rI],to=ranges[rI+1],fromB=Math.max(posB,from),toB=Math.min(end,to);if(fromB<=toB&&new ChangedRange(fromB+off,toB+off,fromB,toB).addToSet(result),to>end)break;rI+=2}if(!next)return result;new ChangedRange(next.fromA,next.toA,next.fromB,next.toB).addToSet(result),posA=next.toA,posB=next.toB}}}class ViewUpdate{constructor(view,state,transactions){this.view=view,this.state=state,this.transactions=transactions,this.flags=0,this.startState=view.state,this.changes=ChangeSet.empty(this.startState.doc.length);for(let tr of transactions)this.changes=this.changes.compose(tr.changes);let changedRanges=[];this.changes.iterChangedRanges(((fromA,toA,fromB,toB)=>changedRanges.push(new ChangedRange(fromA,toA,fromB,toB)))),this.changedRanges=changedRanges;let focus=view.hasFocus;focus!=view.inputState.notifiedFocused&&(view.inputState.notifiedFocused=focus,this.flags|=1)}static create(view,state,transactions){return new ViewUpdate(view,state,transactions)}get viewportChanged(){return(4&this.flags)>0}get heightChanged(){return(2&this.flags)>0}get geometryChanged(){return this.docChanged||(10&this.flags)>0}get focusChanged(){return(1&this.flags)>0}get docChanged(){return!this.changes.empty}get selectionSet(){return this.transactions.some((tr=>tr.selection))}get empty(){return 0==this.flags&&0==this.transactions.length}}var Direction=function(Direction){return Direction[Direction.LTR=0]="LTR",Direction[Direction.RTL=1]="RTL",Direction}(Direction||(Direction={}));const LTR=Direction.LTR,RTL=Direction.RTL;function dec(str){let result=[];for(let i=0;i<str.length;i++)result.push(1<<+str[i]);return result}const LowTypes=dec("88888888888888888888888888888888888666888888787833333333337888888000000000000000000000000008888880000000000000000000000000088888888888888888888888888888888888887866668888088888663380888308888800000000000000000000000800000000000000000000000000000008"),ArabicTypes=dec("4444448826627288999999999992222222222222222222222222222222222222222222222229999999999999999999994444444444644222822222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222999999949999999229989999223333333333"),Brackets=Object.create(null),BracketStack=[];for(let p of["()","[]","{}"]){let l=p.charCodeAt(0),r=p.charCodeAt(1);Brackets[l]=r,Brackets[r]=-l}const BidiRE=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac\ufb50-\ufdff]/;class BidiSpan{constructor(from,to,level){this.from=from,this.to=to,this.level=level}get dir(){return this.level%2?RTL:LTR}side(end,dir){return this.dir==dir==end?this.to:this.from}static find(order,index,level,assoc){let maybe=-1;for(let i=0;i<order.length;i++){let span=order[i];if(span.from<=index&&span.to>=index){if(span.level==level)return i;(maybe<0||(0!=assoc?assoc<0?span.from<index:span.to>index:order[maybe].level>span.level))&&(maybe=i)}}if(maybe<0)throw new RangeError("Index out of range");return maybe}}const types=[];function trivialOrder(length){return[new BidiSpan(0,length,0)]}let movedOver="";function moveVisually(line,order,dir,start,forward){var _a;let startIndex=start.head-line.from,spanI=-1;if(0==startIndex){if(!forward||!line.length)return null;order[0].level!=dir&&(startIndex=order[0].side(!1,dir),spanI=0)}else if(startIndex==line.length){if(forward)return null;let last=order[order.length-1];last.level!=dir&&(startIndex=last.side(!0,dir),spanI=order.length-1)}spanI<0&&(spanI=BidiSpan.find(order,startIndex,null!==(_a=start.bidiLevel)&&void 0!==_a?_a:-1,start.assoc));let span=order[spanI];startIndex==span.side(forward,dir)&&(span=order[spanI+=forward?1:-1],startIndex=span.side(!forward,dir));let indexForward=forward==(span.dir==dir),nextIndex=findClusterBreak(line.text,startIndex,indexForward);if(movedOver=line.text.slice(Math.min(startIndex,nextIndex),Math.max(startIndex,nextIndex)),nextIndex!=span.side(forward,dir))return EditorSelection.cursor(nextIndex+line.from,indexForward?-1:1,span.level);let nextSpan=spanI==(forward?order.length-1:0)?null:order[spanI+(forward?1:-1)];return nextSpan||span.level==dir?nextSpan&&nextSpan.level<span.level?EditorSelection.cursor(nextSpan.side(!forward,dir)+line.from,forward?1:-1,nextSpan.level):EditorSelection.cursor(nextIndex+line.from,forward?-1:1,span.level):EditorSelection.cursor(forward?line.to:line.from,forward?-1:1,dir)}class DOMReader{constructor(points,state){this.points=points,this.text="",this.lineSeparator=state.facet(EditorState.lineSeparator)}append(text){this.text+=text}lineBreak(){this.text+="￿"}readRange(start,end){if(!start)return this;let parent=start.parentNode;for(let cur=start;;){this.findPointBefore(parent,cur),this.readNode(cur);let next=cur.nextSibling;if(next==end)break;let view=ContentView.get(cur),nextView=ContentView.get(next);(view&&nextView?view.breakAfter:(view?view.breakAfter:isBlockElement(cur))||isBlockElement(next)&&("BR"!=cur.nodeName||cur.cmIgnore))&&this.lineBreak(),cur=next}return this.findPointBefore(parent,end),this}readTextNode(node){let text=node.nodeValue;for(let point of this.points)point.node==node&&(point.pos=this.text.length+Math.min(point.offset,text.length));for(let off=0,re=this.lineSeparator?null:/\r\n?|\n/g;;){let m,nextBreak=-1,breakSize=1;if(this.lineSeparator?(nextBreak=text.indexOf(this.lineSeparator,off),breakSize=this.lineSeparator.length):(m=re.exec(text))&&(nextBreak=m.index,breakSize=m[0].length),this.append(text.slice(off,nextBreak<0?text.length:nextBreak)),nextBreak<0)break;if(this.lineBreak(),breakSize>1)for(let point of this.points)point.node==node&&point.pos>this.text.length&&(point.pos-=breakSize-1);off=nextBreak+breakSize}}readNode(node){if(node.cmIgnore)return;let view=ContentView.get(node),fromView=view&&view.overrideDOMText;if(null!=fromView){this.findPointInside(node,fromView.length);for(let i=fromView.iter();!i.next().done;)i.lineBreak?this.lineBreak():this.append(i.value)}else 3==node.nodeType?this.readTextNode(node):"BR"==node.nodeName?node.nextSibling&&this.lineBreak():1==node.nodeType&&this.readRange(node.firstChild,null)}findPointBefore(node,next){for(let point of this.points)point.node==node&&node.childNodes[point.offset]==next&&(point.pos=this.text.length)}findPointInside(node,maxLen){for(let point of this.points)(3==node.nodeType?point.node==node:node.contains(point.node))&&(point.pos=this.text.length+Math.min(maxLen,point.offset))}}function isBlockElement(node){return 1==node.nodeType&&/^(DIV|P|LI|UL|OL|BLOCKQUOTE|DD|DT|H\d|SECTION|PRE)$/.test(node.nodeName)}class DOMPoint{constructor(node,offset){this.node=node,this.offset=offset,this.pos=-1}}class DocView extends ContentView{constructor(view){super(),this.view=view,this.compositionDeco=Decoration.none,this.decorations=[],this.dynamicDecorationMap=[],this.minWidth=0,this.minWidthFrom=0,this.minWidthTo=0,this.impreciseAnchor=null,this.impreciseHead=null,this.forceSelection=!1,this.lastUpdate=Date.now(),this.setDOM(view.contentDOM),this.children=[new LineView],this.children[0].setParent(this),this.updateDeco(),this.updateInner([new ChangedRange(0,0,0,view.state.doc.length)],0)}get editorView(){return this.view}get length(){return this.view.state.doc.length}update(update){let changedRanges=update.changedRanges;this.minWidth>0&&changedRanges.length&&(changedRanges.every((({fromA:fromA,toA:toA})=>toA<this.minWidthFrom||fromA>this.minWidthTo))?(this.minWidthFrom=update.changes.mapPos(this.minWidthFrom,1),this.minWidthTo=update.changes.mapPos(this.minWidthTo,1)):this.minWidth=this.minWidthFrom=this.minWidthTo=0),this.view.inputState.composing<0?this.compositionDeco=Decoration.none:(update.transactions.length||this.dirty)&&(this.compositionDeco=function(view,changes){let surrounding=compositionSurroundingNode(view);if(!surrounding)return Decoration.none;let{from:from,to:to,node:node,text:textNode}=surrounding,newFrom=changes.mapPos(from,1),newTo=Math.max(newFrom,changes.mapPos(to,-1)),{state:state}=view,text=3==node.nodeType?node.nodeValue:new DOMReader([],state).readRange(node.firstChild,null).text;if(newTo-newFrom<text.length)if(state.doc.sliceString(newFrom,Math.min(state.doc.length,newFrom+text.length),"￿")==text)newTo=newFrom+text.length;else{if(state.doc.sliceString(Math.max(0,newTo-text.length),newTo,"￿")!=text)return Decoration.none;newFrom=newTo-text.length}else if(state.doc.sliceString(newFrom,newTo,"￿")!=text)return Decoration.none;let topView=ContentView.get(node);topView instanceof CompositionView?topView=topView.widget.topView:topView&&(topView.parent=null);return Decoration.set(Decoration.replace({widget:new CompositionWidget(node,textNode,topView),inclusive:!0}).range(newFrom,newTo))}(this.view,update.changes)),(browser.ie||browser.chrome)&&!this.compositionDeco.size&&update&&update.state.doc.lines!=update.startState.doc.lines&&(this.forceSelection=!0);let decoDiff=function(a,b,diff){let comp=new DecorationComparator$1;return RangeSet.compare(a,b,diff,comp),comp.changes}(this.decorations,this.updateDeco(),update.changes);return changedRanges=ChangedRange.extendWithRanges(changedRanges,decoDiff),(0!=this.dirty||0!=changedRanges.length)&&(this.updateInner(changedRanges,update.startState.doc.length),update.transactions.length&&(this.lastUpdate=Date.now()),!0)}updateInner(changes,oldLength){this.view.viewState.mustMeasureContent=!0,this.updateChildren(changes,oldLength);let{observer:observer}=this.view;observer.ignore((()=>{this.dom.style.height=this.view.viewState.contentHeight+"px",this.dom.style.flexBasis=this.minWidth?this.minWidth+"px":"";let track=browser.chrome||browser.ios?{node:observer.selectionRange.focusNode,written:!1}:void 0;this.sync(track),this.dirty=0,track&&(track.written||observer.selectionRange.focusNode!=track.node)&&(this.forceSelection=!0),this.dom.style.height=""}));let gaps=[];if(this.view.viewport.from||this.view.viewport.to<this.view.state.doc.length)for(let child of this.children)child instanceof BlockWidgetView&&child.widget instanceof BlockGapWidget&&gaps.push(child.dom);observer.updateGaps(gaps)}updateChildren(changes,oldLength){let cursor=this.childCursor(oldLength);for(let i=changes.length-1;;i--){let next=i>=0?changes[i]:null;if(!next)break;let{fromA:fromA,toA:toA,fromB:fromB,toB:toB}=next,{content:content,breakAtStart:breakAtStart,openStart:openStart,openEnd:openEnd}=ContentBuilder.build(this.view.state.doc,fromB,toB,this.decorations,this.dynamicDecorationMap),{i:toI,off:toOff}=cursor.findPos(toA,1),{i:fromI,off:fromOff}=cursor.findPos(fromA,-1);replaceRange(this,fromI,fromOff,toI,toOff,content,breakAtStart,openStart,openEnd)}}updateSelection(mustRead=!1,fromPointer=!1){if(!mustRead&&this.view.observer.selectionRange.focusNode||this.view.observer.readSelectionRange(),!fromPointer&&!this.mayControlSelection())return;let force=this.forceSelection;this.forceSelection=!1;let main=this.view.state.selection.main,anchor=this.domAtPos(main.anchor),head=main.empty?anchor:this.domAtPos(main.head);if(browser.gecko&&main.empty&&(1==(pos=anchor).node.nodeType&&pos.node.firstChild&&(0==pos.offset||"false"==pos.node.childNodes[pos.offset-1].contentEditable)&&(pos.offset==pos.node.childNodes.length||"false"==pos.node.childNodes[pos.offset].contentEditable))){let dummy=document.createTextNode("");this.view.observer.ignore((()=>anchor.node.insertBefore(dummy,anchor.node.childNodes[anchor.offset]||null))),anchor=head=new DOMPos(dummy,0),force=!0}var pos;let domSel=this.view.observer.selectionRange;!force&&domSel.focusNode&&isEquivalentPosition(anchor.node,anchor.offset,domSel.anchorNode,domSel.anchorOffset)&&isEquivalentPosition(head.node,head.offset,domSel.focusNode,domSel.focusOffset)||(this.view.observer.ignore((()=>{browser.android&&browser.chrome&&this.dom.contains(domSel.focusNode)&&function(node,inside){for(let cur=node;cur&&cur!=inside;cur=cur.assignedSlot||cur.parentNode)if(1==cur.nodeType&&"false"==cur.contentEditable)return!0;return!1}(domSel.focusNode,this.dom)&&(this.dom.blur(),this.dom.focus({preventScroll:!0}));let rawSel=getSelection(this.view.root);if(rawSel)if(main.empty){if(browser.gecko){let nextTo=(node=anchor.node,offset=anchor.offset,1!=node.nodeType?0:(offset&&"false"==node.childNodes[offset-1].contentEditable?1:0)|(offset<node.childNodes.length&&"false"==node.childNodes[offset].contentEditable?2:0));if(nextTo&&3!=nextTo){let text=nearbyTextNode(anchor.node,anchor.offset,1==nextTo?1:-1);text&&(anchor=new DOMPos(text,1==nextTo?0:text.nodeValue.length))}}rawSel.collapse(anchor.node,anchor.offset),null!=main.bidiLevel&&null!=domSel.cursorBidiLevel&&(domSel.cursorBidiLevel=main.bidiLevel)}else if(rawSel.extend){rawSel.collapse(anchor.node,anchor.offset);try{rawSel.extend(head.node,head.offset)}catch(_){}}else{let range=document.createRange();main.anchor>main.head&&([anchor,head]=[head,anchor]),range.setEnd(head.node,head.offset),range.setStart(anchor.node,anchor.offset),rawSel.removeAllRanges(),rawSel.addRange(range)}else;var node,offset})),this.view.observer.setSelectionRange(anchor,head)),this.impreciseAnchor=anchor.precise?null:new DOMPos(domSel.anchorNode,domSel.anchorOffset),this.impreciseHead=head.precise?null:new DOMPos(domSel.focusNode,domSel.focusOffset)}enforceCursorAssoc(){if(this.compositionDeco.size)return;let{view:view}=this,cursor=view.state.selection.main,sel=getSelection(view.root),{anchorNode:anchorNode,anchorOffset:anchorOffset}=view.observer.selectionRange;if(!(sel&&cursor.empty&&cursor.assoc&&sel.modify))return;let line=LineView.find(this,cursor.head);if(!line)return;let lineStart=line.posAtStart;if(cursor.head==lineStart||cursor.head==lineStart+line.length)return;let before=this.coordsAt(cursor.head,-1),after=this.coordsAt(cursor.head,1);if(!before||!after||before.bottom>after.top)return;let dom=this.domAtPos(cursor.head+cursor.assoc);sel.collapse(dom.node,dom.offset),sel.modify("move",cursor.assoc<0?"forward":"backward","lineboundary"),view.observer.readSelectionRange();let newRange=view.observer.selectionRange;view.docView.posFromDOM(newRange.anchorNode,newRange.anchorOffset)!=cursor.from&&sel.collapse(anchorNode,anchorOffset)}mayControlSelection(){let active=this.view.root.activeElement;return active==this.dom||hasSelection(this.dom,this.view.observer.selectionRange)&&!(active&&this.dom.contains(active))}nearest(dom){for(let cur=dom;cur;){let domView=ContentView.get(cur);if(domView&&domView.rootView==this)return domView;cur=cur.parentNode}return null}posFromDOM(node,offset){let view=this.nearest(node);if(!view)throw new RangeError("Trying to find position for a DOM position outside of the document");return view.localPosFromDOM(node,offset)+view.posAtStart}domAtPos(pos){let{i:i,off:off}=this.childCursor().findPos(pos,-1);for(;i<this.children.length-1;){let child=this.children[i];if(off<child.length||child instanceof LineView)break;i++,off=0}return this.children[i].domAtPos(off)}coordsAt(pos,side){for(let off=this.length,i=this.children.length-1;;i--){let child=this.children[i],start=off-child.breakAfter-child.length;if(pos>start||pos==start&&child.type!=BlockType.WidgetBefore&&child.type!=BlockType.WidgetAfter&&(!i||2==side||this.children[i-1].breakAfter||this.children[i-1].type==BlockType.WidgetBefore&&side>-2))return child.coordsAt(pos-start,side);off=start}}measureVisibleLineHeights(viewport){let result=[],{from:from,to:to}=viewport,contentWidth=this.view.contentDOM.clientWidth,isWider=contentWidth>Math.max(this.view.scrollDOM.clientWidth,this.minWidth)+1,widest=-1,ltr=this.view.textDirection==Direction.LTR;for(let pos=0,i=0;i<this.children.length;i++){let child=this.children[i],end=pos+child.length;if(end>to)break;if(pos>=from){let childRect=child.dom.getBoundingClientRect();if(result.push(childRect.height),isWider){let last=child.dom.lastChild,rects=last?clientRectsFor(last):[];if(rects.length){let rect=rects[rects.length-1],width=ltr?rect.right-childRect.left:childRect.right-rect.left;width>widest&&(widest=width,this.minWidth=contentWidth,this.minWidthFrom=pos,this.minWidthTo=end)}}}pos=end+child.breakAfter}return result}textDirectionAt(pos){let{i:i}=this.childPos(pos,1);return"rtl"==getComputedStyle(this.children[i].dom).direction?Direction.RTL:Direction.LTR}measureTextSize(){for(let child of this.children)if(child instanceof LineView){let measure=child.measureTextSize();if(measure)return measure}let lineHeight,charWidth,dummy=document.createElement("div");return dummy.className="cm-line",dummy.style.width="99999px",dummy.textContent="abc def ghi jkl mno pqr stu",this.view.observer.ignore((()=>{this.dom.appendChild(dummy);let rect=clientRectsFor(dummy.firstChild)[0];lineHeight=dummy.getBoundingClientRect().height,charWidth=rect?rect.width/27:7,dummy.remove()})),{lineHeight:lineHeight,charWidth:charWidth}}childCursor(pos=this.length){let i=this.children.length;return i&&(pos-=this.children[--i].length),new ChildCursor(this.children,pos,i)}computeBlockGapDeco(){let deco=[],vs=this.view.viewState;for(let pos=0,i=0;;i++){let next=i==vs.viewports.length?null:vs.viewports[i],end=next?next.from-1:this.length;if(end>pos){let height=vs.lineBlockAt(end).bottom-vs.lineBlockAt(pos).top;deco.push(Decoration.replace({widget:new BlockGapWidget(height),block:!0,inclusive:!0,isBlockGap:!0}).range(pos,end))}if(!next)break;pos=next.to+1}return Decoration.set(deco)}updateDeco(){let allDeco=this.view.state.facet(decorations).map(((d,i)=>(this.dynamicDecorationMap[i]="function"==typeof d)?d(this.view):d));for(let i=allDeco.length;i<allDeco.length+3;i++)this.dynamicDecorationMap[i]=!1;return this.decorations=[...allDeco,this.compositionDeco,this.computeBlockGapDeco(),this.view.viewState.lineGapDeco]}scrollIntoView(target){let other,{range:range}=target,rect=this.coordsAt(range.head,range.empty?range.assoc:range.head>range.anchor?-1:1);if(!rect)return;!range.empty&&(other=this.coordsAt(range.anchor,range.anchor>range.head?-1:1))&&(rect={left:Math.min(rect.left,other.left),top:Math.min(rect.top,other.top),right:Math.max(rect.right,other.right),bottom:Math.max(rect.bottom,other.bottom)});let mLeft=0,mRight=0,mTop=0,mBottom=0;for(let margins of this.view.state.facet(scrollMargins).map((f=>f(this.view))))if(margins){let{left:left,right:right,top:top,bottom:bottom}=margins;null!=left&&(mLeft=Math.max(mLeft,left)),null!=right&&(mRight=Math.max(mRight,right)),null!=top&&(mTop=Math.max(mTop,top)),null!=bottom&&(mBottom=Math.max(mBottom,bottom))}let targetRect={left:rect.left-mLeft,top:rect.top-mTop,right:rect.right+mRight,bottom:rect.bottom+mBottom};!function(dom,rect,side,x,y,xMargin,yMargin,ltr){let doc=dom.ownerDocument,win=doc.defaultView||window;for(let cur=dom;cur;)if(1==cur.nodeType){let bounding,top=cur==doc.body;if(top)bounding=windowRect(win);else{if(cur.scrollHeight<=cur.clientHeight&&cur.scrollWidth<=cur.clientWidth){cur=cur.assignedSlot||cur.parentNode;continue}let rect=cur.getBoundingClientRect();bounding={left:rect.left,right:rect.left+cur.clientWidth,top:rect.top,bottom:rect.top+cur.clientHeight}}let moveX=0,moveY=0;if("nearest"==y)rect.top<bounding.top?(moveY=-(bounding.top-rect.top+yMargin),side>0&&rect.bottom>bounding.bottom+moveY&&(moveY=rect.bottom-bounding.bottom+moveY+yMargin)):rect.bottom>bounding.bottom&&(moveY=rect.bottom-bounding.bottom+yMargin,side<0&&rect.top-moveY<bounding.top&&(moveY=-(bounding.top+moveY-rect.top+yMargin)));else{let rectHeight=rect.bottom-rect.top,boundingHeight=bounding.bottom-bounding.top;moveY=("center"==y&&rectHeight<=boundingHeight?rect.top+rectHeight/2-boundingHeight/2:"start"==y||"center"==y&&side<0?rect.top-yMargin:rect.bottom-boundingHeight+yMargin)-bounding.top}if("nearest"==x?rect.left<bounding.left?(moveX=-(bounding.left-rect.left+xMargin),side>0&&rect.right>bounding.right+moveX&&(moveX=rect.right-bounding.right+moveX+xMargin)):rect.right>bounding.right&&(moveX=rect.right-bounding.right+xMargin,side<0&&rect.left<bounding.left+moveX&&(moveX=-(bounding.left+moveX-rect.left+xMargin))):moveX=("center"==x?rect.left+(rect.right-rect.left)/2-(bounding.right-bounding.left)/2:"start"==x==ltr?rect.left-xMargin:rect.right-(bounding.right-bounding.left)+xMargin)-bounding.left,moveX||moveY)if(top)win.scrollBy(moveX,moveY);else{let movedX=0,movedY=0;if(moveY){let start=cur.scrollTop;cur.scrollTop+=moveY,movedY=cur.scrollTop-start}if(moveX){let start=cur.scrollLeft;cur.scrollLeft+=moveX,movedX=cur.scrollLeft-start}rect={left:rect.left-movedX,top:rect.top-movedY,right:rect.right-movedX,bottom:rect.bottom-movedY},movedX&&Math.abs(movedX-moveX)<1&&(x="nearest"),movedY&&Math.abs(movedY-moveY)<1&&(y="nearest")}if(top)break;cur=cur.assignedSlot||cur.parentNode}else{if(11!=cur.nodeType)break;cur=cur.host}}(this.view.scrollDOM,targetRect,range.head<range.anchor?-1:1,target.x,target.y,target.xMargin,target.yMargin,this.view.textDirection==Direction.LTR)}}class BlockGapWidget extends WidgetType{constructor(height){super(),this.height=height}toDOM(){let elt=document.createElement("div");return this.updateDOM(elt),elt}eq(other){return other.height==this.height}updateDOM(elt){return elt.style.height=this.height+"px",!0}get estimatedHeight(){return this.height}}function compositionSurroundingNode(view){let sel=view.observer.selectionRange,textNode=sel.focusNode&&nearbyTextNode(sel.focusNode,sel.focusOffset,0);if(!textNode)return null;let cView=view.docView.nearest(textNode);if(!cView)return null;if(cView instanceof LineView){let topNode=textNode;for(;topNode.parentNode!=cView.dom;)topNode=topNode.parentNode;let prev=topNode.previousSibling;for(;prev&&!ContentView.get(prev);)prev=prev.previousSibling;let pos=prev?ContentView.get(prev).posAtEnd:cView.posAtStart;return{from:pos,to:pos,node:topNode,text:textNode}}{for(;;){let{parent:parent}=cView;if(!parent)return null;if(parent instanceof LineView)break;cView=parent}let from=cView.posAtStart;return{from:from,to:from+cView.length,node:cView.dom,text:textNode}}}class CompositionWidget extends WidgetType{constructor(top,text,topView){super(),this.top=top,this.text=text,this.topView=topView}eq(other){return this.top==other.top&&this.text==other.text}toDOM(){return this.top}ignoreEvent(){return!1}get customView(){return CompositionView}}function nearbyTextNode(node,offset,side){for(;;){if(3==node.nodeType)return node;if(1==node.nodeType&&offset>0&&side<=0)offset=maxOffset(node=node.childNodes[offset-1]);else{if(!(1==node.nodeType&&offset<node.childNodes.length&&side>=0))return null;node=node.childNodes[offset],offset=0}}}class DecorationComparator$1{constructor(){this.changes=[]}compareRange(from,to){addRange(from,to,this.changes)}comparePoint(from,to){addRange(from,to,this.changes)}}function getdx(x,rect){return rect.left>x?rect.left-x:Math.max(0,x-rect.right)}function getdy(y,rect){return rect.top>y?rect.top-y:Math.max(0,y-rect.bottom)}function yOverlap(a,b){return a.top<b.bottom-1&&a.bottom>b.top+1}function upTop(rect,top){return top<rect.top?{top:top,left:rect.left,right:rect.right,bottom:rect.bottom}:rect}function upBot(rect,bottom){return bottom>rect.bottom?{top:rect.top,left:rect.left,right:rect.right,bottom:bottom}:rect}function domPosAtCoords(parent,x,y){let closest,closestRect,closestX,closestY,above,below,aboveRect,belowRect,closestOverlap=!1;for(let child=parent.firstChild;child;child=child.nextSibling){let rects=clientRectsFor(child);for(let i=0;i<rects.length;i++){let rect=rects[i];closestRect&&yOverlap(closestRect,rect)&&(rect=upTop(upBot(rect,closestRect.bottom),closestRect.top));let dx=getdx(x,rect),dy=getdy(y,rect);if(0==dx&&0==dy)return 3==child.nodeType?domPosInText(child,x,y):domPosAtCoords(child,x,y);(!closest||closestY>dy||closestY==dy&&closestX>dx)&&(closest=child,closestRect=rect,closestX=dx,closestY=dy,closestOverlap=!dx||(dx>0?i<rects.length-1:i>0)),0==dx?y>rect.bottom&&(!aboveRect||aboveRect.bottom<rect.bottom)?(above=child,aboveRect=rect):y<rect.top&&(!belowRect||belowRect.top>rect.top)&&(below=child,belowRect=rect):aboveRect&&yOverlap(aboveRect,rect)?aboveRect=upBot(aboveRect,rect.bottom):belowRect&&yOverlap(belowRect,rect)&&(belowRect=upTop(belowRect,rect.top))}}if(aboveRect&&aboveRect.bottom>=y?(closest=above,closestRect=aboveRect):belowRect&&belowRect.top<=y&&(closest=below,closestRect=belowRect),!closest)return{node:parent,offset:0};let clipX=Math.max(closestRect.left,Math.min(closestRect.right,x));return 3==closest.nodeType?domPosInText(closest,clipX,y):closestOverlap&&"false"!=closest.contentEditable?domPosAtCoords(closest,clipX,y):{node:parent,offset:Array.prototype.indexOf.call(parent.childNodes,closest)+(x>=(closestRect.left+closestRect.right)/2?1:0)}}function domPosInText(node,x,y){let len=node.nodeValue.length,closestOffset=-1,closestDY=1e9,generalSide=0;for(let i=0;i<len;i++){let rects=textRange(node,i,i+1).getClientRects();for(let j=0;j<rects.length;j++){let rect=rects[j];if(rect.top==rect.bottom)continue;generalSide||(generalSide=x-rect.left);let dy=(rect.top>y?rect.top-y:y-rect.bottom)-1;if(rect.left-1<=x&&rect.right+1>=x&&dy<closestDY){let right=x>=(rect.left+rect.right)/2,after=right;if(browser.chrome||browser.gecko){textRange(node,i).getBoundingClientRect().left==rect.right&&(after=!right)}if(dy<=0)return{node:node,offset:i+(after?1:0)};closestOffset=i+(after?1:0),closestDY=dy}}}return{node:node,offset:closestOffset>-1?closestOffset:generalSide>0?node.nodeValue.length:0}}function posAtCoords(view,{x:x,y:y},precise,bias=-1){var _a;let block,content=view.contentDOM.getBoundingClientRect(),docTop=content.top+view.viewState.paddingTop,{docHeight:docHeight}=view.viewState,yOffset=y-docTop;if(yOffset<0)return 0;if(yOffset>docHeight)return view.state.doc.length;for(let halfLine=view.defaultLineHeight/2,bounced=!1;block=view.elementAtHeight(yOffset),block.type!=BlockType.Text;)for(;yOffset=bias>0?block.bottom+halfLine:block.top-halfLine,!(yOffset>=0&&yOffset<=docHeight);){if(bounced)return precise?null:0;bounced=!0,bias=-bias}y=docTop+yOffset;let lineStart=block.from;if(lineStart<view.viewport.from)return 0==view.viewport.from?0:precise?null:posAtCoordsImprecise(view,content,block,x,y);if(lineStart>view.viewport.to)return view.viewport.to==view.state.doc.length?view.state.doc.length:precise?null:posAtCoordsImprecise(view,content,block,x,y);let doc=view.dom.ownerDocument,root=view.root.elementFromPoint?view.root:doc,element=root.elementFromPoint(x,y);element&&!view.contentDOM.contains(element)&&(element=null),element||(x=Math.max(content.left+1,Math.min(content.right-1,x)),element=root.elementFromPoint(x,y),element&&!view.contentDOM.contains(element)&&(element=null));let node,offset=-1;if(element&&0!=(null===(_a=view.docView.nearest(element))||void 0===_a?void 0:_a.isEditable))if(doc.caretPositionFromPoint){let pos=doc.caretPositionFromPoint(x,y);pos&&({offsetNode:node,offset:offset}=pos)}else if(doc.caretRangeFromPoint){let range=doc.caretRangeFromPoint(x,y);range&&(({startContainer:node,startOffset:offset}=range),(!view.contentDOM.contains(node)||browser.safari&&function(node,offset,x){let len;if(3!=node.nodeType||offset!=(len=node.nodeValue.length))return!1;for(let next=node.nextSibling;next;next=next.nextSibling)if(1!=next.nodeType||"BR"!=next.nodeName)return!1;return textRange(node,len-1,len).getBoundingClientRect().left>x}(node,offset,x)||browser.chrome&&function(node,offset,x){if(0!=offset)return!1;for(let cur=node;;){let parent=cur.parentNode;if(!parent||1!=parent.nodeType||parent.firstChild!=cur)return!1;if(parent.classList.contains("cm-line"))break;cur=parent}let rect=1==node.nodeType?node.getBoundingClientRect():textRange(node,0,Math.max(node.nodeValue.length,1)).getBoundingClientRect();return x-rect.left>5}(node,offset,x))&&(node=void 0))}if(!node||!view.docView.dom.contains(node)){let line=LineView.find(view.docView,lineStart);if(!line)return yOffset>block.top+block.height/2?block.to:block.from;({node:node,offset:offset}=domPosAtCoords(line.dom,x,y))}return view.docView.posFromDOM(node,offset)}function posAtCoordsImprecise(view,contentRect,block,x,y){let into=Math.round((x-contentRect.left)*view.defaultCharacterWidth);if(view.lineWrapping&&block.height>1.5*view.defaultLineHeight){into+=Math.floor((y-block.top)/view.defaultLineHeight)*view.viewState.heightOracle.lineLength}let content=view.state.sliceDoc(block.from,block.to);return block.from+findColumn(content,into,view.state.tabSize)}function moveByChar(view,start,forward,by){let line=view.state.doc.lineAt(start.head),spans=view.bidiSpans(line),direction=view.textDirectionAt(line.from);for(let cur=start,check=null;;){let next=moveVisually(line,spans,direction,cur,forward),char=movedOver;if(!next){if(line.number==(forward?view.state.doc.lines:1))return cur;char="\n",line=view.state.doc.line(line.number+(forward?1:-1)),spans=view.bidiSpans(line),next=EditorSelection.cursor(forward?line.from:line.to)}if(check){if(!check(char))return cur}else{if(!by)return next;check=by(char)}cur=next}}function skipAtoms(view,oldPos,pos){let atoms=view.state.facet(atomicRanges).map((f=>f(view)));for(;;){let moved=!1;for(let set of atoms)set.between(pos.from-1,pos.from+1,((from,to,value)=>{pos.from>from&&pos.from<to&&(pos=oldPos.head>pos.from?EditorSelection.cursor(from,1):EditorSelection.cursor(to,-1),moved=!0)}));if(!moved)return pos}}class InputState{constructor(view){this.lastKeyCode=0,this.lastKeyTime=0,this.lastTouchTime=0,this.lastFocusTime=0,this.lastScrollTop=0,this.lastScrollLeft=0,this.chromeScrollHack=-1,this.pendingIOSKey=void 0,this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastEscPress=0,this.lastContextMenu=0,this.scrollHandlers=[],this.registeredEvents=[],this.customHandlers=[],this.composing=-1,this.compositionFirstChange=null,this.compositionEndedAt=0,this.mouseSelection=null;let handleEvent=(handler,event)=>{this.ignoreDuringComposition(event)||"keydown"==event.type&&this.keydown(view,event)||(this.mustFlushObserver(event)&&view.observer.forceFlush(),this.runCustomHandlers(event.type,view,event)?event.preventDefault():handler(view,event))};for(let type in handlers){let handler=handlers[type];view.contentDOM.addEventListener(type,(event=>{eventBelongsToEditor(view,event)&&handleEvent(handler,event)}),handlerOptions[type]),this.registeredEvents.push(type)}view.scrollDOM.addEventListener("mousedown",(event=>{event.target==view.scrollDOM&&handleEvent(handlers.mousedown,event)})),browser.chrome&&102==browser.chrome_version&&view.scrollDOM.addEventListener("wheel",(()=>{this.chromeScrollHack<0?view.contentDOM.style.pointerEvents="none":window.clearTimeout(this.chromeScrollHack),this.chromeScrollHack=setTimeout((()=>{this.chromeScrollHack=-1,view.contentDOM.style.pointerEvents=""}),100)}),{passive:!0}),this.notifiedFocused=view.hasFocus,browser.safari&&view.contentDOM.addEventListener("input",(()=>null))}setSelectionOrigin(origin){this.lastSelectionOrigin=origin,this.lastSelectionTime=Date.now()}ensureHandlers(view,plugins){var _a;let handlers;this.customHandlers=[];for(let plugin of plugins)if(handlers=null===(_a=plugin.update(view).spec)||void 0===_a?void 0:_a.domEventHandlers){this.customHandlers.push({plugin:plugin.value,handlers:handlers});for(let type in handlers)this.registeredEvents.indexOf(type)<0&&"scroll"!=type&&(this.registeredEvents.push(type),view.contentDOM.addEventListener(type,(event=>{eventBelongsToEditor(view,event)&&this.runCustomHandlers(type,view,event)&&event.preventDefault()})))}}runCustomHandlers(type,view,event){for(let set of this.customHandlers){let handler=set.handlers[type];if(handler)try{if(handler.call(set.plugin,event,view)||event.defaultPrevented)return!0}catch(e){logException(view.state,e)}}return!1}runScrollHandlers(view,event){this.lastScrollTop=view.scrollDOM.scrollTop,this.lastScrollLeft=view.scrollDOM.scrollLeft;for(let set of this.customHandlers){let handler=set.handlers.scroll;if(handler)try{handler.call(set.plugin,event,view)}catch(e){logException(view.state,e)}}}keydown(view,event){if(this.lastKeyCode=event.keyCode,this.lastKeyTime=Date.now(),9==event.keyCode&&Date.now()<this.lastEscPress+2e3)return!0;if(browser.android&&browser.chrome&&!event.synthetic&&(13==event.keyCode||8==event.keyCode))return view.observer.delayAndroidKey(event.key,event.keyCode),!0;let pending;return!(!browser.ios||event.synthetic||event.altKey||event.metaKey||!((pending=PendingKeys.find((key=>key.keyCode==event.keyCode)))&&!event.ctrlKey||EmacsyPendingKeys.indexOf(event.key)>-1&&event.ctrlKey&&!event.shiftKey))&&(this.pendingIOSKey=pending||event,setTimeout((()=>this.flushIOSKey(view)),250),!0)}flushIOSKey(view){let key=this.pendingIOSKey;return!!key&&(this.pendingIOSKey=void 0,dispatchKey(view.contentDOM,key.key,key.keyCode))}ignoreDuringComposition(event){return!!/^key/.test(event.type)&&(this.composing>0||!!(browser.safari&&!browser.ios&&Date.now()-this.compositionEndedAt<100)&&(this.compositionEndedAt=0,!0))}mustFlushObserver(event){return"keydown"==event.type&&229!=event.keyCode}startMouseSelection(mouseSelection){this.mouseSelection&&this.mouseSelection.destroy(),this.mouseSelection=mouseSelection}update(update){this.mouseSelection&&this.mouseSelection.update(update),update.transactions.length&&(this.lastKeyCode=this.lastSelectionTime=0)}destroy(){this.mouseSelection&&this.mouseSelection.destroy()}}const PendingKeys=[{key:"Backspace",keyCode:8,inputType:"deleteContentBackward"},{key:"Enter",keyCode:13,inputType:"insertParagraph"},{key:"Delete",keyCode:46,inputType:"deleteContentForward"}],EmacsyPendingKeys="dthko",modifierCodes=[16,17,18,20,91,92,224,225];function dragScrollSpeed(dist){return.7*dist+8}class MouseSelection{constructor(view,startEvent,style,mustSelect){this.view=view,this.style=style,this.mustSelect=mustSelect,this.scrollSpeed={x:0,y:0},this.scrolling=-1,this.lastEvent=startEvent,this.scrollParent=function(dom){let doc=dom.ownerDocument;for(let cur=dom.parentNode;cur&&cur!=doc.body;)if(1==cur.nodeType){if(cur.scrollHeight>cur.clientHeight||cur.scrollWidth>cur.clientWidth)return cur;cur=cur.assignedSlot||cur.parentNode}else{if(11!=cur.nodeType)break;cur=cur.host}return null}(view.contentDOM);let doc=view.contentDOM.ownerDocument;doc.addEventListener("mousemove",this.move=this.move.bind(this)),doc.addEventListener("mouseup",this.up=this.up.bind(this)),this.extend=startEvent.shiftKey,this.multiple=view.state.facet(EditorState.allowMultipleSelections)&&function(view,event){let facet=view.state.facet(clickAddsSelectionRange);return facet.length?facet[0](event):browser.mac?event.metaKey:event.ctrlKey}(view,startEvent),this.dragMove=function(view,event){let facet=view.state.facet(dragMovesSelection$1);return facet.length?facet[0](event):browser.mac?!event.altKey:!event.ctrlKey}(view,startEvent),this.dragging=!(!function(view,event){let{main:main}=view.state.selection;if(main.empty)return!1;let sel=getSelection(view.root);if(!sel||0==sel.rangeCount)return!0;let rects=sel.getRangeAt(0).getClientRects();for(let i=0;i<rects.length;i++){let rect=rects[i];if(rect.left<=event.clientX&&rect.right>=event.clientX&&rect.top<=event.clientY&&rect.bottom>=event.clientY)return!0}return!1}(view,startEvent)||1!=getClickType(startEvent))&&null,!1===this.dragging&&(startEvent.preventDefault(),this.select(startEvent))}move(event){var _a;if(0==event.buttons)return this.destroy();if(!1!==this.dragging)return;this.select(this.lastEvent=event);let sx=0,sy=0,rect=(null===(_a=this.scrollParent)||void 0===_a?void 0:_a.getBoundingClientRect())||{left:0,top:0,right:this.view.win.innerWidth,bottom:this.view.win.innerHeight};event.clientX<=rect.left?sx=-dragScrollSpeed(rect.left-event.clientX):event.clientX>=rect.right&&(sx=dragScrollSpeed(event.clientX-rect.right)),event.clientY<=rect.top?sy=-dragScrollSpeed(rect.top-event.clientY):event.clientY>=rect.bottom&&(sy=dragScrollSpeed(event.clientY-rect.bottom)),this.setScrollSpeed(sx,sy)}up(event){null==this.dragging&&this.select(this.lastEvent),this.dragging||event.preventDefault(),this.destroy()}destroy(){this.setScrollSpeed(0,0);let doc=this.view.contentDOM.ownerDocument;doc.removeEventListener("mousemove",this.move),doc.removeEventListener("mouseup",this.up),this.view.inputState.mouseSelection=null}setScrollSpeed(sx,sy){this.scrollSpeed={x:sx,y:sy},sx||sy?this.scrolling<0&&(this.scrolling=setInterval((()=>this.scroll()),50)):this.scrolling>-1&&(clearInterval(this.scrolling),this.scrolling=-1)}scroll(){this.scrollParent?(this.scrollParent.scrollLeft+=this.scrollSpeed.x,this.scrollParent.scrollTop+=this.scrollSpeed.y):this.view.win.scrollBy(this.scrollSpeed.x,this.scrollSpeed.y),!1===this.dragging&&this.select(this.lastEvent)}select(event){let selection=this.style.get(event,this.extend,this.multiple);!this.mustSelect&&selection.eq(this.view.state.selection)&&selection.main.assoc==this.view.state.selection.main.assoc||this.view.dispatch({selection:selection,userEvent:"select.pointer"}),this.mustSelect=!1}update(update){update.docChanged&&this.dragging&&(this.dragging=this.dragging.map(update.changes)),this.style.update(update)&&setTimeout((()=>this.select(this.lastEvent)),20)}}function eventBelongsToEditor(view,event){if(!event.bubbles)return!0;if(event.defaultPrevented)return!1;for(let cView,node=event.target;node!=view.contentDOM;node=node.parentNode)if(!node||11==node.nodeType||(cView=ContentView.get(node))&&cView.ignoreEvent(event))return!1;return!0}const handlers=Object.create(null),handlerOptions=Object.create(null),brokenClipboardAPI=browser.ie&&browser.ie_version<15||browser.ios&&browser.webkit_version<604;function doPaste(view,input){let changes,{state:state}=view,i=1,text=state.toText(input),byLine=text.lines==state.selection.ranges.length;if(null!=lastLinewiseCopy&&state.selection.ranges.every((r=>r.empty))&&lastLinewiseCopy==text.toString()){let lastLine=-1;changes=state.changeByRange((range=>{let line=state.doc.lineAt(range.from);if(line.from==lastLine)return{range:range};lastLine=line.from;let insert=state.toText((byLine?text.line(i++).text:input)+state.lineBreak);return{changes:{from:line.from,insert:insert},range:EditorSelection.cursor(range.from+insert.length)}}))}else changes=byLine?state.changeByRange((range=>{let line=text.line(i++);return{changes:{from:range.from,to:range.to,insert:line.text},range:EditorSelection.cursor(range.from+line.length)}})):state.replaceSelection(text);view.dispatch(changes,{userEvent:"input.paste",scrollIntoView:!0})}function rangeForClick(view,pos,bias,type){if(1==type)return EditorSelection.cursor(pos,bias);if(2==type)return function(state,pos,bias=1){let categorize=state.charCategorizer(pos),line=state.doc.lineAt(pos),linePos=pos-line.from;if(0==line.length)return EditorSelection.cursor(pos);0==linePos?bias=1:linePos==line.length&&(bias=-1);let from=linePos,to=linePos;bias<0?from=findClusterBreak(line.text,linePos,!1):to=findClusterBreak(line.text,linePos);let cat=categorize(line.text.slice(from,to));for(;from>0;){let prev=findClusterBreak(line.text,from,!1);if(categorize(line.text.slice(prev,from))!=cat)break;from=prev}for(;to<line.length;){let next=findClusterBreak(line.text,to);if(categorize(line.text.slice(to,next))!=cat)break;to=next}return EditorSelection.range(from+line.from,to+line.from)}(view.state,pos,bias);{let visual=LineView.find(view.docView,pos),line=view.state.doc.lineAt(visual?visual.posAtEnd:pos),from=visual?visual.posAtStart:line.from,to=visual?visual.posAtEnd:line.to;return to<view.state.doc.length&&to==line.to&&to++,EditorSelection.range(from,to)}}handlers.keydown=(view,event)=>{view.inputState.setSelectionOrigin("select"),27==event.keyCode?view.inputState.lastEscPress=Date.now():modifierCodes.indexOf(event.keyCode)<0&&(view.inputState.lastEscPress=0)},handlers.touchstart=(view,e)=>{view.inputState.lastTouchTime=Date.now(),view.inputState.setSelectionOrigin("select.pointer")},handlers.touchmove=view=>{view.inputState.setSelectionOrigin("select.pointer")},handlerOptions.touchstart=handlerOptions.touchmove={passive:!0},handlers.mousedown=(view,event)=>{if(view.observer.flush(),view.inputState.lastTouchTime>Date.now()-2e3)return;let style=null;for(let makeStyle of view.state.facet(mouseSelectionStyle))if(style=makeStyle(view,event),style)break;if(style||0!=event.button||(style=function(view,event){let start=queryPos(view,event),type=getClickType(event),startSel=view.state.selection;return{update(update){update.docChanged&&(start.pos=update.changes.mapPos(start.pos),startSel=startSel.map(update.changes))},get(event,extend,multiple){let cur=queryPos(view,event),range=rangeForClick(view,cur.pos,cur.bias,type);if(start.pos!=cur.pos&&!extend){let startRange=rangeForClick(view,start.pos,start.bias,type),from=Math.min(startRange.from,range.from),to=Math.max(startRange.to,range.to);range=from<range.from?EditorSelection.range(from,to):EditorSelection.range(to,from)}return extend?startSel.replaceRange(startSel.main.extend(range.from,range.to)):multiple&&startSel.ranges.length>1&&startSel.ranges.some((r=>r.eq(range)))?function(sel,range){for(let i=0;;i++)if(sel.ranges[i].eq(range))return EditorSelection.create(sel.ranges.slice(0,i).concat(sel.ranges.slice(i+1)),sel.mainIndex==i?0:sel.mainIndex-(sel.mainIndex>i?1:0))}(startSel,range):multiple?startSel.addRange(range):EditorSelection.create([range])}}}(view,event)),style){let mustFocus=view.root.activeElement!=view.contentDOM;mustFocus&&view.observer.ignore((()=>focusPreventScroll(view.contentDOM))),view.inputState.startMouseSelection(new MouseSelection(view,event,style,mustFocus))}};let insideY=(y,rect)=>y>=rect.top&&y<=rect.bottom,inside=(x,y,rect)=>insideY(y,rect)&&x>=rect.left&&x<=rect.right;function findPositionSide(view,pos,x,y){let line=LineView.find(view.docView,pos);if(!line)return 1;let off=pos-line.posAtStart;if(0==off)return 1;if(off==line.length)return-1;let before=line.coordsAt(off,-1);if(before&&inside(x,y,before))return-1;let after=line.coordsAt(off,1);return after&&inside(x,y,after)?1:before&&insideY(y,before)?-1:1}function queryPos(view,event){let pos=view.posAtCoords({x:event.clientX,y:event.clientY},!1);return{pos:pos,bias:findPositionSide(view,pos,event.clientX,event.clientY)}}const BadMouseDetail=browser.ie&&browser.ie_version<=11;let lastMouseDown=null,lastMouseDownCount=0,lastMouseDownTime=0;function getClickType(event){if(!BadMouseDetail)return event.detail;let last=lastMouseDown,lastTime=lastMouseDownTime;return lastMouseDown=event,lastMouseDownTime=Date.now(),lastMouseDownCount=!last||lastTime>Date.now()-400&&Math.abs(last.clientX-event.clientX)<2&&Math.abs(last.clientY-event.clientY)<2?(lastMouseDownCount+1)%3:1}function dropText(view,event,text,direct){if(!text)return;let dropPos=view.posAtCoords({x:event.clientX,y:event.clientY},!1);event.preventDefault();let{mouseSelection:mouseSelection}=view.inputState,del=direct&&mouseSelection&&mouseSelection.dragging&&mouseSelection.dragMove?{from:mouseSelection.dragging.from,to:mouseSelection.dragging.to}:null,ins={from:dropPos,insert:text},changes=view.state.changes(del?[del,ins]:ins);view.focus(),view.dispatch({changes:changes,selection:{anchor:changes.mapPos(dropPos,-1),head:changes.mapPos(dropPos,1)},userEvent:del?"move.drop":"input.drop"})}handlers.dragstart=(view,event)=>{let{selection:{main:main}}=view.state,{mouseSelection:mouseSelection}=view.inputState;mouseSelection&&(mouseSelection.dragging=main),event.dataTransfer&&(event.dataTransfer.setData("Text",view.state.sliceDoc(main.from,main.to)),event.dataTransfer.effectAllowed="copyMove")},handlers.drop=(view,event)=>{if(!event.dataTransfer)return;if(view.state.readOnly)return event.preventDefault();let files=event.dataTransfer.files;if(files&&files.length){event.preventDefault();let text=Array(files.length),read=0,finishFile=()=>{++read==files.length&&dropText(view,event,text.filter((s=>null!=s)).join(view.state.lineBreak),!1)};for(let i=0;i<files.length;i++){let reader=new FileReader;reader.onerror=finishFile,reader.onload=()=>{/[\x00-\x08\x0e-\x1f]{2}/.test(reader.result)||(text[i]=reader.result),finishFile()},reader.readAsText(files[i])}}else dropText(view,event,event.dataTransfer.getData("Text"),!0)},handlers.paste=(view,event)=>{if(view.state.readOnly)return event.preventDefault();view.observer.flush();let data=brokenClipboardAPI?null:event.clipboardData;data?(doPaste(view,data.getData("text/plain")),event.preventDefault()):function(view){let parent=view.dom.parentNode;if(!parent)return;let target=parent.appendChild(document.createElement("textarea"));target.style.cssText="position: fixed; left: -10000px; top: 10px",target.focus(),setTimeout((()=>{view.focus(),target.remove(),doPaste(view,target.value)}),50)}(view)};let lastLinewiseCopy=null;function updateForFocusChange(view){setTimeout((()=>{view.hasFocus!=view.inputState.notifiedFocused&&view.update([])}),10)}handlers.copy=handlers.cut=(view,event)=>{let{text:text,ranges:ranges,linewise:linewise}=function(state){let content=[],ranges=[],linewise=!1;for(let range of state.selection.ranges)range.empty||(content.push(state.sliceDoc(range.from,range.to)),ranges.push(range));if(!content.length){let upto=-1;for(let{from:from}of state.selection.ranges){let line=state.doc.lineAt(from);line.number>upto&&(content.push(line.text),ranges.push({from:line.from,to:Math.min(state.doc.length,line.to+1)})),upto=line.number}linewise=!0}return{text:content.join(state.lineBreak),ranges:ranges,linewise:linewise}}(view.state);if(!text&&!linewise)return;lastLinewiseCopy=linewise?text:null;let data=brokenClipboardAPI?null:event.clipboardData;data?(event.preventDefault(),data.clearData(),data.setData("text/plain",text)):function(view,text){let parent=view.dom.parentNode;if(!parent)return;let target=parent.appendChild(document.createElement("textarea"));target.style.cssText="position: fixed; left: -10000px; top: 10px",target.value=text,target.focus(),target.selectionEnd=text.length,target.selectionStart=0,setTimeout((()=>{target.remove(),view.focus()}),50)}(view,text),"cut"!=event.type||view.state.readOnly||view.dispatch({changes:ranges,scrollIntoView:!0,userEvent:"delete.cut"})},handlers.focus=view=>{view.inputState.lastFocusTime=Date.now(),view.scrollDOM.scrollTop||!view.inputState.lastScrollTop&&!view.inputState.lastScrollLeft||(view.scrollDOM.scrollTop=view.inputState.lastScrollTop,view.scrollDOM.scrollLeft=view.inputState.lastScrollLeft),updateForFocusChange(view)},handlers.blur=view=>{view.observer.clearSelectionRange(),updateForFocusChange(view)},handlers.compositionstart=handlers.compositionupdate=view=>{null==view.inputState.compositionFirstChange&&(view.inputState.compositionFirstChange=!0),view.inputState.composing<0&&(view.inputState.composing=0)},handlers.compositionend=view=>{view.inputState.composing=-1,view.inputState.compositionEndedAt=Date.now(),view.inputState.compositionFirstChange=null,browser.chrome&&browser.android&&view.observer.flushSoon(),setTimeout((()=>{view.inputState.composing<0&&view.docView.compositionDeco.size&&view.update([])}),50)},handlers.contextmenu=view=>{view.inputState.lastContextMenu=Date.now()},handlers.beforeinput=(view,event)=>{var _a;let pending;if(browser.chrome&&browser.android&&(pending=PendingKeys.find((key=>key.inputType==event.inputType)))&&(view.observer.delayAndroidKey(pending.key,pending.keyCode),"Backspace"==pending.key||"Delete"==pending.key)){let startViewHeight=(null===(_a=window.visualViewport)||void 0===_a?void 0:_a.height)||0;setTimeout((()=>{var _a;((null===(_a=window.visualViewport)||void 0===_a?void 0:_a.height)||0)>startViewHeight+10&&view.hasFocus&&(view.contentDOM.blur(),view.focus())}),100)}};const wrappingWhiteSpace=["pre-wrap","normal","pre-line","break-spaces"];class HeightOracle{constructor(lineWrapping){this.lineWrapping=lineWrapping,this.doc=Text.empty,this.heightSamples={},this.lineHeight=14,this.charWidth=7,this.lineLength=30,this.heightChanged=!1}heightForGap(from,to){let lines=this.doc.lineAt(to).number-this.doc.lineAt(from).number+1;return this.lineWrapping&&(lines+=Math.ceil((to-from-lines*this.lineLength*.5)/this.lineLength)),this.lineHeight*lines}heightForLine(length){if(!this.lineWrapping)return this.lineHeight;return(1+Math.max(0,Math.ceil((length-this.lineLength)/(this.lineLength-5))))*this.lineHeight}setDoc(doc){return this.doc=doc,this}mustRefreshForWrapping(whiteSpace){return wrappingWhiteSpace.indexOf(whiteSpace)>-1!=this.lineWrapping}mustRefreshForHeights(lineHeights){let newHeight=!1;for(let i=0;i<lineHeights.length;i++){let h=lineHeights[i];h<0?i++:this.heightSamples[Math.floor(10*h)]||(newHeight=!0,this.heightSamples[Math.floor(10*h)]=!0)}return newHeight}refresh(whiteSpace,lineHeight,charWidth,lineLength,knownHeights){let lineWrapping=wrappingWhiteSpace.indexOf(whiteSpace)>-1,changed=Math.round(lineHeight)!=Math.round(this.lineHeight)||this.lineWrapping!=lineWrapping;if(this.lineWrapping=lineWrapping,this.lineHeight=lineHeight,this.charWidth=charWidth,this.lineLength=lineLength,changed){this.heightSamples={};for(let i=0;i<knownHeights.length;i++){let h=knownHeights[i];h<0?i++:this.heightSamples[Math.floor(10*h)]=!0}}return changed}}class MeasuredHeights{constructor(from,heights){this.from=from,this.heights=heights,this.index=0}get more(){return this.index<this.heights.length}}class BlockInfo{constructor(from,length,top,height,type){this.from=from,this.length=length,this.top=top,this.height=height,this.type=type}get to(){return this.from+this.length}get bottom(){return this.top+this.height}join(other){let detail=(Array.isArray(this.type)?this.type:[this]).concat(Array.isArray(other.type)?other.type:[other]);return new BlockInfo(this.from,this.length+other.length,this.top,this.height+other.height,detail)}}var QueryType$1=function(QueryType){return QueryType[QueryType.ByPos=0]="ByPos",QueryType[QueryType.ByHeight=1]="ByHeight",QueryType[QueryType.ByPosNoHeight=2]="ByPosNoHeight",QueryType}(QueryType$1||(QueryType$1={}));class HeightMap{constructor(length,height,flags=2){this.length=length,this.height=height,this.flags=flags}get outdated(){return(2&this.flags)>0}set outdated(value){this.flags=(value?2:0)|-3&this.flags}setHeight(oracle,height){this.height!=height&&(Math.abs(this.height-height)>.001&&(oracle.heightChanged=!0),this.height=height)}replace(_from,_to,nodes){return HeightMap.of(nodes)}decomposeLeft(_to,result){result.push(this)}decomposeRight(_from,result){result.push(this)}applyChanges(decorations,oldDoc,oracle,changes){let me=this;for(let i=changes.length-1;i>=0;i--){let{fromA:fromA,toA:toA,fromB:fromB,toB:toB}=changes[i],start=me.lineAt(fromA,QueryType$1.ByPosNoHeight,oldDoc,0,0),end=start.to>=toA?start:me.lineAt(toA,QueryType$1.ByPosNoHeight,oldDoc,0,0);for(toB+=end.to-toA,toA=end.to;i>0&&start.from<=changes[i-1].toA;)fromA=changes[i-1].fromA,fromB=changes[i-1].fromB,i--,fromA<start.from&&(start=me.lineAt(fromA,QueryType$1.ByPosNoHeight,oldDoc,0,0));fromB+=start.from-fromA,fromA=start.from;let nodes=NodeBuilder.build(oracle,decorations,fromB,toB);me=me.replace(fromA,toA,nodes)}return me.updateHeight(oracle,0)}static empty(){return new HeightMapText(0,0)}static of(nodes){if(1==nodes.length)return nodes[0];let i=0,j=nodes.length,before=0,after=0;for(;;)if(i==j)if(before>2*after){let split=nodes[i-1];split.break?nodes.splice(--i,1,split.left,null,split.right):nodes.splice(--i,1,split.left,split.right),j+=1+split.break,before-=split.size}else{if(!(after>2*before))break;{let split=nodes[j];split.break?nodes.splice(j,1,split.left,null,split.right):nodes.splice(j,1,split.left,split.right),j+=2+split.break,after-=split.size}}else if(before<after){let next=nodes[i++];next&&(before+=next.size)}else{let next=nodes[--j];next&&(after+=next.size)}let brk=0;return null==nodes[i-1]?(brk=1,i--):null==nodes[i]&&(brk=1,j++),new HeightMapBranch(HeightMap.of(nodes.slice(0,i)),brk,HeightMap.of(nodes.slice(j)))}}HeightMap.prototype.size=1;class HeightMapBlock extends HeightMap{constructor(length,height,type){super(length,height),this.type=type}blockAt(_height,_doc,top,offset){return new BlockInfo(offset,this.length,top,this.height,this.type)}lineAt(_value,_type,doc,top,offset){return this.blockAt(0,doc,top,offset)}forEachLine(from,to,doc,top,offset,f){from<=offset+this.length&&to>=offset&&f(this.blockAt(0,doc,top,offset))}updateHeight(oracle,offset=0,_force=!1,measured){return measured&&measured.from<=offset&&measured.more&&this.setHeight(oracle,measured.heights[measured.index++]),this.outdated=!1,this}toString(){return`block(${this.length})`}}class HeightMapText extends HeightMapBlock{constructor(length,height){super(length,height,BlockType.Text),this.collapsed=0,this.widgetHeight=0}replace(_from,_to,nodes){let node=nodes[0];return 1==nodes.length&&(node instanceof HeightMapText||node instanceof HeightMapGap&&4&node.flags)&&Math.abs(this.length-node.length)<10?(node instanceof HeightMapGap?node=new HeightMapText(node.length,this.height):node.height=this.height,this.outdated||(node.outdated=!1),node):HeightMap.of(nodes)}updateHeight(oracle,offset=0,force=!1,measured){return measured&&measured.from<=offset&&measured.more?this.setHeight(oracle,measured.heights[measured.index++]):(force||this.outdated)&&this.setHeight(oracle,Math.max(this.widgetHeight,oracle.heightForLine(this.length-this.collapsed))),this.outdated=!1,this}toString(){return`line(${this.length}${this.collapsed?-this.collapsed:""}${this.widgetHeight?":"+this.widgetHeight:""})`}}class HeightMapGap extends HeightMap{constructor(length){super(length,0)}lines(doc,offset){let firstLine=doc.lineAt(offset).number,lastLine=doc.lineAt(offset+this.length).number;return{firstLine:firstLine,lastLine:lastLine,lineHeight:this.height/(lastLine-firstLine+1)}}blockAt(height,doc,top,offset){let{firstLine:firstLine,lastLine:lastLine,lineHeight:lineHeight}=this.lines(doc,offset),line=Math.max(0,Math.min(lastLine-firstLine,Math.floor((height-top)/lineHeight))),{from:from,length:length}=doc.line(firstLine+line);return new BlockInfo(from,length,top+lineHeight*line,lineHeight,BlockType.Text)}lineAt(value,type,doc,top,offset){if(type==QueryType$1.ByHeight)return this.blockAt(value,doc,top,offset);if(type==QueryType$1.ByPosNoHeight){let{from:from,to:to}=doc.lineAt(value);return new BlockInfo(from,to-from,0,0,BlockType.Text)}let{firstLine:firstLine,lineHeight:lineHeight}=this.lines(doc,offset),{from:from,length:length,number:number}=doc.lineAt(value);return new BlockInfo(from,length,top+lineHeight*(number-firstLine),lineHeight,BlockType.Text)}forEachLine(from,to,doc,top,offset,f){let{firstLine:firstLine,lineHeight:lineHeight}=this.lines(doc,offset);for(let pos=Math.max(from,offset),end=Math.min(offset+this.length,to);pos<=end;){let line=doc.lineAt(pos);pos==from&&(top+=lineHeight*(line.number-firstLine)),f(new BlockInfo(line.from,line.length,top,lineHeight,BlockType.Text)),top+=lineHeight,pos=line.to+1}}replace(from,to,nodes){let after=this.length-to;if(after>0){let last=nodes[nodes.length-1];last instanceof HeightMapGap?nodes[nodes.length-1]=new HeightMapGap(last.length+after):nodes.push(null,new HeightMapGap(after-1))}if(from>0){let first=nodes[0];first instanceof HeightMapGap?nodes[0]=new HeightMapGap(from+first.length):nodes.unshift(new HeightMapGap(from-1),null)}return HeightMap.of(nodes)}decomposeLeft(to,result){result.push(new HeightMapGap(to-1),null)}decomposeRight(from,result){result.push(null,new HeightMapGap(this.length-from-1))}updateHeight(oracle,offset=0,force=!1,measured){let end=offset+this.length;if(measured&&measured.from<=offset+this.length&&measured.more){let nodes=[],pos=Math.max(offset,measured.from),singleHeight=-1,wasChanged=oracle.heightChanged;for(measured.from>offset&&nodes.push(new HeightMapGap(measured.from-offset-1).updateHeight(oracle,offset));pos<=end&&measured.more;){let len=oracle.doc.lineAt(pos).length;nodes.length&&nodes.push(null);let height=measured.heights[measured.index++];-1==singleHeight?singleHeight=height:Math.abs(height-singleHeight)>=.001&&(singleHeight=-2);let line=new HeightMapText(len,height);line.outdated=!1,nodes.push(line),pos+=len+1}pos<=end&&nodes.push(null,new HeightMapGap(end-pos).updateHeight(oracle,pos));let result=HeightMap.of(nodes);return oracle.heightChanged=wasChanged||singleHeight<0||Math.abs(result.height-this.height)>=.001||Math.abs(singleHeight-this.lines(oracle.doc,offset).lineHeight)>=.001,result}return(force||this.outdated)&&(this.setHeight(oracle,oracle.heightForGap(offset,offset+this.length)),this.outdated=!1),this}toString(){return`gap(${this.length})`}}class HeightMapBranch extends HeightMap{constructor(left,brk,right){super(left.length+brk+right.length,left.height+right.height,brk|(left.outdated||right.outdated?2:0)),this.left=left,this.right=right,this.size=left.size+right.size}get break(){return 1&this.flags}blockAt(height,doc,top,offset){let mid=top+this.left.height;return height<mid?this.left.blockAt(height,doc,top,offset):this.right.blockAt(height,doc,mid,offset+this.left.length+this.break)}lineAt(value,type,doc,top,offset){let rightTop=top+this.left.height,rightOffset=offset+this.left.length+this.break,left=type==QueryType$1.ByHeight?value<rightTop:value<rightOffset,base=left?this.left.lineAt(value,type,doc,top,offset):this.right.lineAt(value,type,doc,rightTop,rightOffset);if(this.break||(left?base.to<rightOffset:base.from>rightOffset))return base;let subQuery=type==QueryType$1.ByPosNoHeight?QueryType$1.ByPosNoHeight:QueryType$1.ByPos;return left?base.join(this.right.lineAt(rightOffset,subQuery,doc,rightTop,rightOffset)):this.left.lineAt(rightOffset,subQuery,doc,top,offset).join(base)}forEachLine(from,to,doc,top,offset,f){let rightTop=top+this.left.height,rightOffset=offset+this.left.length+this.break;if(this.break)from<rightOffset&&this.left.forEachLine(from,to,doc,top,offset,f),to>=rightOffset&&this.right.forEachLine(from,to,doc,rightTop,rightOffset,f);else{let mid=this.lineAt(rightOffset,QueryType$1.ByPos,doc,top,offset);from<mid.from&&this.left.forEachLine(from,mid.from-1,doc,top,offset,f),mid.to>=from&&mid.from<=to&&f(mid),to>mid.to&&this.right.forEachLine(mid.to+1,to,doc,rightTop,rightOffset,f)}}replace(from,to,nodes){let rightStart=this.left.length+this.break;if(to<rightStart)return this.balanced(this.left.replace(from,to,nodes),this.right);if(from>this.left.length)return this.balanced(this.left,this.right.replace(from-rightStart,to-rightStart,nodes));let result=[];from>0&&this.decomposeLeft(from,result);let left=result.length;for(let node of nodes)result.push(node);if(from>0&&mergeGaps(result,left-1),to<this.length){let right=result.length;this.decomposeRight(to,result),mergeGaps(result,right)}return HeightMap.of(result)}decomposeLeft(to,result){let left=this.left.length;if(to<=left)return this.left.decomposeLeft(to,result);result.push(this.left),this.break&&(left++,to>=left&&result.push(null)),to>left&&this.right.decomposeLeft(to-left,result)}decomposeRight(from,result){let left=this.left.length,right=left+this.break;if(from>=right)return this.right.decomposeRight(from-right,result);from<left&&this.left.decomposeRight(from,result),this.break&&from<right&&result.push(null),result.push(this.right)}balanced(left,right){return left.size>2*right.size||right.size>2*left.size?HeightMap.of(this.break?[left,null,right]:[left,right]):(this.left=left,this.right=right,this.height=left.height+right.height,this.outdated=left.outdated||right.outdated,this.size=left.size+right.size,this.length=left.length+this.break+right.length,this)}updateHeight(oracle,offset=0,force=!1,measured){let{left:left,right:right}=this,rightStart=offset+left.length+this.break,rebalance=null;return measured&&measured.from<=offset+left.length&&measured.more?rebalance=left=left.updateHeight(oracle,offset,force,measured):left.updateHeight(oracle,offset,force),measured&&measured.from<=rightStart+right.length&&measured.more?rebalance=right=right.updateHeight(oracle,rightStart,force,measured):right.updateHeight(oracle,rightStart,force),rebalance?this.balanced(left,right):(this.height=this.left.height+this.right.height,this.outdated=!1,this)}toString(){return this.left+(this.break?" ":"-")+this.right}}function mergeGaps(nodes,around){let before,after;null==nodes[around]&&(before=nodes[around-1])instanceof HeightMapGap&&(after=nodes[around+1])instanceof HeightMapGap&&nodes.splice(around-1,3,new HeightMapGap(before.length+1+after.length))}class NodeBuilder{constructor(pos,oracle){this.pos=pos,this.oracle=oracle,this.nodes=[],this.lineStart=-1,this.lineEnd=-1,this.covering=null,this.writtenTo=pos}get isCovered(){return this.covering&&this.nodes[this.nodes.length-1]==this.covering}span(_from,to){if(this.lineStart>-1){let end=Math.min(to,this.lineEnd),last=this.nodes[this.nodes.length-1];last instanceof HeightMapText?last.length+=end-this.pos:(end>this.pos||!this.isCovered)&&this.nodes.push(new HeightMapText(end-this.pos,-1)),this.writtenTo=end,to>end&&(this.nodes.push(null),this.writtenTo++,this.lineStart=-1)}this.pos=to}point(from,to,deco){if(from<to||deco.heightRelevant){let height=deco.widget?deco.widget.estimatedHeight:0;height<0&&(height=this.oracle.lineHeight);let len=to-from;deco.block?this.addBlock(new HeightMapBlock(len,height,deco.type)):(len||height>=5)&&this.addLineDeco(height,len)}else to>from&&this.span(from,to);this.lineEnd>-1&&this.lineEnd<this.pos&&(this.lineEnd=this.oracle.doc.lineAt(this.pos).to)}enterLine(){if(this.lineStart>-1)return;let{from:from,to:to}=this.oracle.doc.lineAt(this.pos);this.lineStart=from,this.lineEnd=to,this.writtenTo<from&&((this.writtenTo<from-1||null==this.nodes[this.nodes.length-1])&&this.nodes.push(this.blankContent(this.writtenTo,from-1)),this.nodes.push(null)),this.pos>from&&this.nodes.push(new HeightMapText(this.pos-from,-1)),this.writtenTo=this.pos}blankContent(from,to){let gap=new HeightMapGap(to-from);return this.oracle.doc.lineAt(from).to==to&&(gap.flags|=4),gap}ensureLine(){this.enterLine();let last=this.nodes.length?this.nodes[this.nodes.length-1]:null;if(last instanceof HeightMapText)return last;let line=new HeightMapText(0,-1);return this.nodes.push(line),line}addBlock(block){this.enterLine(),block.type!=BlockType.WidgetAfter||this.isCovered||this.ensureLine(),this.nodes.push(block),this.writtenTo=this.pos=this.pos+block.length,block.type!=BlockType.WidgetBefore&&(this.covering=block)}addLineDeco(height,length){let line=this.ensureLine();line.length+=length,line.collapsed+=length,line.widgetHeight=Math.max(line.widgetHeight,height),this.writtenTo=this.pos=this.pos+length}finish(from){let last=0==this.nodes.length?null:this.nodes[this.nodes.length-1];!(this.lineStart>-1)||last instanceof HeightMapText||this.isCovered?(this.writtenTo<this.pos||null==last)&&this.nodes.push(this.blankContent(this.writtenTo,this.pos)):this.nodes.push(new HeightMapText(0,-1));let pos=from;for(let node of this.nodes)node instanceof HeightMapText&&node.updateHeight(this.oracle,pos),pos+=node?node.length:1;return this.nodes}static build(oracle,decorations,from,to){let builder=new NodeBuilder(from,oracle);return RangeSet.spans(decorations,from,to,builder,0),builder.finish(from)}}class DecorationComparator{constructor(){this.changes=[]}compareRange(){}comparePoint(from,to,a,b){(from<to||a&&a.heightRelevant||b&&b.heightRelevant)&&addRange(from,to,this.changes,5)}}function visiblePixelRange(dom,paddingTop){let rect=dom.getBoundingClientRect(),doc=dom.ownerDocument,win=doc.defaultView||window,left=Math.max(0,rect.left),right=Math.min(win.innerWidth,rect.right),top=Math.max(0,rect.top),bottom=Math.min(win.innerHeight,rect.bottom);for(let parent=dom.parentNode;parent&&parent!=doc.body;)if(1==parent.nodeType){let elt=parent,style=window.getComputedStyle(elt);if((elt.scrollHeight>elt.clientHeight||elt.scrollWidth>elt.clientWidth)&&"visible"!=style.overflow){let parentRect=elt.getBoundingClientRect();left=Math.max(left,parentRect.left),right=Math.min(right,parentRect.right),top=Math.max(top,parentRect.top),bottom=parent==dom.parentNode?parentRect.bottom:Math.min(bottom,parentRect.bottom)}parent="absolute"==style.position||"fixed"==style.position?elt.offsetParent:elt.parentNode}else{if(11!=parent.nodeType)break;parent=parent.host}return{left:left-rect.left,right:Math.max(left,right)-rect.left,top:top-(rect.top+paddingTop),bottom:Math.max(top,bottom)-(rect.top+paddingTop)}}function fullPixelRange(dom,paddingTop){let rect=dom.getBoundingClientRect();return{left:0,right:rect.right-rect.left,top:paddingTop,bottom:rect.bottom-(rect.top+paddingTop)}}class LineGap{constructor(from,to,size){this.from=from,this.to=to,this.size=size}static same(a,b){if(a.length!=b.length)return!1;for(let i=0;i<a.length;i++){let gA=a[i],gB=b[i];if(gA.from!=gB.from||gA.to!=gB.to||gA.size!=gB.size)return!1}return!0}draw(wrapping){return Decoration.replace({widget:new LineGapWidget(this.size,wrapping)}).range(this.from,this.to)}}class LineGapWidget extends WidgetType{constructor(size,vertical){super(),this.size=size,this.vertical=vertical}eq(other){return other.size==this.size&&other.vertical==this.vertical}toDOM(){let elt=document.createElement("div");return this.vertical?elt.style.height=this.size+"px":(elt.style.width=this.size+"px",elt.style.height="2px",elt.style.display="inline-block"),elt}get estimatedHeight(){return this.vertical?this.size:-1}}class ViewState{constructor(state){this.state=state,this.pixelViewport={left:0,right:window.innerWidth,top:0,bottom:0},this.inView=!0,this.paddingTop=0,this.paddingBottom=0,this.contentDOMWidth=0,this.contentDOMHeight=0,this.editorHeight=0,this.editorWidth=0,this.scaler=IdScaler,this.scrollTarget=null,this.printing=!1,this.mustMeasureContent=!0,this.defaultTextDirection=Direction.LTR,this.visibleRanges=[],this.mustEnforceCursorAssoc=!1;let guessWrapping=state.facet(contentAttributes).some((v=>"function"!=typeof v&&"cm-lineWrapping"==v.class));this.heightOracle=new HeightOracle(guessWrapping),this.stateDeco=state.facet(decorations).filter((d=>"function"!=typeof d)),this.heightMap=HeightMap.empty().applyChanges(this.stateDeco,Text.empty,this.heightOracle.setDoc(state.doc),[new ChangedRange(0,0,0,state.doc.length)]),this.viewport=this.getViewport(0,null),this.updateViewportLines(),this.updateForViewport(),this.lineGaps=this.ensureLineGaps([]),this.lineGapDeco=Decoration.set(this.lineGaps.map((gap=>gap.draw(!1)))),this.computeVisibleRanges()}updateForViewport(){let viewports=[this.viewport],{main:main}=this.state.selection;for(let i=0;i<=1;i++){let pos=i?main.head:main.anchor;if(!viewports.some((({from:from,to:to})=>pos>=from&&pos<=to))){let{from:from,to:to}=this.lineBlockAt(pos);viewports.push(new Viewport(from,to))}}this.viewports=viewports.sort(((a,b)=>a.from-b.from)),this.scaler=this.heightMap.height<=7e6?IdScaler:new BigScaler(this.heightOracle.doc,this.heightMap,this.viewports)}updateViewportLines(){this.viewportLines=[],this.heightMap.forEachLine(this.viewport.from,this.viewport.to,this.state.doc,0,0,(block=>{this.viewportLines.push(1==this.scaler.scale?block:scaleBlock(block,this.scaler))}))}update(update,scrollTarget=null){this.state=update.state;let prevDeco=this.stateDeco;this.stateDeco=this.state.facet(decorations).filter((d=>"function"!=typeof d));let contentChanges=update.changedRanges,heightChanges=ChangedRange.extendWithRanges(contentChanges,function(a,b,diff){let comp=new DecorationComparator;return RangeSet.compare(a,b,diff,comp,0),comp.changes}(prevDeco,this.stateDeco,update?update.changes:ChangeSet.empty(this.state.doc.length))),prevHeight=this.heightMap.height;this.heightMap=this.heightMap.applyChanges(this.stateDeco,update.startState.doc,this.heightOracle.setDoc(this.state.doc),heightChanges),this.heightMap.height!=prevHeight&&(update.flags|=2);let viewport=heightChanges.length?this.mapViewport(this.viewport,update.changes):this.viewport;(scrollTarget&&(scrollTarget.range.head<viewport.from||scrollTarget.range.head>viewport.to)||!this.viewportIsAppropriate(viewport))&&(viewport=this.getViewport(0,scrollTarget));let updateLines=!update.changes.empty||2&update.flags||viewport.from!=this.viewport.from||viewport.to!=this.viewport.to;this.viewport=viewport,this.updateForViewport(),updateLines&&this.updateViewportLines(),(this.lineGaps.length||this.viewport.to-this.viewport.from>4e3)&&this.updateLineGaps(this.ensureLineGaps(this.mapLineGaps(this.lineGaps,update.changes))),update.flags|=this.computeVisibleRanges(),scrollTarget&&(this.scrollTarget=scrollTarget),!this.mustEnforceCursorAssoc&&update.selectionSet&&update.view.lineWrapping&&update.state.selection.main.empty&&update.state.selection.main.assoc&&!update.state.facet(nativeSelectionHidden)&&(this.mustEnforceCursorAssoc=!0)}measure(view){let dom=view.contentDOM,style=window.getComputedStyle(dom),oracle=this.heightOracle,whiteSpace=style.whiteSpace;this.defaultTextDirection="rtl"==style.direction?Direction.RTL:Direction.LTR;let refresh=this.heightOracle.mustRefreshForWrapping(whiteSpace),measureContent=refresh||this.mustMeasureContent||this.contentDOMHeight!=dom.clientHeight;this.contentDOMHeight=dom.clientHeight,this.mustMeasureContent=!1;let result=0,bias=0,paddingTop=parseInt(style.paddingTop)||0,paddingBottom=parseInt(style.paddingBottom)||0;this.paddingTop==paddingTop&&this.paddingBottom==paddingBottom||(this.paddingTop=paddingTop,this.paddingBottom=paddingBottom,result|=10),this.editorWidth!=view.scrollDOM.clientWidth&&(oracle.lineWrapping&&(measureContent=!0),this.editorWidth=view.scrollDOM.clientWidth,result|=8);let pixelViewport=(this.printing?fullPixelRange:visiblePixelRange)(dom,this.paddingTop),dTop=pixelViewport.top-this.pixelViewport.top,dBottom=pixelViewport.bottom-this.pixelViewport.bottom;this.pixelViewport=pixelViewport;let inView=this.pixelViewport.bottom>this.pixelViewport.top&&this.pixelViewport.right>this.pixelViewport.left;if(inView!=this.inView&&(this.inView=inView,inView&&(measureContent=!0)),!this.inView&&!this.scrollTarget)return 0;let contentWidth=dom.clientWidth;if(this.contentDOMWidth==contentWidth&&this.editorHeight==view.scrollDOM.clientHeight||(this.contentDOMWidth=contentWidth,this.editorHeight=view.scrollDOM.clientHeight,result|=8),measureContent){let lineHeights=view.docView.measureVisibleLineHeights(this.viewport);if(oracle.mustRefreshForHeights(lineHeights)&&(refresh=!0),refresh||oracle.lineWrapping&&Math.abs(contentWidth-this.contentDOMWidth)>oracle.charWidth){let{lineHeight:lineHeight,charWidth:charWidth}=view.docView.measureTextSize();refresh=lineHeight>0&&oracle.refresh(whiteSpace,lineHeight,charWidth,contentWidth/charWidth,lineHeights),refresh&&(view.docView.minWidth=0,result|=8)}dTop>0&&dBottom>0?bias=Math.max(dTop,dBottom):dTop<0&&dBottom<0&&(bias=Math.min(dTop,dBottom)),oracle.heightChanged=!1;for(let vp of this.viewports){let heights=vp.from==this.viewport.from?lineHeights:view.docView.measureVisibleLineHeights(vp);this.heightMap=(refresh?HeightMap.empty().applyChanges(this.stateDeco,Text.empty,this.heightOracle,[new ChangedRange(0,0,0,view.state.doc.length)]):this.heightMap).updateHeight(oracle,0,refresh,new MeasuredHeights(vp.from,heights))}oracle.heightChanged&&(result|=2)}let viewportChange=!this.viewportIsAppropriate(this.viewport,bias)||this.scrollTarget&&(this.scrollTarget.range.head<this.viewport.from||this.scrollTarget.range.head>this.viewport.to);return viewportChange&&(this.viewport=this.getViewport(bias,this.scrollTarget)),this.updateForViewport(),(2&result||viewportChange)&&this.updateViewportLines(),(this.lineGaps.length||this.viewport.to-this.viewport.from>4e3)&&this.updateLineGaps(this.ensureLineGaps(refresh?[]:this.lineGaps,view)),result|=this.computeVisibleRanges(),this.mustEnforceCursorAssoc&&(this.mustEnforceCursorAssoc=!1,view.docView.enforceCursorAssoc()),result}get visibleTop(){return this.scaler.fromDOM(this.pixelViewport.top)}get visibleBottom(){return this.scaler.fromDOM(this.pixelViewport.bottom)}getViewport(bias,scrollTarget){let marginTop=.5-Math.max(-.5,Math.min(.5,bias/1e3/2)),map=this.heightMap,doc=this.state.doc,{visibleTop:visibleTop,visibleBottom:visibleBottom}=this,viewport=new Viewport(map.lineAt(visibleTop-1e3*marginTop,QueryType$1.ByHeight,doc,0,0).from,map.lineAt(visibleBottom+1e3*(1-marginTop),QueryType$1.ByHeight,doc,0,0).to);if(scrollTarget){let{head:head}=scrollTarget.range;if(head<viewport.from||head>viewport.to){let topPos,viewHeight=Math.min(this.editorHeight,this.pixelViewport.bottom-this.pixelViewport.top),block=map.lineAt(head,QueryType$1.ByPos,doc,0,0);topPos="center"==scrollTarget.y?(block.top+block.bottom)/2-viewHeight/2:"start"==scrollTarget.y||"nearest"==scrollTarget.y&&head<viewport.from?block.top:block.bottom-viewHeight,viewport=new Viewport(map.lineAt(topPos-500,QueryType$1.ByHeight,doc,0,0).from,map.lineAt(topPos+viewHeight+500,QueryType$1.ByHeight,doc,0,0).to)}}return viewport}mapViewport(viewport,changes){let from=changes.mapPos(viewport.from,-1),to=changes.mapPos(viewport.to,1);return new Viewport(this.heightMap.lineAt(from,QueryType$1.ByPos,this.state.doc,0,0).from,this.heightMap.lineAt(to,QueryType$1.ByPos,this.state.doc,0,0).to)}viewportIsAppropriate({from:from,to:to},bias=0){if(!this.inView)return!0;let{top:top}=this.heightMap.lineAt(from,QueryType$1.ByPos,this.state.doc,0,0),{bottom:bottom}=this.heightMap.lineAt(to,QueryType$1.ByPos,this.state.doc,0,0),{visibleTop:visibleTop,visibleBottom:visibleBottom}=this;return(0==from||top<=visibleTop-Math.max(10,Math.min(-bias,250)))&&(to==this.state.doc.length||bottom>=visibleBottom+Math.max(10,Math.min(bias,250)))&&top>visibleTop-2e3&&bottom<visibleBottom+2e3}mapLineGaps(gaps,changes){if(!gaps.length||changes.empty)return gaps;let mapped=[];for(let gap of gaps)changes.touchesRange(gap.from,gap.to)||mapped.push(new LineGap(changes.mapPos(gap.from),changes.mapPos(gap.to),gap.size));return mapped}ensureLineGaps(current,mayMeasure){let wrapping=this.heightOracle.lineWrapping,margin=wrapping?1e4:2e3,halfMargin=margin>>1,doubleMargin=margin<<1;if(this.defaultTextDirection!=Direction.LTR&&!wrapping)return[];let gaps=[],addGap=(from,to,line,structure)=>{if(to-from<halfMargin)return;let sel=this.state.selection.main,avoid=[sel.from];sel.empty||avoid.push(sel.to);for(let pos of avoid)if(pos>from&&pos<to)return addGap(from,pos-10,line,structure),void addGap(pos+10,to,line,structure);let gap=function(array,f){for(let val of array)if(f(val))return val;return}(current,(gap=>gap.from>=line.from&&gap.to<=line.to&&Math.abs(gap.from-from)<halfMargin&&Math.abs(gap.to-to)<halfMargin&&!avoid.some((pos=>gap.from<pos&&gap.to>pos))));if(!gap){if(to<line.to&&mayMeasure&&wrapping&&mayMeasure.visibleRanges.some((r=>r.from<=to&&r.to>=to))){let lineStart=mayMeasure.moveToLineBoundary(EditorSelection.cursor(to),!1,!0).head;lineStart>from&&(to=lineStart)}gap=new LineGap(from,to,this.gapSize(line,from,to,structure))}gaps.push(gap)};for(let line of this.viewportLines){if(line.length<doubleMargin)continue;let structure=lineStructure(line.from,line.to,this.stateDeco);if(structure.total<doubleMargin)continue;let viewFrom,viewTo,target=this.scrollTarget?this.scrollTarget.range.head:null;if(wrapping){let top,bot,marginHeight=margin/this.heightOracle.lineLength*this.heightOracle.lineHeight;if(null!=target){let targetFrac=findFraction(structure,target),spaceFrac=((this.visibleBottom-this.visibleTop)/2+marginHeight)/line.height;top=targetFrac-spaceFrac,bot=targetFrac+spaceFrac}else top=(this.visibleTop-line.top-marginHeight)/line.height,bot=(this.visibleBottom-line.top+marginHeight)/line.height;viewFrom=findPosition(structure,top),viewTo=findPosition(structure,bot)}else{let left,right,totalWidth=structure.total*this.heightOracle.charWidth,marginWidth=margin*this.heightOracle.charWidth;if(null!=target){let targetFrac=findFraction(structure,target),spaceFrac=((this.pixelViewport.right-this.pixelViewport.left)/2+marginWidth)/totalWidth;left=targetFrac-spaceFrac,right=targetFrac+spaceFrac}else left=(this.pixelViewport.left-marginWidth)/totalWidth,right=(this.pixelViewport.right+marginWidth)/totalWidth;viewFrom=findPosition(structure,left),viewTo=findPosition(structure,right)}viewFrom>line.from&&addGap(line.from,viewFrom,line,structure),viewTo<line.to&&addGap(viewTo,line.to,line,structure)}return gaps}gapSize(line,from,to,structure){let fraction=findFraction(structure,to)-findFraction(structure,from);return this.heightOracle.lineWrapping?line.height*fraction:structure.total*this.heightOracle.charWidth*fraction}updateLineGaps(gaps){LineGap.same(gaps,this.lineGaps)||(this.lineGaps=gaps,this.lineGapDeco=Decoration.set(gaps.map((gap=>gap.draw(this.heightOracle.lineWrapping)))))}computeVisibleRanges(){let deco=this.stateDeco;this.lineGaps.length&&(deco=deco.concat(this.lineGapDeco));let ranges=[];RangeSet.spans(deco,this.viewport.from,this.viewport.to,{span(from,to){ranges.push({from:from,to:to})},point(){}},20);let changed=ranges.length!=this.visibleRanges.length||this.visibleRanges.some(((r,i)=>r.from!=ranges[i].from||r.to!=ranges[i].to));return this.visibleRanges=ranges,changed?4:0}lineBlockAt(pos){return pos>=this.viewport.from&&pos<=this.viewport.to&&this.viewportLines.find((b=>b.from<=pos&&b.to>=pos))||scaleBlock(this.heightMap.lineAt(pos,QueryType$1.ByPos,this.state.doc,0,0),this.scaler)}lineBlockAtHeight(height){return scaleBlock(this.heightMap.lineAt(this.scaler.fromDOM(height),QueryType$1.ByHeight,this.state.doc,0,0),this.scaler)}elementAtHeight(height){return scaleBlock(this.heightMap.blockAt(this.scaler.fromDOM(height),this.state.doc,0,0),this.scaler)}get docHeight(){return this.scaler.toDOM(this.heightMap.height)}get contentHeight(){return this.docHeight+this.paddingTop+this.paddingBottom}}class Viewport{constructor(from,to){this.from=from,this.to=to}}function lineStructure(from,to,stateDeco){let ranges=[],pos=from,total=0;return RangeSet.spans(stateDeco,from,to,{span(){},point(from,to){from>pos&&(ranges.push({from:pos,to:from}),total+=from-pos),pos=to}},20),pos<to&&(ranges.push({from:pos,to:to}),total+=to-pos),{total:total,ranges:ranges}}function findPosition({total:total,ranges:ranges},ratio){if(ratio<=0)return ranges[0].from;if(ratio>=1)return ranges[ranges.length-1].to;let dist=Math.floor(total*ratio);for(let i=0;;i++){let{from:from,to:to}=ranges[i],size=to-from;if(dist<=size)return from+dist;dist-=size}}function findFraction(structure,pos){let counted=0;for(let{from:from,to:to}of structure.ranges){if(pos<=to){counted+=pos-from;break}counted+=to-from}return counted/structure.total}const IdScaler={toDOM:n=>n,fromDOM:n=>n,scale:1};class BigScaler{constructor(doc,heightMap,viewports){let vpHeight=0,base=0,domBase=0;this.viewports=viewports.map((({from:from,to:to})=>{let top=heightMap.lineAt(from,QueryType$1.ByPos,doc,0,0).top,bottom=heightMap.lineAt(to,QueryType$1.ByPos,doc,0,0).bottom;return vpHeight+=bottom-top,{from:from,to:to,top:top,bottom:bottom,domTop:0,domBottom:0}})),this.scale=(7e6-vpHeight)/(heightMap.height-vpHeight);for(let obj of this.viewports)obj.domTop=domBase+(obj.top-base)*this.scale,domBase=obj.domBottom=obj.domTop+(obj.bottom-obj.top),base=obj.bottom}toDOM(n){for(let i=0,base=0,domBase=0;;i++){let vp=i<this.viewports.length?this.viewports[i]:null;if(!vp||n<vp.top)return domBase+(n-base)*this.scale;if(n<=vp.bottom)return vp.domTop+(n-vp.top);base=vp.bottom,domBase=vp.domBottom}}fromDOM(n){for(let i=0,base=0,domBase=0;;i++){let vp=i<this.viewports.length?this.viewports[i]:null;if(!vp||n<vp.domTop)return base+(n-domBase)/this.scale;if(n<=vp.domBottom)return vp.top+(n-vp.domTop);base=vp.bottom,domBase=vp.domBottom}}}function scaleBlock(block,scaler){if(1==scaler.scale)return block;let bTop=scaler.toDOM(block.top),bBottom=scaler.toDOM(block.bottom);return new BlockInfo(block.from,block.length,bTop,bBottom-bTop,Array.isArray(block.type)?block.type.map((b=>scaleBlock(b,scaler))):block.type)}const theme$1=Facet.define({combine:strs=>strs.join(" ")}),darkTheme=Facet.define({combine:values=>values.indexOf(!0)>-1}),baseThemeID=StyleModule.newName(),baseLightID=StyleModule.newName(),baseDarkID=StyleModule.newName(),lightDarkIDs={"&light":"."+baseLightID,"&dark":"."+baseDarkID};function buildTheme(main,spec,scopes){return new StyleModule(spec,{finish:sel=>/&/.test(sel)?sel.replace(/&\w*/,(m=>{if("&"==m)return main;if(!scopes||!scopes[m])throw new RangeError(`Unsupported selector: ${m}`);return scopes[m]})):main+" "+sel})}const baseTheme$1$2=buildTheme("."+baseThemeID,{"&.cm-editor":{position:"relative !important",boxSizing:"border-box","&.cm-focused":{outline:"1px dotted #212121"},display:"flex !important",flexDirection:"column"},".cm-scroller":{display:"flex !important",alignItems:"flex-start !important",fontFamily:"monospace",lineHeight:1.4,height:"100%",overflowX:"auto",position:"relative",zIndex:0},".cm-content":{margin:0,flexGrow:2,flexShrink:0,display:"block",whiteSpace:"pre",wordWrap:"normal",boxSizing:"border-box",padding:"4px 0",outline:"none","&[contenteditable=true]":{WebkitUserModify:"read-write-plaintext-only"}},".cm-lineWrapping":{whiteSpace_fallback:"pre-wrap",whiteSpace:"break-spaces",wordBreak:"break-word",overflowWrap:"anywhere",flexShrink:1},"&light .cm-content":{caretColor:"black"},"&dark .cm-content":{caretColor:"white"},".cm-line":{display:"block",padding:"0 2px 0 6px"},".cm-layer":{contain:"size style","& > *":{position:"absolute"}},"&light .cm-selectionBackground":{background:"#d9d9d9"},"&dark .cm-selectionBackground":{background:"#222"},"&light.cm-focused .cm-selectionBackground":{background:"#d7d4f0"},"&dark.cm-focused .cm-selectionBackground":{background:"#233"},".cm-cursorLayer":{pointerEvents:"none"},"&.cm-focused .cm-cursorLayer":{animation:"steps(1) cm-blink 1.2s infinite"},"@keyframes cm-blink":{"0%":{},"50%":{opacity:0},"100%":{}},"@keyframes cm-blink2":{"0%":{},"50%":{opacity:0},"100%":{}},".cm-cursor, .cm-dropCursor":{borderLeft:"1.2px solid black",marginLeft:"-0.6px",pointerEvents:"none"},".cm-cursor":{display:"none"},"&dark .cm-cursor":{borderLeftColor:"#444"},"&.cm-focused .cm-cursor":{display:"block"},"&light .cm-activeLine":{backgroundColor:"#cceeff44"},"&dark .cm-activeLine":{backgroundColor:"#99eeff33"},"&light .cm-specialChar":{color:"red"},"&dark .cm-specialChar":{color:"#f78"},".cm-gutters":{flexShrink:0,display:"flex",height:"100%",boxSizing:"border-box",left:0,zIndex:200},"&light .cm-gutters":{backgroundColor:"#f5f5f5",color:"#6c6c6c",borderRight:"1px solid #ddd"},"&dark .cm-gutters":{backgroundColor:"#333338",color:"#ccc"},".cm-gutter":{display:"flex !important",flexDirection:"column",flexShrink:0,boxSizing:"border-box",minHeight:"100%",overflow:"hidden"},".cm-gutterElement":{boxSizing:"border-box"},".cm-lineNumbers .cm-gutterElement":{padding:"0 3px 0 5px",minWidth:"20px",textAlign:"right",whiteSpace:"nowrap"},"&light .cm-activeLineGutter":{backgroundColor:"#e2f2ff"},"&dark .cm-activeLineGutter":{backgroundColor:"#222227"},".cm-panels":{boxSizing:"border-box",position:"sticky",left:0,right:0},"&light .cm-panels":{backgroundColor:"#f5f5f5",color:"black"},"&light .cm-panels-top":{borderBottom:"1px solid #ddd"},"&light .cm-panels-bottom":{borderTop:"1px solid #ddd"},"&dark .cm-panels":{backgroundColor:"#333338",color:"white"},".cm-tab":{display:"inline-block",overflow:"hidden",verticalAlign:"bottom"},".cm-widgetBuffer":{verticalAlign:"text-top",height:"1em",width:0,display:"inline"},".cm-placeholder":{color:"#888",display:"inline-block",verticalAlign:"top"},".cm-highlightSpace:before":{content:"attr(data-display)",position:"absolute",pointerEvents:"none",color:"#888"},".cm-highlightTab":{backgroundImage:'url(\'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="20"><path stroke="%23888" stroke-width="1" fill="none" d="M1 10H196L190 5M190 15L196 10M197 4L197 16"/></svg>\')',backgroundSize:"auto 100%",backgroundPosition:"right 90%",backgroundRepeat:"no-repeat"},".cm-trailingSpace":{backgroundColor:"#ff332255"},".cm-button":{verticalAlign:"middle",color:"inherit",fontSize:"70%",padding:".2em 1em",borderRadius:"1px"},"&light .cm-button":{backgroundImage:"linear-gradient(#eff1f5, #d9d9df)",border:"1px solid #888","&:active":{backgroundImage:"linear-gradient(#b4b4b4, #d0d3d6)"}},"&dark .cm-button":{backgroundImage:"linear-gradient(#393939, #111)",border:"1px solid #888","&:active":{backgroundImage:"linear-gradient(#111, #333)"}},".cm-textfield":{verticalAlign:"middle",color:"inherit",fontSize:"70%",border:"1px solid silver",padding:".2em .5em"},"&light .cm-textfield":{backgroundColor:"white"},"&dark .cm-textfield":{border:"1px solid #555",backgroundColor:"inherit"}},lightDarkIDs);class DOMChange{constructor(view,start,end,typeOver){this.typeOver=typeOver,this.bounds=null,this.text="";let{impreciseHead:iHead,impreciseAnchor:iAnchor}=view.docView;if(view.state.readOnly&&start>-1)this.newSel=null;else if(start>-1&&(this.bounds=view.docView.domBoundsAround(start,end,0))){let selPoints=iHead||iAnchor?[]:function(view){let result=[];if(view.root.activeElement!=view.contentDOM)return result;let{anchorNode:anchorNode,anchorOffset:anchorOffset,focusNode:focusNode,focusOffset:focusOffset}=view.observer.selectionRange;anchorNode&&(result.push(new DOMPoint(anchorNode,anchorOffset)),focusNode==anchorNode&&focusOffset==anchorOffset||result.push(new DOMPoint(focusNode,focusOffset)));return result}(view),reader=new DOMReader(selPoints,view.state);reader.readRange(this.bounds.startDOM,this.bounds.endDOM),this.text=reader.text,this.newSel=function(points,base){if(0==points.length)return null;let anchor=points[0].pos,head=2==points.length?points[1].pos:anchor;return anchor>-1&&head>-1?EditorSelection.single(anchor+base,head+base):null}(selPoints,this.bounds.from)}else{let domSel=view.observer.selectionRange,head=iHead&&iHead.node==domSel.focusNode&&iHead.offset==domSel.focusOffset||!contains(view.contentDOM,domSel.focusNode)?view.state.selection.main.head:view.docView.posFromDOM(domSel.focusNode,domSel.focusOffset),anchor=iAnchor&&iAnchor.node==domSel.anchorNode&&iAnchor.offset==domSel.anchorOffset||!contains(view.contentDOM,domSel.anchorNode)?view.state.selection.main.anchor:view.docView.posFromDOM(domSel.anchorNode,domSel.anchorOffset);this.newSel=EditorSelection.single(anchor,head)}}}function applyDOMChange(view,domChange){let change,{newSel:newSel}=domChange,sel=view.state.selection.main;if(domChange.bounds){let{from:from,to:to}=domChange.bounds,preferredPos=sel.from,preferredSide=null;(8===view.inputState.lastKeyCode&&view.inputState.lastKeyTime>Date.now()-100||browser.android&&domChange.text.length<to-from)&&(preferredPos=sel.to,preferredSide="end");let diff=function(a,b,preferredPos,preferredSide){let minLen=Math.min(a.length,b.length),from=0;for(;from<minLen&&a.charCodeAt(from)==b.charCodeAt(from);)from++;if(from==minLen&&a.length==b.length)return null;let toA=a.length,toB=b.length;for(;toA>0&&toB>0&&a.charCodeAt(toA-1)==b.charCodeAt(toB-1);)toA--,toB--;if("end"==preferredSide){preferredPos-=toA+Math.max(0,from-Math.min(toA,toB))-from}if(toA<from&&a.length<b.length){from-=preferredPos<=from&&preferredPos>=toA?from-preferredPos:0,toB=from+(toB-toA),toA=from}else if(toB<from){from-=preferredPos<=from&&preferredPos>=toB?from-preferredPos:0,toA=from+(toA-toB),toB=from}return{from:from,toA:toA,toB:toB}}(view.state.doc.sliceString(from,to,"￿"),domChange.text,preferredPos-from,preferredSide);diff&&(browser.chrome&&13==view.inputState.lastKeyCode&&diff.toB==diff.from+2&&"￿￿"==domChange.text.slice(diff.from,diff.toB)&&diff.toB--,change={from:from+diff.from,to:from+diff.toA,insert:Text.of(domChange.text.slice(diff.from,diff.toB).split("￿"))})}else!newSel||view.hasFocus&&view.state.facet(editable)&&!newSel.main.eq(sel)||(newSel=null);if(!change&&!newSel)return!1;if(!change&&domChange.typeOver&&!sel.empty&&newSel&&newSel.main.empty?change={from:sel.from,to:sel.to,insert:view.state.doc.slice(sel.from,sel.to)}:change&&change.from>=sel.from&&change.to<=sel.to&&(change.from!=sel.from||change.to!=sel.to)&&sel.to-sel.from-(change.to-change.from)<=4?change={from:sel.from,to:sel.to,insert:view.state.doc.slice(sel.from,change.from).append(change.insert).append(view.state.doc.slice(change.to,sel.to))}:(browser.mac||browser.android)&&change&&change.from==change.to&&change.from==sel.head-1&&/^\. ?$/.test(change.insert.toString())?(newSel&&2==change.insert.length&&(newSel=EditorSelection.single(newSel.main.anchor-1,newSel.main.head-1)),change={from:sel.from,to:sel.to,insert:Text.of([" "])}):browser.chrome&&change&&change.from==change.to&&change.from==sel.head&&"\n "==change.insert.toString()&&view.lineWrapping&&(newSel&&(newSel=EditorSelection.single(newSel.main.anchor-1,newSel.main.head-1)),change={from:sel.from,to:sel.to,insert:Text.of([" "])}),change){let startState=view.state;if(browser.ios&&view.inputState.flushIOSKey(view))return!0;if(browser.android&&(change.from==sel.from&&change.to==sel.to&&1==change.insert.length&&2==change.insert.lines&&dispatchKey(view.contentDOM,"Enter",13)||change.from==sel.from-1&&change.to==sel.to&&0==change.insert.length&&dispatchKey(view.contentDOM,"Backspace",8)||change.from==sel.from&&change.to==sel.to+1&&0==change.insert.length&&dispatchKey(view.contentDOM,"Delete",46)))return!0;let tr,text=change.insert.toString();if(view.state.facet(inputHandler$1).some((h=>h(view,change.from,change.to,text))))return!0;if(view.inputState.composing>=0&&view.inputState.composing++,change.from>=sel.from&&change.to<=sel.to&&change.to-change.from>=(sel.to-sel.from)/3&&(!newSel||newSel.main.empty&&newSel.main.from==change.from+change.insert.length)&&view.inputState.composing<0){let before=sel.from<change.from?startState.sliceDoc(sel.from,change.from):"",after=sel.to>change.to?startState.sliceDoc(change.to,sel.to):"";tr=startState.replaceSelection(view.state.toText(before+change.insert.sliceString(0,void 0,view.state.lineBreak)+after))}else{let changes=startState.changes(change),mainSel=newSel&&!startState.selection.main.eq(newSel.main)&&newSel.main.to<=changes.newLength?newSel.main:void 0;if(startState.selection.ranges.length>1&&view.inputState.composing>=0&&change.to<=sel.to&&change.to>=sel.to-10){let replaced=view.state.sliceDoc(change.from,change.to),compositionRange=compositionSurroundingNode(view)||view.state.doc.lineAt(sel.head),offset=sel.to-change.to,size=sel.to-sel.from;tr=startState.changeByRange((range=>{if(range.from==sel.from&&range.to==sel.to)return{changes:changes,range:mainSel||range.map(changes)};let to=range.to-offset,from=to-replaced.length;if(range.to-range.from!=size||view.state.sliceDoc(from,to)!=replaced||compositionRange&&range.to>=compositionRange.from&&range.from<=compositionRange.to)return{range:range};let rangeChanges=startState.changes({from:from,to:to,insert:change.insert}),selOff=range.to-sel.to;return{changes:rangeChanges,range:mainSel?EditorSelection.range(Math.max(0,mainSel.anchor+selOff),Math.max(0,mainSel.head+selOff)):range.map(rangeChanges)}}))}else tr={changes:changes,selection:mainSel&&startState.selection.replaceRange(mainSel)}}let userEvent="input.type";return view.composing&&(userEvent+=".compose",view.inputState.compositionFirstChange&&(userEvent+=".start",view.inputState.compositionFirstChange=!1)),view.dispatch(tr,{scrollIntoView:!0,userEvent:userEvent}),!0}if(newSel&&!newSel.main.eq(sel)){let scrollIntoView=!1,userEvent="select";return view.inputState.lastSelectionTime>Date.now()-50&&("select"==view.inputState.lastSelectionOrigin&&(scrollIntoView=!0),userEvent=view.inputState.lastSelectionOrigin),view.dispatch({selection:newSel,scrollIntoView:scrollIntoView,userEvent:userEvent}),!0}return!1}const observeOptions={childList:!0,characterData:!0,subtree:!0,attributes:!0,characterDataOldValue:!0},useCharData=browser.ie&&browser.ie_version<=11;class DOMObserver{constructor(view){this.view=view,this.active=!1,this.selectionRange=new DOMSelectionState,this.selectionChanged=!1,this.delayedFlush=-1,this.resizeTimeout=-1,this.queue=[],this.delayedAndroidKey=null,this.flushingAndroidKey=-1,this.lastChange=0,this.scrollTargets=[],this.intersection=null,this.resizeScroll=null,this.resizeContent=null,this.intersecting=!1,this.gapIntersection=null,this.gaps=[],this.parentCheck=-1,this.dom=view.contentDOM,this.observer=new MutationObserver((mutations=>{for(let mut of mutations)this.queue.push(mut);(browser.ie&&browser.ie_version<=11||browser.ios&&view.composing)&&mutations.some((m=>"childList"==m.type&&m.removedNodes.length||"characterData"==m.type&&m.oldValue.length>m.target.nodeValue.length))?this.flushSoon():this.flush()})),useCharData&&(this.onCharData=event=>{this.queue.push({target:event.target,type:"characterData",oldValue:event.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this),this.onResize=this.onResize.bind(this),this.onPrint=this.onPrint.bind(this),this.onScroll=this.onScroll.bind(this),"function"==typeof ResizeObserver&&(this.resizeScroll=new ResizeObserver((()=>{var _a;(null===(_a=this.view.docView)||void 0===_a?void 0:_a.lastUpdate)<Date.now()-75&&this.onResize()})),this.resizeScroll.observe(view.scrollDOM),this.resizeContent=new ResizeObserver((()=>this.view.requestMeasure())),this.resizeContent.observe(view.contentDOM)),this.addWindowListeners(this.win=view.win),this.start(),"function"==typeof IntersectionObserver&&(this.intersection=new IntersectionObserver((entries=>{this.parentCheck<0&&(this.parentCheck=setTimeout(this.listenForScroll.bind(this),1e3)),entries.length>0&&entries[entries.length-1].intersectionRatio>0!=this.intersecting&&(this.intersecting=!this.intersecting,this.intersecting!=this.view.inView&&this.onScrollChanged(document.createEvent("Event")))}),{}),this.intersection.observe(this.dom),this.gapIntersection=new IntersectionObserver((entries=>{entries.length>0&&entries[entries.length-1].intersectionRatio>0&&this.onScrollChanged(document.createEvent("Event"))}),{})),this.listenForScroll(),this.readSelectionRange()}onScrollChanged(e){this.view.inputState.runScrollHandlers(this.view,e),this.intersecting&&this.view.measure()}onScroll(e){this.intersecting&&this.flush(!1),this.onScrollChanged(e)}onResize(){this.resizeTimeout<0&&(this.resizeTimeout=setTimeout((()=>{this.resizeTimeout=-1,this.view.requestMeasure()}),50))}onPrint(){this.view.viewState.printing=!0,this.view.measure(),setTimeout((()=>{this.view.viewState.printing=!1,this.view.requestMeasure()}),500)}updateGaps(gaps){if(this.gapIntersection&&(gaps.length!=this.gaps.length||this.gaps.some(((g,i)=>g!=gaps[i])))){this.gapIntersection.disconnect();for(let gap of gaps)this.gapIntersection.observe(gap);this.gaps=gaps}}onSelectionChange(event){let wasChanged=this.selectionChanged;if(!this.readSelectionRange()||this.delayedAndroidKey)return;let{view:view}=this,sel=this.selectionRange;if(view.state.facet(editable)?view.root.activeElement!=this.dom:!hasSelection(view.dom,sel))return;let context=sel.anchorNode&&view.docView.nearest(sel.anchorNode);context&&context.ignoreEvent(event)?wasChanged||(this.selectionChanged=!1):(browser.ie&&browser.ie_version<=11||browser.android&&browser.chrome)&&!view.state.selection.main.empty&&sel.focusNode&&isEquivalentPosition(sel.focusNode,sel.focusOffset,sel.anchorNode,sel.anchorOffset)?this.flushSoon():this.flush(!1)}readSelectionRange(){let{view:view}=this,range=browser.safari&&11==view.root.nodeType&&function(doc){let elt=doc.activeElement;for(;elt&&elt.shadowRoot;)elt=elt.shadowRoot.activeElement;return elt}(this.dom.ownerDocument)==this.dom&&function(view){let found=null;function read(event){event.preventDefault(),event.stopImmediatePropagation(),found=event.getTargetRanges()[0]}if(view.contentDOM.addEventListener("beforeinput",read,!0),view.dom.ownerDocument.execCommand("indent"),view.contentDOM.removeEventListener("beforeinput",read,!0),!found)return null;let anchorNode=found.startContainer,anchorOffset=found.startOffset,focusNode=found.endContainer,focusOffset=found.endOffset,curAnchor=view.docView.domAtPos(view.state.selection.main.anchor);isEquivalentPosition(curAnchor.node,curAnchor.offset,focusNode,focusOffset)&&([anchorNode,anchorOffset,focusNode,focusOffset]=[focusNode,focusOffset,anchorNode,anchorOffset]);return{anchorNode:anchorNode,anchorOffset:anchorOffset,focusNode:focusNode,focusOffset:focusOffset}}(this.view)||getSelection(view.root);if(!range||this.selectionRange.eq(range))return!1;let local=hasSelection(this.dom,range);return local&&!this.selectionChanged&&view.inputState.lastFocusTime>Date.now()-200&&view.inputState.lastTouchTime<Date.now()-300&&function(doc,selection){let node=selection.focusNode,offset=selection.focusOffset;if(!node||selection.anchorNode!=node||selection.anchorOffset!=offset)return!1;for(;;)if(offset){if(1!=node.nodeType)return!1;let prev=node.childNodes[offset-1];"false"==prev.contentEditable?offset--:(node=prev,offset=maxOffset(node))}else{if(node==doc)return!0;offset=domIndex(node),node=node.parentNode}}(this.dom,range)?(this.view.inputState.lastFocusTime=0,view.docView.updateSelection(),!1):(this.selectionRange.setRange(range),local&&(this.selectionChanged=!0),!0)}setSelectionRange(anchor,head){this.selectionRange.set(anchor.node,anchor.offset,head.node,head.offset),this.selectionChanged=!1}clearSelectionRange(){this.selectionRange.set(null,0,null,0)}listenForScroll(){this.parentCheck=-1;let i=0,changed=null;for(let dom=this.dom;dom;)if(1==dom.nodeType)!changed&&i<this.scrollTargets.length&&this.scrollTargets[i]==dom?i++:changed||(changed=this.scrollTargets.slice(0,i)),changed&&changed.push(dom),dom=dom.assignedSlot||dom.parentNode;else{if(11!=dom.nodeType)break;dom=dom.host}if(i<this.scrollTargets.length&&!changed&&(changed=this.scrollTargets.slice(0,i)),changed){for(let dom of this.scrollTargets)dom.removeEventListener("scroll",this.onScroll);for(let dom of this.scrollTargets=changed)dom.addEventListener("scroll",this.onScroll)}}ignore(f){if(!this.active)return f();try{return this.stop(),f()}finally{this.start(),this.clear()}}start(){this.active||(this.observer.observe(this.dom,observeOptions),useCharData&&this.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.active=!0)}stop(){this.active&&(this.active=!1,this.observer.disconnect(),useCharData&&this.dom.removeEventListener("DOMCharacterDataModified",this.onCharData))}clear(){this.processRecords(),this.queue.length=0,this.selectionChanged=!1}delayAndroidKey(key,keyCode){var _a;if(!this.delayedAndroidKey){let flush=()=>{let key=this.delayedAndroidKey;key&&(this.clearDelayedAndroidKey(),!this.flush()&&key.force&&dispatchKey(this.dom,key.key,key.keyCode))};this.flushingAndroidKey=this.view.win.requestAnimationFrame(flush)}this.delayedAndroidKey&&"Enter"!=key||(this.delayedAndroidKey={key:key,keyCode:keyCode,force:this.lastChange<Date.now()-50||!!(null===(_a=this.delayedAndroidKey)||void 0===_a?void 0:_a.force)})}clearDelayedAndroidKey(){this.win.cancelAnimationFrame(this.flushingAndroidKey),this.delayedAndroidKey=null,this.flushingAndroidKey=-1}flushSoon(){this.delayedFlush<0&&(this.delayedFlush=this.view.win.requestAnimationFrame((()=>{this.delayedFlush=-1,this.flush()})))}forceFlush(){this.delayedFlush>=0&&(this.view.win.cancelAnimationFrame(this.delayedFlush),this.delayedFlush=-1),this.flush()}processRecords(){let records=this.queue;for(let mut of this.observer.takeRecords())records.push(mut);records.length&&(this.queue=[]);let from=-1,to=-1,typeOver=!1;for(let record of records){let range=this.readMutation(record);range&&(range.typeOver&&(typeOver=!0),-1==from?({from:from,to:to}=range):(from=Math.min(range.from,from),to=Math.max(range.to,to)))}return{from:from,to:to,typeOver:typeOver}}readChange(){let{from:from,to:to,typeOver:typeOver}=this.processRecords(),newSel=this.selectionChanged&&hasSelection(this.dom,this.selectionRange);return from<0&&!newSel?null:(from>-1&&(this.lastChange=Date.now()),this.view.inputState.lastFocusTime=0,this.selectionChanged=!1,new DOMChange(this.view,from,to,typeOver))}flush(readSelection=!0){if(this.delayedFlush>=0||this.delayedAndroidKey)return!1;readSelection&&this.readSelectionRange();let domChange=this.readChange();if(!domChange)return!1;let startState=this.view.state,handled=applyDOMChange(this.view,domChange);return this.view.state==startState&&this.view.update([]),handled}readMutation(rec){let cView=this.view.docView.nearest(rec.target);if(!cView||cView.ignoreMutation(rec))return null;if(cView.markDirty("attributes"==rec.type),"attributes"==rec.type&&(cView.dirty|=4),"childList"==rec.type){let childBefore=findChild(cView,rec.previousSibling||rec.target.previousSibling,-1),childAfter=findChild(cView,rec.nextSibling||rec.target.nextSibling,1);return{from:childBefore?cView.posAfter(childBefore):cView.posAtStart,to:childAfter?cView.posBefore(childAfter):cView.posAtEnd,typeOver:!1}}return"characterData"==rec.type?{from:cView.posAtStart,to:cView.posAtEnd,typeOver:rec.target.nodeValue==rec.oldValue}:null}setWindow(win){win!=this.win&&(this.removeWindowListeners(this.win),this.win=win,this.addWindowListeners(this.win))}addWindowListeners(win){win.addEventListener("resize",this.onResize),win.addEventListener("beforeprint",this.onPrint),win.addEventListener("scroll",this.onScroll),win.document.addEventListener("selectionchange",this.onSelectionChange)}removeWindowListeners(win){win.removeEventListener("scroll",this.onScroll),win.removeEventListener("resize",this.onResize),win.removeEventListener("beforeprint",this.onPrint),win.document.removeEventListener("selectionchange",this.onSelectionChange)}destroy(){var _a,_b,_c,_d;this.stop(),null===(_a=this.intersection)||void 0===_a||_a.disconnect(),null===(_b=this.gapIntersection)||void 0===_b||_b.disconnect(),null===(_c=this.resizeScroll)||void 0===_c||_c.disconnect(),null===(_d=this.resizeContent)||void 0===_d||_d.disconnect();for(let dom of this.scrollTargets)dom.removeEventListener("scroll",this.onScroll);this.removeWindowListeners(this.win),clearTimeout(this.parentCheck),clearTimeout(this.resizeTimeout),this.win.cancelAnimationFrame(this.delayedFlush),this.win.cancelAnimationFrame(this.flushingAndroidKey)}}function findChild(cView,dom,dir){for(;dom;){let curView=ContentView.get(dom);if(curView&&curView.parent==cView)return curView;let parent=dom.parentNode;dom=parent!=cView.dom?parent:dir>0?dom.nextSibling:dom.previousSibling}return null}class EditorView{constructor(config={}){this.plugins=[],this.pluginMap=new Map,this.editorAttrs={},this.contentAttrs={},this.bidiCache=[],this.destroyed=!1,this.updateState=2,this.measureScheduled=-1,this.measureRequests=[],this.contentDOM=document.createElement("div"),this.scrollDOM=document.createElement("div"),this.scrollDOM.tabIndex=-1,this.scrollDOM.className="cm-scroller",this.scrollDOM.appendChild(this.contentDOM),this.announceDOM=document.createElement("div"),this.announceDOM.style.cssText="position: fixed; top: -10000px",this.announceDOM.setAttribute("aria-live","polite"),this.dom=document.createElement("div"),this.dom.appendChild(this.announceDOM),this.dom.appendChild(this.scrollDOM),this._dispatch=config.dispatch||(tr=>this.update([tr])),this.dispatch=this.dispatch.bind(this),this._root=config.root||function(node){for(;node;){if(node&&(9==node.nodeType||11==node.nodeType&&node.host))return node;node=node.assignedSlot||node.parentNode}return null}(config.parent)||document,this.viewState=new ViewState(config.state||EditorState.create(config)),this.plugins=this.state.facet(viewPlugin).map((spec=>new PluginInstance(spec)));for(let plugin of this.plugins)plugin.update(this);this.observer=new DOMObserver(this),this.inputState=new InputState(this),this.inputState.ensureHandlers(this,this.plugins),this.docView=new DocView(this),this.mountStyles(),this.updateAttrs(),this.updateState=0,this.requestMeasure(),config.parent&&config.parent.appendChild(this.dom)}get state(){return this.viewState.state}get viewport(){return this.viewState.viewport}get visibleRanges(){return this.viewState.visibleRanges}get inView(){return this.viewState.inView}get composing(){return this.inputState.composing>0}get compositionStarted(){return this.inputState.composing>=0}get root(){return this._root}get win(){return this.dom.ownerDocument.defaultView||window}dispatch(...input){this._dispatch(1==input.length&&input[0]instanceof Transaction?input[0]:this.state.update(...input))}update(transactions){if(0!=this.updateState)throw new Error("Calls to EditorView.update are not allowed while an update is in progress");let update,redrawn=!1,attrsChanged=!1,state=this.state;for(let tr of transactions){if(tr.startState!=state)throw new RangeError("Trying to update state with a transaction that doesn't start from the previous state.");state=tr.state}if(this.destroyed)return void(this.viewState.state=state);let pendingKey=this.observer.delayedAndroidKey,domChange=null;if(pendingKey?(this.observer.clearDelayedAndroidKey(),domChange=this.observer.readChange(),(domChange&&!this.state.doc.eq(state.doc)||!this.state.selection.eq(state.selection))&&(domChange=null)):this.observer.clear(),state.facet(EditorState.phrases)!=this.state.facet(EditorState.phrases))return this.setState(state);update=ViewUpdate.create(this,state,transactions);let scrollTarget=this.viewState.scrollTarget;try{this.updateState=2;for(let tr of transactions){if(scrollTarget&&(scrollTarget=scrollTarget.map(tr.changes)),tr.scrollIntoView){let{main:main}=tr.state.selection;scrollTarget=new ScrollTarget(main.empty?main:EditorSelection.cursor(main.head,main.head>main.anchor?-1:1))}for(let e of tr.effects)e.is(scrollIntoView)&&(scrollTarget=e.value)}this.viewState.update(update,scrollTarget),this.bidiCache=CachedOrder.update(this.bidiCache,update.changes),update.empty||(this.updatePlugins(update),this.inputState.update(update)),redrawn=this.docView.update(update),this.state.facet(styleModule)!=this.styleModules&&this.mountStyles(),attrsChanged=this.updateAttrs(),this.showAnnouncements(transactions),this.docView.updateSelection(redrawn,transactions.some((tr=>tr.isUserEvent("select.pointer"))))}finally{this.updateState=0}if(update.startState.facet(theme$1)!=update.state.facet(theme$1)&&(this.viewState.mustMeasureContent=!0),(redrawn||attrsChanged||scrollTarget||this.viewState.mustEnforceCursorAssoc||this.viewState.mustMeasureContent)&&this.requestMeasure(),!update.empty)for(let listener of this.state.facet(updateListener))listener(update);domChange&&!applyDOMChange(this,domChange)&&pendingKey.force&&dispatchKey(this.contentDOM,pendingKey.key,pendingKey.keyCode)}setState(newState){if(0!=this.updateState)throw new Error("Calls to EditorView.setState are not allowed while an update is in progress");if(this.destroyed)return void(this.viewState.state=newState);this.updateState=2;let hadFocus=this.hasFocus;try{for(let plugin of this.plugins)plugin.destroy(this);this.viewState=new ViewState(newState),this.plugins=newState.facet(viewPlugin).map((spec=>new PluginInstance(spec))),this.pluginMap.clear();for(let plugin of this.plugins)plugin.update(this);this.docView=new DocView(this),this.inputState.ensureHandlers(this,this.plugins),this.mountStyles(),this.updateAttrs(),this.bidiCache=[]}finally{this.updateState=0}hadFocus&&this.focus(),this.requestMeasure()}updatePlugins(update){let prevSpecs=update.startState.facet(viewPlugin),specs=update.state.facet(viewPlugin);if(prevSpecs!=specs){let newPlugins=[];for(let spec of specs){let found=prevSpecs.indexOf(spec);if(found<0)newPlugins.push(new PluginInstance(spec));else{let plugin=this.plugins[found];plugin.mustUpdate=update,newPlugins.push(plugin)}}for(let plugin of this.plugins)plugin.mustUpdate!=update&&plugin.destroy(this);this.plugins=newPlugins,this.pluginMap.clear(),this.inputState.ensureHandlers(this,this.plugins)}else for(let p of this.plugins)p.mustUpdate=update;for(let i=0;i<this.plugins.length;i++)this.plugins[i].update(this)}measure(flush=!0){if(this.destroyed)return;this.measureScheduled>-1&&cancelAnimationFrame(this.measureScheduled),this.measureScheduled=0,flush&&this.observer.forceFlush();let updated=null,{scrollHeight:scrollHeight,scrollTop:scrollTop,clientHeight:clientHeight}=this.scrollDOM,refHeight=scrollTop>scrollHeight-clientHeight-4?scrollHeight:scrollTop;try{for(let i=0;;i++){this.updateState=1;let oldViewport=this.viewport,refBlock=this.viewState.lineBlockAtHeight(refHeight),changed=this.viewState.measure(this);if(!changed&&!this.measureRequests.length&&null==this.viewState.scrollTarget)break;if(i>5){console.warn(this.measureRequests.length?"Measure loop restarted more than 5 times":"Viewport failed to stabilize");break}let measuring=[];4&changed||([this.measureRequests,measuring]=[measuring,this.measureRequests]);let measured=measuring.map((m=>{try{return m.read(this)}catch(e){return logException(this.state,e),BadMeasure}})),update=ViewUpdate.create(this,this.state,[]),redrawn=!1,scrolled=!1;update.flags|=changed,updated?updated.flags|=changed:updated=update,this.updateState=2,update.empty||(this.updatePlugins(update),this.inputState.update(update),this.updateAttrs(),redrawn=this.docView.update(update));for(let i=0;i<measuring.length;i++)if(measured[i]!=BadMeasure)try{let m=measuring[i];m.write&&m.write(measured[i],this)}catch(e){logException(this.state,e)}if(this.viewState.editorHeight)if(this.viewState.scrollTarget)this.docView.scrollIntoView(this.viewState.scrollTarget),this.viewState.scrollTarget=null,scrolled=!0;else{let diff=this.viewState.lineBlockAt(refBlock.from).top-refBlock.top;(diff>1||diff<-1)&&(this.scrollDOM.scrollTop+=diff,scrolled=!0)}if(redrawn&&this.docView.updateSelection(!0),this.viewport.from==oldViewport.from&&this.viewport.to==oldViewport.to&&!scrolled&&0==this.measureRequests.length)break}}finally{this.updateState=0,this.measureScheduled=-1}if(updated&&!updated.empty)for(let listener of this.state.facet(updateListener))listener(updated)}get themeClasses(){return baseThemeID+" "+(this.state.facet(darkTheme)?baseDarkID:baseLightID)+" "+this.state.facet(theme$1)}updateAttrs(){let editorAttrs=attrsFromFacet(this,editorAttributes,{class:"cm-editor"+(this.hasFocus?" cm-focused ":" ")+this.themeClasses}),contentAttrs={spellcheck:"false",autocorrect:"off",autocapitalize:"off",translate:"no",contenteditable:this.state.facet(editable)?"true":"false",class:"cm-content",style:`${browser.tabSize}: ${this.state.tabSize}`,role:"textbox","aria-multiline":"true"};this.state.readOnly&&(contentAttrs["aria-readonly"]="true"),attrsFromFacet(this,contentAttributes,contentAttrs);let changed=this.observer.ignore((()=>{let changedContent=updateAttrs(this.contentDOM,this.contentAttrs,contentAttrs),changedEditor=updateAttrs(this.dom,this.editorAttrs,editorAttrs);return changedContent||changedEditor}));return this.editorAttrs=editorAttrs,this.contentAttrs=contentAttrs,changed}showAnnouncements(trs){let first=!0;for(let tr of trs)for(let effect of tr.effects)if(effect.is(EditorView.announce)){first&&(this.announceDOM.textContent=""),first=!1,this.announceDOM.appendChild(document.createElement("div")).textContent=effect.value}}mountStyles(){this.styleModules=this.state.facet(styleModule),StyleModule.mount(this.root,this.styleModules.concat(baseTheme$1$2).reverse())}readMeasured(){if(2==this.updateState)throw new Error("Reading the editor layout isn't allowed during an update");0==this.updateState&&this.measureScheduled>-1&&this.measure(!1)}requestMeasure(request){if(this.measureScheduled<0&&(this.measureScheduled=this.win.requestAnimationFrame((()=>this.measure()))),request){if(null!=request.key)for(let i=0;i<this.measureRequests.length;i++)if(this.measureRequests[i].key===request.key)return void(this.measureRequests[i]=request);this.measureRequests.push(request)}}plugin(plugin){let known=this.pluginMap.get(plugin);return(void 0===known||known&&known.spec!=plugin)&&this.pluginMap.set(plugin,known=this.plugins.find((p=>p.spec==plugin))||null),known&&known.update(this).value}get documentTop(){return this.contentDOM.getBoundingClientRect().top+this.viewState.paddingTop}get documentPadding(){return{top:this.viewState.paddingTop,bottom:this.viewState.paddingBottom}}elementAtHeight(height){return this.readMeasured(),this.viewState.elementAtHeight(height)}lineBlockAtHeight(height){return this.readMeasured(),this.viewState.lineBlockAtHeight(height)}get viewportLineBlocks(){return this.viewState.viewportLines}lineBlockAt(pos){return this.viewState.lineBlockAt(pos)}get contentHeight(){return this.viewState.contentHeight}moveByChar(start,forward,by){return skipAtoms(this,start,moveByChar(this,start,forward,by))}moveByGroup(start,forward){return skipAtoms(this,start,moveByChar(this,start,forward,(initial=>function(view,pos,start){let categorize=view.state.charCategorizer(pos),cat=categorize(start);return next=>{let nextCat=categorize(next);return cat==CharCategory.Space&&(cat=nextCat),cat==nextCat}}(this,start.head,initial))))}moveToLineBoundary(start,forward,includeWrap=!0){return function(view,start,forward,includeWrap){let line=view.state.doc.lineAt(start.head),coords=includeWrap&&view.lineWrapping?view.coordsAtPos(start.assoc<0&&start.head>line.from?start.head-1:start.head):null;if(coords){let editorRect=view.dom.getBoundingClientRect(),direction=view.textDirectionAt(line.from),pos=view.posAtCoords({x:forward==(direction==Direction.LTR)?editorRect.right-1:editorRect.left+1,y:(coords.top+coords.bottom)/2});if(null!=pos)return EditorSelection.cursor(pos,forward?-1:1)}let lineView=LineView.find(view.docView,start.head),end=lineView?forward?lineView.posAtEnd:lineView.posAtStart:forward?line.to:line.from;return EditorSelection.cursor(end,forward?-1:1)}(this,start,forward,includeWrap)}moveVertically(start,forward,distance){return skipAtoms(this,start,function(view,start,forward,distance){let startPos=start.head,dir=forward?1:-1;if(startPos==(forward?view.state.doc.length:0))return EditorSelection.cursor(startPos,start.assoc);let startY,goal=start.goalColumn,rect=view.contentDOM.getBoundingClientRect(),startCoords=view.coordsAtPos(startPos),docTop=view.documentTop;if(startCoords)null==goal&&(goal=startCoords.left-rect.left),startY=dir<0?startCoords.top:startCoords.bottom;else{let line=view.viewState.lineBlockAt(startPos);null==goal&&(goal=Math.min(rect.right-rect.left,view.defaultCharacterWidth*(startPos-line.from))),startY=(dir<0?line.top:line.bottom)+docTop}let resolvedGoal=rect.left+goal,dist=null!=distance?distance:view.defaultLineHeight>>1;for(let extra=0;;extra+=10){let curY=startY+(dist+extra)*dir,pos=posAtCoords(view,{x:resolvedGoal,y:curY},!1,dir);if(curY<rect.top||curY>rect.bottom||(dir<0?pos<startPos:pos>startPos))return EditorSelection.cursor(pos,start.assoc,void 0,goal)}}(this,start,forward,distance))}domAtPos(pos){return this.docView.domAtPos(pos)}posAtDOM(node,offset=0){return this.docView.posFromDOM(node,offset)}posAtCoords(coords,precise=!0){return this.readMeasured(),posAtCoords(this,coords,precise)}coordsAtPos(pos,side=1){this.readMeasured();let rect=this.docView.coordsAt(pos,side);if(!rect||rect.left==rect.right)return rect;let line=this.state.doc.lineAt(pos),order=this.bidiSpans(line);return flattenRect(rect,order[BidiSpan.find(order,pos-line.from,-1,side)].dir==Direction.LTR==side>0)}get defaultCharacterWidth(){return this.viewState.heightOracle.charWidth}get defaultLineHeight(){return this.viewState.heightOracle.lineHeight}get textDirection(){return this.viewState.defaultTextDirection}textDirectionAt(pos){return!this.state.facet(perLineTextDirection)||pos<this.viewport.from||pos>this.viewport.to?this.textDirection:(this.readMeasured(),this.docView.textDirectionAt(pos))}get lineWrapping(){return this.viewState.heightOracle.lineWrapping}bidiSpans(line){if(line.length>MaxBidiLine)return trivialOrder(line.length);let dir=this.textDirectionAt(line.from);for(let entry of this.bidiCache)if(entry.from==line.from&&entry.dir==dir)return entry.order;let order=function(line,direction){let len=line.length,outerType=direction==LTR?1:2,oppositeType=direction==LTR?2:1;if(!line||1==outerType&&!BidiRE.test(line))return trivialOrder(len);for(let i=0,prev=outerType,prevStrong=outerType;i<len;i++){let type=(ch=line.charCodeAt(i))<=247?LowTypes[ch]:1424<=ch&&ch<=1524?2:1536<=ch&&ch<=1785?ArabicTypes[ch-1536]:1774<=ch&&ch<=2220?4:8192<=ch&&ch<=8203?256:64336<=ch&&ch<=65023?4:8204==ch?256:1;512==type?type=prev:8==type&&4==prevStrong&&(type=16),types[i]=4==type?2:type,7&type&&(prevStrong=type),prev=type}var ch;for(let i=0,prev=outerType,prevStrong=outerType;i<len;i++){let type=types[i];if(128==type)i<len-1&&prev==types[i+1]&&24&prev?type=types[i]=prev:types[i]=256;else if(64==type){let end=i+1;for(;end<len&&64==types[end];)end++;let replace=i&&8==prev||end<len&&8==types[end]?1==prevStrong?1:8:256;for(let j=i;j<end;j++)types[j]=replace;i=end-1}else 8==type&&1==prevStrong&&(types[i]=1);prev=type,7&type&&(prevStrong=type)}for(let ch,br,type,i=0,sI=0,context=0;i<len;i++)if(br=Brackets[ch=line.charCodeAt(i)])if(br<0){for(let sJ=sI-3;sJ>=0;sJ-=3)if(BracketStack[sJ+1]==-br){let flags=BracketStack[sJ+2],type=2&flags?outerType:4&flags?1&flags?oppositeType:outerType:0;type&&(types[i]=types[BracketStack[sJ]]=type),sI=sJ;break}}else{if(189==BracketStack.length)break;BracketStack[sI++]=i,BracketStack[sI++]=ch,BracketStack[sI++]=context}else if(2==(type=types[i])||1==type){let embed=type==outerType;context=embed?0:1;for(let sJ=sI-3;sJ>=0;sJ-=3){let cur=BracketStack[sJ+2];if(2&cur)break;if(embed)BracketStack[sJ+2]|=2;else{if(4&cur)break;BracketStack[sJ+2]|=4}}}for(let i=0;i<len;i++)if(256==types[i]){let end=i+1;for(;end<len&&256==types[end];)end++;let beforeL=1==(i?types[i-1]:outerType),replace=beforeL==(1==(end<len?types[end]:outerType))?beforeL?1:2:outerType;for(let j=i;j<end;j++)types[j]=replace;i=end-1}let order=[];if(1==outerType)for(let i=0;i<len;){let start=i,rtl=1!=types[i++];for(;i<len&&rtl==(1!=types[i]);)i++;if(rtl)for(let j=i;j>start;){let end=j,l=2!=types[--j];for(;j>start&&l==(2!=types[j-1]);)j--;order.push(new BidiSpan(j,end,l?2:1))}else order.push(new BidiSpan(start,i,0))}else for(let i=0;i<len;){let start=i,rtl=2==types[i++];for(;i<len&&rtl==(2==types[i]);)i++;order.push(new BidiSpan(start,i,rtl?1:2))}return order}(line.text,dir);return this.bidiCache.push(new CachedOrder(line.from,line.to,dir,order)),order}get hasFocus(){var _a;return(this.dom.ownerDocument.hasFocus()||browser.safari&&(null===(_a=this.inputState)||void 0===_a?void 0:_a.lastContextMenu)>Date.now()-3e4)&&this.root.activeElement==this.contentDOM}focus(){this.observer.ignore((()=>{focusPreventScroll(this.contentDOM),this.docView.updateSelection()}))}setRoot(root){this._root!=root&&(this._root=root,this.observer.setWindow((9==root.nodeType?root:root.ownerDocument).defaultView||window),this.mountStyles())}destroy(){for(let plugin of this.plugins)plugin.destroy(this);this.plugins=[],this.inputState.destroy(),this.dom.remove(),this.observer.destroy(),this.measureScheduled>-1&&cancelAnimationFrame(this.measureScheduled),this.destroyed=!0}static scrollIntoView(pos,options={}){return scrollIntoView.of(new ScrollTarget("number"==typeof pos?EditorSelection.cursor(pos):pos,options.y,options.x,options.yMargin,options.xMargin))}static domEventHandlers(handlers){return ViewPlugin.define((()=>({})),{eventHandlers:handlers})}static theme(spec,options){let prefix=StyleModule.newName(),result=[theme$1.of(prefix),styleModule.of(buildTheme(`.${prefix}`,spec))];return options&&options.dark&&result.push(darkTheme.of(!0)),result}static baseTheme(spec){return Prec.lowest(styleModule.of(buildTheme("."+baseThemeID,spec,lightDarkIDs)))}static findFromDOM(dom){var _a;let content=dom.querySelector(".cm-content"),cView=content&&ContentView.get(content)||ContentView.get(dom);return(null===(_a=null==cView?void 0:cView.rootView)||void 0===_a?void 0:_a.view)||null}}EditorView.styleModule=styleModule,EditorView.inputHandler=inputHandler$1,EditorView.perLineTextDirection=perLineTextDirection,EditorView.exceptionSink=exceptionSink,EditorView.updateListener=updateListener,EditorView.editable=editable,EditorView.mouseSelectionStyle=mouseSelectionStyle,EditorView.dragMovesSelection=dragMovesSelection$1,EditorView.clickAddsSelectionRange=clickAddsSelectionRange,EditorView.decorations=decorations,EditorView.atomicRanges=atomicRanges,EditorView.scrollMargins=scrollMargins,EditorView.darkTheme=darkTheme,EditorView.contentAttributes=contentAttributes,EditorView.editorAttributes=editorAttributes,EditorView.lineWrapping=EditorView.contentAttributes.of({class:"cm-lineWrapping"}),EditorView.announce=StateEffect.define();const MaxBidiLine=4096,BadMeasure={};class CachedOrder{constructor(from,to,dir,order){this.from=from,this.to=to,this.dir=dir,this.order=order}static update(cache,changes){if(changes.empty)return cache;let result=[],lastDir=cache.length?cache[cache.length-1].dir:Direction.LTR;for(let i=Math.max(0,cache.length-10);i<cache.length;i++){let entry=cache[i];entry.dir!=lastDir||changes.touchesRange(entry.from,entry.to)||result.push(new CachedOrder(changes.mapPos(entry.from,1),changes.mapPos(entry.to,-1),entry.dir,entry.order))}return result}}function attrsFromFacet(view,facet,base){for(let sources=view.state.facet(facet),i=sources.length-1;i>=0;i--){let source=sources[i],value="function"==typeof source?source(view):source;value&&combineAttrs(value,base)}return base}const currentPlatform=browser.mac?"mac":browser.windows?"win":browser.linux?"linux":"key";function modifiers(name,event,shift){return event.altKey&&(name="Alt-"+name),event.ctrlKey&&(name="Ctrl-"+name),event.metaKey&&(name="Meta-"+name),!1!==shift&&event.shiftKey&&(name="Shift-"+name),name}const handleKeyEvents=Prec.default(EditorView.domEventHandlers({keydown:(event,view)=>runHandlers(getKeymap(view.state),event,view,"editor")})),keymap=Facet.define({enables:handleKeyEvents}),Keymaps=new WeakMap;function getKeymap(state){let bindings=state.facet(keymap),map=Keymaps.get(bindings);return map||Keymaps.set(bindings,map=function(bindings,platform=currentPlatform){let bound=Object.create(null),isPrefix=Object.create(null),checkPrefix=(name,is)=>{let current=isPrefix[name];if(null==current)isPrefix[name]=is;else if(current!=is)throw new Error("Key binding "+name+" is used both as a regular binding and as a multi-stroke prefix")},add=(scope,key,command,preventDefault)=>{var _a,_b;let scopeObj=bound[scope]||(bound[scope]=Object.create(null)),parts=key.split(/ (?!$)/).map((k=>function(name,platform){const parts=name.split(/-(?!$)/);let alt,ctrl,shift,meta,result=parts[parts.length-1];"Space"==result&&(result=" ");for(let i=0;i<parts.length-1;++i){const mod=parts[i];if(/^(cmd|meta|m)$/i.test(mod))meta=!0;else if(/^a(lt)?$/i.test(mod))alt=!0;else if(/^(c|ctrl|control)$/i.test(mod))ctrl=!0;else if(/^s(hift)?$/i.test(mod))shift=!0;else{if(!/^mod$/i.test(mod))throw new Error("Unrecognized modifier name: "+mod);"mac"==platform?meta=!0:ctrl=!0}}return alt&&(result="Alt-"+result),ctrl&&(result="Ctrl-"+result),meta&&(result="Meta-"+result),shift&&(result="Shift-"+result),result}(k,platform)));for(let i=1;i<parts.length;i++){let prefix=parts.slice(0,i).join(" ");checkPrefix(prefix,!0),scopeObj[prefix]||(scopeObj[prefix]={preventDefault:!0,run:[view=>{let ourObj=storedPrefix={view:view,prefix:prefix,scope:scope};return setTimeout((()=>{storedPrefix==ourObj&&(storedPrefix=null)}),PrefixTimeout),!0}]})}let full=parts.join(" ");checkPrefix(full,!1);let binding=scopeObj[full]||(scopeObj[full]={preventDefault:!1,run:(null===(_b=null===(_a=scopeObj._any)||void 0===_a?void 0:_a.run)||void 0===_b?void 0:_b.slice())||[]});command&&binding.run.push(command),preventDefault&&(binding.preventDefault=!0)};for(let b of bindings){let scopes=b.scope?b.scope.split(" "):["editor"];if(b.any)for(let scope of scopes){let scopeObj=bound[scope]||(bound[scope]=Object.create(null));scopeObj._any||(scopeObj._any={preventDefault:!1,run:[]});for(let key in scopeObj)scopeObj[key].run.push(b.any)}let name=b[platform]||b.key;if(name)for(let scope of scopes)add(scope,name,b.run,b.preventDefault),b.shift&&add(scope,"Shift-"+name,b.shift,b.preventDefault)}return bound}(bindings.reduce(((a,b)=>a.concat(b)),[]))),map}let storedPrefix=null;const PrefixTimeout=4e3;function runHandlers(map,event,view,scope){let name=function(event){var name=!(brokenModifierNames&&(event.ctrlKey||event.altKey||event.metaKey)||ie$1&&event.shiftKey&&event.key&&1==event.key.length||"Unidentified"==event.key)&&event.key||(event.shiftKey?shift:base)[event.keyCode]||event.key||"Unidentified";return"Esc"==name&&(name="Escape"),"Del"==name&&(name="Delete"),"Left"==name&&(name="ArrowLeft"),"Up"==name&&(name="ArrowUp"),"Right"==name&&(name="ArrowRight"),"Down"==name&&(name="ArrowDown"),name}(event),isChar=codePointSize(codePointAt(name,0))==name.length&&" "!=name,prefix="",fallthrough=!1;storedPrefix&&storedPrefix.view==view&&storedPrefix.scope==scope&&(prefix=storedPrefix.prefix+" ",(fallthrough=modifierCodes.indexOf(event.keyCode)<0)&&(storedPrefix=null));let baseName,shiftName,ran=new Set,runFor=binding=>{if(binding){for(let cmd of binding.run)if(!ran.has(cmd)&&(ran.add(cmd),cmd(view,event)))return!0;binding.preventDefault&&(fallthrough=!0)}return!1},scopeObj=map[scope];if(scopeObj){if(runFor(scopeObj[prefix+modifiers(name,event,!isChar)]))return!0;if(isChar&&(event.altKey||event.metaKey||event.ctrlKey)&&(baseName=base[event.keyCode])&&baseName!=name){if(runFor(scopeObj[prefix+modifiers(baseName,event,!0)]))return!0;if(event.shiftKey&&(shiftName=shift[event.keyCode])!=name&&shiftName!=baseName&&runFor(scopeObj[prefix+modifiers(shiftName,event,!1)]))return!0}else if(isChar&&event.shiftKey&&runFor(scopeObj[prefix+modifiers(name,event,!0)]))return!0;if(runFor(scopeObj._any))return!0}return fallthrough}class RectangleMarker{constructor(className,left,top,width,height){this.className=className,this.left=left,this.top=top,this.width=width,this.height=height}draw(){let elt=document.createElement("div");return elt.className=this.className,this.adjust(elt),elt}update(elt,prev){return prev.className==this.className&&(this.adjust(elt),!0)}adjust(elt){elt.style.left=this.left+"px",elt.style.top=this.top+"px",null!=this.width&&(elt.style.width=this.width+"px"),elt.style.height=this.height+"px"}eq(p){return this.left==p.left&&this.top==p.top&&this.width==p.width&&this.height==p.height&&this.className==p.className}static forRange(view,className,range){if(range.empty){let pos=view.coordsAtPos(range.head,range.assoc||1);if(!pos)return[];let base=getBase(view);return[new RectangleMarker(className,pos.left-base.left,pos.top-base.top,null,pos.bottom-pos.top)]}return function(view,className,range){if(range.to<=view.viewport.from||range.from>=view.viewport.to)return[];let from=Math.max(range.from,view.viewport.from),to=Math.min(range.to,view.viewport.to),ltr=view.textDirection==Direction.LTR,content=view.contentDOM,contentRect=content.getBoundingClientRect(),base=getBase(view),lineStyle=window.getComputedStyle(content.firstChild),leftSide=contentRect.left+parseInt(lineStyle.paddingLeft)+Math.min(0,parseInt(lineStyle.textIndent)),rightSide=contentRect.right-parseInt(lineStyle.paddingRight),startBlock=blockAt(view,from),endBlock=blockAt(view,to),visualStart=startBlock.type==BlockType.Text?startBlock:null,visualEnd=endBlock.type==BlockType.Text?endBlock:null;view.lineWrapping&&(visualStart&&(visualStart=wrappedLine(view,from,visualStart)),visualEnd&&(visualEnd=wrappedLine(view,to,visualEnd)));if(visualStart&&visualEnd&&visualStart.from==visualEnd.from)return pieces(drawForLine(range.from,range.to,visualStart));{let top=visualStart?drawForLine(range.from,null,visualStart):drawForWidget(startBlock,!1),bottom=visualEnd?drawForLine(null,range.to,visualEnd):drawForWidget(endBlock,!0),between=[];return(visualStart||startBlock).to<(visualEnd||endBlock).from-1?between.push(piece(leftSide,top.bottom,rightSide,bottom.top)):top.bottom<bottom.top&&view.elementAtHeight((top.bottom+bottom.top)/2).type==BlockType.Text&&(top.bottom=bottom.top=(top.bottom+bottom.top)/2),pieces(top).concat(between).concat(pieces(bottom))}function piece(left,top,right,bottom){return new RectangleMarker(className,left-base.left,top-base.top-.01,right-left,bottom-top+.01)}function pieces({top:top,bottom:bottom,horizontal:horizontal}){let pieces=[];for(let i=0;i<horizontal.length;i+=2)pieces.push(piece(horizontal[i],top,horizontal[i+1],bottom));return pieces}function drawForLine(from,to,line){let top=1e9,bottom=-1e9,horizontal=[];function addSpan(from,fromOpen,to,toOpen,dir){let fromCoords=view.coordsAtPos(from,from==line.to?-2:2),toCoords=view.coordsAtPos(to,to==line.from?2:-2);top=Math.min(fromCoords.top,toCoords.top,top),bottom=Math.max(fromCoords.bottom,toCoords.bottom,bottom),dir==Direction.LTR?horizontal.push(ltr&&fromOpen?leftSide:fromCoords.left,ltr&&toOpen?rightSide:toCoords.right):horizontal.push(!ltr&&toOpen?leftSide:toCoords.left,!ltr&&fromOpen?rightSide:fromCoords.right)}let start=null!=from?from:line.from,end=null!=to?to:line.to;for(let r of view.visibleRanges)if(r.to>start&&r.from<end)for(let pos=Math.max(r.from,start),endPos=Math.min(r.to,end);;){let docLine=view.state.doc.lineAt(pos);for(let span of view.bidiSpans(docLine)){let spanFrom=span.from+docLine.from,spanTo=span.to+docLine.from;if(spanFrom>=endPos)break;spanTo>pos&&addSpan(Math.max(spanFrom,pos),null==from&&spanFrom<=start,Math.min(spanTo,endPos),null==to&&spanTo>=end,span.dir)}if(pos=docLine.to+1,pos>=endPos)break}return 0==horizontal.length&&addSpan(start,null==from,end,null==to,view.textDirection),{top:top,bottom:bottom,horizontal:horizontal}}function drawForWidget(block,top){let y=contentRect.top+(top?block.top:block.bottom);return{top:y,bottom:y,horizontal:[]}}}(view,className,range)}}function getBase(view){let rect=view.scrollDOM.getBoundingClientRect();return{left:(view.textDirection==Direction.LTR?rect.left:rect.right-view.scrollDOM.clientWidth)-view.scrollDOM.scrollLeft,top:rect.top-view.scrollDOM.scrollTop}}function wrappedLine(view,pos,inside){let range=EditorSelection.cursor(pos);return{from:Math.max(inside.from,view.moveToLineBoundary(range,!1,!0).from),to:Math.min(inside.to,view.moveToLineBoundary(range,!0,!0).from),type:BlockType.Text}}function blockAt(view,pos){let line=view.lineBlockAt(pos);if(Array.isArray(line.type))for(let l of line.type)if(l.to>pos||l.to==pos&&(l.to==line.to||l.type==BlockType.Text))return l;return line}class LayerView{constructor(view,layer){this.view=view,this.layer=layer,this.drawn=[],this.measureReq={read:this.measure.bind(this),write:this.draw.bind(this)},this.dom=view.scrollDOM.appendChild(document.createElement("div")),this.dom.classList.add("cm-layer"),layer.above&&this.dom.classList.add("cm-layer-above"),layer.class&&this.dom.classList.add(layer.class),this.dom.setAttribute("aria-hidden","true"),this.setOrder(view.state),view.requestMeasure(this.measureReq),layer.mount&&layer.mount(this.dom,view)}update(update){update.startState.facet(layerOrder)!=update.state.facet(layerOrder)&&this.setOrder(update.state),(this.layer.update(update,this.dom)||update.geometryChanged)&&update.view.requestMeasure(this.measureReq)}setOrder(state){let pos=0,order=state.facet(layerOrder);for(;pos<order.length&&order[pos]!=this.layer;)pos++;this.dom.style.zIndex=String((this.layer.above?150:-1)-pos)}measure(){return this.layer.markers(this.view)}draw(markers){if(markers.length!=this.drawn.length||markers.some(((p,i)=>{return a=p,b=this.drawn[i],!(a.constructor==b.constructor&&a.eq(b));var a,b}))){let old=this.dom.firstChild,oldI=0;for(let marker of markers)marker.update&&old&&marker.constructor&&this.drawn[oldI].constructor&&marker.update(old,this.drawn[oldI])?(old=old.nextSibling,oldI++):this.dom.insertBefore(marker.draw(),old);for(;old;){let next=old.nextSibling;old.remove(),old=next}this.drawn=markers}}destroy(){this.layer.destroy&&this.layer.destroy(this.dom,this.view),this.dom.remove()}}const layerOrder=Facet.define();function layer(config){return[ViewPlugin.define((v=>new LayerView(v,config))),layerOrder.of(config)]}const CanHidePrimary=!browser.ios,selectionConfig=Facet.define({combine:configs=>combineConfig(configs,{cursorBlinkRate:1200,drawRangeCursor:!0},{cursorBlinkRate:(a,b)=>Math.min(a,b),drawRangeCursor:(a,b)=>a||b})});function drawSelection(config={}){return[selectionConfig.of(config),cursorLayer,selectionLayer,hideNativeSelection,nativeSelectionHidden.of(!0)]}function configChanged(update){return update.startState.facet(selectionConfig)!=update.startState.facet(selectionConfig)}const cursorLayer=layer({above:!0,markers(view){let{state:state}=view,conf=state.facet(selectionConfig),cursors=[];for(let r of state.selection.ranges){let prim=r==state.selection.main;if(r.empty?!prim||CanHidePrimary:conf.drawRangeCursor){let className=prim?"cm-cursor cm-cursor-primary":"cm-cursor cm-cursor-secondary",cursor=r.empty?r:EditorSelection.cursor(r.head,r.head>r.anchor?-1:1);for(let piece of RectangleMarker.forRange(view,className,cursor))cursors.push(piece)}}return cursors},update(update,dom){update.transactions.some((tr=>tr.scrollIntoView))&&(dom.style.animationName="cm-blink"==dom.style.animationName?"cm-blink2":"cm-blink");let confChange=configChanged(update);return confChange&&setBlinkRate(update.state,dom),update.docChanged||update.selectionSet||confChange},mount(dom,view){setBlinkRate(view.state,dom)},class:"cm-cursorLayer"});function setBlinkRate(state,dom){dom.style.animationDuration=state.facet(selectionConfig).cursorBlinkRate+"ms"}const selectionLayer=layer({above:!1,markers:view=>view.state.selection.ranges.map((r=>r.empty?[]:RectangleMarker.forRange(view,"cm-selectionBackground",r))).reduce(((a,b)=>a.concat(b))),update:(update,dom)=>update.docChanged||update.selectionSet||update.viewportChanged||configChanged(update),class:"cm-selectionLayer"}),themeSpec={".cm-line":{"& ::selection":{backgroundColor:"transparent !important"},"&::selection":{backgroundColor:"transparent !important"}}};CanHidePrimary&&(themeSpec[".cm-line"].caretColor="transparent !important");const hideNativeSelection=Prec.highest(EditorView.theme(themeSpec));const lineDeco=Decoration.line({class:"cm-activeLine"}),activeLineHighlighter=ViewPlugin.fromClass(class{constructor(view){this.decorations=this.getDeco(view)}update(update){(update.docChanged||update.selectionSet)&&(this.decorations=this.getDeco(update.view))}getDeco(view){let lastLineStart=-1,deco=[];for(let r of view.state.selection.ranges){let line=view.lineBlockAt(r.head);line.from>lastLineStart&&(deco.push(lineDeco.range(line.from)),lastLineStart=line.from)}return Decoration.set(deco)}},{decorations:v=>v.decorations});function getPos(view,event){let offset=view.posAtCoords({x:event.clientX,y:event.clientY},!1),line=view.state.doc.lineAt(offset),off=offset-line.from,col=off>2e3?-1:off==line.length?function(view,x){let ref=view.coordsAtPos(view.viewport.from);return ref?Math.round(Math.abs((ref.left-x)/view.defaultCharacterWidth)):-1}(view,event.clientX):countColumn(line.text,view.state.tabSize,offset-line.from);return{line:line.number,col:col,off:off}}function rectangleSelectionStyle(view,event){let start=getPos(view,event),startSel=view.state.selection;return start?{update(update){if(update.docChanged){let newStart=update.changes.mapPos(update.startState.doc.line(start.line).from),newLine=update.state.doc.lineAt(newStart);start={line:newLine.number,col:start.col,off:Math.min(start.off,newLine.length)},startSel=startSel.map(update.changes)}},get(event,_extend,multiple){let cur=getPos(view,event);if(!cur)return startSel;let ranges=function(state,a,b){let startLine=Math.min(a.line,b.line),endLine=Math.max(a.line,b.line),ranges=[];if(a.off>2e3||b.off>2e3||a.col<0||b.col<0){let startOff=Math.min(a.off,b.off),endOff=Math.max(a.off,b.off);for(let i=startLine;i<=endLine;i++){let line=state.doc.line(i);line.length<=endOff&&ranges.push(EditorSelection.range(line.from+startOff,line.to+endOff))}}else{let startCol=Math.min(a.col,b.col),endCol=Math.max(a.col,b.col);for(let i=startLine;i<=endLine;i++){let line=state.doc.line(i),start=findColumn(line.text,startCol,state.tabSize,!0);if(start<0)ranges.push(EditorSelection.cursor(line.to));else{let end=findColumn(line.text,endCol,state.tabSize);ranges.push(EditorSelection.range(line.from+start,line.from+end))}}}return ranges}(view.state,start,cur);return ranges.length?multiple?EditorSelection.create(ranges.concat(startSel.ranges)):EditorSelection.create(ranges):startSel}}:null}function rectangularSelection(options){let filter=(null==options?void 0:options.eventFilter)||(e=>e.altKey&&0==e.button);return EditorView.mouseSelectionStyle.of(((view,event)=>filter(event)?rectangleSelectionStyle(view,event):null))}const keys={Alt:[18,e=>e.altKey],Control:[17,e=>e.ctrlKey],Shift:[16,e=>e.shiftKey],Meta:[91,e=>e.metaKey]},showCrosshair={style:"cursor: crosshair"};function crosshairCursor(options={}){let[code,getter]=keys[options.key||"Alt"],plugin=ViewPlugin.fromClass(class{constructor(view){this.view=view,this.isDown=!1}set(isDown){this.isDown!=isDown&&(this.isDown=isDown,this.view.update([]))}},{eventHandlers:{keydown(e){this.set(e.keyCode==code||getter(e))},keyup(e){e.keyCode!=code&&getter(e)||this.set(!1)},mousemove(e){this.set(getter(e))}}});return[plugin,EditorView.contentAttributes.of((view=>{var _a;return(null===(_a=view.plugin(plugin))||void 0===_a?void 0:_a.isDown)?showCrosshair:null}))]}const panelConfig=Facet.define({combine(configs){let topContainer,bottomContainer;for(let c of configs)topContainer=topContainer||c.topContainer,bottomContainer=bottomContainer||c.bottomContainer;return{topContainer:topContainer,bottomContainer:bottomContainer}}});function getPanel(view,panel){let plugin=view.plugin(panelPlugin),index=plugin?plugin.specs.indexOf(panel):-1;return index>-1?plugin.panels[index]:null}const panelPlugin=ViewPlugin.fromClass(class{constructor(view){this.input=view.state.facet(showPanel),this.specs=this.input.filter((s=>s)),this.panels=this.specs.map((spec=>spec(view)));let conf=view.state.facet(panelConfig);this.top=new PanelGroup(view,!0,conf.topContainer),this.bottom=new PanelGroup(view,!1,conf.bottomContainer),this.top.sync(this.panels.filter((p=>p.top))),this.bottom.sync(this.panels.filter((p=>!p.top)));for(let p of this.panels)p.dom.classList.add("cm-panel"),p.mount&&p.mount()}update(update){let conf=update.state.facet(panelConfig);this.top.container!=conf.topContainer&&(this.top.sync([]),this.top=new PanelGroup(update.view,!0,conf.topContainer)),this.bottom.container!=conf.bottomContainer&&(this.bottom.sync([]),this.bottom=new PanelGroup(update.view,!1,conf.bottomContainer)),this.top.syncClasses(),this.bottom.syncClasses();let input=update.state.facet(showPanel);if(input!=this.input){let specs=input.filter((x=>x)),panels=[],top=[],bottom=[],mount=[];for(let spec of specs){let panel,known=this.specs.indexOf(spec);known<0?(panel=spec(update.view),mount.push(panel)):(panel=this.panels[known],panel.update&&panel.update(update)),panels.push(panel),(panel.top?top:bottom).push(panel)}this.specs=specs,this.panels=panels,this.top.sync(top),this.bottom.sync(bottom);for(let p of mount)p.dom.classList.add("cm-panel"),p.mount&&p.mount()}else for(let p of this.panels)p.update&&p.update(update)}destroy(){this.top.sync([]),this.bottom.sync([])}},{provide:plugin=>EditorView.scrollMargins.of((view=>{let value=view.plugin(plugin);return value&&{top:value.top.scrollMargin(),bottom:value.bottom.scrollMargin()}}))});class PanelGroup{constructor(view,top,container){this.view=view,this.top=top,this.container=container,this.dom=void 0,this.classes="",this.panels=[],this.syncClasses()}sync(panels){for(let p of this.panels)p.destroy&&panels.indexOf(p)<0&&p.destroy();this.panels=panels,this.syncDOM()}syncDOM(){if(0==this.panels.length)return void(this.dom&&(this.dom.remove(),this.dom=void 0));if(!this.dom){this.dom=document.createElement("div"),this.dom.className=this.top?"cm-panels cm-panels-top":"cm-panels cm-panels-bottom",this.dom.style[this.top?"top":"bottom"]="0";let parent=this.container||this.view.dom;parent.insertBefore(this.dom,this.top?parent.firstChild:null)}let curDOM=this.dom.firstChild;for(let panel of this.panels)if(panel.dom.parentNode==this.dom){for(;curDOM!=panel.dom;)curDOM=rm(curDOM);curDOM=curDOM.nextSibling}else this.dom.insertBefore(panel.dom,curDOM);for(;curDOM;)curDOM=rm(curDOM)}scrollMargin(){return!this.dom||this.container?0:Math.max(0,this.top?this.dom.getBoundingClientRect().bottom-Math.max(0,this.view.scrollDOM.getBoundingClientRect().top):Math.min(innerHeight,this.view.scrollDOM.getBoundingClientRect().bottom)-this.dom.getBoundingClientRect().top)}syncClasses(){if(this.container&&this.classes!=this.view.themeClasses){for(let cls of this.classes.split(" "))cls&&this.container.classList.remove(cls);for(let cls of(this.classes=this.view.themeClasses).split(" "))cls&&this.container.classList.add(cls)}}}function rm(node){let next=node.nextSibling;return node.remove(),next}const showPanel=Facet.define({enables:panelPlugin});class GutterMarker extends RangeValue{compare(other){return this==other||this.constructor==other.constructor&&this.eq(other)}eq(other){return!1}destroy(dom){}}GutterMarker.prototype.elementClass="",GutterMarker.prototype.toDOM=void 0,GutterMarker.prototype.mapMode=MapMode.TrackBefore,GutterMarker.prototype.startSide=GutterMarker.prototype.endSide=-1,GutterMarker.prototype.point=!0;const gutterLineClass=Facet.define(),defaults$1={class:"",renderEmptyElements:!1,elementStyle:"",markers:()=>RangeSet.empty,lineMarker:()=>null,lineMarkerChange:null,initialSpacer:null,updateSpacer:null,domEventHandlers:{}},activeGutters=Facet.define();function gutter(config){return[gutters(),activeGutters.of(Object.assign(Object.assign({},defaults$1),config))]}const unfixGutters=Facet.define({combine:values=>values.some((x=>x))});function gutters(config){let result=[gutterView];return config&&!1===config.fixed&&result.push(unfixGutters.of(!0)),result}const gutterView=ViewPlugin.fromClass(class{constructor(view){this.view=view,this.prevViewport=view.viewport,this.dom=document.createElement("div"),this.dom.className="cm-gutters",this.dom.setAttribute("aria-hidden","true"),this.dom.style.minHeight=this.view.contentHeight+"px",this.gutters=view.state.facet(activeGutters).map((conf=>new SingleGutterView(view,conf)));for(let gutter of this.gutters)this.dom.appendChild(gutter.dom);this.fixed=!view.state.facet(unfixGutters),this.fixed&&(this.dom.style.position="sticky"),this.syncGutters(!1),view.scrollDOM.insertBefore(this.dom,view.contentDOM)}update(update){if(this.updateGutters(update)){let vpA=this.prevViewport,vpB=update.view.viewport,vpOverlap=Math.min(vpA.to,vpB.to)-Math.max(vpA.from,vpB.from);this.syncGutters(vpOverlap<.8*(vpB.to-vpB.from))}update.geometryChanged&&(this.dom.style.minHeight=this.view.contentHeight+"px"),this.view.state.facet(unfixGutters)!=!this.fixed&&(this.fixed=!this.fixed,this.dom.style.position=this.fixed?"sticky":""),this.prevViewport=update.view.viewport}syncGutters(detach){let after=this.dom.nextSibling;detach&&this.dom.remove();let lineClasses=RangeSet.iter(this.view.state.facet(gutterLineClass),this.view.viewport.from),classSet=[],contexts=this.gutters.map((gutter=>new UpdateContext(gutter,this.view.viewport,-this.view.documentPadding.top)));for(let line of this.view.viewportLineBlocks){let text;if(Array.isArray(line.type)){for(let b of line.type)if(b.type==BlockType.Text){text=b;break}}else text=line.type==BlockType.Text?line:void 0;if(text){classSet.length&&(classSet=[]),advanceCursor(lineClasses,classSet,line.from);for(let cx of contexts)cx.line(this.view,text,classSet)}}for(let cx of contexts)cx.finish();detach&&this.view.scrollDOM.insertBefore(this.dom,after)}updateGutters(update){let prev=update.startState.facet(activeGutters),cur=update.state.facet(activeGutters),change=update.docChanged||update.heightChanged||update.viewportChanged||!RangeSet.eq(update.startState.facet(gutterLineClass),update.state.facet(gutterLineClass),update.view.viewport.from,update.view.viewport.to);if(prev==cur)for(let gutter of this.gutters)gutter.update(update)&&(change=!0);else{change=!0;let gutters=[];for(let conf of cur){let known=prev.indexOf(conf);known<0?gutters.push(new SingleGutterView(this.view,conf)):(this.gutters[known].update(update),gutters.push(this.gutters[known]))}for(let g of this.gutters)g.dom.remove(),gutters.indexOf(g)<0&&g.destroy();for(let g of gutters)this.dom.appendChild(g.dom);this.gutters=gutters}return change}destroy(){for(let view of this.gutters)view.destroy();this.dom.remove()}},{provide:plugin=>EditorView.scrollMargins.of((view=>{let value=view.plugin(plugin);return value&&0!=value.gutters.length&&value.fixed?view.textDirection==Direction.LTR?{left:value.dom.offsetWidth}:{right:value.dom.offsetWidth}:null}))});function asArray(val){return Array.isArray(val)?val:[val]}function advanceCursor(cursor,collect,pos){for(;cursor.value&&cursor.from<=pos;)cursor.from==pos&&collect.push(cursor.value),cursor.next()}class UpdateContext{constructor(gutter,viewport,height){this.gutter=gutter,this.height=height,this.localMarkers=[],this.i=0,this.cursor=RangeSet.iter(gutter.markers,viewport.from)}line(view,line,extraMarkers){this.localMarkers.length&&(this.localMarkers=[]),advanceCursor(this.cursor,this.localMarkers,line.from);let localMarkers=extraMarkers.length?this.localMarkers.concat(extraMarkers):this.localMarkers,forLine=this.gutter.config.lineMarker(view,line,localMarkers);forLine&&localMarkers.unshift(forLine);let gutter=this.gutter;if(0==localMarkers.length&&!gutter.config.renderEmptyElements)return;let above=line.top-this.height;if(this.i==gutter.elements.length){let newElt=new GutterElement(view,line.height,above,localMarkers);gutter.elements.push(newElt),gutter.dom.appendChild(newElt.dom)}else gutter.elements[this.i].update(view,line.height,above,localMarkers);this.height=line.bottom,this.i++}finish(){let gutter=this.gutter;for(;gutter.elements.length>this.i;){let last=gutter.elements.pop();gutter.dom.removeChild(last.dom),last.destroy()}}}class SingleGutterView{constructor(view,config){this.view=view,this.config=config,this.elements=[],this.spacer=null,this.dom=document.createElement("div"),this.dom.className="cm-gutter"+(this.config.class?" "+this.config.class:"");for(let prop in config.domEventHandlers)this.dom.addEventListener(prop,(event=>{let line=view.lineBlockAtHeight(event.clientY-view.documentTop);config.domEventHandlers[prop](view,line,event)&&event.preventDefault()}));this.markers=asArray(config.markers(view)),config.initialSpacer&&(this.spacer=new GutterElement(view,0,0,[config.initialSpacer(view)]),this.dom.appendChild(this.spacer.dom),this.spacer.dom.style.cssText+="visibility: hidden; pointer-events: none")}update(update){let prevMarkers=this.markers;if(this.markers=asArray(this.config.markers(update.view)),this.spacer&&this.config.updateSpacer){let updated=this.config.updateSpacer(this.spacer.markers[0],update);updated!=this.spacer.markers[0]&&this.spacer.update(update.view,0,0,[updated])}let vp=update.view.viewport;return!RangeSet.eq(this.markers,prevMarkers,vp.from,vp.to)||!!this.config.lineMarkerChange&&this.config.lineMarkerChange(update)}destroy(){for(let elt of this.elements)elt.destroy()}}class GutterElement{constructor(view,height,above,markers){this.height=-1,this.above=0,this.markers=[],this.dom=document.createElement("div"),this.dom.className="cm-gutterElement",this.update(view,height,above,markers)}update(view,height,above,markers){this.height!=height&&(this.dom.style.height=(this.height=height)+"px"),this.above!=above&&(this.dom.style.marginTop=(this.above=above)?above+"px":""),function(a,b){if(a.length!=b.length)return!1;for(let i=0;i<a.length;i++)if(!a[i].compare(b[i]))return!1;return!0}(this.markers,markers)||this.setMarkers(view,markers)}setMarkers(view,markers){let cls="cm-gutterElement",domPos=this.dom.firstChild;for(let iNew=0,iOld=0;;){let skipTo=iOld,marker=iNew<markers.length?markers[iNew++]:null,matched=!1;if(marker){let c=marker.elementClass;c&&(cls+=" "+c);for(let i=iOld;i<this.markers.length;i++)if(this.markers[i].compare(marker)){skipTo=i,matched=!0;break}}else skipTo=this.markers.length;for(;iOld<skipTo;){let next=this.markers[iOld++];if(next.toDOM){next.destroy(domPos);let after=domPos.nextSibling;domPos.remove(),domPos=after}}if(!marker)break;marker.toDOM&&(matched?domPos=domPos.nextSibling:this.dom.insertBefore(marker.toDOM(view),domPos)),matched&&iOld++}this.dom.className=cls,this.markers=markers}destroy(){this.setMarkers(null,[])}}const lineNumberMarkers=Facet.define(),lineNumberConfig=Facet.define({combine:values=>combineConfig(values,{formatNumber:String,domEventHandlers:{}},{domEventHandlers(a,b){let result=Object.assign({},a);for(let event in b){let exists=result[event],add=b[event];result[event]=exists?(view,line,event)=>exists(view,line,event)||add(view,line,event):add}return result}})});class NumberMarker extends GutterMarker{constructor(number){super(),this.number=number}eq(other){return this.number==other.number}toDOM(){return document.createTextNode(this.number)}}function formatNumber(view,number){return view.state.facet(lineNumberConfig).formatNumber(number,view.state)}const lineNumberGutter=activeGutters.compute([lineNumberConfig],(state=>({class:"cm-lineNumbers",renderEmptyElements:!1,markers:view=>view.state.facet(lineNumberMarkers),lineMarker:(view,line,others)=>others.some((m=>m.toDOM))?null:new NumberMarker(formatNumber(view,view.state.doc.lineAt(line.from).number)),lineMarkerChange:update=>update.startState.facet(lineNumberConfig)!=update.state.facet(lineNumberConfig),initialSpacer:view=>new NumberMarker(formatNumber(view,maxLineNumber(view.state.doc.lines))),updateSpacer(spacer,update){let max=formatNumber(update.view,maxLineNumber(update.view.state.doc.lines));return max==spacer.number?spacer:new NumberMarker(max)},domEventHandlers:state.facet(lineNumberConfig).domEventHandlers})));function lineNumbers(config={}){return[lineNumberConfig.of(config),gutters(),lineNumberGutter]}function maxLineNumber(lines){let last=9;for(;last<lines;)last=10*last+9;return last}const DefaultBufferLength=1024;let nextPropID=0;class Range{constructor(from,to){this.from=from,this.to=to}}class NodeProp{constructor(config={}){this.id=nextPropID++,this.perNode=!!config.perNode,this.deserialize=config.deserialize||(()=>{throw new Error("This node type doesn't define a deserialize function")})}add(match){if(this.perNode)throw new RangeError("Can't add per-node props to node types");return"function"!=typeof match&&(match=NodeType.match(match)),type=>{let result=match(type);return void 0===result?null:[this,result]}}}NodeProp.closedBy=new NodeProp({deserialize:str=>str.split(" ")}),NodeProp.openedBy=new NodeProp({deserialize:str=>str.split(" ")}),NodeProp.group=new NodeProp({deserialize:str=>str.split(" ")}),NodeProp.contextHash=new NodeProp({perNode:!0}),NodeProp.lookAhead=new NodeProp({perNode:!0}),NodeProp.mounted=new NodeProp({perNode:!0});const noProps=Object.create(null);class NodeType{constructor(name,props,id,flags=0){this.name=name,this.props=props,this.id=id,this.flags=flags}static define(spec){let props=spec.props&&spec.props.length?Object.create(null):noProps,flags=(spec.top?1:0)|(spec.skipped?2:0)|(spec.error?4:0)|(null==spec.name?8:0),type=new NodeType(spec.name||"",props,spec.id,flags);if(spec.props)for(let src of spec.props)if(Array.isArray(src)||(src=src(type)),src){if(src[0].perNode)throw new RangeError("Can't store a per-node prop on a node type");props[src[0].id]=src[1]}return type}prop(prop){return this.props[prop.id]}get isTop(){return(1&this.flags)>0}get isSkipped(){return(2&this.flags)>0}get isError(){return(4&this.flags)>0}get isAnonymous(){return(8&this.flags)>0}is(name){if("string"==typeof name){if(this.name==name)return!0;let group=this.prop(NodeProp.group);return!!group&&group.indexOf(name)>-1}return this.id==name}static match(map){let direct=Object.create(null);for(let prop in map)for(let name of prop.split(" "))direct[name]=map[prop];return node=>{for(let groups=node.prop(NodeProp.group),i=-1;i<(groups?groups.length:0);i++){let found=direct[i<0?node.name:groups[i]];if(found)return found}}}}NodeType.none=new NodeType("",Object.create(null),0,8);class NodeSet{constructor(types){this.types=types;for(let i=0;i<types.length;i++)if(types[i].id!=i)throw new RangeError("Node type ids should correspond to array positions when creating a node set")}extend(...props){let newTypes=[];for(let type of this.types){let newProps=null;for(let source of props){let add=source(type);add&&(newProps||(newProps=Object.assign({},type.props)),newProps[add[0].id]=add[1])}newTypes.push(newProps?new NodeType(type.name,newProps,type.id,type.flags):type)}return new NodeSet(newTypes)}}const CachedNode=new WeakMap,CachedInnerNode=new WeakMap;var IterMode;!function(IterMode){IterMode[IterMode.ExcludeBuffers=1]="ExcludeBuffers",IterMode[IterMode.IncludeAnonymous=2]="IncludeAnonymous",IterMode[IterMode.IgnoreMounts=4]="IgnoreMounts",IterMode[IterMode.IgnoreOverlays=8]="IgnoreOverlays"}(IterMode||(IterMode={}));class Tree{constructor(type,children,positions,length,props){if(this.type=type,this.children=children,this.positions=positions,this.length=length,this.props=null,props&&props.length){this.props=Object.create(null);for(let[prop,value]of props)this.props["number"==typeof prop?prop:prop.id]=value}}toString(){let mounted=this.prop(NodeProp.mounted);if(mounted&&!mounted.overlay)return mounted.tree.toString();let children="";for(let ch of this.children){let str=ch.toString();str&&(children&&(children+=","),children+=str)}return this.type.name?(/\W/.test(this.type.name)&&!this.type.isError?JSON.stringify(this.type.name):this.type.name)+(children.length?"("+children+")":""):children}cursor(mode=0){return new TreeCursor(this.topNode,mode)}cursorAt(pos,side=0,mode=0){let scope=CachedNode.get(this)||this.topNode,cursor=new TreeCursor(scope);return cursor.moveTo(pos,side),CachedNode.set(this,cursor._tree),cursor}get topNode(){return new TreeNode(this,0,0,null)}resolve(pos,side=0){let node=resolveNode(CachedNode.get(this)||this.topNode,pos,side,!1);return CachedNode.set(this,node),node}resolveInner(pos,side=0){let node=resolveNode(CachedInnerNode.get(this)||this.topNode,pos,side,!0);return CachedInnerNode.set(this,node),node}iterate(spec){let{enter:enter,leave:leave,from:from=0,to:to=this.length}=spec;for(let c=this.cursor((spec.mode||0)|IterMode.IncludeAnonymous);;){let entered=!1;if(c.from<=to&&c.to>=from&&(c.type.isAnonymous||!1!==enter(c))){if(c.firstChild())continue;entered=!0}for(;entered&&leave&&!c.type.isAnonymous&&leave(c),!c.nextSibling();){if(!c.parent())return;entered=!0}}}prop(prop){return prop.perNode?this.props?this.props[prop.id]:void 0:this.type.prop(prop)}get propValues(){let result=[];if(this.props)for(let id in this.props)result.push([+id,this.props[id]]);return result}balance(config={}){return this.children.length<=8?this:balanceRange(NodeType.none,this.children,this.positions,0,this.children.length,0,this.length,((children,positions,length)=>new Tree(this.type,children,positions,length,this.propValues)),config.makeTree||((children,positions,length)=>new Tree(NodeType.none,children,positions,length)))}static build(data){return function(data){var _a;let{buffer:buffer,nodeSet:nodeSet,maxBufferLength:maxBufferLength=DefaultBufferLength,reused:reused=[],minRepeatType:minRepeatType=nodeSet.types.length}=data,cursor=Array.isArray(buffer)?new FlatBufferCursor(buffer,buffer.length):buffer,types=nodeSet.types,contextHash=0,lookAhead=0;function takeNode(parentStart,minPos,children,positions,inRepeat){let{id:id,start:start,end:end,size:size}=cursor,lookAheadAtStart=lookAhead;for(;size<0;){if(cursor.next(),-1==size){let node=reused[id];return children.push(node),void positions.push(start-parentStart)}if(-3==size)return void(contextHash=id);if(-4==size)return void(lookAhead=id);throw new RangeError(`Unrecognized record size: ${size}`)}let node,buffer,type=types[id],startPos=start-parentStart;if(end-start<=maxBufferLength&&(buffer=findBufferSize(cursor.pos-minPos,inRepeat))){let data=new Uint16Array(buffer.size-buffer.skip),endPos=cursor.pos-buffer.size,index=data.length;for(;cursor.pos>endPos;)index=copyToBuffer(buffer.start,data,index);node=new TreeBuffer(data,end-buffer.start,nodeSet),startPos=buffer.start-parentStart}else{let endPos=cursor.pos-size;cursor.next();let localChildren=[],localPositions=[],localInRepeat=id>=minRepeatType?id:-1,lastGroup=0,lastEnd=end;for(;cursor.pos>endPos;)localInRepeat>=0&&cursor.id==localInRepeat&&cursor.size>=0?(cursor.end<=lastEnd-maxBufferLength&&(makeRepeatLeaf(localChildren,localPositions,start,lastGroup,cursor.end,lastEnd,localInRepeat,lookAheadAtStart),lastGroup=localChildren.length,lastEnd=cursor.end),cursor.next()):takeNode(start,endPos,localChildren,localPositions,localInRepeat);if(localInRepeat>=0&&lastGroup>0&&lastGroup<localChildren.length&&makeRepeatLeaf(localChildren,localPositions,start,lastGroup,start,lastEnd,localInRepeat,lookAheadAtStart),localChildren.reverse(),localPositions.reverse(),localInRepeat>-1&&lastGroup>0){let make=makeBalanced(type);node=balanceRange(type,localChildren,localPositions,0,localChildren.length,0,end-start,make,make)}else node=makeTree(type,localChildren,localPositions,end-start,lookAheadAtStart-end)}children.push(node),positions.push(startPos)}function makeBalanced(type){return(children,positions,length)=>{let last,lookAheadProp,lookAhead=0,lastI=children.length-1;if(lastI>=0&&(last=children[lastI])instanceof Tree){if(!lastI&&last.type==type&&last.length==length)return last;(lookAheadProp=last.prop(NodeProp.lookAhead))&&(lookAhead=positions[lastI]+last.length+lookAheadProp)}return makeTree(type,children,positions,length,lookAhead)}}function makeRepeatLeaf(children,positions,base,i,from,to,type,lookAhead){let localChildren=[],localPositions=[];for(;children.length>i;)localChildren.push(children.pop()),localPositions.push(positions.pop()+base-from);children.push(makeTree(nodeSet.types[type],localChildren,localPositions,to-from,lookAhead-to)),positions.push(from-base)}function makeTree(type,children,positions,length,lookAhead=0,props){if(contextHash){let pair=[NodeProp.contextHash,contextHash];props=props?[pair].concat(props):[pair]}if(lookAhead>25){let pair=[NodeProp.lookAhead,lookAhead];props=props?[pair].concat(props):[pair]}return new Tree(type,children,positions,length,props)}function findBufferSize(maxSize,inRepeat){let fork=cursor.fork(),size=0,start=0,skip=0,minStart=fork.end-maxBufferLength,result={size:0,start:0,skip:0};scan:for(let minPos=fork.pos-maxSize;fork.pos>minPos;){let nodeSize=fork.size;if(fork.id==inRepeat&&nodeSize>=0){result.size=size,result.start=start,result.skip=skip,skip+=4,size+=4,fork.next();continue}let startPos=fork.pos-nodeSize;if(nodeSize<0||startPos<minPos||fork.start<minStart)break;let localSkipped=fork.id>=minRepeatType?4:0,nodeStart=fork.start;for(fork.next();fork.pos>startPos;){if(fork.size<0){if(-3!=fork.size)break scan;localSkipped+=4}else fork.id>=minRepeatType&&(localSkipped+=4);fork.next()}start=nodeStart,size+=nodeSize,skip+=localSkipped}return(inRepeat<0||size==maxSize)&&(result.size=size,result.start=start,result.skip=skip),result.size>4?result:void 0}function copyToBuffer(bufferStart,buffer,index){let{id:id,start:start,end:end,size:size}=cursor;if(cursor.next(),size>=0&&id<minRepeatType){let startIndex=index;if(size>4){let endPos=cursor.pos-(size-4);for(;cursor.pos>endPos;)index=copyToBuffer(bufferStart,buffer,index)}buffer[--index]=startIndex,buffer[--index]=end-bufferStart,buffer[--index]=start-bufferStart,buffer[--index]=id}else-3==size?contextHash=id:-4==size&&(lookAhead=id);return index}let children=[],positions=[];for(;cursor.pos>0;)takeNode(data.start||0,data.bufferStart||0,children,positions,-1);let length=null!==(_a=data.length)&&void 0!==_a?_a:children.length?positions[0]+children[0].length:0;return new Tree(types[data.topID],children.reverse(),positions.reverse(),length)}(data)}}Tree.empty=new Tree(NodeType.none,[],[],0);class FlatBufferCursor{constructor(buffer,index){this.buffer=buffer,this.index=index}get id(){return this.buffer[this.index-4]}get start(){return this.buffer[this.index-3]}get end(){return this.buffer[this.index-2]}get size(){return this.buffer[this.index-1]}get pos(){return this.index}next(){this.index-=4}fork(){return new FlatBufferCursor(this.buffer,this.index)}}class TreeBuffer{constructor(buffer,length,set){this.buffer=buffer,this.length=length,this.set=set}get type(){return NodeType.none}toString(){let result=[];for(let index=0;index<this.buffer.length;)result.push(this.childString(index)),index=this.buffer[index+3];return result.join(",")}childString(index){let id=this.buffer[index],endIndex=this.buffer[index+3],type=this.set.types[id],result=type.name;if(/\W/.test(result)&&!type.isError&&(result=JSON.stringify(result)),endIndex==(index+=4))return result;let children=[];for(;index<endIndex;)children.push(this.childString(index)),index=this.buffer[index+3];return result+"("+children.join(",")+")"}findChild(startIndex,endIndex,dir,pos,side){let{buffer:buffer}=this,pick=-1;for(let i=startIndex;i!=endIndex&&!(checkSide(side,pos,buffer[i+1],buffer[i+2])&&(pick=i,dir>0));i=buffer[i+3]);return pick}slice(startI,endI,from){let b=this.buffer,copy=new Uint16Array(endI-startI),len=0;for(let i=startI,j=0;i<endI;){copy[j++]=b[i++],copy[j++]=b[i++]-from;let to=copy[j++]=b[i++]-from;copy[j++]=b[i++]-startI,len=Math.max(len,to)}return new TreeBuffer(copy,len,this.set)}}function checkSide(side,pos,from,to){switch(side){case-2:return from<pos;case-1:return to>=pos&&from<pos;case 0:return from<pos&&to>pos;case 1:return from<=pos&&to>pos;case 2:return to>pos;case 4:return!0}}function enterUnfinishedNodesBefore(node,pos){let scan=node.childBefore(pos);for(;scan;){let last=scan.lastChild;if(!last||last.to!=scan.to)break;last.type.isError&&last.from==last.to?(node=scan,scan=last.prevSibling):scan=last}return node}function resolveNode(node,pos,side,overlays){for(var _a;node.from==node.to||(side<1?node.from>=pos:node.from>pos)||(side>-1?node.to<=pos:node.to<pos);){let parent=!overlays&&node instanceof TreeNode&&node.index<0?null:node.parent;if(!parent)return node;node=parent}let mode=overlays?0:IterMode.IgnoreOverlays;if(overlays)for(let scan=node,parent=scan.parent;parent;scan=parent,parent=scan.parent)scan instanceof TreeNode&&scan.index<0&&(null===(_a=parent.enter(pos,side,mode))||void 0===_a?void 0:_a.from)!=scan.from&&(node=parent);for(;;){let inner=node.enter(pos,side,mode);if(!inner)return node;node=inner}}class TreeNode{constructor(_tree,from,index,_parent){this._tree=_tree,this.from=from,this.index=index,this._parent=_parent}get type(){return this._tree.type}get name(){return this._tree.type.name}get to(){return this.from+this._tree.length}nextChild(i,dir,pos,side,mode=0){for(let parent=this;;){for(let{children:children,positions:positions}=parent._tree,e=dir>0?children.length:-1;i!=e;i+=dir){let next=children[i],start=positions[i]+parent.from;if(checkSide(side,pos,start,start+next.length))if(next instanceof TreeBuffer){if(mode&IterMode.ExcludeBuffers)continue;let index=next.findChild(0,next.buffer.length,dir,pos-start,side);if(index>-1)return new BufferNode(new BufferContext(parent,next,i,start),null,index)}else if(mode&IterMode.IncludeAnonymous||!next.type.isAnonymous||hasChild(next)){let mounted;if(!(mode&IterMode.IgnoreMounts)&&next.props&&(mounted=next.prop(NodeProp.mounted))&&!mounted.overlay)return new TreeNode(mounted.tree,start,i,parent);let inner=new TreeNode(next,start,i,parent);return mode&IterMode.IncludeAnonymous||!inner.type.isAnonymous?inner:inner.nextChild(dir<0?next.children.length-1:0,dir,pos,side)}}if(mode&IterMode.IncludeAnonymous||!parent.type.isAnonymous)return null;if(i=parent.index>=0?parent.index+dir:dir<0?-1:parent._parent._tree.children.length,parent=parent._parent,!parent)return null}}get firstChild(){return this.nextChild(0,1,0,4)}get lastChild(){return this.nextChild(this._tree.children.length-1,-1,0,4)}childAfter(pos){return this.nextChild(0,1,pos,2)}childBefore(pos){return this.nextChild(this._tree.children.length-1,-1,pos,-2)}enter(pos,side,mode=0){let mounted;if(!(mode&IterMode.IgnoreOverlays)&&(mounted=this._tree.prop(NodeProp.mounted))&&mounted.overlay){let rPos=pos-this.from;for(let{from:from,to:to}of mounted.overlay)if((side>0?from<=rPos:from<rPos)&&(side<0?to>=rPos:to>rPos))return new TreeNode(mounted.tree,mounted.overlay[0].from+this.from,-1,this)}return this.nextChild(0,1,pos,side,mode)}nextSignificantParent(){let val=this;for(;val.type.isAnonymous&&val._parent;)val=val._parent;return val}get parent(){return this._parent?this._parent.nextSignificantParent():null}get nextSibling(){return this._parent&&this.index>=0?this._parent.nextChild(this.index+1,1,0,4):null}get prevSibling(){return this._parent&&this.index>=0?this._parent.nextChild(this.index-1,-1,0,4):null}cursor(mode=0){return new TreeCursor(this,mode)}get tree(){return this._tree}toTree(){return this._tree}resolve(pos,side=0){return resolveNode(this,pos,side,!1)}resolveInner(pos,side=0){return resolveNode(this,pos,side,!0)}enterUnfinishedNodesBefore(pos){return enterUnfinishedNodesBefore(this,pos)}getChild(type,before=null,after=null){let r=getChildren(this,type,before,after);return r.length?r[0]:null}getChildren(type,before=null,after=null){return getChildren(this,type,before,after)}toString(){return this._tree.toString()}get node(){return this}matchContext(context){return matchNodeContext(this,context)}}function getChildren(node,type,before,after){let cur=node.cursor(),result=[];if(!cur.firstChild())return result;if(null!=before)for(;!cur.type.is(before);)if(!cur.nextSibling())return result;for(;;){if(null!=after&&cur.type.is(after))return result;if(cur.type.is(type)&&result.push(cur.node),!cur.nextSibling())return null==after?result:[]}}function matchNodeContext(node,context,i=context.length-1){for(let p=node.parent;i>=0;p=p.parent){if(!p)return!1;if(!p.type.isAnonymous){if(context[i]&&context[i]!=p.name)return!1;i--}}return!0}class BufferContext{constructor(parent,buffer,index,start){this.parent=parent,this.buffer=buffer,this.index=index,this.start=start}}class BufferNode{get name(){return this.type.name}get from(){return this.context.start+this.context.buffer.buffer[this.index+1]}get to(){return this.context.start+this.context.buffer.buffer[this.index+2]}constructor(context,_parent,index){this.context=context,this._parent=_parent,this.index=index,this.type=context.buffer.set.types[context.buffer.buffer[index]]}child(dir,pos,side){let{buffer:buffer}=this.context,index=buffer.findChild(this.index+4,buffer.buffer[this.index+3],dir,pos-this.context.start,side);return index<0?null:new BufferNode(this.context,this,index)}get firstChild(){return this.child(1,0,4)}get lastChild(){return this.child(-1,0,4)}childAfter(pos){return this.child(1,pos,2)}childBefore(pos){return this.child(-1,pos,-2)}enter(pos,side,mode=0){if(mode&IterMode.ExcludeBuffers)return null;let{buffer:buffer}=this.context,index=buffer.findChild(this.index+4,buffer.buffer[this.index+3],side>0?1:-1,pos-this.context.start,side);return index<0?null:new BufferNode(this.context,this,index)}get parent(){return this._parent||this.context.parent.nextSignificantParent()}externalSibling(dir){return this._parent?null:this.context.parent.nextChild(this.context.index+dir,dir,0,4)}get nextSibling(){let{buffer:buffer}=this.context,after=buffer.buffer[this.index+3];return after<(this._parent?buffer.buffer[this._parent.index+3]:buffer.buffer.length)?new BufferNode(this.context,this._parent,after):this.externalSibling(1)}get prevSibling(){let{buffer:buffer}=this.context,parentStart=this._parent?this._parent.index+4:0;return this.index==parentStart?this.externalSibling(-1):new BufferNode(this.context,this._parent,buffer.findChild(parentStart,this.index,-1,0,4))}cursor(mode=0){return new TreeCursor(this,mode)}get tree(){return null}toTree(){let children=[],positions=[],{buffer:buffer}=this.context,startI=this.index+4,endI=buffer.buffer[this.index+3];if(endI>startI){let from=buffer.buffer[this.index+1];children.push(buffer.slice(startI,endI,from)),positions.push(0)}return new Tree(this.type,children,positions,this.to-this.from)}resolve(pos,side=0){return resolveNode(this,pos,side,!1)}resolveInner(pos,side=0){return resolveNode(this,pos,side,!0)}enterUnfinishedNodesBefore(pos){return enterUnfinishedNodesBefore(this,pos)}toString(){return this.context.buffer.childString(this.index)}getChild(type,before=null,after=null){let r=getChildren(this,type,before,after);return r.length?r[0]:null}getChildren(type,before=null,after=null){return getChildren(this,type,before,after)}get node(){return this}matchContext(context){return matchNodeContext(this,context)}}class TreeCursor{get name(){return this.type.name}constructor(node,mode=0){if(this.mode=mode,this.buffer=null,this.stack=[],this.index=0,this.bufferNode=null,node instanceof TreeNode)this.yieldNode(node);else{this._tree=node.context.parent,this.buffer=node.context;for(let n=node._parent;n;n=n._parent)this.stack.unshift(n.index);this.bufferNode=node,this.yieldBuf(node.index)}}yieldNode(node){return!!node&&(this._tree=node,this.type=node.type,this.from=node.from,this.to=node.to,!0)}yieldBuf(index,type){this.index=index;let{start:start,buffer:buffer}=this.buffer;return this.type=type||buffer.set.types[buffer.buffer[index]],this.from=start+buffer.buffer[index+1],this.to=start+buffer.buffer[index+2],!0}yield(node){return!!node&&(node instanceof TreeNode?(this.buffer=null,this.yieldNode(node)):(this.buffer=node.context,this.yieldBuf(node.index,node.type)))}toString(){return this.buffer?this.buffer.buffer.childString(this.index):this._tree.toString()}enterChild(dir,pos,side){if(!this.buffer)return this.yield(this._tree.nextChild(dir<0?this._tree._tree.children.length-1:0,dir,pos,side,this.mode));let{buffer:buffer}=this.buffer,index=buffer.findChild(this.index+4,buffer.buffer[this.index+3],dir,pos-this.buffer.start,side);return!(index<0)&&(this.stack.push(this.index),this.yieldBuf(index))}firstChild(){return this.enterChild(1,0,4)}lastChild(){return this.enterChild(-1,0,4)}childAfter(pos){return this.enterChild(1,pos,2)}childBefore(pos){return this.enterChild(-1,pos,-2)}enter(pos,side,mode=this.mode){return this.buffer?!(mode&IterMode.ExcludeBuffers)&&this.enterChild(1,pos,side):this.yield(this._tree.enter(pos,side,mode))}parent(){if(!this.buffer)return this.yieldNode(this.mode&IterMode.IncludeAnonymous?this._tree._parent:this._tree.parent);if(this.stack.length)return this.yieldBuf(this.stack.pop());let parent=this.mode&IterMode.IncludeAnonymous?this.buffer.parent:this.buffer.parent.nextSignificantParent();return this.buffer=null,this.yieldNode(parent)}sibling(dir){if(!this.buffer)return!!this._tree._parent&&this.yield(this._tree.index<0?null:this._tree._parent.nextChild(this._tree.index+dir,dir,0,4,this.mode));let{buffer:buffer}=this.buffer,d=this.stack.length-1;if(dir<0){let parentStart=d<0?0:this.stack[d]+4;if(this.index!=parentStart)return this.yieldBuf(buffer.findChild(parentStart,this.index,-1,0,4))}else{let after=buffer.buffer[this.index+3];if(after<(d<0?buffer.buffer.length:buffer.buffer[this.stack[d]+3]))return this.yieldBuf(after)}return d<0&&this.yield(this.buffer.parent.nextChild(this.buffer.index+dir,dir,0,4,this.mode))}nextSibling(){return this.sibling(1)}prevSibling(){return this.sibling(-1)}atLastNode(dir){let index,parent,{buffer:buffer}=this;if(buffer){if(dir>0){if(this.index<buffer.buffer.buffer.length)return!1}else for(let i=0;i<this.index;i++)if(buffer.buffer.buffer[i+3]<this.index)return!1;({index:index,parent:parent}=buffer)}else({index:index,_parent:parent}=this._tree);for(;parent;({index:index,_parent:parent}=parent))if(index>-1)for(let i=index+dir,e=dir<0?-1:parent._tree.children.length;i!=e;i+=dir){let child=parent._tree.children[i];if(this.mode&IterMode.IncludeAnonymous||child instanceof TreeBuffer||!child.type.isAnonymous||hasChild(child))return!1}return!0}move(dir,enter){if(enter&&this.enterChild(dir,0,4))return!0;for(;;){if(this.sibling(dir))return!0;if(this.atLastNode(dir)||!this.parent())return!1}}next(enter=!0){return this.move(1,enter)}prev(enter=!0){return this.move(-1,enter)}moveTo(pos,side=0){for(;(this.from==this.to||(side<1?this.from>=pos:this.from>pos)||(side>-1?this.to<=pos:this.to<pos))&&this.parent(););for(;this.enterChild(1,pos,side););return this}get node(){if(!this.buffer)return this._tree;let cache=this.bufferNode,result=null,depth=0;if(cache&&cache.context==this.buffer)scan:for(let index=this.index,d=this.stack.length;d>=0;){for(let c=cache;c;c=c._parent)if(c.index==index){if(index==this.index)return c;result=c,depth=d+1;break scan}index=this.stack[--d]}for(let i=depth;i<this.stack.length;i++)result=new BufferNode(this.buffer,result,this.stack[i]);return this.bufferNode=new BufferNode(this.buffer,result,this.index)}get tree(){return this.buffer?null:this._tree._tree}iterate(enter,leave){for(let depth=0;;){let mustLeave=!1;if(this.type.isAnonymous||!1!==enter(this)){if(this.firstChild()){depth++;continue}this.type.isAnonymous||(mustLeave=!0)}for(;mustLeave&&leave&&leave(this),mustLeave=this.type.isAnonymous,!this.nextSibling();){if(!depth)return;this.parent(),depth--,mustLeave=!0}}}matchContext(context){if(!this.buffer)return matchNodeContext(this.node,context);let{buffer:buffer}=this.buffer,{types:types}=buffer.set;for(let i=context.length-1,d=this.stack.length-1;i>=0;d--){if(d<0)return matchNodeContext(this.node,context,i);let type=types[buffer.buffer[this.stack[d]]];if(!type.isAnonymous){if(context[i]&&context[i]!=type.name)return!1;i--}}return!0}}function hasChild(tree){return tree.children.some((ch=>ch instanceof TreeBuffer||!ch.type.isAnonymous||hasChild(ch)))}const nodeSizeCache=new WeakMap;function nodeSize(balanceType,node){if(!balanceType.isAnonymous||node instanceof TreeBuffer||node.type!=balanceType)return 1;let size=nodeSizeCache.get(node);if(null==size){size=1;for(let child of node.children){if(child.type!=balanceType||!(child instanceof Tree)){size=1;break}size+=nodeSize(balanceType,child)}nodeSizeCache.set(node,size)}return size}function balanceRange(balanceType,children,positions,from,to,start,length,mkTop,mkTree){let total=0;for(let i=from;i<to;i++)total+=nodeSize(balanceType,children[i]);let maxChild=Math.ceil(1.5*total/8),localChildren=[],localPositions=[];return function divide(children,positions,from,to,offset){for(let i=from;i<to;){let groupFrom=i,groupStart=positions[i],groupSize=nodeSize(balanceType,children[i]);for(i++;i<to;i++){let nextSize=nodeSize(balanceType,children[i]);if(groupSize+nextSize>=maxChild)break;groupSize+=nextSize}if(i==groupFrom+1){if(groupSize>maxChild){let only=children[groupFrom];divide(only.children,only.positions,0,only.children.length,positions[groupFrom]+offset);continue}localChildren.push(children[groupFrom])}else{let length=positions[i-1]+children[i-1].length-groupStart;localChildren.push(balanceRange(balanceType,children,positions,groupFrom,i,groupStart,length,null,mkTree))}localPositions.push(groupStart+offset-start)}}(children,positions,from,to,0),(mkTop||mkTree)(localChildren,localPositions,length)}class TreeFragment{constructor(from,to,tree,offset,openStart=!1,openEnd=!1){this.from=from,this.to=to,this.tree=tree,this.offset=offset,this.open=(openStart?1:0)|(openEnd?2:0)}get openStart(){return(1&this.open)>0}get openEnd(){return(2&this.open)>0}static addTree(tree,fragments=[],partial=!1){let result=[new TreeFragment(0,tree.length,tree,0,!1,partial)];for(let f of fragments)f.to>tree.length&&result.push(f);return result}static applyChanges(fragments,changes,minGap=128){if(!changes.length)return fragments;let result=[],fI=1,nextF=fragments.length?fragments[0]:null;for(let cI=0,pos=0,off=0;;cI++){let nextC=cI<changes.length?changes[cI]:null,nextPos=nextC?nextC.fromA:1e9;if(nextPos-pos>=minGap)for(;nextF&&nextF.from<nextPos;){let cut=nextF;if(pos>=cut.from||nextPos<=cut.to||off){let fFrom=Math.max(cut.from,pos)-off,fTo=Math.min(cut.to,nextPos)-off;cut=fFrom>=fTo?null:new TreeFragment(fFrom,fTo,cut.tree,cut.offset+off,cI>0,!!nextC)}if(cut&&result.push(cut),nextF.to>nextPos)break;nextF=fI<fragments.length?fragments[fI++]:null}if(!nextC)break;pos=nextC.toA,off=nextC.toA-nextC.toB}return result}}class Parser{startParse(input,fragments,ranges){return"string"==typeof input&&(input=new StringInput(input)),ranges=ranges?ranges.length?ranges.map((r=>new Range(r.from,r.to))):[new Range(0,0)]:[new Range(0,input.length)],this.createParse(input,fragments||[],ranges)}parse(input,fragments,ranges){let parse=this.startParse(input,fragments,ranges);for(;;){let done=parse.advance();if(done)return done}}}class StringInput{constructor(string){this.string=string}get length(){return this.string.length}chunk(from){return this.string.slice(from)}get lineChunks(){return!1}read(from,to){return this.string.slice(from,to)}}new NodeProp({perNode:!0});let nextTagID=0;class Tag{constructor(set,base,modified){this.set=set,this.base=base,this.modified=modified,this.id=nextTagID++}static define(parent){if(null==parent?void 0:parent.base)throw new Error("Can not derive from a modified tag");let tag=new Tag([],null,[]);if(tag.set.push(tag),parent)for(let t of parent.set)tag.set.push(t);return tag}static defineModifier(){let mod=new Modifier;return tag=>tag.modified.indexOf(mod)>-1?tag:Modifier.get(tag.base||tag,tag.modified.concat(mod).sort(((a,b)=>a.id-b.id)))}}let nextModifierID=0;class Modifier{constructor(){this.instances=[],this.id=nextModifierID++}static get(base,mods){if(!mods.length)return base;let exists=mods[0].instances.find((t=>{return t.base==base&&(a=mods,b=t.modified,a.length==b.length&&a.every(((x,i)=>x==b[i])));var a,b}));if(exists)return exists;let set=[],tag=new Tag(set,base,mods);for(let m of mods)m.instances.push(tag);let configs=function(array){let sets=[[]];for(let i=0;i<array.length;i++)for(let j=0,e=sets.length;j<e;j++)sets.push(sets[j].concat(array[i]));return sets.sort(((a,b)=>b.length-a.length))}(mods);for(let parent of base.set)if(!parent.modified.length)for(let config of configs)set.push(Modifier.get(parent,config));return tag}}function styleTags(spec){let byName=Object.create(null);for(let prop in spec){let tags=spec[prop];Array.isArray(tags)||(tags=[tags]);for(let part of prop.split(" "))if(part){let pieces=[],mode=2,rest=part;for(let pos=0;;){if("..."==rest&&pos>0&&pos+3==part.length){mode=1;break}let m=/^"(?:[^"\\]|\\.)*?"|[^\/!]+/.exec(rest);if(!m)throw new RangeError("Invalid path: "+part);if(pieces.push("*"==m[0]?"":'"'==m[0][0]?JSON.parse(m[0]):m[0]),pos+=m[0].length,pos==part.length)break;let next=part[pos++];if(pos==part.length&&"!"==next){mode=0;break}if("/"!=next)throw new RangeError("Invalid path: "+part);rest=part.slice(pos)}let last=pieces.length-1,inner=pieces[last];if(!inner)throw new RangeError("Invalid path: "+part);let rule=new Rule(tags,mode,last>0?pieces.slice(0,last):null);byName[inner]=rule.sort(byName[inner])}}return ruleNodeProp.add(byName)}const ruleNodeProp=new NodeProp;class Rule{constructor(tags,mode,context,next){this.tags=tags,this.mode=mode,this.context=context,this.next=next}get opaque(){return 0==this.mode}get inherit(){return 1==this.mode}sort(other){return!other||other.depth<this.depth?(this.next=other,this):(other.next=this.sort(other.next),other)}get depth(){return this.context?this.context.length:0}}function tagHighlighter(tags,options){let map=Object.create(null);for(let style of tags)if(Array.isArray(style.tag))for(let tag of style.tag)map[tag.id]=style.class;else map[style.tag.id]=style.class;let{scope:scope,all:all=null}=options||{};return{style:tags=>{let cls=all;for(let tag of tags)for(let sub of tag.set){let tagClass=map[sub.id];if(tagClass){cls=cls?cls+" "+tagClass:tagClass;break}}return cls},scope:scope}}function highlightTree(tree,highlighter,putStyle,from=0,to=tree.length){let builder=new HighlightBuilder(from,Array.isArray(highlighter)?highlighter:[highlighter],putStyle);builder.highlightRange(tree.cursor(),from,to,"",builder.highlighters),builder.flush(to)}Rule.empty=new Rule([],2,null);class HighlightBuilder{constructor(at,highlighters,span){this.at=at,this.highlighters=highlighters,this.span=span,this.class=""}startSpan(at,cls){cls!=this.class&&(this.flush(at),at>this.at&&(this.at=at),this.class=cls)}flush(to){to>this.at&&this.class&&this.span(this.at,to,this.class)}highlightRange(cursor,from,to,inheritedClass,highlighters){let{type:type,from:start,to:end}=cursor;if(start>=to||end<=from)return;type.isTop&&(highlighters=this.highlighters.filter((h=>!h.scope||h.scope(type))));let cls=inheritedClass,rule=function(node){let rule=node.type.prop(ruleNodeProp);for(;rule&&rule.context&&!node.matchContext(rule.context);)rule=rule.next;return rule||null}(cursor)||Rule.empty,tagCls=function(highlighters,tags){let result=null;for(let highlighter of highlighters){let value=highlighter.style(tags);value&&(result=result?result+" "+value:value)}return result}(highlighters,rule.tags);if(tagCls&&(cls&&(cls+=" "),cls+=tagCls,1==rule.mode&&(inheritedClass+=(inheritedClass?" ":"")+tagCls)),this.startSpan(cursor.from,cls),rule.opaque)return;let mounted=cursor.tree&&cursor.tree.prop(NodeProp.mounted);if(mounted&&mounted.overlay){let inner=cursor.node.enter(mounted.overlay[0].from+start,1),innerHighlighters=this.highlighters.filter((h=>!h.scope||h.scope(mounted.tree.type))),hasChild=cursor.firstChild();for(let i=0,pos=start;;i++){let next=i<mounted.overlay.length?mounted.overlay[i]:null,nextPos=next?next.from+start:end,rangeFrom=Math.max(from,pos),rangeTo=Math.min(to,nextPos);if(rangeFrom<rangeTo&&hasChild)for(;cursor.from<rangeTo&&(this.highlightRange(cursor,rangeFrom,rangeTo,inheritedClass,highlighters),this.startSpan(Math.min(rangeTo,cursor.to),cls),!(cursor.to>=nextPos)&&cursor.nextSibling()););if(!next||nextPos>to)break;pos=next.to+start,pos>from&&(this.highlightRange(inner.cursor(),Math.max(from,next.from+start),Math.min(to,pos),inheritedClass,innerHighlighters),this.startSpan(pos,cls))}hasChild&&cursor.parent()}else if(cursor.firstChild()){do{if(!(cursor.to<=from)){if(cursor.from>=to)break;this.highlightRange(cursor,from,to,inheritedClass,highlighters),this.startSpan(Math.min(to,cursor.to),cls)}}while(cursor.nextSibling());cursor.parent()}}}const t=Tag.define,comment=t(),name=t(),typeName=t(name),propertyName=t(name),literal=t(),string=t(literal),number=t(literal),content=t(),heading=t(content),keyword=t(),operator=t(),punctuation=t(),bracket=t(punctuation),meta=t(),tags={comment:comment,lineComment:t(comment),blockComment:t(comment),docComment:t(comment),name:name,variableName:t(name),typeName:typeName,tagName:t(typeName),propertyName:propertyName,attributeName:t(propertyName),className:t(name),labelName:t(name),namespace:t(name),macroName:t(name),literal:literal,string:string,docString:t(string),character:t(string),attributeValue:t(string),number:number,integer:t(number),float:t(number),bool:t(literal),regexp:t(literal),escape:t(literal),color:t(literal),url:t(literal),keyword:keyword,self:t(keyword),null:t(keyword),atom:t(keyword),unit:t(keyword),modifier:t(keyword),operatorKeyword:t(keyword),controlKeyword:t(keyword),definitionKeyword:t(keyword),moduleKeyword:t(keyword),operator:operator,derefOperator:t(operator),arithmeticOperator:t(operator),logicOperator:t(operator),bitwiseOperator:t(operator),compareOperator:t(operator),updateOperator:t(operator),definitionOperator:t(operator),typeOperator:t(operator),controlOperator:t(operator),punctuation:punctuation,separator:t(punctuation),bracket:bracket,angleBracket:t(bracket),squareBracket:t(bracket),paren:t(bracket),brace:t(bracket),content:content,heading:heading,heading1:t(heading),heading2:t(heading),heading3:t(heading),heading4:t(heading),heading5:t(heading),heading6:t(heading),contentSeparator:t(content),list:t(content),quote:t(content),emphasis:t(content),strong:t(content),link:t(content),monospace:t(content),strikethrough:t(content),inserted:t(),deleted:t(),changed:t(),invalid:t(),meta:meta,documentMeta:t(meta),annotation:t(meta),processingInstruction:t(meta),definition:Tag.defineModifier(),constant:Tag.defineModifier(),function:Tag.defineModifier(),standard:Tag.defineModifier(),local:Tag.defineModifier(),special:Tag.defineModifier()};var _a;tagHighlighter([{tag:tags.link,class:"tok-link"},{tag:tags.heading,class:"tok-heading"},{tag:tags.emphasis,class:"tok-emphasis"},{tag:tags.strong,class:"tok-strong"},{tag:tags.keyword,class:"tok-keyword"},{tag:tags.atom,class:"tok-atom"},{tag:tags.bool,class:"tok-bool"},{tag:tags.url,class:"tok-url"},{tag:tags.labelName,class:"tok-labelName"},{tag:tags.inserted,class:"tok-inserted"},{tag:tags.deleted,class:"tok-deleted"},{tag:tags.literal,class:"tok-literal"},{tag:tags.string,class:"tok-string"},{tag:tags.number,class:"tok-number"},{tag:[tags.regexp,tags.escape,tags.special(tags.string)],class:"tok-string2"},{tag:tags.variableName,class:"tok-variableName"},{tag:tags.local(tags.variableName),class:"tok-variableName tok-local"},{tag:tags.definition(tags.variableName),class:"tok-variableName tok-definition"},{tag:tags.special(tags.variableName),class:"tok-variableName2"},{tag:tags.definition(tags.propertyName),class:"tok-propertyName tok-definition"},{tag:tags.typeName,class:"tok-typeName"},{tag:tags.namespace,class:"tok-namespace"},{tag:tags.className,class:"tok-className"},{tag:tags.macroName,class:"tok-macroName"},{tag:tags.propertyName,class:"tok-propertyName"},{tag:tags.operator,class:"tok-operator"},{tag:tags.comment,class:"tok-comment"},{tag:tags.meta,class:"tok-meta"},{tag:tags.invalid,class:"tok-invalid"},{tag:tags.punctuation,class:"tok-punctuation"}]);const languageDataProp=new NodeProp;const sublanguageProp=new NodeProp;class Language{constructor(data,parser,extraExtensions=[],name=""){this.data=data,this.name=name,EditorState.prototype.hasOwnProperty("tree")||Object.defineProperty(EditorState.prototype,"tree",{get(){return syntaxTree(this)}}),this.parser=parser,this.extension=[language$1.of(this),EditorState.languageData.of(((state,pos,side)=>{let top=topNodeAt(state,pos,side),data=top.type.prop(languageDataProp);if(!data)return[];let base=state.facet(data),sub=top.type.prop(sublanguageProp);if(sub){let innerNode=top.resolve(pos-top.from,side);for(let sublang of sub)if(sublang.test(innerNode,state)){let data=state.facet(sublang.facet);return"replace"==sublang.type?data:data.concat(base)}}return base}))].concat(extraExtensions)}isActiveAt(state,pos,side=-1){return topNodeAt(state,pos,side).type.prop(languageDataProp)==this.data}findRegions(state){let lang=state.facet(language$1);if((null==lang?void 0:lang.data)==this.data)return[{from:0,to:state.doc.length}];if(!lang||!lang.allowsNesting)return[];let result=[],explore=(tree,from)=>{if(tree.prop(languageDataProp)==this.data)return void result.push({from:from,to:from+tree.length});let mount=tree.prop(NodeProp.mounted);if(mount){if(mount.tree.prop(languageDataProp)==this.data){if(mount.overlay)for(let r of mount.overlay)result.push({from:r.from+from,to:r.to+from});else result.push({from:from,to:from+tree.length});return}if(mount.overlay){let size=result.length;if(explore(mount.tree,mount.overlay[0].from+from),result.length>size)return}}for(let i=0;i<tree.children.length;i++){let ch=tree.children[i];ch instanceof Tree&&explore(ch,tree.positions[i]+from)}};return explore(syntaxTree(state),0),result}get allowsNesting(){return!0}}function topNodeAt(state,pos,side){let topLang=state.facet(language$1),tree=syntaxTree(state).topNode;if(!topLang||topLang.allowsNesting)for(let node=tree;node;node=node.enter(pos,side,IterMode.ExcludeBuffers))node.type.isTop&&(tree=node);return tree}Language.setState=StateEffect.define();class LRLanguage extends Language{constructor(data,parser,name){super(data,parser,[],name),this.parser=parser}static define(spec){let data=(baseData=spec.languageData,Facet.define({combine:baseData?values=>values.concat(baseData):void 0}));var baseData;return new LRLanguage(data,spec.parser.configure({props:[languageDataProp.add((type=>type.isTop?data:void 0))]}),spec.name)}configure(options,name){return new LRLanguage(this.data,this.parser.configure(options),name||this.name)}get allowsNesting(){return this.parser.hasWrappers()}}function syntaxTree(state){let field=state.field(Language.state,!1);return field?field.tree:Tree.empty}class DocInput{constructor(doc){this.doc=doc,this.cursorPos=0,this.string="",this.cursor=doc.iter()}get length(){return this.doc.length}syncTo(pos){return this.string=this.cursor.next(pos-this.cursorPos).value,this.cursorPos=pos+this.string.length,this.cursorPos-this.string.length}chunk(pos){return this.syncTo(pos),this.string}get lineChunks(){return!0}read(from,to){let stringStart=this.cursorPos-this.string.length;return from<stringStart||to>=this.cursorPos?this.doc.sliceString(from,to):this.string.slice(from-stringStart,to-stringStart)}}let currentContext=null;class ParseContext{constructor(parser,state,fragments=[],tree,treeLen,viewport,skipped,scheduleOn){this.parser=parser,this.state=state,this.fragments=fragments,this.tree=tree,this.treeLen=treeLen,this.viewport=viewport,this.skipped=skipped,this.scheduleOn=scheduleOn,this.parse=null,this.tempSkipped=[]}static create(parser,state,viewport){return new ParseContext(parser,state,[],Tree.empty,0,viewport,[],null)}startParse(){return this.parser.startParse(new DocInput(this.state.doc),this.fragments)}work(until,upto){return null!=upto&&upto>=this.state.doc.length&&(upto=void 0),this.tree!=Tree.empty&&this.isDone(null!=upto?upto:this.state.doc.length)?(this.takeTree(),!0):this.withContext((()=>{var _a;if("number"==typeof until){let endTime=Date.now()+until;until=()=>Date.now()>endTime}for(this.parse||(this.parse=this.startParse()),null!=upto&&(null==this.parse.stoppedAt||this.parse.stoppedAt>upto)&&upto<this.state.doc.length&&this.parse.stopAt(upto);;){let done=this.parse.advance();if(done){if(this.fragments=this.withoutTempSkipped(TreeFragment.addTree(done,this.fragments,null!=this.parse.stoppedAt)),this.treeLen=null!==(_a=this.parse.stoppedAt)&&void 0!==_a?_a:this.state.doc.length,this.tree=done,this.parse=null,!(this.treeLen<(null!=upto?upto:this.state.doc.length)))return!0;this.parse=this.startParse()}if(until())return!1}}))}takeTree(){let pos,tree;this.parse&&(pos=this.parse.parsedPos)>=this.treeLen&&((null==this.parse.stoppedAt||this.parse.stoppedAt>pos)&&this.parse.stopAt(pos),this.withContext((()=>{for(;!(tree=this.parse.advance()););})),this.treeLen=pos,this.tree=tree,this.fragments=this.withoutTempSkipped(TreeFragment.addTree(this.tree,this.fragments,!0)),this.parse=null)}withContext(f){let prev=currentContext;currentContext=this;try{return f()}finally{currentContext=prev}}withoutTempSkipped(fragments){for(let r;r=this.tempSkipped.pop();)fragments=cutFragments(fragments,r.from,r.to);return fragments}changes(changes,newState){let{fragments:fragments,tree:tree,treeLen:treeLen,viewport:viewport,skipped:skipped}=this;if(this.takeTree(),!changes.empty){let ranges=[];if(changes.iterChangedRanges(((fromA,toA,fromB,toB)=>ranges.push({fromA:fromA,toA:toA,fromB:fromB,toB:toB}))),fragments=TreeFragment.applyChanges(fragments,ranges),tree=Tree.empty,treeLen=0,viewport={from:changes.mapPos(viewport.from,-1),to:changes.mapPos(viewport.to,1)},this.skipped.length){skipped=[];for(let r of this.skipped){let from=changes.mapPos(r.from,1),to=changes.mapPos(r.to,-1);from<to&&skipped.push({from:from,to:to})}}}return new ParseContext(this.parser,newState,fragments,tree,treeLen,viewport,skipped,this.scheduleOn)}updateViewport(viewport){if(this.viewport.from==viewport.from&&this.viewport.to==viewport.to)return!1;this.viewport=viewport;let startLen=this.skipped.length;for(let i=0;i<this.skipped.length;i++){let{from:from,to:to}=this.skipped[i];from<viewport.to&&to>viewport.from&&(this.fragments=cutFragments(this.fragments,from,to),this.skipped.splice(i--,1))}return!(this.skipped.length>=startLen)&&(this.reset(),!0)}reset(){this.parse&&(this.takeTree(),this.parse=null)}skipUntilInView(from,to){this.skipped.push({from:from,to:to})}static getSkippingParser(until){return new class extends Parser{createParse(input,fragments,ranges){let from=ranges[0].from,to=ranges[ranges.length-1].to;return{parsedPos:from,advance(){let cx=currentContext;if(cx){for(let r of ranges)cx.tempSkipped.push(r);until&&(cx.scheduleOn=cx.scheduleOn?Promise.all([cx.scheduleOn,until]):until)}return this.parsedPos=to,new Tree(NodeType.none,[],[],to-from)},stoppedAt:null,stopAt(){}}}}}isDone(upto){upto=Math.min(upto,this.state.doc.length);let frags=this.fragments;return this.treeLen>=upto&&frags.length&&0==frags[0].from&&frags[0].to>=upto}static get(){return currentContext}}function cutFragments(fragments,from,to){return TreeFragment.applyChanges(fragments,[{fromA:from,toA:to,fromB:from,toB:to}])}class LanguageState{constructor(context){this.context=context,this.tree=context.tree}apply(tr){if(!tr.docChanged&&this.tree==this.context.tree)return this;let newCx=this.context.changes(tr.changes,tr.state),upto=this.context.treeLen==tr.startState.doc.length?void 0:Math.max(tr.changes.mapPos(this.context.treeLen),newCx.viewport.to);return newCx.work(20,upto)||newCx.takeTree(),new LanguageState(newCx)}static init(state){let vpTo=Math.min(3e3,state.doc.length),parseState=ParseContext.create(state.facet(language$1).parser,state,{from:0,to:vpTo});return parseState.work(20,vpTo)||parseState.takeTree(),new LanguageState(parseState)}}Language.state=StateField.define({create:LanguageState.init,update(value,tr){for(let e of tr.effects)if(e.is(Language.setState))return e.value;return tr.startState.facet(language$1)!=tr.state.facet(language$1)?LanguageState.init(tr.state):value.apply(tr)}});let requestIdle=callback=>{let timeout=setTimeout((()=>callback()),500);return()=>clearTimeout(timeout)};"undefined"!=typeof requestIdleCallback&&(requestIdle=callback=>{let idle=-1,timeout=setTimeout((()=>{idle=requestIdleCallback(callback,{timeout:400})}),100);return()=>idle<0?clearTimeout(timeout):cancelIdleCallback(idle)});const isInputPending="undefined"!=typeof navigator&&(null===(_a=navigator.scheduling)||void 0===_a?void 0:_a.isInputPending)?()=>navigator.scheduling.isInputPending():null,parseWorker=ViewPlugin.fromClass(class{constructor(view){this.view=view,this.working=null,this.workScheduled=0,this.chunkEnd=-1,this.chunkBudget=-1,this.work=this.work.bind(this),this.scheduleWork()}update(update){let cx=this.view.state.field(Language.state).context;(cx.updateViewport(update.view.viewport)||this.view.viewport.to>cx.treeLen)&&this.scheduleWork(),update.docChanged&&(this.view.hasFocus&&(this.chunkBudget+=50),this.scheduleWork()),this.checkAsyncSchedule(cx)}scheduleWork(){if(this.working)return;let{state:state}=this.view,field=state.field(Language.state);field.tree==field.context.tree&&field.context.isDone(state.doc.length)||(this.working=requestIdle(this.work))}work(deadline){this.working=null;let now=Date.now();if(this.chunkEnd<now&&(this.chunkEnd<0||this.view.hasFocus)&&(this.chunkEnd=now+3e4,this.chunkBudget=3e3),this.chunkBudget<=0)return;let{state:state,viewport:{to:vpTo}}=this.view,field=state.field(Language.state);if(field.tree==field.context.tree&&field.context.isDone(vpTo+1e5))return;let endTime=Date.now()+Math.min(this.chunkBudget,100,deadline&&!isInputPending?Math.max(25,deadline.timeRemaining()-5):1e9),viewportFirst=field.context.treeLen<vpTo&&state.doc.length>vpTo+1e3,done=field.context.work((()=>isInputPending&&isInputPending()||Date.now()>endTime),vpTo+(viewportFirst?0:1e5));this.chunkBudget-=Date.now()-now,(done||this.chunkBudget<=0)&&(field.context.takeTree(),this.view.dispatch({effects:Language.setState.of(new LanguageState(field.context))})),this.chunkBudget>0&&(!done||viewportFirst)&&this.scheduleWork(),this.checkAsyncSchedule(field.context)}checkAsyncSchedule(cx){cx.scheduleOn&&(this.workScheduled++,cx.scheduleOn.then((()=>this.scheduleWork())).catch((err=>logException(this.view.state,err))).then((()=>this.workScheduled--)),cx.scheduleOn=null)}destroy(){this.working&&this.working()}isWorking(){return!!(this.working||this.workScheduled>0)}},{eventHandlers:{focus(){this.scheduleWork()}}}),language$1=Facet.define({combine:languages=>languages.length?languages[0]:null,enables:language=>[Language.state,parseWorker,EditorView.contentAttributes.compute([language],(state=>{let lang=state.facet(language);return lang&&lang.name?{"data-language":lang.name}:{}}))]});class LanguageSupport{constructor(language,support=[]){this.language=language,this.support=support,this.extension=[language,support]}}const indentService=Facet.define(),indentUnit=Facet.define({combine:values=>{if(!values.length)return"  ";let unit=values[0];if(!unit||/\S/.test(unit)||Array.from(unit).some((e=>e!=unit[0])))throw new Error("Invalid indent unit: "+JSON.stringify(values[0]));return unit}});function getIndentUnit(state){let unit=state.facet(indentUnit);return 9==unit.charCodeAt(0)?state.tabSize*unit.length:unit.length}function indentString(state,cols){let result="",ts=state.tabSize,ch=state.facet(indentUnit)[0];if("\t"==ch){for(;cols>=ts;)result+="\t",cols-=ts;ch=" "}for(let i=0;i<cols;i++)result+=ch;return result}function getIndentation(context,pos){context instanceof EditorState&&(context=new IndentContext(context));for(let service of context.state.facet(indentService)){let result=service(context,pos);if(void 0!==result)return result}let tree=syntaxTree(context.state);return tree?function(cx,ast,pos){return indentFrom(ast.resolveInner(pos).enterUnfinishedNodesBefore(pos),pos,cx)}(context,tree,pos):null}class IndentContext{constructor(state,options={}){this.state=state,this.options=options,this.unit=getIndentUnit(state)}lineAt(pos,bias=1){let line=this.state.doc.lineAt(pos),{simulateBreak:simulateBreak,simulateDoubleBreak:simulateDoubleBreak}=this.options;return null!=simulateBreak&&simulateBreak>=line.from&&simulateBreak<=line.to?simulateDoubleBreak&&simulateBreak==pos?{text:"",from:pos}:(bias<0?simulateBreak<pos:simulateBreak<=pos)?{text:line.text.slice(simulateBreak-line.from),from:simulateBreak}:{text:line.text.slice(0,simulateBreak-line.from),from:line.from}:line}textAfterPos(pos,bias=1){if(this.options.simulateDoubleBreak&&pos==this.options.simulateBreak)return"";let{text:text,from:from}=this.lineAt(pos,bias);return text.slice(pos-from,Math.min(text.length,pos+100-from))}column(pos,bias=1){let{text:text,from:from}=this.lineAt(pos,bias),result=this.countColumn(text,pos-from),override=this.options.overrideIndentation?this.options.overrideIndentation(from):-1;return override>-1&&(result+=override-this.countColumn(text,text.search(/\S|$/))),result}countColumn(line,pos=line.length){return countColumn(line,this.state.tabSize,pos)}lineIndent(pos,bias=1){let{text:text,from:from}=this.lineAt(pos,bias),override=this.options.overrideIndentation;if(override){let overriden=override(from);if(overriden>-1)return overriden}return this.countColumn(text,text.search(/\S|$/))}get simulatedBreak(){return this.options.simulateBreak||null}}const indentNodeProp=new NodeProp;function indentStrategy(tree){let strategy=tree.type.prop(indentNodeProp);if(strategy)return strategy;let close,first=tree.firstChild;if(first&&(close=first.type.prop(NodeProp.closedBy))){let last=tree.lastChild,closed=last&&close.indexOf(last.name)>-1;return cx=>delimitedStrategy(cx,!0,1,void 0,closed&&!function(cx){return cx.pos==cx.options.simulateBreak&&cx.options.simulateDoubleBreak}(cx)?last.from:void 0)}return null==tree.parent?topIndent:null}function indentFrom(node,pos,base){for(;node;node=node.parent){let strategy=indentStrategy(node);if(strategy)return strategy(TreeIndentContext.create(base,pos,node))}return null}function topIndent(){return 0}class TreeIndentContext extends IndentContext{constructor(base,pos,node){super(base.state,base.options),this.base=base,this.pos=pos,this.node=node}static create(base,pos,node){return new TreeIndentContext(base,pos,node)}get textAfter(){return this.textAfterPos(this.pos)}get baseIndent(){let line=this.state.doc.lineAt(this.node.from);for(;;){let atBreak=this.node.resolve(line.from);for(;atBreak.parent&&atBreak.parent.from==atBreak.from;)atBreak=atBreak.parent;if(isParent(atBreak,this.node))break;line=this.state.doc.lineAt(atBreak.from)}return this.lineIndent(line.from)}continue(){let parent=this.node.parent;return parent?indentFrom(parent,this.pos,this.base):0}}function isParent(parent,of){for(let cur=of;cur;cur=cur.parent)if(parent==cur)return!0;return!1}function delimitedIndent({closing:closing,align:align=!0,units:units=1}){return context=>delimitedStrategy(context,align,units,closing)}function delimitedStrategy(context,align,units,closing,closedAt){let after=context.textAfter,space=after.match(/^\s*/)[0].length,closed=closing&&after.slice(space,space+closing.length)==closing||closedAt==context.pos+space,aligned=align?function(context){let tree=context.node,openToken=tree.childAfter(tree.from),last=tree.lastChild;if(!openToken)return null;let sim=context.options.simulateBreak,openLine=context.state.doc.lineAt(openToken.from),lineEnd=null==sim||sim<=openLine.from?openLine.to:Math.min(openLine.to,sim);for(let pos=openToken.to;;){let next=tree.childAfter(pos);if(!next||next==last)return null;if(!next.type.isSkipped)return next.from<lineEnd?openToken:null;pos=next.to}}(context):null;return aligned?closed?context.column(aligned.from):context.column(aligned.to):context.baseIndent+(closed?0:context.unit*units)}function continuedIndent({except:except,units:units=1}={}){return context=>{let matchExcept=except&&except.test(context.textAfter);return context.baseIndent+(matchExcept?0:units*context.unit)}}const foldService=Facet.define(),foldNodeProp=new NodeProp;function foldInside(node){let first=node.firstChild,last=node.lastChild;return first&&first.to<last.from?{from:first.to,to:last.type.isError?node.to:last.from}:null}function isUnfinished(node){let ch=node.lastChild;return ch&&ch.to==node.to&&ch.type.isError}function foldable(state,lineStart,lineEnd){for(let service of state.facet(foldService)){let result=service(state,lineStart,lineEnd);if(result)return result}return function(state,start,end){let tree=syntaxTree(state);if(tree.length<end)return null;let found=null;for(let cur=tree.resolveInner(end,1);cur;cur=cur.parent){if(cur.to<=end||cur.from>end)continue;if(found&&cur.from<start)break;let prop=cur.type.prop(foldNodeProp);if(prop&&(cur.to<tree.length-50||tree.length==state.doc.length||!isUnfinished(cur))){let value=prop(cur,state);value&&value.from<=end&&value.from>=start&&value.to>end&&(found=value)}}return found}(state,lineStart,lineEnd)}function mapRange(range,mapping){let from=mapping.mapPos(range.from,1),to=mapping.mapPos(range.to,-1);return from>=to?void 0:{from:from,to:to}}const foldEffect=StateEffect.define({map:mapRange}),unfoldEffect=StateEffect.define({map:mapRange}),foldState=StateField.define({create:()=>Decoration.none,update(folded,tr){folded=folded.map(tr.changes);for(let e of tr.effects)e.is(foldEffect)&&!foldExists(folded,e.value.from,e.value.to)?folded=folded.update({add:[foldWidget.range(e.value.from,e.value.to)]}):e.is(unfoldEffect)&&(folded=folded.update({filter:(from,to)=>e.value.from!=from||e.value.to!=to,filterFrom:e.value.from,filterTo:e.value.to}));if(tr.selection){let onSelection=!1,{head:head}=tr.selection.main;folded.between(head,head,((a,b)=>{a<head&&b>head&&(onSelection=!0)})),onSelection&&(folded=folded.update({filterFrom:head,filterTo:head,filter:(a,b)=>b<=head||a>=head}))}return folded},provide:f=>EditorView.decorations.from(f),toJSON(folded,state){let ranges=[];return folded.between(0,state.doc.length,((from,to)=>{ranges.push(from,to)})),ranges},fromJSON(value){if(!Array.isArray(value)||value.length%2)throw new RangeError("Invalid JSON for fold state");let ranges=[];for(let i=0;i<value.length;){let from=value[i++],to=value[i++];if("number"!=typeof from||"number"!=typeof to)throw new RangeError("Invalid JSON for fold state");ranges.push(foldWidget.range(from,to))}return Decoration.set(ranges,!0)}});function findFold(state,from,to){var _a;let found=null;return null===(_a=state.field(foldState,!1))||void 0===_a||_a.between(from,to,((from,to)=>{(!found||found.from>from)&&(found={from:from,to:to})})),found}function foldExists(folded,from,to){let found=!1;return folded.between(from,from,((a,b)=>{a==from&&b==to&&(found=!0)})),found}const defaultConfig={placeholderDOM:null,placeholderText:"…"},foldConfig=Facet.define({combine:values=>combineConfig(values,defaultConfig)});function codeFolding(config){let result=[foldState,baseTheme$1$1];return config&&result.push(foldConfig.of(config)),result}const foldWidget=Decoration.replace({widget:new class extends WidgetType{toDOM(view){let{state:state}=view,conf=state.facet(foldConfig),onclick=event=>{let line=view.lineBlockAt(view.posAtDOM(event.target)),folded=findFold(view.state,line.from,line.to);folded&&view.dispatch({effects:unfoldEffect.of(folded)}),event.preventDefault()};if(conf.placeholderDOM)return conf.placeholderDOM(view,onclick);let element=document.createElement("span");return element.textContent=conf.placeholderText,element.setAttribute("aria-label",state.phrase("folded code")),element.title=state.phrase("unfold"),element.className="cm-foldPlaceholder",element.onclick=onclick,element}}}),foldGutterDefaults={openText:"⌄",closedText:"›",markerDOM:null,domEventHandlers:{},foldingChanged:()=>!1};class FoldMarker extends GutterMarker{constructor(config,open){super(),this.config=config,this.open=open}eq(other){return this.config==other.config&&this.open==other.open}toDOM(view){if(this.config.markerDOM)return this.config.markerDOM(this.open);let span=document.createElement("span");return span.textContent=this.open?this.config.openText:this.config.closedText,span.title=view.state.phrase(this.open?"Fold line":"Unfold line"),span}}function foldGutter(config={}){let fullConfig=Object.assign(Object.assign({},foldGutterDefaults),config),canFold=new FoldMarker(fullConfig,!0),canUnfold=new FoldMarker(fullConfig,!1),markers=ViewPlugin.fromClass(class{constructor(view){this.from=view.viewport.from,this.markers=this.buildMarkers(view)}update(update){(update.docChanged||update.viewportChanged||update.startState.facet(language$1)!=update.state.facet(language$1)||update.startState.field(foldState,!1)!=update.state.field(foldState,!1)||syntaxTree(update.startState)!=syntaxTree(update.state)||fullConfig.foldingChanged(update))&&(this.markers=this.buildMarkers(update.view))}buildMarkers(view){let builder=new RangeSetBuilder;for(let line of view.viewportLineBlocks){let mark=findFold(view.state,line.from,line.to)?canUnfold:foldable(view.state,line.from,line.to)?canFold:null;mark&&builder.add(line.from,line.from,mark)}return builder.finish()}}),{domEventHandlers:domEventHandlers}=fullConfig;return[markers,gutter({class:"cm-foldGutter",markers(view){var _a;return(null===(_a=view.plugin(markers))||void 0===_a?void 0:_a.markers)||RangeSet.empty},initialSpacer:()=>new FoldMarker(fullConfig,!1),domEventHandlers:Object.assign(Object.assign({},domEventHandlers),{click:(view,line,event)=>{if(domEventHandlers.click&&domEventHandlers.click(view,line,event))return!0;let folded=findFold(view.state,line.from,line.to);if(folded)return view.dispatch({effects:unfoldEffect.of(folded)}),!0;let range=foldable(view.state,line.from,line.to);return!!range&&(view.dispatch({effects:foldEffect.of(range)}),!0)}})}),codeFolding()]}const baseTheme$1$1=EditorView.baseTheme({".cm-foldPlaceholder":{backgroundColor:"#eee",border:"1px solid #ddd",color:"#888",borderRadius:".2em",margin:"0 1px",padding:"0 1px",cursor:"pointer"},".cm-foldGutter span":{padding:"0 1px",cursor:"pointer"}});class HighlightStyle{constructor(specs,options){let modSpec;function def(spec){let cls=StyleModule.newName();return(modSpec||(modSpec=Object.create(null)))["."+cls]=spec,cls}this.specs=specs;const all="string"==typeof options.all?options.all:options.all?def(options.all):void 0,scopeOpt=options.scope;this.scope=scopeOpt instanceof Language?type=>type.prop(languageDataProp)==scopeOpt.data:scopeOpt?type=>type==scopeOpt:void 0,this.style=tagHighlighter(specs.map((style=>({tag:style.tag,class:style.class||def(Object.assign({},style,{tag:null}))}))),{all:all}).style,this.module=modSpec?new StyleModule(modSpec):null,this.themeType=options.themeType}static define(specs,options){return new HighlightStyle(specs,options||{})}}const highlighterFacet=Facet.define(),fallbackHighlighter=Facet.define({combine:values=>values.length?[values[0]]:null});function getHighlighters(state){let main=state.facet(highlighterFacet);return main.length?main:state.facet(fallbackHighlighter)}function syntaxHighlighting(highlighter,options){let themeType,ext=[treeHighlighter];return highlighter instanceof HighlightStyle&&(highlighter.module&&ext.push(EditorView.styleModule.of(highlighter.module)),themeType=highlighter.themeType),(null==options?void 0:options.fallback)?ext.push(fallbackHighlighter.of(highlighter)):themeType?ext.push(highlighterFacet.computeN([EditorView.darkTheme],(state=>state.facet(EditorView.darkTheme)==("dark"==themeType)?[highlighter]:[]))):ext.push(highlighterFacet.of(highlighter)),ext}class TreeHighlighter{constructor(view){this.markCache=Object.create(null),this.tree=syntaxTree(view.state),this.decorations=this.buildDeco(view,getHighlighters(view.state))}update(update){let tree=syntaxTree(update.state),highlighters=getHighlighters(update.state),styleChange=highlighters!=getHighlighters(update.startState);tree.length<update.view.viewport.to&&!styleChange&&tree.type==this.tree.type?this.decorations=this.decorations.map(update.changes):(tree!=this.tree||update.viewportChanged||styleChange)&&(this.tree=tree,this.decorations=this.buildDeco(update.view,highlighters))}buildDeco(view,highlighters){if(!highlighters||!this.tree.length)return Decoration.none;let builder=new RangeSetBuilder;for(let{from:from,to:to}of view.visibleRanges)highlightTree(this.tree,highlighters,((from,to,style)=>{builder.add(from,to,this.markCache[style]||(this.markCache[style]=Decoration.mark({class:style})))}),from,to);return builder.finish()}}const treeHighlighter=Prec.high(ViewPlugin.fromClass(TreeHighlighter,{decorations:v=>v.decorations})),defaultHighlightStyle=HighlightStyle.define([{tag:tags.meta,color:"#404740"},{tag:tags.link,textDecoration:"underline"},{tag:tags.heading,textDecoration:"underline",fontWeight:"bold"},{tag:tags.emphasis,fontStyle:"italic"},{tag:tags.strong,fontWeight:"bold"},{tag:tags.strikethrough,textDecoration:"line-through"},{tag:tags.keyword,color:"#708"},{tag:[tags.atom,tags.bool,tags.url,tags.contentSeparator,tags.labelName],color:"#219"},{tag:[tags.literal,tags.inserted],color:"#164"},{tag:[tags.string,tags.deleted],color:"#a11"},{tag:[tags.regexp,tags.escape,tags.special(tags.string)],color:"#e40"},{tag:tags.definition(tags.variableName),color:"#00f"},{tag:tags.local(tags.variableName),color:"#30a"},{tag:[tags.typeName,tags.namespace],color:"#085"},{tag:tags.className,color:"#167"},{tag:[tags.special(tags.variableName),tags.macroName],color:"#256"},{tag:tags.definition(tags.propertyName),color:"#00c"},{tag:tags.comment,color:"#940"},{tag:tags.invalid,color:"#f00"}]),baseTheme$2=EditorView.baseTheme({"&.cm-focused .cm-matchingBracket":{backgroundColor:"#328c8252"},"&.cm-focused .cm-nonmatchingBracket":{backgroundColor:"#bb555544"}}),bracketMatchingConfig=Facet.define({combine:configs=>combineConfig(configs,{afterCursor:!0,brackets:"()[]{}",maxScanDistance:1e4,renderMatch:defaultRenderMatch})}),matchingMark=Decoration.mark({class:"cm-matchingBracket"}),nonmatchingMark=Decoration.mark({class:"cm-nonmatchingBracket"});function defaultRenderMatch(match){let decorations=[],mark=match.matched?matchingMark:nonmatchingMark;return decorations.push(mark.range(match.start.from,match.start.to)),match.end&&decorations.push(mark.range(match.end.from,match.end.to)),decorations}const bracketMatchingState=StateField.define({create:()=>Decoration.none,update(deco,tr){if(!tr.docChanged&&!tr.selection)return deco;let decorations=[],config=tr.state.facet(bracketMatchingConfig);for(let range of tr.state.selection.ranges){if(!range.empty)continue;let match=matchBrackets(tr.state,range.head,-1,config)||range.head>0&&matchBrackets(tr.state,range.head-1,1,config)||config.afterCursor&&(matchBrackets(tr.state,range.head,1,config)||range.head<tr.state.doc.length&&matchBrackets(tr.state,range.head+1,-1,config));match&&(decorations=decorations.concat(config.renderMatch(match,tr.state)))}return Decoration.set(decorations,!0)},provide:f=>EditorView.decorations.from(f)}),bracketMatchingUnique=[bracketMatchingState,baseTheme$2];function bracketMatching(config={}){return[bracketMatchingConfig.of(config),bracketMatchingUnique]}const bracketMatchingHandle=new NodeProp;function matchingNodes(node,dir,brackets){let byProp=node.prop(dir<0?NodeProp.openedBy:NodeProp.closedBy);if(byProp)return byProp;if(1==node.name.length){let index=brackets.indexOf(node.name);if(index>-1&&index%2==(dir<0?1:0))return[brackets[index+dir]]}return null}function findHandle(node){let hasHandle=node.type.prop(bracketMatchingHandle);return hasHandle?hasHandle(node.node):node}function matchBrackets(state,pos,dir,config={}){let maxScanDistance=config.maxScanDistance||1e4,brackets=config.brackets||"()[]{}",tree=syntaxTree(state),node=tree.resolveInner(pos,dir);for(let cur=node;cur;cur=cur.parent){let matches=matchingNodes(cur.type,dir,brackets);if(matches&&cur.from<cur.to){let handle=findHandle(cur);if(handle&&(dir>0?pos>=handle.from&&pos<handle.to:pos>handle.from&&pos<=handle.to))return matchMarkedBrackets(state,pos,dir,cur,handle,matches,brackets)}}return function(state,pos,dir,tree,tokenType,maxScanDistance,brackets){let startCh=dir<0?state.sliceDoc(pos-1,pos):state.sliceDoc(pos,pos+1),bracket=brackets.indexOf(startCh);if(bracket<0||bracket%2==0!=dir>0)return null;let startToken={from:dir<0?pos-1:pos,to:dir>0?pos+1:pos},iter=state.doc.iterRange(pos,dir>0?state.doc.length:0),depth=0;for(let distance=0;!iter.next().done&&distance<=maxScanDistance;){let text=iter.value;dir<0&&(distance+=text.length);let basePos=pos+distance*dir;for(let pos=dir>0?0:text.length-1,end=dir>0?text.length:-1;pos!=end;pos+=dir){let found=brackets.indexOf(text[pos]);if(!(found<0||tree.resolveInner(basePos+pos,1).type!=tokenType))if(found%2==0==dir>0)depth++;else{if(1==depth)return{start:startToken,end:{from:basePos+pos,to:basePos+pos+1},matched:found>>1==bracket>>1};depth--}}dir>0&&(distance+=text.length)}return iter.done?{start:startToken,matched:!1}:null}(state,pos,dir,tree,node.type,maxScanDistance,brackets)}function matchMarkedBrackets(_state,_pos,dir,token,handle,matching,brackets){let parent=token.parent,firstToken={from:handle.from,to:handle.to},depth=0,cursor=null==parent?void 0:parent.cursor();if(cursor&&(dir<0?cursor.childBefore(token.from):cursor.childAfter(token.to)))do{if(dir<0?cursor.to<=token.from:cursor.from>=token.to){if(0==depth&&matching.indexOf(cursor.type.name)>-1&&cursor.from<cursor.to){let endHandle=findHandle(cursor);return{start:firstToken,end:endHandle?{from:endHandle.from,to:endHandle.to}:void 0,matched:!0}}if(matchingNodes(cursor.type,dir,brackets))depth++;else if(matchingNodes(cursor.type,-dir,brackets)){if(0==depth){let endHandle=findHandle(cursor);return{start:firstToken,end:endHandle&&endHandle.from<endHandle.to?{from:endHandle.from,to:endHandle.to}:void 0,matched:!1}}depth--}}}while(dir<0?cursor.prevSibling():cursor.nextSibling());return{start:firstToken,matched:!1}}const noTokens=Object.create(null),typeArray=[NodeType.none],warned=[],defaultTable=Object.create(null);for(let[legacyName,name]of[["variable","variableName"],["variable-2","variableName.special"],["string-2","string.special"],["def","variableName.definition"],["tag","tagName"],["attribute","attributeName"],["type","typeName"],["builtin","variableName.standard"],["qualifier","modifier"],["error","invalid"],["header","heading"],["property","propertyName"]])defaultTable[legacyName]=createTokenType(noTokens,name);function warnForPart(part,msg){warned.indexOf(part)>-1||(warned.push(part),console.warn(msg))}function createTokenType(extra,tagStr){let tag=null;for(let part of tagStr.split(".")){let value=extra[part]||tags[part];value?"function"==typeof value?tag?tag=value(tag):warnForPart(part,`Modifier ${part} used at start of tag`):tag?warnForPart(part,`Tag ${part} used as modifier`):tag=value:warnForPart(part,`Unknown highlighting tag ${part}`)}if(!tag)return 0;let name=tagStr.replace(/ /g,"_"),type=NodeType.define({id:typeArray.length,name:name,props:[styleTags({[name]:tag})]});return typeArray.push(type),type.id}function command(f,option){return({state:state,dispatch:dispatch})=>{if(state.readOnly)return!1;let tr=f(option,state);return!!tr&&(dispatch(state.update(tr)),!0)}}const toggleLineComment=command(changeLineComment,0),toggleBlockComment=command(changeBlockComment,0),toggleBlockCommentByLine=command(((o,s)=>changeBlockComment(o,s,function(state){let ranges=[];for(let r of state.selection.ranges){let fromLine=state.doc.lineAt(r.from),toLine=r.to<=fromLine.to?fromLine:state.doc.lineAt(r.to),last=ranges.length-1;last>=0&&ranges[last].to>fromLine.from?ranges[last].to=toLine.to:ranges.push({from:fromLine.from,to:toLine.to})}return ranges}(s))),0);function getConfig(state,pos=state.selection.main.head){let data=state.languageDataAt("commentTokens",pos);return data.length?data[0]:{}}const SearchMargin=50;function changeBlockComment(option,state,ranges=state.selection.ranges){let tokens=ranges.map((r=>getConfig(state,r.from).block));if(!tokens.every((c=>c)))return null;let comments=ranges.map(((r,i)=>function(state,{open:open,close:close},from,to){let startText,endText,textBefore=state.sliceDoc(from-SearchMargin,from),textAfter=state.sliceDoc(to,to+SearchMargin),spaceBefore=/\s*$/.exec(textBefore)[0].length,spaceAfter=/^\s*/.exec(textAfter)[0].length,beforeOff=textBefore.length-spaceBefore;if(textBefore.slice(beforeOff-open.length,beforeOff)==open&&textAfter.slice(spaceAfter,spaceAfter+close.length)==close)return{open:{pos:from-spaceBefore,margin:spaceBefore&&1},close:{pos:to+spaceAfter,margin:spaceAfter&&1}};to-from<=2*SearchMargin?startText=endText=state.sliceDoc(from,to):(startText=state.sliceDoc(from,from+SearchMargin),endText=state.sliceDoc(to-SearchMargin,to));let startSpace=/^\s*/.exec(startText)[0].length,endSpace=/\s*$/.exec(endText)[0].length,endOff=endText.length-endSpace-close.length;return startText.slice(startSpace,startSpace+open.length)==open&&endText.slice(endOff,endOff+close.length)==close?{open:{pos:from+startSpace+open.length,margin:/\s/.test(startText.charAt(startSpace+open.length))?1:0},close:{pos:to-endSpace-close.length,margin:/\s/.test(endText.charAt(endOff-1))?1:0}}:null}(state,tokens[i],r.from,r.to)));if(2!=option&&!comments.every((c=>c)))return{changes:state.changes(ranges.map(((range,i)=>comments[i]?[]:[{from:range.from,insert:tokens[i].open+" "},{from:range.to,insert:" "+tokens[i].close}])))};if(1!=option&&comments.some((c=>c))){let changes=[];for(let comment,i=0;i<comments.length;i++)if(comment=comments[i]){let token=tokens[i],{open:open,close:close}=comment;changes.push({from:open.pos-token.open.length,to:open.pos+open.margin},{from:close.pos-close.margin,to:close.pos+token.close.length})}return{changes:changes}}return null}function changeLineComment(option,state,ranges=state.selection.ranges){let lines=[],prevLine=-1;for(let{from:from,to:to}of ranges){let startI=lines.length,minIndent=1e9;for(let pos=from;pos<=to;){let line=state.doc.lineAt(pos);if(line.from>prevLine&&(from==to||to>line.from)){prevLine=line.from;let token=getConfig(state,pos).line;if(!token)continue;let indent=/^\s*/.exec(line.text)[0].length,empty=indent==line.length,comment=line.text.slice(indent,indent+token.length)==token?indent:-1;indent<line.text.length&&indent<minIndent&&(minIndent=indent),lines.push({line:line,comment:comment,token:token,indent:indent,empty:empty,single:!1})}pos=line.to+1}if(minIndent<1e9)for(let i=startI;i<lines.length;i++)lines[i].indent<lines[i].line.text.length&&(lines[i].indent=minIndent);lines.length==startI+1&&(lines[startI].single=!0)}if(2!=option&&lines.some((l=>l.comment<0&&(!l.empty||l.single)))){let changes=[];for(let{line:line,token:token,indent:indent,empty:empty,single:single}of lines)!single&&empty||changes.push({from:line.from+indent,insert:token+" "});let changeSet=state.changes(changes);return{changes:changeSet,selection:state.selection.map(changeSet,1)}}if(1!=option&&lines.some((l=>l.comment>=0))){let changes=[];for(let{line:line,comment:comment,token:token}of lines)if(comment>=0){let from=line.from+comment,to=from+token.length;" "==line.text[to-line.from]&&to++,changes.push({from:from,to:to})}return{changes:changes}}return null}const fromHistory=Annotation.define(),isolateHistory=Annotation.define(),invertedEffects=Facet.define(),historyConfig=Facet.define({combine:configs=>combineConfig(configs,{minDepth:100,newGroupDelay:500},{minDepth:Math.max,newGroupDelay:Math.min})});const historyField_=StateField.define({create:()=>HistoryState.empty,update(state,tr){let config=tr.state.facet(historyConfig),fromHist=tr.annotation(fromHistory);if(fromHist){let selection=tr.docChanged?EditorSelection.single(function(changes){let end=0;return changes.iterChangedRanges(((_,to)=>end=to)),end}(tr.changes)):void 0,item=HistEvent.fromTransaction(tr,selection),from=fromHist.side,other=0==from?state.undone:state.done;return other=item?updateBranch(other,other.length,config.minDepth,item):addSelection(other,tr.startState.selection),new HistoryState(0==from?fromHist.rest:other,0==from?other:fromHist.rest)}let isolate=tr.annotation(isolateHistory);if("full"!=isolate&&"before"!=isolate||(state=state.isolate()),!1===tr.annotation(Transaction.addToHistory))return tr.changes.empty?state:state.addMapping(tr.changes.desc);let event=HistEvent.fromTransaction(tr),time=tr.annotation(Transaction.time),userEvent=tr.annotation(Transaction.userEvent);return event?state=state.addChanges(event,time,userEvent,config.newGroupDelay,config.minDepth):tr.selection&&(state=state.addSelection(tr.startState.selection,time,userEvent,config.newGroupDelay)),"full"!=isolate&&"after"!=isolate||(state=state.isolate()),state},toJSON:value=>({done:value.done.map((e=>e.toJSON())),undone:value.undone.map((e=>e.toJSON()))}),fromJSON:json=>new HistoryState(json.done.map(HistEvent.fromJSON),json.undone.map(HistEvent.fromJSON))});function history(config={}){return[historyField_,historyConfig.of(config),EditorView.domEventHandlers({beforeinput(e,view){let command="historyUndo"==e.inputType?undo:"historyRedo"==e.inputType?redo:null;return!!command&&(e.preventDefault(),command(view))}})]}function cmd(side,selection){return function({state:state,dispatch:dispatch}){if(!selection&&state.readOnly)return!1;let historyState=state.field(historyField_,!1);if(!historyState)return!1;let tr=historyState.pop(side,state,selection);return!!tr&&(dispatch(tr),!0)}}const undo=cmd(0,!1),redo=cmd(1,!1),undoSelection=cmd(0,!0),redoSelection=cmd(1,!0);class HistEvent{constructor(changes,effects,mapped,startSelection,selectionsAfter){this.changes=changes,this.effects=effects,this.mapped=mapped,this.startSelection=startSelection,this.selectionsAfter=selectionsAfter}setSelAfter(after){return new HistEvent(this.changes,this.effects,this.mapped,this.startSelection,after)}toJSON(){var _a,_b,_c;return{changes:null===(_a=this.changes)||void 0===_a?void 0:_a.toJSON(),mapped:null===(_b=this.mapped)||void 0===_b?void 0:_b.toJSON(),startSelection:null===(_c=this.startSelection)||void 0===_c?void 0:_c.toJSON(),selectionsAfter:this.selectionsAfter.map((s=>s.toJSON()))}}static fromJSON(json){return new HistEvent(json.changes&&ChangeSet.fromJSON(json.changes),[],json.mapped&&ChangeDesc.fromJSON(json.mapped),json.startSelection&&EditorSelection.fromJSON(json.startSelection),json.selectionsAfter.map(EditorSelection.fromJSON))}static fromTransaction(tr,selection){let effects=none;for(let invert of tr.startState.facet(invertedEffects)){let result=invert(tr);result.length&&(effects=effects.concat(result))}return!effects.length&&tr.changes.empty?null:new HistEvent(tr.changes.invert(tr.startState.doc),effects,void 0,selection||tr.startState.selection,none)}static selection(selections){return new HistEvent(void 0,none,void 0,void 0,selections)}}function updateBranch(branch,to,maxLen,newEvent){let start=to+1>maxLen+20?to-maxLen-1:0,newBranch=branch.slice(start,to);return newBranch.push(newEvent),newBranch}function conc(a,b){return a.length?b.length?a.concat(b):a:b}const none=[],MaxSelectionsPerEvent=200;function addSelection(branch,selection){if(branch.length){let lastEvent=branch[branch.length-1],sels=lastEvent.selectionsAfter.slice(Math.max(0,lastEvent.selectionsAfter.length-MaxSelectionsPerEvent));return sels.length&&sels[sels.length-1].eq(selection)?branch:(sels.push(selection),updateBranch(branch,branch.length-1,1e9,lastEvent.setSelAfter(sels)))}return[HistEvent.selection([selection])]}function popSelection(branch){let last=branch[branch.length-1],newBranch=branch.slice();return newBranch[branch.length-1]=last.setSelAfter(last.selectionsAfter.slice(0,last.selectionsAfter.length-1)),newBranch}function addMappingToBranch(branch,mapping){if(!branch.length)return branch;let length=branch.length,selections=none;for(;length;){let event=mapEvent(branch[length-1],mapping,selections);if(event.changes&&!event.changes.empty||event.effects.length){let result=branch.slice(0,length);return result[length-1]=event,result}mapping=event.mapped,length--,selections=event.selectionsAfter}return selections.length?[HistEvent.selection(selections)]:none}function mapEvent(event,mapping,extraSelections){let selections=conc(event.selectionsAfter.length?event.selectionsAfter.map((s=>s.map(mapping))):none,extraSelections);if(!event.changes)return HistEvent.selection(selections);let mappedChanges=event.changes.map(mapping),before=mapping.mapDesc(event.changes,!0),fullMapping=event.mapped?event.mapped.composeDesc(before):before;return new HistEvent(mappedChanges,StateEffect.mapEffects(event.effects,mapping),fullMapping,event.startSelection.map(before),selections)}const joinableUserEvent=/^(input\.type|delete)($|\.)/;class HistoryState{constructor(done,undone,prevTime=0,prevUserEvent=void 0){this.done=done,this.undone=undone,this.prevTime=prevTime,this.prevUserEvent=prevUserEvent}isolate(){return this.prevTime?new HistoryState(this.done,this.undone):this}addChanges(event,time,userEvent,newGroupDelay,maxLen){let done=this.done,lastEvent=done[done.length-1];return done=lastEvent&&lastEvent.changes&&!lastEvent.changes.empty&&event.changes&&(!userEvent||joinableUserEvent.test(userEvent))&&(!lastEvent.selectionsAfter.length&&time-this.prevTime<newGroupDelay&&function(a,b){let ranges=[],isAdjacent=!1;return a.iterChangedRanges(((f,t)=>ranges.push(f,t))),b.iterChangedRanges(((_f,_t,f,t)=>{for(let i=0;i<ranges.length;){let from=ranges[i++],to=ranges[i++];t>=from&&f<=to&&(isAdjacent=!0)}})),isAdjacent}(lastEvent.changes,event.changes)||"input.type.compose"==userEvent)?updateBranch(done,done.length-1,maxLen,new HistEvent(event.changes.compose(lastEvent.changes),conc(event.effects,lastEvent.effects),lastEvent.mapped,lastEvent.startSelection,none)):updateBranch(done,done.length,maxLen,event),new HistoryState(done,none,time,userEvent)}addSelection(selection,time,userEvent,newGroupDelay){let last=this.done.length?this.done[this.done.length-1].selectionsAfter:none;return last.length>0&&time-this.prevTime<newGroupDelay&&userEvent==this.prevUserEvent&&userEvent&&/^select($|\.)/.test(userEvent)&&(a=last[last.length-1],b=selection,a.ranges.length==b.ranges.length&&0===a.ranges.filter(((r,i)=>r.empty!=b.ranges[i].empty)).length)?this:new HistoryState(addSelection(this.done,selection),this.undone,time,userEvent);var a,b}addMapping(mapping){return new HistoryState(addMappingToBranch(this.done,mapping),addMappingToBranch(this.undone,mapping),this.prevTime,this.prevUserEvent)}pop(side,state,selection){let branch=0==side?this.done:this.undone;if(0==branch.length)return null;let event=branch[branch.length-1];if(selection&&event.selectionsAfter.length)return state.update({selection:event.selectionsAfter[event.selectionsAfter.length-1],annotations:fromHistory.of({side:side,rest:popSelection(branch)}),userEvent:0==side?"select.undo":"select.redo",scrollIntoView:!0});if(event.changes){let rest=1==branch.length?none:branch.slice(0,branch.length-1);return event.mapped&&(rest=addMappingToBranch(rest,event.mapped)),state.update({changes:event.changes,selection:event.startSelection,effects:event.effects,annotations:fromHistory.of({side:side,rest:rest}),filter:!1,userEvent:0==side?"undo":"redo",scrollIntoView:!0})}return null}}HistoryState.empty=new HistoryState(none,none);const historyKeymap=[{key:"Mod-z",run:undo,preventDefault:!0},{key:"Mod-y",mac:"Mod-Shift-z",run:redo,preventDefault:!0},{linux:"Ctrl-Shift-z",run:redo,preventDefault:!0},{key:"Mod-u",run:undoSelection,preventDefault:!0},{key:"Alt-u",mac:"Mod-Shift-u",run:redoSelection,preventDefault:!0}];function updateSel(sel,by){return EditorSelection.create(sel.ranges.map(by),sel.mainIndex)}function setSel(state,selection){return state.update({selection:selection,scrollIntoView:!0,userEvent:"select"})}function moveSel({state:state,dispatch:dispatch},how){let selection=updateSel(state.selection,how);return!selection.eq(state.selection)&&(dispatch(setSel(state,selection)),!0)}function rangeEnd(range,forward){return EditorSelection.cursor(forward?range.to:range.from)}function cursorByChar(view,forward){return moveSel(view,(range=>range.empty?view.moveByChar(range,forward):rangeEnd(range,forward)))}function ltrAtCursor(view){return view.textDirectionAt(view.state.selection.main.head)==Direction.LTR}const cursorCharLeft=view=>cursorByChar(view,!ltrAtCursor(view)),cursorCharRight=view=>cursorByChar(view,ltrAtCursor(view));function cursorByGroup(view,forward){return moveSel(view,(range=>range.empty?view.moveByGroup(range,forward):rangeEnd(range,forward)))}function interestingNode(state,node,bracketProp){if(node.type.prop(bracketProp))return!0;let len=node.to-node.from;return len&&(len>2||/[^\s,.;:]/.test(state.sliceDoc(node.from,node.to)))||node.firstChild}function moveBySyntax(state,start,forward){let match,newPos,pos=syntaxTree(state).resolveInner(start.head),bracketProp=forward?NodeProp.closedBy:NodeProp.openedBy;for(let at=start.head;;){let next=forward?pos.childAfter(at):pos.childBefore(at);if(!next)break;interestingNode(state,next,bracketProp)?pos=next:at=forward?next.to:next.from}return newPos=pos.type.prop(bracketProp)&&(match=forward?matchBrackets(state,pos.from,1):matchBrackets(state,pos.to,-1))&&match.matched?forward?match.end.to:match.end.from:forward?pos.to:pos.from,EditorSelection.cursor(newPos,forward?-1:1)}function cursorByLine(view,forward){return moveSel(view,(range=>{if(!range.empty)return rangeEnd(range,forward);let moved=view.moveVertically(range,forward);return moved.head!=range.head?moved:view.moveToLineBoundary(range,forward)}))}const cursorLineUp=view=>cursorByLine(view,!1),cursorLineDown=view=>cursorByLine(view,!0);function pageHeight(view){return Math.max(view.defaultLineHeight,Math.min(view.dom.clientHeight,innerHeight)-5)}function cursorByPage(view,forward){let{state:state}=view,selection=updateSel(state.selection,(range=>range.empty?view.moveVertically(range,forward,pageHeight(view)):rangeEnd(range,forward)));if(selection.eq(state.selection))return!1;let effect,startPos=view.coordsAtPos(state.selection.main.head),scrollRect=view.scrollDOM.getBoundingClientRect();return startPos&&startPos.top>scrollRect.top&&startPos.bottom<scrollRect.bottom&&startPos.top-scrollRect.top<=view.scrollDOM.scrollHeight-view.scrollDOM.scrollTop-view.scrollDOM.clientHeight&&(effect=EditorView.scrollIntoView(selection.main.head,{y:"start",yMargin:startPos.top-scrollRect.top})),view.dispatch(setSel(state,selection),{effects:effect}),!0}const cursorPageUp=view=>cursorByPage(view,!1),cursorPageDown=view=>cursorByPage(view,!0);function moveByLineBoundary(view,start,forward){let line=view.lineBlockAt(start.head),moved=view.moveToLineBoundary(start,forward);if(moved.head==start.head&&moved.head!=(forward?line.to:line.from)&&(moved=view.moveToLineBoundary(start,forward,!1)),!forward&&moved.head==line.from&&line.length){let space=/^\s*/.exec(view.state.sliceDoc(line.from,Math.min(line.from+100,line.to)))[0].length;space&&start.head!=line.from+space&&(moved=EditorSelection.cursor(line.from+space))}return moved}function extendSel(view,how){let selection=updateSel(view.state.selection,(range=>{let head=how(range);return EditorSelection.range(range.anchor,head.head,head.goalColumn)}));return!selection.eq(view.state.selection)&&(view.dispatch(setSel(view.state,selection)),!0)}function selectByChar(view,forward){return extendSel(view,(range=>view.moveByChar(range,forward)))}const selectCharLeft=view=>selectByChar(view,!ltrAtCursor(view)),selectCharRight=view=>selectByChar(view,ltrAtCursor(view));function selectByGroup(view,forward){return extendSel(view,(range=>view.moveByGroup(range,forward)))}function selectByLine(view,forward){return extendSel(view,(range=>view.moveVertically(range,forward)))}const selectLineUp=view=>selectByLine(view,!1),selectLineDown=view=>selectByLine(view,!0);function selectByPage(view,forward){return extendSel(view,(range=>view.moveVertically(range,forward,pageHeight(view))))}const selectPageUp=view=>selectByPage(view,!1),selectPageDown=view=>selectByPage(view,!0),cursorDocStart=({state:state,dispatch:dispatch})=>(dispatch(setSel(state,{anchor:0})),!0),cursorDocEnd=({state:state,dispatch:dispatch})=>(dispatch(setSel(state,{anchor:state.doc.length})),!0),selectDocStart=({state:state,dispatch:dispatch})=>(dispatch(setSel(state,{anchor:state.selection.main.anchor,head:0})),!0),selectDocEnd=({state:state,dispatch:dispatch})=>(dispatch(setSel(state,{anchor:state.selection.main.anchor,head:state.doc.length})),!0);function deleteBy(target,by){if(target.state.readOnly)return!1;let event="delete.selection",{state:state}=target,changes=state.changeByRange((range=>{let{from:from,to:to}=range;if(from==to){let towards=by(from);towards<from?(event="delete.backward",towards=skipAtomic(target,towards,!1)):towards>from&&(event="delete.forward",towards=skipAtomic(target,towards,!0)),from=Math.min(from,towards),to=Math.max(to,towards)}else from=skipAtomic(target,from,!1),to=skipAtomic(target,to,!0);return from==to?{range:range}:{changes:{from:from,to:to},range:EditorSelection.cursor(from)}}));return!changes.changes.empty&&(target.dispatch(state.update(changes,{scrollIntoView:!0,userEvent:event,effects:"delete.selection"==event?EditorView.announce.of(state.phrase("Selection deleted")):void 0})),!0)}function skipAtomic(target,pos,forward){if(target instanceof EditorView)for(let ranges of target.state.facet(EditorView.atomicRanges).map((f=>f(target))))ranges.between(pos,pos,((from,to)=>{from<pos&&to>pos&&(pos=forward?to:from)}));return pos}const deleteByChar=(target,forward)=>deleteBy(target,(pos=>{let before,targetPos,{state:state}=target,line=state.doc.lineAt(pos);if(!forward&&pos>line.from&&pos<line.from+200&&!/[^ \t]/.test(before=line.text.slice(0,pos-line.from))){if("\t"==before[before.length-1])return pos-1;let drop=countColumn(before,state.tabSize)%getIndentUnit(state)||getIndentUnit(state);for(let i=0;i<drop&&" "==before[before.length-1-i];i++)pos--;targetPos=pos}else targetPos=findClusterBreak(line.text,pos-line.from,forward,forward)+line.from,targetPos==pos&&line.number!=(forward?state.doc.lines:1)&&(targetPos+=forward?1:-1);return targetPos})),deleteCharBackward=view=>deleteByChar(view,!1),deleteCharForward=view=>deleteByChar(view,!0),deleteByGroup=(target,forward)=>deleteBy(target,(start=>{let pos=start,{state:state}=target,line=state.doc.lineAt(pos),categorize=state.charCategorizer(pos);for(let cat=null;;){if(pos==(forward?line.to:line.from)){pos==start&&line.number!=(forward?state.doc.lines:1)&&(pos+=forward?1:-1);break}let next=findClusterBreak(line.text,pos-line.from,forward)+line.from,nextChar=line.text.slice(Math.min(pos,next)-line.from,Math.max(pos,next)-line.from),nextCat=categorize(nextChar);if(null!=cat&&nextCat!=cat)break;" "==nextChar&&pos==start||(cat=nextCat),pos=next}return pos})),deleteGroupBackward=target=>deleteByGroup(target,!1),deleteToLineEnd=view=>deleteBy(view,(pos=>{let lineEnd=view.lineBlockAt(pos).to;return pos<lineEnd?lineEnd:Math.min(view.state.doc.length,pos+1)}));function selectedLineBlocks(state){let blocks=[],upto=-1;for(let range of state.selection.ranges){let startLine=state.doc.lineAt(range.from),endLine=state.doc.lineAt(range.to);if(range.empty||range.to!=endLine.from||(endLine=state.doc.lineAt(range.to-1)),upto>=startLine.number){let prev=blocks[blocks.length-1];prev.to=endLine.to,prev.ranges.push(range)}else blocks.push({from:startLine.from,to:endLine.to,ranges:[range]});upto=endLine.number+1}return blocks}function moveLine(state,dispatch,forward){if(state.readOnly)return!1;let changes=[],ranges=[];for(let block of selectedLineBlocks(state)){if(forward?block.to==state.doc.length:0==block.from)continue;let nextLine=state.doc.lineAt(forward?block.to+1:block.from-1),size=nextLine.length+1;if(forward){changes.push({from:block.to,to:nextLine.to},{from:block.from,insert:nextLine.text+state.lineBreak});for(let r of block.ranges)ranges.push(EditorSelection.range(Math.min(state.doc.length,r.anchor+size),Math.min(state.doc.length,r.head+size)))}else{changes.push({from:nextLine.from,to:block.from},{from:block.to,insert:state.lineBreak+nextLine.text});for(let r of block.ranges)ranges.push(EditorSelection.range(r.anchor-size,r.head-size))}}return!!changes.length&&(dispatch(state.update({changes:changes,scrollIntoView:!0,selection:EditorSelection.create(ranges,state.selection.mainIndex),userEvent:"move.line"})),!0)}function copyLine(state,dispatch,forward){if(state.readOnly)return!1;let changes=[];for(let block of selectedLineBlocks(state))forward?changes.push({from:block.from,insert:state.doc.slice(block.from,block.to)+state.lineBreak}):changes.push({from:block.to,insert:state.lineBreak+state.doc.slice(block.from,block.to)});return dispatch(state.update({changes:changes,scrollIntoView:!0,userEvent:"input.copyline"})),!0}const insertNewlineAndIndent=newlineAndIndent(!1);function newlineAndIndent(atEof){return({state:state,dispatch:dispatch})=>{if(state.readOnly)return!1;let changes=state.changeByRange((range=>{let{from:from,to:to}=range,line=state.doc.lineAt(from),explode=!atEof&&from==to&&function(state,pos){if(/\(\)|\[\]|\{\}/.test(state.sliceDoc(pos-1,pos+1)))return{from:pos,to:pos};let closedBy,context=syntaxTree(state).resolveInner(pos),before=context.childBefore(pos),after=context.childAfter(pos);return before&&after&&before.to<=pos&&after.from>=pos&&(closedBy=before.type.prop(NodeProp.closedBy))&&closedBy.indexOf(after.name)>-1&&state.doc.lineAt(before.to).from==state.doc.lineAt(after.from).from?{from:before.to,to:after.from}:null}(state,from);atEof&&(from=to=(to<=line.to?line:state.doc.lineAt(to)).to);let cx=new IndentContext(state,{simulateBreak:from,simulateDoubleBreak:!!explode}),indent=getIndentation(cx,from);for(null==indent&&(indent=/^\s*/.exec(state.doc.lineAt(from).text)[0].length);to<line.to&&/\s/.test(line.text[to-line.from]);)to++;explode?({from:from,to:to}=explode):from>line.from&&from<line.from+100&&!/\S/.test(line.text.slice(0,from))&&(from=line.from);let insert=["",indentString(state,indent)];return explode&&insert.push(indentString(state,cx.lineIndent(line.from,-1))),{changes:{from:from,to:to,insert:Text.of(insert)},range:EditorSelection.cursor(from+1+insert[1].length)}}));return dispatch(state.update(changes,{scrollIntoView:!0,userEvent:"input"})),!0}}function changeBySelectedLine(state,f){let atLine=-1;return state.changeByRange((range=>{let changes=[];for(let pos=range.from;pos<=range.to;){let line=state.doc.lineAt(pos);line.number>atLine&&(range.empty||range.to>line.from)&&(f(line,changes,range),atLine=line.number),pos=line.to+1}let changeSet=state.changes(changes);return{changes:changes,range:EditorSelection.range(changeSet.mapPos(range.anchor,1),changeSet.mapPos(range.head,1))}}))}const indentMore=({state:state,dispatch:dispatch})=>!state.readOnly&&(dispatch(state.update(changeBySelectedLine(state,((line,changes)=>{changes.push({from:line.from,insert:state.facet(indentUnit)})})),{userEvent:"input.indent"})),!0),indentLess=({state:state,dispatch:dispatch})=>!state.readOnly&&(dispatch(state.update(changeBySelectedLine(state,((line,changes)=>{let space=/^\s*/.exec(line.text)[0];if(!space)return;let col=countColumn(space,state.tabSize),keep=0,insert=indentString(state,Math.max(0,col-getIndentUnit(state)));for(;keep<space.length&&keep<insert.length&&space.charCodeAt(keep)==insert.charCodeAt(keep);)keep++;changes.push({from:line.from+keep,to:line.from+space.length,insert:insert.slice(keep)})})),{userEvent:"delete.dedent"})),!0),defaultKeymap=[{key:"Alt-ArrowLeft",mac:"Ctrl-ArrowLeft",run:view=>moveSel(view,(range=>moveBySyntax(view.state,range,!ltrAtCursor(view)))),shift:view=>extendSel(view,(range=>moveBySyntax(view.state,range,!ltrAtCursor(view))))},{key:"Alt-ArrowRight",mac:"Ctrl-ArrowRight",run:view=>moveSel(view,(range=>moveBySyntax(view.state,range,ltrAtCursor(view)))),shift:view=>extendSel(view,(range=>moveBySyntax(view.state,range,ltrAtCursor(view))))},{key:"Alt-ArrowUp",run:({state:state,dispatch:dispatch})=>moveLine(state,dispatch,!1)},{key:"Shift-Alt-ArrowUp",run:({state:state,dispatch:dispatch})=>copyLine(state,dispatch,!1)},{key:"Alt-ArrowDown",run:({state:state,dispatch:dispatch})=>moveLine(state,dispatch,!0)},{key:"Shift-Alt-ArrowDown",run:({state:state,dispatch:dispatch})=>copyLine(state,dispatch,!0)},{key:"Escape",run:({state:state,dispatch:dispatch})=>{let cur=state.selection,selection=null;return cur.ranges.length>1?selection=EditorSelection.create([cur.main]):cur.main.empty||(selection=EditorSelection.create([EditorSelection.cursor(cur.main.head)])),!!selection&&(dispatch(setSel(state,selection)),!0)}},{key:"Mod-Enter",run:newlineAndIndent(!0)},{key:"Alt-l",mac:"Ctrl-l",run:({state:state,dispatch:dispatch})=>{let ranges=selectedLineBlocks(state).map((({from:from,to:to})=>EditorSelection.range(from,Math.min(to+1,state.doc.length))));return dispatch(state.update({selection:EditorSelection.create(ranges),userEvent:"select"})),!0}},{key:"Mod-i",run:({state:state,dispatch:dispatch})=>{let selection=updateSel(state.selection,(range=>{var _a;let context=syntaxTree(state).resolveInner(range.head,1);for(;!(context.from<range.from&&context.to>=range.to||context.to>range.to&&context.from<=range.from)&&(null===(_a=context.parent)||void 0===_a?void 0:_a.parent);)context=context.parent;return EditorSelection.range(context.to,context.from)}));return dispatch(setSel(state,selection)),!0},preventDefault:!0},{key:"Mod-[",run:indentLess},{key:"Mod-]",run:indentMore},{key:"Mod-Alt-\\",run:({state:state,dispatch:dispatch})=>{if(state.readOnly)return!1;let updated=Object.create(null),context=new IndentContext(state,{overrideIndentation:start=>{let found=updated[start];return null==found?-1:found}}),changes=changeBySelectedLine(state,((line,changes,range)=>{let indent=getIndentation(context,line.from);if(null==indent)return;/\S/.test(line.text)||(indent=0);let cur=/^\s*/.exec(line.text)[0],norm=indentString(state,indent);(cur!=norm||range.from<line.from+cur.length)&&(updated[line.from]=indent,changes.push({from:line.from,to:line.from+cur.length,insert:norm}))}));return changes.changes.empty||dispatch(state.update(changes,{userEvent:"indent"})),!0}},{key:"Shift-Mod-k",run:view=>{if(view.state.readOnly)return!1;let{state:state}=view,changes=state.changes(selectedLineBlocks(state).map((({from:from,to:to})=>(from>0?from--:to<state.doc.length&&to++,{from:from,to:to})))),selection=updateSel(state.selection,(range=>view.moveVertically(range,!0))).map(changes);return view.dispatch({changes:changes,selection:selection,scrollIntoView:!0,userEvent:"delete.line"}),!0}},{key:"Shift-Mod-\\",run:({state:state,dispatch:dispatch})=>function(state,dispatch,extend){let found=!1,selection=updateSel(state.selection,(range=>{let matching=matchBrackets(state,range.head,-1)||matchBrackets(state,range.head,1)||range.head>0&&matchBrackets(state,range.head-1,1)||range.head<state.doc.length&&matchBrackets(state,range.head+1,-1);if(!matching||!matching.end)return range;found=!0;let head=matching.start.from==range.head?matching.end.to:matching.end.from;return extend?EditorSelection.range(range.anchor,head):EditorSelection.cursor(head)}));return!!found&&(dispatch(setSel(state,selection)),!0)}(state,dispatch,!1)},{key:"Mod-/",run:target=>{let config=getConfig(target.state);return config.line?toggleLineComment(target):!!config.block&&toggleBlockCommentByLine(target)}},{key:"Alt-A",run:toggleBlockComment}].concat([{key:"ArrowLeft",run:cursorCharLeft,shift:selectCharLeft,preventDefault:!0},{key:"Mod-ArrowLeft",mac:"Alt-ArrowLeft",run:view=>cursorByGroup(view,!ltrAtCursor(view)),shift:view=>selectByGroup(view,!ltrAtCursor(view)),preventDefault:!0},{mac:"Cmd-ArrowLeft",run:view=>moveSel(view,(range=>moveByLineBoundary(view,range,!ltrAtCursor(view)))),shift:view=>extendSel(view,(range=>moveByLineBoundary(view,range,!ltrAtCursor(view)))),preventDefault:!0},{key:"ArrowRight",run:cursorCharRight,shift:selectCharRight,preventDefault:!0},{key:"Mod-ArrowRight",mac:"Alt-ArrowRight",run:view=>cursorByGroup(view,ltrAtCursor(view)),shift:view=>selectByGroup(view,ltrAtCursor(view)),preventDefault:!0},{mac:"Cmd-ArrowRight",run:view=>moveSel(view,(range=>moveByLineBoundary(view,range,ltrAtCursor(view)))),shift:view=>extendSel(view,(range=>moveByLineBoundary(view,range,ltrAtCursor(view)))),preventDefault:!0},{key:"ArrowUp",run:cursorLineUp,shift:selectLineUp,preventDefault:!0},{mac:"Cmd-ArrowUp",run:cursorDocStart,shift:selectDocStart},{mac:"Ctrl-ArrowUp",run:cursorPageUp,shift:selectPageUp},{key:"ArrowDown",run:cursorLineDown,shift:selectLineDown,preventDefault:!0},{mac:"Cmd-ArrowDown",run:cursorDocEnd,shift:selectDocEnd},{mac:"Ctrl-ArrowDown",run:cursorPageDown,shift:selectPageDown},{key:"PageUp",run:cursorPageUp,shift:selectPageUp},{key:"PageDown",run:cursorPageDown,shift:selectPageDown},{key:"Home",run:view=>moveSel(view,(range=>moveByLineBoundary(view,range,!1))),shift:view=>extendSel(view,(range=>moveByLineBoundary(view,range,!1))),preventDefault:!0},{key:"Mod-Home",run:cursorDocStart,shift:selectDocStart},{key:"End",run:view=>moveSel(view,(range=>moveByLineBoundary(view,range,!0))),shift:view=>extendSel(view,(range=>moveByLineBoundary(view,range,!0))),preventDefault:!0},{key:"Mod-End",run:cursorDocEnd,shift:selectDocEnd},{key:"Enter",run:insertNewlineAndIndent},{key:"Mod-a",run:({state:state,dispatch:dispatch})=>(dispatch(state.update({selection:{anchor:0,head:state.doc.length},userEvent:"select"})),!0)},{key:"Backspace",run:deleteCharBackward,shift:deleteCharBackward},{key:"Delete",run:deleteCharForward},{key:"Mod-Backspace",mac:"Alt-Backspace",run:deleteGroupBackward},{key:"Mod-Delete",mac:"Alt-Delete",run:target=>deleteByGroup(target,!0)},{mac:"Mod-Backspace",run:view=>deleteBy(view,(pos=>{let lineStart=view.lineBlockAt(pos).from;return pos>lineStart?lineStart:Math.max(0,pos-1)}))},{mac:"Mod-Delete",run:deleteToLineEnd}].concat([{key:"Ctrl-b",run:cursorCharLeft,shift:selectCharLeft,preventDefault:!0},{key:"Ctrl-f",run:cursorCharRight,shift:selectCharRight},{key:"Ctrl-p",run:cursorLineUp,shift:selectLineUp},{key:"Ctrl-n",run:cursorLineDown,shift:selectLineDown},{key:"Ctrl-a",run:view=>moveSel(view,(range=>EditorSelection.cursor(view.lineBlockAt(range.head).from,1))),shift:view=>extendSel(view,(range=>EditorSelection.cursor(view.lineBlockAt(range.head).from)))},{key:"Ctrl-e",run:view=>moveSel(view,(range=>EditorSelection.cursor(view.lineBlockAt(range.head).to,-1))),shift:view=>extendSel(view,(range=>EditorSelection.cursor(view.lineBlockAt(range.head).to)))},{key:"Ctrl-d",run:deleteCharForward},{key:"Ctrl-h",run:deleteCharBackward},{key:"Ctrl-k",run:deleteToLineEnd},{key:"Ctrl-Alt-h",run:deleteGroupBackward},{key:"Ctrl-o",run:({state:state,dispatch:dispatch})=>{if(state.readOnly)return!1;let changes=state.changeByRange((range=>({changes:{from:range.from,to:range.to,insert:Text.of(["",""])},range:EditorSelection.cursor(range.from)})));return dispatch(state.update(changes,{scrollIntoView:!0,userEvent:"input"})),!0}},{key:"Ctrl-t",run:({state:state,dispatch:dispatch})=>{if(state.readOnly)return!1;let changes=state.changeByRange((range=>{if(!range.empty||0==range.from||range.from==state.doc.length)return{range:range};let pos=range.from,line=state.doc.lineAt(pos),from=pos==line.from?pos-1:findClusterBreak(line.text,pos-line.from,!1)+line.from,to=pos==line.to?pos+1:findClusterBreak(line.text,pos-line.from,!0)+line.from;return{changes:{from:from,to:to,insert:state.doc.slice(pos,to).append(state.doc.slice(from,pos))},range:EditorSelection.cursor(to)}}));return!changes.changes.empty&&(dispatch(state.update(changes,{scrollIntoView:!0,userEvent:"move.character"})),!0)}},{key:"Ctrl-v",run:cursorPageDown}].map((b=>({mac:b.key,run:b.run,shift:b.shift}))))),indentWithTab={key:"Tab",run:indentMore,shift:indentLess};class Stack{constructor(p,stack,state,reducePos,pos,score,buffer,bufferBase,curContext,lookAhead=0,parent){this.p=p,this.stack=stack,this.state=state,this.reducePos=reducePos,this.pos=pos,this.score=score,this.buffer=buffer,this.bufferBase=bufferBase,this.curContext=curContext,this.lookAhead=lookAhead,this.parent=parent}toString(){return`[${this.stack.filter(((_,i)=>i%3==0)).concat(this.state)}]@${this.pos}${this.score?"!"+this.score:""}`}static start(p,state,pos=0){let cx=p.parser.context;return new Stack(p,[],state,pos,pos,0,[],0,cx?new StackContext(cx,cx.start):null,0,null)}get context(){return this.curContext?this.curContext.context:null}pushState(state,start){this.stack.push(this.state,start,this.bufferBase+this.buffer.length),this.state=state}reduce(action){var _a;let depth=action>>19,type=65535&action,{parser:parser}=this.p,dPrec=parser.dynamicPrecedence(type);if(dPrec&&(this.score+=dPrec),0==depth)return this.pushState(parser.getGoto(this.state,type,!0),this.reducePos),type<parser.minRepeatTerm&&this.storeNode(type,this.reducePos,this.reducePos,4,!0),void this.reduceContext(type,this.reducePos);let base=this.stack.length-3*(depth-1)-(262144&action?6:0),start=base?this.stack[base-2]:this.p.ranges[0].from,size=this.reducePos-start;size>=2e3&&!(null===(_a=this.p.parser.nodeSet.types[type])||void 0===_a?void 0:_a.isAnonymous)&&(start==this.p.lastBigReductionStart?(this.p.bigReductionCount++,this.p.lastBigReductionSize=size):this.p.lastBigReductionSize<size&&(this.p.bigReductionCount=1,this.p.lastBigReductionStart=start,this.p.lastBigReductionSize=size));let bufferBase=base?this.stack[base-1]:0,count=this.bufferBase+this.buffer.length-bufferBase;if(type<parser.minRepeatTerm||131072&action){let pos=parser.stateFlag(this.state,1)?this.pos:this.reducePos;this.storeNode(type,start,pos,count+4,!0)}if(262144&action)this.state=this.stack[base];else{let baseStateID=this.stack[base-3];this.state=parser.getGoto(baseStateID,type,!0)}for(;this.stack.length>base;)this.stack.pop();this.reduceContext(type,start)}storeNode(term,start,end,size=4,isReduce=!1){if(0==term&&(!this.stack.length||this.stack[this.stack.length-1]<this.buffer.length+this.bufferBase)){let cur=this,top=this.buffer.length;if(0==top&&cur.parent&&(top=cur.bufferBase-cur.parent.bufferBase,cur=cur.parent),top>0&&0==cur.buffer[top-4]&&cur.buffer[top-1]>-1){if(start==end)return;if(cur.buffer[top-2]>=start)return void(cur.buffer[top-2]=end)}}if(isReduce&&this.pos!=end){let index=this.buffer.length;if(index>0&&0!=this.buffer[index-4])for(;index>0&&this.buffer[index-2]>end;)this.buffer[index]=this.buffer[index-4],this.buffer[index+1]=this.buffer[index-3],this.buffer[index+2]=this.buffer[index-2],this.buffer[index+3]=this.buffer[index-1],index-=4,size>4&&(size-=4);this.buffer[index]=term,this.buffer[index+1]=start,this.buffer[index+2]=end,this.buffer[index+3]=size}else this.buffer.push(term,start,end,size)}shift(action,next,nextEnd){let start=this.pos;if(131072&action)this.pushState(65535&action,this.pos);else if(262144&action)this.pos=nextEnd,this.shiftContext(next,start),next<=this.p.parser.maxNode&&this.buffer.push(next,start,nextEnd,4);else{let nextState=action,{parser:parser}=this.p;(nextEnd>this.pos||next<=parser.maxNode)&&(this.pos=nextEnd,parser.stateFlag(nextState,1)||(this.reducePos=nextEnd)),this.pushState(nextState,start),this.shiftContext(next,start),next<=parser.maxNode&&this.buffer.push(next,start,nextEnd,4)}}apply(action,next,nextEnd){65536&action?this.reduce(action):this.shift(action,next,nextEnd)}useNode(value,next){let index=this.p.reused.length-1;(index<0||this.p.reused[index]!=value)&&(this.p.reused.push(value),index++);let start=this.pos;this.reducePos=this.pos=start+value.length,this.pushState(next,start),this.buffer.push(index,start,this.reducePos,-1),this.curContext&&this.updateContext(this.curContext.tracker.reuse(this.curContext.context,value,this,this.p.stream.reset(this.pos-value.length)))}split(){let parent=this,off=parent.buffer.length;for(;off>0&&parent.buffer[off-2]>parent.reducePos;)off-=4;let buffer=parent.buffer.slice(off),base=parent.bufferBase+off;for(;parent&&base==parent.bufferBase;)parent=parent.parent;return new Stack(this.p,this.stack.slice(),this.state,this.reducePos,this.pos,this.score,buffer,base,this.curContext,this.lookAhead,parent)}recoverByDelete(next,nextEnd){let isNode=next<=this.p.parser.maxNode;isNode&&this.storeNode(next,this.pos,nextEnd,4),this.storeNode(0,this.pos,nextEnd,isNode?8:4),this.pos=this.reducePos=nextEnd,this.score-=190}canShift(term){for(let sim=new SimulatedStack(this);;){let action=this.p.parser.stateSlot(sim.state,4)||this.p.parser.hasAction(sim.state,term);if(0==action)return!1;if(!(65536&action))return!0;sim.reduce(action)}}recoverByInsert(next){if(this.stack.length>=300)return[];let nextStates=this.p.parser.nextStates(this.state);if(nextStates.length>8||this.stack.length>=120){let best=[];for(let s,i=0;i<nextStates.length;i+=2)(s=nextStates[i+1])!=this.state&&this.p.parser.hasAction(s,next)&&best.push(nextStates[i],s);if(this.stack.length<120)for(let i=0;best.length<8&&i<nextStates.length;i+=2){let s=nextStates[i+1];best.some(((v,i)=>1&i&&v==s))||best.push(nextStates[i],s)}nextStates=best}let result=[];for(let i=0;i<nextStates.length&&result.length<4;i+=2){let s=nextStates[i+1];if(s==this.state)continue;let stack=this.split();stack.pushState(s,this.pos),stack.storeNode(0,stack.pos,stack.pos,4,!0),stack.shiftContext(nextStates[i],this.pos),stack.score-=200,result.push(stack)}return result}forceReduce(){let reduce=this.p.parser.stateSlot(this.state,5);if(!(65536&reduce))return!1;let{parser:parser}=this.p;if(!parser.validAction(this.state,reduce)){let depth=reduce>>19,term=65535&reduce,target=this.stack.length-3*depth;if(target<0||parser.getGoto(this.stack[target],term,!1)<0)return!1;this.storeNode(0,this.reducePos,this.reducePos,4,!0),this.score-=100}return this.reducePos=this.pos,this.reduce(reduce),!0}forceAll(){for(;!this.p.parser.stateFlag(this.state,2);)if(!this.forceReduce()){this.storeNode(0,this.pos,this.pos,4,!0);break}return this}get deadEnd(){if(3!=this.stack.length)return!1;let{parser:parser}=this.p;return 65535==parser.data[parser.stateSlot(this.state,1)]&&!parser.stateSlot(this.state,4)}restart(){this.state=this.stack[0],this.stack.length=0}sameState(other){if(this.state!=other.state||this.stack.length!=other.stack.length)return!1;for(let i=0;i<this.stack.length;i+=3)if(this.stack[i]!=other.stack[i])return!1;return!0}get parser(){return this.p.parser}dialectEnabled(dialectID){return this.p.parser.dialect.flags[dialectID]}shiftContext(term,start){this.curContext&&this.updateContext(this.curContext.tracker.shift(this.curContext.context,term,this,this.p.stream.reset(start)))}reduceContext(term,start){this.curContext&&this.updateContext(this.curContext.tracker.reduce(this.curContext.context,term,this,this.p.stream.reset(start)))}emitContext(){let last=this.buffer.length-1;(last<0||-3!=this.buffer[last])&&this.buffer.push(this.curContext.hash,this.reducePos,this.reducePos,-3)}emitLookAhead(){let last=this.buffer.length-1;(last<0||-4!=this.buffer[last])&&this.buffer.push(this.lookAhead,this.reducePos,this.reducePos,-4)}updateContext(context){if(context!=this.curContext.context){let newCx=new StackContext(this.curContext.tracker,context);newCx.hash!=this.curContext.hash&&this.emitContext(),this.curContext=newCx}}setLookAhead(lookAhead){lookAhead>this.lookAhead&&(this.emitLookAhead(),this.lookAhead=lookAhead)}close(){this.curContext&&this.curContext.tracker.strict&&this.emitContext(),this.lookAhead>0&&this.emitLookAhead()}}class StackContext{constructor(tracker,context){this.tracker=tracker,this.context=context,this.hash=tracker.strict?tracker.hash(context):0}}var Recover;!function(Recover){Recover[Recover.Insert=200]="Insert",Recover[Recover.Delete=190]="Delete",Recover[Recover.Reduce=100]="Reduce",Recover[Recover.MaxNext=4]="MaxNext",Recover[Recover.MaxInsertStackDepth=300]="MaxInsertStackDepth",Recover[Recover.DampenInsertStackDepth=120]="DampenInsertStackDepth",Recover[Recover.MinBigReduction=2e3]="MinBigReduction"}(Recover||(Recover={}));class SimulatedStack{constructor(start){this.start=start,this.state=start.state,this.stack=start.stack,this.base=this.stack.length}reduce(action){let term=65535&action,depth=action>>19;0==depth?(this.stack==this.start.stack&&(this.stack=this.stack.slice()),this.stack.push(this.state,0,0),this.base+=3):this.base-=3*(depth-1);let goto=this.start.p.parser.getGoto(this.stack[this.base-3],term,!0);this.state=goto}}class StackBufferCursor{constructor(stack,pos,index){this.stack=stack,this.pos=pos,this.index=index,this.buffer=stack.buffer,0==this.index&&this.maybeNext()}static create(stack,pos=stack.bufferBase+stack.buffer.length){return new StackBufferCursor(stack,pos,pos-stack.bufferBase)}maybeNext(){let next=this.stack.parent;null!=next&&(this.index=this.stack.bufferBase-next.bufferBase,this.stack=next,this.buffer=next.buffer)}get id(){return this.buffer[this.index-4]}get start(){return this.buffer[this.index-3]}get end(){return this.buffer[this.index-2]}get size(){return this.buffer[this.index-1]}next(){this.index-=4,this.pos-=4,0==this.index&&this.maybeNext()}fork(){return new StackBufferCursor(this.stack,this.pos,this.index)}}function decodeArray(input,Type=Uint16Array){if("string"!=typeof input)return input;let array=null;for(let pos=0,out=0;pos<input.length;){let value=0;for(;;){let next=input.charCodeAt(pos++),stop=!1;if(126==next){value=65535;break}next>=92&&next--,next>=34&&next--;let digit=next-32;if(digit>=46&&(digit-=46,stop=!0),value+=digit,stop)break;value*=46}array?array[out++]=value:array=new Type(value)}return array}class CachedToken{constructor(){this.start=-1,this.value=-1,this.end=-1,this.extended=-1,this.lookAhead=0,this.mask=0,this.context=0}}const nullToken=new CachedToken;class InputStream{constructor(input,ranges){this.input=input,this.ranges=ranges,this.chunk="",this.chunkOff=0,this.chunk2="",this.chunk2Pos=0,this.next=-1,this.token=nullToken,this.rangeIndex=0,this.pos=this.chunkPos=ranges[0].from,this.range=ranges[0],this.end=ranges[ranges.length-1].to,this.readNext()}resolveOffset(offset,assoc){let range=this.range,index=this.rangeIndex,pos=this.pos+offset;for(;pos<range.from;){if(!index)return null;let next=this.ranges[--index];pos-=range.from-next.to,range=next}for(;assoc<0?pos>range.to:pos>=range.to;){if(index==this.ranges.length-1)return null;let next=this.ranges[++index];pos+=next.from-range.to,range=next}return pos}clipPos(pos){if(pos>=this.range.from&&pos<this.range.to)return pos;for(let range of this.ranges)if(range.to>pos)return Math.max(pos,range.from);return this.end}peek(offset){let pos,result,idx=this.chunkOff+offset;if(idx>=0&&idx<this.chunk.length)pos=this.pos+offset,result=this.chunk.charCodeAt(idx);else{let resolved=this.resolveOffset(offset,1);if(null==resolved)return-1;if(pos=resolved,pos>=this.chunk2Pos&&pos<this.chunk2Pos+this.chunk2.length)result=this.chunk2.charCodeAt(pos-this.chunk2Pos);else{let i=this.rangeIndex,range=this.range;for(;range.to<=pos;)range=this.ranges[++i];this.chunk2=this.input.chunk(this.chunk2Pos=pos),pos+this.chunk2.length>range.to&&(this.chunk2=this.chunk2.slice(0,range.to-pos)),result=this.chunk2.charCodeAt(0)}}return pos>=this.token.lookAhead&&(this.token.lookAhead=pos+1),result}acceptToken(token,endOffset=0){let end=endOffset?this.resolveOffset(endOffset,-1):this.pos;if(null==end||end<this.token.start)throw new RangeError("Token end out of bounds");this.token.value=token,this.token.end=end}getChunk(){if(this.pos>=this.chunk2Pos&&this.pos<this.chunk2Pos+this.chunk2.length){let{chunk:chunk,chunkPos:chunkPos}=this;this.chunk=this.chunk2,this.chunkPos=this.chunk2Pos,this.chunk2=chunk,this.chunk2Pos=chunkPos,this.chunkOff=this.pos-this.chunkPos}else{this.chunk2=this.chunk,this.chunk2Pos=this.chunkPos;let nextChunk=this.input.chunk(this.pos),end=this.pos+nextChunk.length;this.chunk=end>this.range.to?nextChunk.slice(0,this.range.to-this.pos):nextChunk,this.chunkPos=this.pos,this.chunkOff=0}}readNext(){return this.chunkOff>=this.chunk.length&&(this.getChunk(),this.chunkOff==this.chunk.length)?this.next=-1:this.next=this.chunk.charCodeAt(this.chunkOff)}advance(n=1){for(this.chunkOff+=n;this.pos+n>=this.range.to;){if(this.rangeIndex==this.ranges.length-1)return this.setDone();n-=this.range.to-this.pos,this.range=this.ranges[++this.rangeIndex],this.pos=this.range.from}return this.pos+=n,this.pos>=this.token.lookAhead&&(this.token.lookAhead=this.pos+1),this.readNext()}setDone(){return this.pos=this.chunkPos=this.end,this.range=this.ranges[this.rangeIndex=this.ranges.length-1],this.chunk="",this.next=-1}reset(pos,token){if(token?(this.token=token,token.start=pos,token.lookAhead=pos+1,token.value=token.extended=-1):this.token=nullToken,this.pos!=pos){if(this.pos=pos,pos==this.end)return this.setDone(),this;for(;pos<this.range.from;)this.range=this.ranges[--this.rangeIndex];for(;pos>=this.range.to;)this.range=this.ranges[++this.rangeIndex];pos>=this.chunkPos&&pos<this.chunkPos+this.chunk.length?this.chunkOff=pos-this.chunkPos:(this.chunk="",this.chunkOff=0),this.readNext()}return this}read(from,to){if(from>=this.chunkPos&&to<=this.chunkPos+this.chunk.length)return this.chunk.slice(from-this.chunkPos,to-this.chunkPos);if(from>=this.chunk2Pos&&to<=this.chunk2Pos+this.chunk2.length)return this.chunk2.slice(from-this.chunk2Pos,to-this.chunk2Pos);if(from>=this.range.from&&to<=this.range.to)return this.input.read(from,to);let result="";for(let r of this.ranges){if(r.from>=to)break;r.to>from&&(result+=this.input.read(Math.max(r.from,from),Math.min(r.to,to)))}return result}}class TokenGroup{constructor(data,id){this.data=data,this.id=id}token(input,stack){let{parser:parser}=stack.p;readToken(this.data,input,stack,this.id,parser.data,parser.tokenPrecTable)}}TokenGroup.prototype.contextual=TokenGroup.prototype.fallback=TokenGroup.prototype.extend=!1;class LocalTokenGroup{constructor(data,precTable,elseToken){this.precTable=precTable,this.elseToken=elseToken,this.data="string"==typeof data?decodeArray(data):data}token(input,stack){let start=input.pos,skipped=0;for(;readToken(this.data,input,stack,0,this.data,this.precTable),!(input.token.value>-1);){if(null==this.elseToken)return;if(input.next<0)break;input.advance(),input.reset(input.pos,input.token),skipped++}skipped&&(input.reset(start,input.token),input.acceptToken(this.elseToken,skipped))}}function readToken(data,input,stack,group,precTable,precOffset){let state=0,groupMask=1<<group,{dialect:dialect}=stack.p.parser;scan:for(;groupMask&data[state];){let accEnd=data[state+1];for(let i=state+3;i<accEnd;i+=2)if((data[i+1]&groupMask)>0){let term=data[i];if(dialect.allows(term)&&(-1==input.token.value||input.token.value==term||overrides(term,input.token.value,precTable,precOffset))){input.acceptToken(term);break}}let next=input.next,low=0,high=data[state+2];if(!(input.next<0&&high>low&&65535==data[accEnd+3*high-3]&&65535==data[accEnd+3*high-3])){for(;low<high;){let mid=low+high>>1,index=accEnd+mid+(mid<<1),from=data[index],to=data[index+1]||65536;if(next<from)high=mid;else{if(!(next>=to)){state=data[index+2],input.advance();continue scan}low=mid+1}}break}state=data[accEnd+3*high-1]}}function findOffset(data,start,term){for(let next,i=start;65535!=(next=data[i]);i++)if(next==term)return i-start;return-1}function overrides(token,prev,tableData,tableOffset){let iPrev=findOffset(tableData,tableOffset,prev);return iPrev<0||findOffset(tableData,tableOffset,token)<iPrev}LocalTokenGroup.prototype.contextual=TokenGroup.prototype.fallback=TokenGroup.prototype.extend=!1;const verbose="undefined"!=typeof process&&process.env&&/\bparse\b/.test(process.env.LOG);let stackIDs=null;var Safety,Rec;function cutAt(tree,pos,side){let cursor=tree.cursor(IterMode.IncludeAnonymous);for(cursor.moveTo(pos);;)if(!(side<0?cursor.childBefore(pos):cursor.childAfter(pos)))for(;;){if((side<0?cursor.to<pos:cursor.from>pos)&&!cursor.type.isError)return side<0?Math.max(0,Math.min(cursor.to-1,pos-25)):Math.min(tree.length,Math.max(cursor.from+1,pos+25));if(side<0?cursor.prevSibling():cursor.nextSibling())break;if(!cursor.parent())return side<0?0:tree.length}}!function(Safety){Safety[Safety.Margin=25]="Margin"}(Safety||(Safety={}));class FragmentCursor{constructor(fragments,nodeSet){this.fragments=fragments,this.nodeSet=nodeSet,this.i=0,this.fragment=null,this.safeFrom=-1,this.safeTo=-1,this.trees=[],this.start=[],this.index=[],this.nextFragment()}nextFragment(){let fr=this.fragment=this.i==this.fragments.length?null:this.fragments[this.i++];if(fr){for(this.safeFrom=fr.openStart?cutAt(fr.tree,fr.from+fr.offset,1)-fr.offset:fr.from,this.safeTo=fr.openEnd?cutAt(fr.tree,fr.to+fr.offset,-1)-fr.offset:fr.to;this.trees.length;)this.trees.pop(),this.start.pop(),this.index.pop();this.trees.push(fr.tree),this.start.push(-fr.offset),this.index.push(0),this.nextStart=this.safeFrom}else this.nextStart=1e9}nodeAt(pos){if(pos<this.nextStart)return null;for(;this.fragment&&this.safeTo<=pos;)this.nextFragment();if(!this.fragment)return null;for(;;){let last=this.trees.length-1;if(last<0)return this.nextFragment(),null;let top=this.trees[last],index=this.index[last];if(index==top.children.length){this.trees.pop(),this.start.pop(),this.index.pop();continue}let next=top.children[index],start=this.start[last]+top.positions[index];if(start>pos)return this.nextStart=start,null;if(next instanceof Tree){if(start==pos){if(start<this.safeFrom)return null;let end=start+next.length;if(end<=this.safeTo){let lookAhead=next.prop(NodeProp.lookAhead);if(!lookAhead||end+lookAhead<this.fragment.to)return next}}this.index[last]++,start+next.length>=Math.max(this.safeFrom,pos)&&(this.trees.push(next),this.start.push(start),this.index.push(0))}else this.index[last]++,this.nextStart=start+next.length}}}class TokenCache{constructor(parser,stream){this.stream=stream,this.tokens=[],this.mainToken=null,this.actions=[],this.tokens=parser.tokenizers.map((_=>new CachedToken))}getActions(stack){let actionIndex=0,main=null,{parser:parser}=stack.p,{tokenizers:tokenizers}=parser,mask=parser.stateSlot(stack.state,3),context=stack.curContext?stack.curContext.hash:0,lookAhead=0;for(let i=0;i<tokenizers.length;i++){if(!(1<<i&mask))continue;let tokenizer=tokenizers[i],token=this.tokens[i];if((!main||tokenizer.fallback)&&((tokenizer.contextual||token.start!=stack.pos||token.mask!=mask||token.context!=context)&&(this.updateCachedToken(token,tokenizer,stack),token.mask=mask,token.context=context),token.lookAhead>token.end+25&&(lookAhead=Math.max(token.lookAhead,lookAhead)),0!=token.value)){let startIndex=actionIndex;if(token.extended>-1&&(actionIndex=this.addActions(stack,token.extended,token.end,actionIndex)),actionIndex=this.addActions(stack,token.value,token.end,actionIndex),!tokenizer.extend&&(main=token,actionIndex>startIndex))break}}for(;this.actions.length>actionIndex;)this.actions.pop();return lookAhead&&stack.setLookAhead(lookAhead),main||stack.pos!=this.stream.end||(main=new CachedToken,main.value=stack.p.parser.eofTerm,main.start=main.end=stack.pos,actionIndex=this.addActions(stack,main.value,main.end,actionIndex)),this.mainToken=main,this.actions}getMainToken(stack){if(this.mainToken)return this.mainToken;let main=new CachedToken,{pos:pos,p:p}=stack;return main.start=pos,main.end=Math.min(pos+1,p.stream.end),main.value=pos==p.stream.end?p.parser.eofTerm:0,main}updateCachedToken(token,tokenizer,stack){let start=this.stream.clipPos(stack.pos);if(tokenizer.token(this.stream.reset(start,token),stack),token.value>-1){let{parser:parser}=stack.p;for(let i=0;i<parser.specialized.length;i++)if(parser.specialized[i]==token.value){let result=parser.specializers[i](this.stream.read(token.start,token.end),stack);if(result>=0&&stack.p.parser.dialect.allows(result>>1)){1&result?token.extended=result>>1:token.value=result>>1;break}}}else token.value=0,token.end=this.stream.clipPos(start+1)}putAction(action,token,end,index){for(let i=0;i<index;i+=3)if(this.actions[i]==action)return index;return this.actions[index++]=action,this.actions[index++]=token,this.actions[index++]=end,index}addActions(stack,token,end,index){let{state:state}=stack,{parser:parser}=stack.p,{data:data}=parser;for(let set=0;set<2;set++)for(let i=parser.stateSlot(state,set?2:1);;i+=3){if(65535==data[i]){if(1!=data[i+1]){0==index&&2==data[i+1]&&(index=this.putAction(pair(data,i+2),token,end,index));break}i=pair(data,i+2)}data[i]==token&&(index=this.putAction(pair(data,i+1),token,end,index))}return index}}!function(Rec){Rec[Rec.Distance=5]="Distance",Rec[Rec.MaxRemainingPerStep=3]="MaxRemainingPerStep",Rec[Rec.MinBufferLengthPrune=500]="MinBufferLengthPrune",Rec[Rec.ForceReduceLimit=10]="ForceReduceLimit",Rec[Rec.CutDepth=15e3]="CutDepth",Rec[Rec.CutTo=9e3]="CutTo",Rec[Rec.MaxLeftAssociativeReductionCount=300]="MaxLeftAssociativeReductionCount",Rec[Rec.MaxStackCount=12]="MaxStackCount"}(Rec||(Rec={}));class Parse{constructor(parser,input,fragments,ranges){this.parser=parser,this.input=input,this.ranges=ranges,this.recovering=0,this.nextStackID=9812,this.minStackPos=0,this.reused=[],this.stoppedAt=null,this.lastBigReductionStart=-1,this.lastBigReductionSize=0,this.bigReductionCount=0,this.stream=new InputStream(input,ranges),this.tokens=new TokenCache(parser,this.stream),this.topTerm=parser.top[1];let{from:from}=ranges[0];this.stacks=[Stack.start(this,parser.top[0],from)],this.fragments=fragments.length&&this.stream.end-from>4*parser.bufferLength?new FragmentCursor(fragments,parser.nodeSet):null}get parsedPos(){return this.minStackPos}advance(){let stopped,stoppedTokens,stacks=this.stacks,pos=this.minStackPos,newStacks=this.stacks=[];if(this.bigReductionCount>300&&1==stacks.length){let[s]=stacks;for(;s.forceReduce()&&s.stack.length&&s.stack[s.stack.length-2]>=this.lastBigReductionStart;);this.bigReductionCount=this.lastBigReductionSize=0}for(let i=0;i<stacks.length;i++){let stack=stacks[i];for(;;){if(this.tokens.mainToken=null,stack.pos>pos)newStacks.push(stack);else{if(this.advanceStack(stack,newStacks,stacks))continue;{stopped||(stopped=[],stoppedTokens=[]),stopped.push(stack);let tok=this.tokens.getMainToken(stack);stoppedTokens.push(tok.value,tok.end)}}break}}if(!newStacks.length){let finished=stopped&&function(stacks){let best=null;for(let stack of stacks){let stopped=stack.p.stoppedAt;(stack.pos==stack.p.stream.end||null!=stopped&&stack.pos>stopped)&&stack.p.parser.stateFlag(stack.state,2)&&(!best||best.score<stack.score)&&(best=stack)}return best}(stopped);if(finished)return this.stackToTree(finished);if(this.parser.strict)throw verbose&&stopped&&console.log("Stuck with token "+(this.tokens.mainToken?this.parser.getName(this.tokens.mainToken.value):"none")),new SyntaxError("No parse at "+pos);this.recovering||(this.recovering=5)}if(this.recovering&&stopped){let finished=null!=this.stoppedAt&&stopped[0].pos>this.stoppedAt?stopped[0]:this.runRecovery(stopped,stoppedTokens,newStacks);if(finished)return this.stackToTree(finished.forceAll())}if(this.recovering){let maxRemaining=1==this.recovering?1:3*this.recovering;if(newStacks.length>maxRemaining)for(newStacks.sort(((a,b)=>b.score-a.score));newStacks.length>maxRemaining;)newStacks.pop();newStacks.some((s=>s.reducePos>pos))&&this.recovering--}else if(newStacks.length>1){outer:for(let i=0;i<newStacks.length-1;i++){let stack=newStacks[i];for(let j=i+1;j<newStacks.length;j++){let other=newStacks[j];if(stack.sameState(other)||stack.buffer.length>500&&other.buffer.length>500){if(!((stack.score-other.score||stack.buffer.length-other.buffer.length)>0)){newStacks.splice(i--,1);continue outer}newStacks.splice(j--,1)}}}newStacks.length>12&&newStacks.splice(12,newStacks.length-12)}this.minStackPos=newStacks[0].pos;for(let i=1;i<newStacks.length;i++)newStacks[i].pos<this.minStackPos&&(this.minStackPos=newStacks[i].pos);return null}stopAt(pos){if(null!=this.stoppedAt&&this.stoppedAt<pos)throw new RangeError("Can't move stoppedAt forward");this.stoppedAt=pos}advanceStack(stack,stacks,split){let start=stack.pos,{parser:parser}=this,base=verbose?this.stackID(stack)+" -> ":"";if(null!=this.stoppedAt&&start>this.stoppedAt)return stack.forceReduce()?stack:null;if(this.fragments){let strictCx=stack.curContext&&stack.curContext.tracker.strict,cxHash=strictCx?stack.curContext.hash:0;for(let cached=this.fragments.nodeAt(start);cached;){let match=this.parser.nodeSet.types[cached.type.id]==cached.type?parser.getGoto(stack.state,cached.type.id):-1;if(match>-1&&cached.length&&(!strictCx||(cached.prop(NodeProp.contextHash)||0)==cxHash))return stack.useNode(cached,match),verbose&&console.log(base+this.stackID(stack)+` (via reuse of ${parser.getName(cached.type.id)})`),!0;if(!(cached instanceof Tree)||0==cached.children.length||cached.positions[0]>0)break;let inner=cached.children[0];if(!(inner instanceof Tree&&0==cached.positions[0]))break;cached=inner}}let defaultReduce=parser.stateSlot(stack.state,4);if(defaultReduce>0)return stack.reduce(defaultReduce),verbose&&console.log(base+this.stackID(stack)+` (via always-reduce ${parser.getName(65535&defaultReduce)})`),!0;if(stack.stack.length>=15e3)for(;stack.stack.length>9e3&&stack.forceReduce(););let actions=this.tokens.getActions(stack);for(let i=0;i<actions.length;){let action=actions[i++],term=actions[i++],end=actions[i++],last=i==actions.length||!split,localStack=last?stack:stack.split();if(localStack.apply(action,term,end),verbose&&console.log(base+this.stackID(localStack)+` (via ${65536&action?`reduce of ${parser.getName(65535&action)}`:"shift"} for ${parser.getName(term)} @ ${start}${localStack==stack?"":", split"})`),last)return!0;localStack.pos>start?stacks.push(localStack):split.push(localStack)}return!1}advanceFully(stack,newStacks){let pos=stack.pos;for(;;){if(!this.advanceStack(stack,null,null))return!1;if(stack.pos>pos)return pushStackDedup(stack,newStacks),!0}}runRecovery(stacks,tokens,newStacks){let finished=null,restarted=!1;for(let i=0;i<stacks.length;i++){let stack=stacks[i],token=tokens[i<<1],tokenEnd=tokens[1+(i<<1)],base=verbose?this.stackID(stack)+" -> ":"";if(stack.deadEnd){if(restarted)continue;if(restarted=!0,stack.restart(),verbose&&console.log(base+this.stackID(stack)+" (restarted)"),this.advanceFully(stack,newStacks))continue}let force=stack.split(),forceBase=base;for(let j=0;force.forceReduce()&&j<10;j++){if(verbose&&console.log(forceBase+this.stackID(force)+" (via force-reduce)"),this.advanceFully(force,newStacks))break;verbose&&(forceBase=this.stackID(force)+" -> ")}for(let insert of stack.recoverByInsert(token))verbose&&console.log(base+this.stackID(insert)+" (via recover-insert)"),this.advanceFully(insert,newStacks);this.stream.end>stack.pos?(tokenEnd==stack.pos&&(tokenEnd++,token=0),stack.recoverByDelete(token,tokenEnd),verbose&&console.log(base+this.stackID(stack)+` (via recover-delete ${this.parser.getName(token)})`),pushStackDedup(stack,newStacks)):(!finished||finished.score<stack.score)&&(finished=stack)}return finished}stackToTree(stack){return stack.close(),Tree.build({buffer:StackBufferCursor.create(stack),nodeSet:this.parser.nodeSet,topID:this.topTerm,maxBufferLength:this.parser.bufferLength,reused:this.reused,start:this.ranges[0].from,length:stack.pos-this.ranges[0].from,minRepeatType:this.parser.minRepeatTerm})}stackID(stack){let id=(stackIDs||(stackIDs=new WeakMap)).get(stack);return id||stackIDs.set(stack,id=String.fromCodePoint(this.nextStackID++)),id+stack}}function pushStackDedup(stack,newStacks){for(let i=0;i<newStacks.length;i++){let other=newStacks[i];if(other.pos==stack.pos&&other.sameState(stack))return void(newStacks[i].score<stack.score&&(newStacks[i]=stack))}newStacks.push(stack)}class Dialect{constructor(source,flags,disabled){this.source=source,this.flags=flags,this.disabled=disabled}allows(term){return!this.disabled||0==this.disabled[term]}}class LRParser extends Parser{constructor(spec){if(super(),this.wrappers=[],14!=spec.version)throw new RangeError(`Parser version (${spec.version}) doesn't match runtime version (14)`);let nodeNames=spec.nodeNames.split(" ");this.minRepeatTerm=nodeNames.length;for(let i=0;i<spec.repeatNodeCount;i++)nodeNames.push("");let topTerms=Object.keys(spec.topRules).map((r=>spec.topRules[r][1])),nodeProps=[];for(let i=0;i<nodeNames.length;i++)nodeProps.push([]);function setProp(nodeID,prop,value){nodeProps[nodeID].push([prop,prop.deserialize(String(value))])}if(spec.nodeProps)for(let propSpec of spec.nodeProps){let prop=propSpec[0];"string"==typeof prop&&(prop=NodeProp[prop]);for(let i=1;i<propSpec.length;){let next=propSpec[i++];if(next>=0)setProp(next,prop,propSpec[i++]);else{let value=propSpec[i+-next];for(let j=-next;j>0;j--)setProp(propSpec[i++],prop,value);i++}}}this.nodeSet=new NodeSet(nodeNames.map(((name,i)=>NodeType.define({name:i>=this.minRepeatTerm?void 0:name,id:i,props:nodeProps[i],top:topTerms.indexOf(i)>-1,error:0==i,skipped:spec.skippedNodes&&spec.skippedNodes.indexOf(i)>-1})))),spec.propSources&&(this.nodeSet=this.nodeSet.extend(...spec.propSources)),this.strict=!1,this.bufferLength=DefaultBufferLength;let tokenArray=decodeArray(spec.tokenData);this.context=spec.context,this.specializerSpecs=spec.specialized||[],this.specialized=new Uint16Array(this.specializerSpecs.length);for(let i=0;i<this.specializerSpecs.length;i++)this.specialized[i]=this.specializerSpecs[i].term;this.specializers=this.specializerSpecs.map(getSpecializer),this.states=decodeArray(spec.states,Uint32Array),this.data=decodeArray(spec.stateData),this.goto=decodeArray(spec.goto),this.maxTerm=spec.maxTerm,this.tokenizers=spec.tokenizers.map((value=>"number"==typeof value?new TokenGroup(tokenArray,value):value)),this.topRules=spec.topRules,this.dialects=spec.dialects||{},this.dynamicPrecedences=spec.dynamicPrecedences||null,this.tokenPrecTable=spec.tokenPrec,this.termNames=spec.termNames||null,this.maxNode=this.nodeSet.types.length-1,this.dialect=this.parseDialect(),this.top=this.topRules[Object.keys(this.topRules)[0]]}createParse(input,fragments,ranges){let parse=new Parse(this,input,fragments,ranges);for(let w of this.wrappers)parse=w(parse,input,fragments,ranges);return parse}getGoto(state,term,loose=!1){let table=this.goto;if(term>=table[0])return-1;for(let pos=table[term+1];;){let groupTag=table[pos++],last=1&groupTag,target=table[pos++];if(last&&loose)return target;for(let end=pos+(groupTag>>1);pos<end;pos++)if(table[pos]==state)return target;if(last)return-1}}hasAction(state,terminal){let data=this.data;for(let set=0;set<2;set++)for(let next,i=this.stateSlot(state,set?2:1);;i+=3){if(65535==(next=data[i])){if(1!=data[i+1]){if(2==data[i+1])return pair(data,i+2);break}next=data[i=pair(data,i+2)]}if(next==terminal||0==next)return pair(data,i+1)}return 0}stateSlot(state,slot){return this.states[6*state+slot]}stateFlag(state,flag){return(this.stateSlot(state,0)&flag)>0}validAction(state,action){if(action==this.stateSlot(state,4))return!0;for(let i=this.stateSlot(state,1);;i+=3){if(65535==this.data[i]){if(1!=this.data[i+1])return!1;i=pair(this.data,i+2)}if(action==pair(this.data,i+1))return!0}}nextStates(state){let result=[];for(let i=this.stateSlot(state,1);;i+=3){if(65535==this.data[i]){if(1!=this.data[i+1])break;i=pair(this.data,i+2)}if(!(1&this.data[i+2])){let value=this.data[i+1];result.some(((v,i)=>1&i&&v==value))||result.push(this.data[i],value)}}return result}configure(config){let copy=Object.assign(Object.create(LRParser.prototype),this);if(config.props&&(copy.nodeSet=this.nodeSet.extend(...config.props)),config.top){let info=this.topRules[config.top];if(!info)throw new RangeError(`Invalid top rule name ${config.top}`);copy.top=info}return config.tokenizers&&(copy.tokenizers=this.tokenizers.map((t=>{let found=config.tokenizers.find((r=>r.from==t));return found?found.to:t}))),config.specializers&&(copy.specializers=this.specializers.slice(),copy.specializerSpecs=this.specializerSpecs.map(((s,i)=>{let found=config.specializers.find((r=>r.from==s.external));if(!found)return s;let spec=Object.assign(Object.assign({},s),{external:found.to});return copy.specializers[i]=getSpecializer(spec),spec}))),config.contextTracker&&(copy.context=config.contextTracker),config.dialect&&(copy.dialect=this.parseDialect(config.dialect)),null!=config.strict&&(copy.strict=config.strict),config.wrap&&(copy.wrappers=copy.wrappers.concat(config.wrap)),null!=config.bufferLength&&(copy.bufferLength=config.bufferLength),copy}hasWrappers(){return this.wrappers.length>0}getName(term){return this.termNames?this.termNames[term]:String(term<=this.maxNode&&this.nodeSet.types[term].name||term)}get eofTerm(){return this.maxNode+1}get topNode(){return this.nodeSet.types[this.top[1]]}dynamicPrecedence(term){let prec=this.dynamicPrecedences;return null==prec?0:prec[term]||0}parseDialect(dialect){let values=Object.keys(this.dialects),flags=values.map((()=>!1));if(dialect)for(let part of dialect.split(" ")){let id=values.indexOf(part);id>=0&&(flags[id]=!0)}let disabled=null;for(let i=0;i<values.length;i++)if(!flags[i])for(let id,j=this.dialects[values[i]];65535!=(id=this.data[j++]);)(disabled||(disabled=new Uint8Array(this.maxTerm+1)))[id]=1;return new Dialect(dialect,flags,disabled)}static deserialize(spec){return new LRParser(spec)}}function pair(data,off){return data[off]|data[off+1]<<16}function getSpecializer(spec){if(spec.external){let mask=spec.extend?1:0;return(value,stack)=>spec.external(value,stack)<<1|mask}return spec.get}const spec_Identifier$1={__proto__:null,rekarel:130,globals:132,move:154,turnleft:156,putbeeper:158,pickbeeper:160,turnoff:162,iszero:170,nextToABeeper:172,notNextToABeeper:174,frontIsClear:176,leftIsClear:178,rightIsClear:180,frontIsBlocked:182,leftIsBlocked:184,rightIsBlocked:186,facingNorth:188,facingSouth:190,facingEast:192,facingWest:194,notFacingNorth:196,notFacingSouth:198,notFacingEast:200,notFacingWest:202,anyBeepersInBeeperBag:204,noBeepersInBeeperBag:206,true:208,false:210,beepersOnFloor:212,beepersInBeeperBag:214,currentRow:216,currentColumn:218,succ:224,pred:226,while:228,iterate:230,if:232,else:234,continue:236,break:238,return:240},parser$1=LRParser.deserialize({version:14,states:"2SO]QPOOPeOPOOOmQQO'#CcO]QPOOOOQO'#Cb'#CbOxQPOOP}OWO'#C]P!YOSO'#C_POOO)C?[)C?[OOQO'#Cf'#CfO!hQPO,58}OOQO,58|,58|OOQO'#Ch'#ChO!mQPOOPOOO'#Da'#DaP!rOWO,58wPOOO,58w,58wPOOO'#Db'#DbP!}OSO,58yPOOO,58y,58yO#]QQO1G.iOOQO'#Cj'#CjO#hQPO'#CiQOQPOOPOOO-E7_-E7_POOO1G.c1G.cPOOO-E7`-E7`POOO1G.e1G.eO#pQPO7+$TO#uQQO'#CkOOQO'#Dc'#DcO#hQPO'#DuOOQO'#D`'#D`O#zQPO'#EzOOQO'#Du'#DuO$PQPO,59TOOQO<<Go<<GoO$UQPO,59VOOQO-E7a-E7aOOQO,5:a,5:aO$ZQPO,5;fOOQO'#D_'#D_OOQO1G.o1G.oO$`QQO1G.qO!mQPO1G1QO$hQPO7+$]OOQO'#Cm'#CmO!mQPO7+$]O%nQQO'#CnOOQO7+&l7+&lO%uQQO,59XO!mQPO<<GwOOQO<<Gw<<GwOOQO'#Cp'#CpO%zQPO'#DzOOQO'#DR'#DRO&PQPO'#DQOOQO'#DV'#DVO&UQPO'#DUOOQO'#DX'#DXO&PQPO'#DWOOQO'#DZ'#DZOOQO'#D['#D[OOQO'#D^'#D^O(jQQO'#D]O(tQPO'#DyOOQO'#Dy'#DyOOQO'#Dd'#DdO(yQQO'#CoO$PQPO,59YOOQO1G.s1G.sOOQOAN=cAN=cO)QQQO,5:fO)[QQO'#DSO$pQQO,59lO)[QQO,59pO$pQQO,59rOOQO'#Cz'#CzO)cQPO'#CyOOQO'#C{'#C{OOQO'#C|'#C|OOQO'#DO'#DOOOQO'#DP'#DPO)hQPO'#EoOOQO'#En'#EnOOQO'#ES'#ESO*XQPO'#ESO*`QPO'#ESO*xQPO,59wO)[QQO'#EQO+PQQO,59wOOQO'#EQ'#EQOOQO,5:e,5:eOOQO-E7b-E7bOOQO1G.t1G.tO+ZQPO'#CrO)[QQO'#EQO+eQPO1G0QOOQO'#Cq'#CqOOQO1G0Q1G0QO+mQPO'#DTO+tQPO,59nOOQO1G/W1G/WO+yQPO1G/[O,OQQO1G/^O)[QQO,59eO)[QQO,5;ZO-SQPO,5:nOOQO'#ER'#ERO)[QQO,5:lO-XQPO,5:lO-fQPO,5:lOOQO1G/c1G/cO)[QQO,59]OOQO7+%l7+%lOOQO1G/Y1G/YO$pQQO7+$vOOQO'#DY'#DYO$pQQO7+$xO-mQPO1G/PO-rQPO1G0uOOQO1G0Y1G0YOOQO1G0W1G0WOOQO1G.w1G.wOOQO<<Hb<<HbOOQO<<Hd<<HdOOQO7+$k7+$kOOQO7+&a7+&aO-zQPO7+&aO.PQPO<<I{OOQOAN?gAN?g",stateData:".U~O!ZOS![PQ!_PQ~OWQOZTO~O![UO!_VO~OXYO!cXO!dXO~O!g[O~OQ^O!]^O!^`O~OSaO!`aO!aaO!bcO~O!edO~O!heO~OQ^O!]^O!^iO~OSaO!`aO!aaO!bkO~OXlO!cXO!dXO~O`mO!gpO~O!ftO~OXuO~O!jxO~O#myO~O!j{O~O!l|O~OX!OO!l!PO~O!k!SO!l!TO~OX!WO!f!dO!heO!o!VO!p!VO!q!VO!r!VO!s!VO#f!XO#g!ZO#h!]O#j!_O#k!`O#l!aO~O#mcP~P$pOX!hO~O!j!jO~O!j!kO~O!j!mO~OX!yOl!{Oq!vO!o!VO!p!VO!q!VO!r!VO!s!VO!w!oO!x!qO!y!qO!z!qO!{!qO!|!qO!}!qO#O!qO#P!qO#Q!qO#R!qO#S!qO#T!qO#U!qO#V!qO#W!qO#X!qO#Y!qO#Z!qO#[!rO#]!rO#^!rO#_!rO#`!rO#a!rO#d!sO#e!tO~O!j!|O!f!PX~P&ZO!f#OO~O#mcX~P$pO!j#SO!l#VO~P&ZO!j#SO~P&ZO!j#]O~O!j#^O~Og!vXh!vXi!vXj!vXk!vX!f!vX!k!vX!l!vX~O!j#_O~P)mO!j!jO~P)mOg#`Oh#`Oi#`Oj#`Ok#`O~O!f!Pa~P*gO!j#SO!l#dO~P&ZO!kfX!lfX~P*gO!k#eO!l#fO~O!lwX~P*gO!l#gO~O!l#hO~O#i#iOXzi!fzi!hzi!ozi!pzi!qzi!rzi!szi#fzi#gzi#hzi#jzi#kzi#lzi#mzi~O!l#mO~O!f!ta!k!ta!l!ta~P*gO!l#nO~P*gO!l#rO~O!k#tO!l#sO~Oq#uO~O!l#vO~O",goto:"+^#oP#pP#pPP#s#vPP#|P$S$V$Y$hP$l$o%Q%T%h%kPPPPPP%z&X&f%zP&s&s'Q'Y'b'h'Q'k'Q's'{(O(O(O(W(`(f(j(p(v(|PPPPPPPPPPPPPPPP)SPPP)V)gPPPPP)|*e*lPPPPPPPPPPPPPPPPPPPPPPPPP%z*yPPPPPPPPPP+WRWPRROQSORZRQYQRldR]TRg]Qf]c!Q|!P!Q!T!f!l!n#h#jTnfoR}{Q!R|Q!U!P[!d!Q!f!l!n#h#jR!i!TR!g!Qs!W!Q!b!f!j!k!l!m!n!{!|#S#]#^#a#e#h#jR#T!jQ#U!jQ#Z!mQ#k#]Q#l#^R#o#eg!w!b!j!k!m!{!|#S#]#^#a#eg!p!b!j!k!m!{!|#S#]#^#a#eg!x!b!j!k!m!{!|#S#]#^#a#eg!u!b!j!k!m!{!|#S#]#^#a#e]!d!Q!f!l!n#h#j]!Y!Q!f!l!n#h#jQ!l!YR!n!^R#X!k]![!Q!f!l!n#h#j]!^!Q!f!l!n#h#jR#j#[]!c!Q!f!l!n#h#j]!b!Q!f!l!n#h#jQzsR#Q!gTqfoQ_URh_QbVRjbQofRvoQ!f!QR#P!fRsfS!e!Q!fQ#Y!lQ#[!nQ#p#hR#q#j[!c!Q!f!l!n#h#jg!w!b!j!k!m!{!|#S#]#^#a#eQ!z!bY#R!j!m#]#^#eQ#W!kQ#b!{S#c!|#SR#n#aZ#a!z#R#W#b#cg!}!b!j!k!m!{!|#S#]#^#a#eg!v!b!j!k!m!{!|#S#]#^#a#eQrfRwo",nodeNames:"⚠ Comment Annotation2 BlockComment Annotation Script ImportList ImportStatement Import Identifier Modules Class ProgramClass ScriptBlock Start Function DefineType FunctionParams Block InnerBlock BuiltIn CallParams NumericTerm Or And LT LTE COMP Not IFZ Ifzero BoolFunc Globals Number Succ Pred WhileStatement While BooleanHeader BooleanTerm IterateStatement Iterate IfStatement If Else Continue Break ReturnStatement Return End ProgramMain",maxTerm:122,nodeProps:[["closedBy",14,"End"],["openedBy",49,"Start"]],skippedNodes:[0,1,2,3,4,51,52],repeatNodeCount:4,tokenData:"6S~RtX^#cpq#cqr$Wvw$]xy$hyz$m|}$r!O!P$w!P!Q$|!Q![%a!]!^%i!^!_%n!_!`%{!c!}&W#T#U&W#U#V&i#V#W(e#W#X*u#X#]&W#]#^-^#^#d&W#d#e0t#e#j&W#j#k4U#k#o&W#o#p5m#p#q5r#q#r5}#y#z#c$f$g#c#BY#BZ#c$IS$I_#c$I|$JO#c$JT$JU#c$KV$KW#c&FU&FV#c~#hY!Z~X^#cpq#c#y#z#c$f$g#c#BY#BZ#c$IS$I_#c$I|$JO#c$JT$JU#c$KV$KW#c&FU&FV#c~$]Ol~~$`Pvw$c~$hOh~~$mO!j~~$rO!l~~$wO!k~~$|O!e~~%PQz{%V!P!Q%[~%[O!_~~%aO![~~%fPq~!Q![%a~%nO!f~~%sPi~!_!`%v~%{Oj~~&OP!_!`&R~&WOk~W&]SXW!Q![&W!c!}&W#R#S&W#T#o&W[&nUXW!Q![&W!c!}&W#R#S&W#T#c&W#c#d'Q#d#o&W['VUXW!Q![&W!c!}&W#R#S&W#T#c&W#c#d'i#d#o&W['nUXW!Q![&W!c!}&W#R#S&W#T#`&W#`#a(Q#a#o&W[(XS`SXW!Q![&W!c!}&W#R#S&W#T#o&W[(jUXW!Q![&W!c!}&W#R#S&W#T#`&W#`#a(|#a#o&W[)RTXW!Q![&W!c!}&W#R#S&W#T#U)b#U#o&W[)gUXW!Q![&W!c!}&W#R#S&W#T#g&W#g#h)y#h#o&W[*OUXW!Q![&W!c!}&W#R#S&W#T#g&W#g#h*b#h#o&W[*iSZSXW!Q![&W!c!}&W#R#S&W#T#o&W[*zUXW!Q![&W!c!}&W#R#S&W#T#X&W#X#Y+^#Y#o&W[+cUXW!Q![&W!c!}&W#R#S&W#T#Y&W#Y#Z+u#Z#o&W[+zUXW!Q![&W!c!}&W#R#S&W#T#]&W#]#^,^#^#o&W[,cUXW!Q![&W!c!}&W#R#S&W#T#b&W#b#c,u#c#o&W[,zUXW!Q![&W!c!}&W#R#S&W#T#X&W#X#Y(Q#Y#o&W[-cVXW!Q![&W!c!}&W#R#S&W#T#a&W#a#b-x#b#c0]#c#o&W[-}UXW!Q![&W!c!}&W#R#S&W#T#d&W#d#e.a#e#o&W[.fUXW!Q![&W!c!}&W#R#S&W#T#c&W#c#d.x#d#o&W[.}UXW!Q![&W!c!}&W#R#S&W#T#f&W#f#g/a#g#o&W[/fUXW!Q![&W!c!}&W#R#S&W#T#h&W#h#i/x#i#o&W[0PSXWWS!Q![&W!c!}&W#R#S&W#T#o&W[0bUXW!Q![&W!c!}&W#R#S&W#T#h&W#h#i(Q#i#o&W[0yUXW!Q![&W!c!}&W#R#S&W#T#f&W#f#g1]#g#o&W[1bUXW!Q![&W!c!}&W#R#S&W#T#c&W#c#d1t#d#o&W[1yUXW!Q![&W!c!}&W#R#S&W#T#Z&W#Z#[2]#[#o&W[2bUXW!Q![&W!c!}&W#R#S&W#T#f&W#f#g2t#g#o&W[2yTXW!Q![&W!c!}&W#R#S&W#T#U3Y#U#o&W[3_UXW!Q![&W!c!}&W#R#S&W#T#a&W#a#b3q#b#o&W[3xSXW!gS!Q![&W!c!}&W#R#S&W#T#o&W[4ZUXW!Q![&W!c!}&W#R#S&W#T#c&W#c#d4m#d#o&W[4rUXW!Q![&W!c!}&W#R#S&W#T#]&W#]#^5U#^#o&W[5ZUXW!Q![&W!c!}&W#R#S&W#T#W&W#W#X(Q#X#o&W~5rO!h~~5uP#p#q5x~5}Og~~6SO#m~",tokenizers:[2,3,new LocalTokenGroup("x~RRYZ[z{a!b!cl~aO!a~~dP!P!Qg~lO!b~~qQS~!c!}l#T#ol~",39,62),new LocalTokenGroup("j~RQYZX!b!c^~^O!^~~cQQ~!c!}^#T#o^~",25,59)],topRules:{Script:[0,5]},specialized:[{term:9,get:value=>spec_Identifier$1[value]||-1}],tokenPrec:0}),conditions=["frontIsClear","leftIsClear","rightIsClear","frontIsBlocked","leftIsBlocked","rightIsBlocked","nextToABeeper","notNextToABeeper","facingNorth","facingSouth","facingEast","facingWest","notFacingNorth","notFacingSouth","notFacingEast","notFacingWest"].map((tag=>({label:tag,type:"function"}))),builtins=["move()","turnleft()","pickbeeper()","putbeeper()","return()","turnoff()"].map((tag=>({label:tag,type:"function"}))),keywords=["if","iterate","while"].map((tag=>({label:tag,type:"keyword"}))),statements=builtins.concat(keywords);function searchFirst(node,depth){return depth<=0?"none":(console.log(node.name,depth),"BooleanHeader"===node.name?"Boolean":"InnerBlock"===node.name||"Block"===node.name?"Block":node.parent?searchFirst(node.parent,depth-1):"none")}let javaWithContext=parser$1.configure({props:[styleTags({Class:tags.keyword,DefineType:tags.definitionKeyword,ProgramClass:tags.className,ProgramMain:tags.definitionKeyword,Comment:tags.comment,BlockComment:tags.blockComment,obr:tags.bracket,cbr:tags.bracket,Identifier:tags.variableName,Number:tags.integer,While:tags.controlKeyword,If:tags.controlKeyword,Else:tags.controlKeyword,Iterate:tags.controlKeyword,BoolFunc:tags.atom,Ifzero:tags.atom,And:tags.operator,Or:tags.operator,Not:tags.operator,LT:tags.operator,LTE:tags.operator,COMP:tags.operator,BuiltIn:tags.function(tags.variableName),Start:tags.brace,End:tags.brace,Succ:tags.operator,Pred:tags.operator,Continue:tags.controlKeyword,Break:tags.controlKeyword,Return:tags.controlKeyword,Import:tags.keyword,Globals:tags.constant(tags.variableName),Modules:tags.constant(tags.variableName),Annotation:tags.constant(tags.variableName),Annotation2:tags.constant(tags.variableName)}),indentNodeProp.add({Script:_=>0,Block:delimitedIndent({closing:"}"}),ScriptBlock:delimitedIndent({closing:"}"}),WhileStatement:continuedIndent({except:/^\s*\{/}),IterateStatement:continuedIndent({except:/^\s*\{/}),IfStatement:continuedIndent({except:/^\s*(\{|else\b)/})}),foldNodeProp.add({Block:foldInside})]});const javaLanguage=LRLanguage.define({parser:javaWithContext,languageData:{commentTokens:{line:"//",block:{open:"/*",close:"*/"}},indentOnInput:/^\s*(\{|\})\b$/}}),javaCompletion=javaLanguage.data.of({autocomplete:function(context){let nodeBefore=syntaxTree(context.state).resolveInner(context.pos,-1),word=context.matchBefore(/\w*/);if(word.from===word.to&&!context.explicit)return null;console.log(word);const target=searchFirst(nodeBefore,2);return"Boolean"===target?{from:word.from,options:conditions}:"Block"===target?{from:word.from,options:statements}:null}});const spec_Identifier={__proto__:null,usa:144,rekarel:146,globales:148,"iniciar-programa":154,"define-nueva-instruccion":156,"define-condicion":158,"define-calculo":160,define:162,"define-nueva-instrucción":164,"define-condición":166,"define-cálculo":168,como:170,avanza:176,"gira-izquierda":178,"deja-zumbador":180,"coge-zumbador":182,apagate:184,o:194,u:196,y:198,e:200,no:202,"si-es-cero":208,"es-cero":210,"junto-a-zumbador":212,"no-junto-a-zumbador":214,"frente-libre":216,"izquierda-libre":218,"derecha-libre":220,"frente-bloqueado":222,"izquierda-bloqueada":224,"derecha-bloqueada":226,"orientado-al-norte":228,"orientado-al-sur":230,"orientado-al-este":232,"orientado-al-oeste":234,"no-orientado-al-norte":236,"no-orientado-al-sur":238,"no-orientado-al-este":240,"no-orientado-al-oeste":242,"algun-zumbador-en-la-mochila":244,"ningun-zumbador-en-la-mochila":246,verdadero:248,falso:250,"zumbadores-del-piso":252,"zumbadores-en-la-mochila":254,"fila-actual":256,"columna-actual":258,sucede:264,precede:266,mientras:270,hacer:272,repetir:274,veces:276,si:278,entonces:280,sino:282,"si-no":284,inicio:286,fin:292,continua:294,"continúa":296,rompe:298,regresa:300,"sal-de-instruccion":302,"define-prototipo-instruccion":304,"define-prototipo-calculo":306,"define-prototipo-condicion":308,"define-prototipo-instrucción":310,"define-prototipo-cálculo":312,"define-prototipo-condición":314,"inicia-ejecucion":316,"inicia-ejecución":318,"termina-ejecucion":320,"termina-ejecución":322,"finalizar-programa":324},parser=LRParser.deserialize({version:14,states:"3bO]QPOOPeOPOOOOQO'#Cd'#CdOmQPO'#CcOOQO'#Dh'#DhOxQPO'#CbOOQO'#Cg'#CgO!QQPOOO`QPOOP#ROQO'#C]P#aOSO'#C_POOO)C?b)C?bOOQO'#Cf'#CfO#oQPO,58}OOQO-E7f-E7fOOQO'#Ci'#CiO#tQPO'#ChOOQO'#Da'#DaO#yQPO'#D`OOQO'#Di'#DiO!QQPOOOOQO'#Dc'#DcO$OQPO'#DbO%YQPOOPOOO'#Df'#DfP%_OQO,58wPOOO,58w,58wPOOO'#Dg'#DgP%mOSO,58yPOOO,58y,58yO%{QPO1G.iO&WQPO,59SO&`QPO,59zOOQO-E7g-E7gOOQO'#Ck'#CkO&hQPO'#EVOOQO'#EV'#EVOOQO'#C|'#C|O(OQPO'#C{OOQO'#DQ'#DQO(OQPO'#DPOOQO'#DT'#DTO(OQPO'#DSOOQO'#Fc'#FcOOQO'#Fb'#FbO*UQPO,59|O*aQPO'#DWOOQO'#DZ'#DZOOQO'#D['#D[OOQO'#D^'#D^O+hQPO'#D]OOQO'#EU'#EUOOQO'#DX'#DXOOQO'#De'#DeQOQPOOPOOO-E7d-E7dPOOO1G.c1G.cPOOO-E7e-E7ePOOO1G.e1G.eO,}QPO7+$TOOQO'#Cj'#CjO-SQPO1G.nO.TQPO1G.nOOQO1G/f1G/fO.TQPO1G/fO(OQPO,5:wOOQO'#Cs'#CsOOQO'#Cu'#CuO.YQPO'#CtOOQO'#Cv'#CvOOQO'#Cw'#CwOOQO'#Cy'#CyOOQO'#Cz'#CzO._QPO'#FTOOQO'#FS'#FSOOQO'#Eg'#EgO.dQPO'#EgO1XQPO'#C}O(OQPO'#E_O(OQPO'#E_OOQO'#E_'#E_O1cQPO,59gO1hQPO'#CmO1uQPO,59kO1zQPO,59nO2PQPO,5;|OOQO'#Dd'#DdOOQO1G/h1G/hO2WQPO,59rO2`QPO,59wOOQO<<Go<<GoOOQO7+$Y7+$YO3uQPO7+$YOOQO'#D_'#D_O3}QPO7+%QO4VQPO'#ClO4_QPO1G0cO(OQPO,59`O(OQPO,5;oOOQO'#Cn'#CnOOQO'#Co'#CoOOQO'#E`'#E`O(OQPO,5:yO4dQPO,5:yO6YQPO,5:yOOQO'#DO'#DOO-SQPO1G/ROOQO'#DR'#DRO-SQPO1G/VOOQO'#DU'#DUO-SQPO1G/YOOQO1G1h1G1hOOQO1G/^1G/^OOQO'#DY'#DYO6aQPO,59yO6fQPO<<GtO6kQPO<<HlO(OQPO'#DjO6pQPO,59WOOQO7+%}7+%}O6xQPO1G.zO6}QPO1G1ZOOQO1G0e1G0eOOQO7+$m7+$mOOQO7+$q7+$qO7VQPO7+$tOOQO1G/e1G/eO-SQPOAN=`OOQOAN>WAN>WOOQO,5:U,5:UOOQO-E7h-E7hOOQO7+$f7+$fOOQO7+&u7+&uO8jQPO7+&uOOQO'#DV'#DVO-SQPO<<H`O8oQPOG22zO8tQPO<<JaOOQOAN=zAN=zOOQOLD(fLD(fOOQOAN?{AN?{",stateData:"8y~O!aOS!bPQ!fPQ~O!jQO!oUO~O!bXO!fYO~OX]O!k[O!l[O~O!jQO!oUX~O!p_O!q_O!r_O!s_O!t_O!u_O!v_O$^aO$_aO$`aO$aaO$baO$caO$deO$eeO~OQhO!chO!dhO!ejO~OSkO!gkO!hkO!imO~O!mnO~OXoO~OXpO~OXsO!zrO!{rO!|rO!}rO#OrO#{uO#}wO$PyO$T!UO$X!PO$Y!PO$Z!QO$[!RO$]!RO!n$VP$f$VP$g$VP~O$h!VO~OQhO!chO!dhO!e!YO~OSkO!gkO!hkO!i![O~OX!]O!k[O!l[O~O!w!^O#Q!`O~O!n!aO#Q!bO~O#Q!cO!n!yX$f!yX$g!yX$W!yX!p!yX!q!yX!r!yX!s!yX!t!yX!u!yX!v!yX$^!yX$_!yX$`!yX$a!yX$b!yX$c!yX$d!yX$e!yX$R!yX$S!yX~OX!nOl!lO#Q!qO#X!dO#[!eO#]!eO#^!gO#_!gO#`!gO#a!gO#b!gO#c!gO#d!gO#e!gO#f!gO#g!gO#h!gO#i!gO#j!gO#k!gO#l!gO#m!gO#n!gO#o!gO#p!hO#q!hO#r!hO#s!hO#t!hO#u!hO#x!iO#y!jO~O!n!wO$f!xO$g!xO~OXsO!zrO!{rO!|rO!}rO#OrO#{uO#}wO$PyO$T!UO$X!PO$Y!PO$Z!QO$[!RO$]!RO!n$VP$W$VP~O!n!PX$f!PX$g!PX$W!PX!p!PX!q!PX!r!PX!s!PX!t!PX!u!PX!v!PX$^!PX$_!PX$`!PX$a!PX$b!PX$c!PX$d!PX$e!PX$R!PX$S!PX~P(OO!n!|O~OXsO!zrO!{rO!|rO!}rO#OrO#{uO#}wO$PyO$T!UO$X!PO$Y!PO$Z!QO$[!RO$]!RO~OX#PO~O#Q#TO~O#Q#UO~O#Q!cOd#ZXe#ZXf#ZX#T#ZX#U#ZX#V#ZX#W#ZX#|#ZX$O#ZX$Q#ZX!n#ZX$f#ZX$g#ZX#Y#ZX#z#ZX$W#ZX!p#ZX!q#ZX!r#ZX!s#ZX!t#ZX!u#ZX!v#ZX$^#ZX$_#ZX$`#ZX$a#ZX$b#ZX$c#ZX$d#ZX$e#ZX$R#ZX$S#ZX~Od#XOe#XOf#XO#T#VO#U#VO#V#WO#W#WO~O#|qX$QqX~P0pO#|#]O~O$OaX#YaX#zaX~P0pO$O#_O~O$Q#aO~O$W$VP~P$OO!n!wO$W#eO~O!n!Pa$f!Pa$g!Pa$W!Pa!p!Pa!q!Pa!r!Pa!s!Pa!t!Pa!u!Pa!v!Pa$^!Pa$_!Pa$`!Pa$a!Pa$b!Pa$c!Pa$d!Pa$e!Pa$R!Pa$S!Pa~P0pO#Y#gO#z#fO~O#Y#hO#z#fO~O#z#iO#Y`X~O#Y#kO~O#|#Ra$O#Ra$Q#Ra!n#Ra$f#Ra$g#Ra#Y#Ra#z#Ra$W#Ra!p#Ra!q#Ra!r#Ra!s#Ra!t#Ra!u#Ra!v#Ra$^#Ra$_#Ra$`#Ra$a#Ra$b#Ra$c#Ra$d#Ra$e#Ra$R#Ra$S#Ra~P0pO#Y#nO~P0pOX#rO~O!w!^O~O!n#tO~O#z#iO#Y`a~O#Y#wO~O#Y#xO#z#yO~O$R#zO$S#zO!nvq$fvq$gvq$Wvq!pvq!qvq!rvq!svq!tvq!uvq!vvq$^vq$_vq$`vq$avq$bvq$cvq$dvq$evq~Ol#}O~O!n$PO~O#Y$QO~O",goto:",h$WP$XP$XPP$[$_$cP$g$m$q$u$y%P%[%_%n%nPPP%u&S&a&S&SP&n&n&{'W'c'i&{'l'w&{'z(V(Y&{(](h&{&{&{(k(v$q(|)Q)U)Y)])`)f)l)r)xPPPPPPPPPPPPPPPPPPPPPPPPP*O&{PPPPP*gP+P+hPPPPPP+oPPPPPPPPPPPPPPPPPPPPPPPPPP&S+|PPPPPPPPPPPP,Z,aRZPRWOTSOTTROTQ]RR!]nTVOWTcVdT`VdQ!_oR#s#gctf!O!_!w#^#`#b#s#{R#S!cQ!uxQ#R!cQ#l#TQ#m#UR#u#iZ#X!o!t!{#Z#[g!pvxz!S!c!p!q#T#U#Y#ig!mvxz!S!c!p!q#T#U#Y#ig!fvxz!S!c!p!q#T#U#Y#ig!kvxz!S!c!p!q#T#U#Y#ic!Tf!O!_!w#^#`#b#s#{cvf!O!_!w#^#`#b#s#{Q!svR!vzR#^!scxf!O!_!w#^#`#b#s#{R#`!uczf!O!_!w#^#`#b#s#{R#b!vR#{#qc!Of!O!_!w#^#`#b#s#{R#d!zc!Sf!O!_!w#^#`#b#s#{Q#O!`R#Q!bTbVdTgVdTfVdR!y}R!WgQiXR!XiQlYR!ZlQTOR^TQdVRqdQ#j#RR#v#jU{f!O!wQ!}!_Q#o#^Q#p#`Q#q#bQ#|#sR$O#{btf!O!_!w#^#`#b#s#{g!mvxz!S!c!p!q#T#U#Y#iS!ovzY!tx!c#T#U#iQ!{!SQ#Z!pQ#[!qR#n#YZ#Y!o!t!{#Z#[g!rvxz!S!c!p!q#T#U#Y#ig!lvxz!S!c!p!q#T#U#Y#iQ}fR!z!OS|f!OR#c!w",nodeNames:"⚠ BlockComment Annotation BlockComment2 Annotation2 Script ImportList ImportStatement Import Identifier Modules StartProgram Function DefineType As BuiltIn CallParams NumericTerm Or And LTE LT COMP Not IFZ Ifzero BoolFunc Globals Number Succ Pred WhileStatement While BooleanTerm Do IterateStatement Iterate Times IfStatement If Then Else Block Begin End Continue Break ReturnStatement Return FunctionParams Prototype PrototipoType Execution StartExecution EndExecution EndProgram",maxTerm:162,nodeProps:[["closedBy",43,"End"],["openedBy",44,"Begin"]],skippedNodes:[0,1,2,3,4,56,57],repeatNodeCount:5,tokenData:"%l~RiX^!ppq!pxy#eyz#r|}#w!O!P#|!Q![$R!]!^$Z!^!_$`!_!`$m!c!}$x#R#S$x#T#o$x#o#p%g#y#z!p$f$g!p%W%o$x%p&a$x&b&j$x#BY#BZ!p$IS$I_!p$I|$JO!p$JT$JU!p$KV$KW!p&FU&FV!p~!uY!a~X^!ppq!p#y#z!p$f$g!p#BY#BZ!p$IS$I_!p$I|$JO!p$JT$JU!p$KV$KW!p&FU&FV!p~#jP#Q~z{#m~#rO!f~~#wO#Y~~#|O#z~~$RO!m~~$WPl~!Q![$R~$`O!n~~$ePe~!_!`$h~$mOd~~$pP!_!`$s~$xOf~~$}WX~}!O$x!Q![$x!c!}$x#R#S$x#T#o$x%W%o$x%p&a$x&b&j$x~%lO!b~",tokenizers:[2,new LocalTokenGroup("r~RRYZ[!b!ca#q#rl~aO!d~~fQQ~!c!}a#T#oa~qO!e~~",33,65),new LocalTokenGroup("x~RRYZ[z{a!b!cl~aO!h~~dPyzg~lO!i~~qQS~!c!}l#T#ol~",39,69)],topRules:{Script:[0,5]},specialized:[{term:9,get:value=>spec_Identifier[value]||-1}],tokenPrec:0});function toSet(chars){let flat=Object.keys(chars).join(""),words=/\w/.test(flat);return words&&(flat=flat.replace(/\w/g,"")),`[${words?"\\w":""}${flat.replace(/[^\w\s]/g,"\\$&")}]`}const defaults={brackets:["(","[","{","'",'"'],before:")]}:;>",stringPrefixes:[]},closeBracketEffect=StateEffect.define({map(value,mapping){let mapped=mapping.mapPos(value,-1,MapMode.TrackAfter);return null==mapped?void 0:mapped}}),skipBracketEffect=StateEffect.define({map:(value,mapping)=>mapping.mapPos(value)}),closedBracket=new class extends RangeValue{};closedBracket.startSide=1,closedBracket.endSide=-1;const bracketState=StateField.define({create:()=>RangeSet.empty,update(value,tr){if(tr.selection){let lineStart=tr.state.doc.lineAt(tr.selection.main.head).from,prevLineStart=tr.startState.doc.lineAt(tr.startState.selection.main.head).from;lineStart!=tr.changes.mapPos(prevLineStart,-1)&&(value=RangeSet.empty)}value=value.map(tr.changes);for(let effect of tr.effects)effect.is(closeBracketEffect)?value=value.update({add:[closedBracket.range(effect.value,effect.value+1)]}):effect.is(skipBracketEffect)&&(value=value.update({filter:from=>from!=effect.value}));return value}});function closing(ch){for(let i=0;i<8;i+=2)if("()[]{}<>".charCodeAt(i)==ch)return"()[]{}<>".charAt(i+1);return fromCodePoint(ch<128?ch:ch+1)}const android="object"==typeof navigator&&/Android\b/.test(navigator.userAgent),inputHandler=EditorView.inputHandler.of(((view,from,to,insert)=>{if((android?view.composing:view.compositionStarted)||view.state.readOnly)return!1;let sel=view.state.selection.main;if(insert.length>2||2==insert.length&&1==codePointSize(codePointAt(insert,0))||from!=sel.from||to!=sel.to)return!1;let tr=function(state,bracket){let conf=function(state,pos){return state.languageDataAt("closeBrackets",pos)[0]||defaults}(state,state.selection.main.head),tokens=conf.brackets||defaults.brackets;for(let tok of tokens){let closed=closing(codePointAt(tok,0));if(bracket==tok)return closed==tok?handleSame(state,tok,tokens.indexOf(tok+tok+tok)>-1,conf):handleOpen(state,tok,closed,conf.before||defaults.before);if(bracket==closed&&closedBracketAt(state,state.selection.main.from))return handleClose(state,tok,closed)}return null}(view.state,insert);return!!tr&&(view.dispatch(tr),!0)}));function closedBracketAt(state,pos){let found=!1;return state.field(bracketState).between(0,state.doc.length,(from=>{from==pos&&(found=!0)})),found}function nextChar(doc,pos){let next=doc.sliceString(pos,pos+2);return next.slice(0,codePointSize(codePointAt(next,0)))}function handleOpen(state,open,close,closeBefore){let dont=null,changes=state.changeByRange((range=>{if(!range.empty)return{changes:[{insert:open,from:range.from},{insert:close,from:range.to}],effects:closeBracketEffect.of(range.to+open.length),range:EditorSelection.range(range.anchor+open.length,range.head+open.length)};let next=nextChar(state.doc,range.head);return!next||/\s/.test(next)||closeBefore.indexOf(next)>-1?{changes:{insert:open+close,from:range.head},effects:closeBracketEffect.of(range.head+open.length),range:EditorSelection.cursor(range.head+open.length)}:{range:dont=range}}));return dont?null:state.update(changes,{scrollIntoView:!0,userEvent:"input.type"})}function handleClose(state,_open,close){let dont=null,moved=state.selection.ranges.map((range=>range.empty&&nextChar(state.doc,range.head)==close?EditorSelection.cursor(range.head+close.length):dont=range));return dont?null:state.update({selection:EditorSelection.create(moved,state.selection.mainIndex),scrollIntoView:!0,effects:state.selection.ranges.map((({from:from})=>skipBracketEffect.of(from)))})}function handleSame(state,token,allowTriple,config){let stringPrefixes=config.stringPrefixes||defaults.stringPrefixes,dont=null,changes=state.changeByRange((range=>{if(!range.empty)return{changes:[{insert:token,from:range.from},{insert:token,from:range.to}],effects:closeBracketEffect.of(range.to+token.length),range:EditorSelection.range(range.anchor+token.length,range.head+token.length)};let start,pos=range.head,next=nextChar(state.doc,pos);if(next==token){if(nodeStart(state,pos))return{changes:{insert:token+token,from:pos},effects:closeBracketEffect.of(pos+token.length),range:EditorSelection.cursor(pos+token.length)};if(closedBracketAt(state,pos)){let isTriple=allowTriple&&state.sliceDoc(pos,pos+3*token.length)==token+token+token;return{range:EditorSelection.cursor(pos+token.length*(isTriple?3:1)),effects:skipBracketEffect.of(pos)}}}else{if(allowTriple&&state.sliceDoc(pos-2*token.length,pos)==token+token&&(start=canStartStringAt(state,pos-2*token.length,stringPrefixes))>-1&&nodeStart(state,start))return{changes:{insert:token+token+token+token,from:pos},effects:closeBracketEffect.of(pos+token.length),range:EditorSelection.cursor(pos+token.length)};if(state.charCategorizer(pos)(next)!=CharCategory.Word&&canStartStringAt(state,pos,stringPrefixes)>-1&&!function(state,pos,quoteToken,prefixes){let node=syntaxTree(state).resolveInner(pos,-1),maxPrefix=prefixes.reduce(((m,p)=>Math.max(m,p.length)),0);for(let i=0;i<5;i++){let start=state.sliceDoc(node.from,Math.min(node.to,node.from+quoteToken.length+maxPrefix)),quotePos=start.indexOf(quoteToken);if(!quotePos||quotePos>-1&&prefixes.indexOf(start.slice(0,quotePos))>-1){let first=node.firstChild;for(;first&&first.from==node.from&&first.to-first.from>quoteToken.length+quotePos;){if(state.sliceDoc(first.to-quoteToken.length,first.to)==quoteToken)return!1;first=first.firstChild}return!0}let parent=node.to==pos&&node.parent;if(!parent)break;node=parent}return!1}(state,pos,token,stringPrefixes))return{changes:{insert:token+token,from:pos},effects:closeBracketEffect.of(pos+token.length),range:EditorSelection.cursor(pos+token.length)}}return{range:dont=range}}));return dont?null:state.update(changes,{scrollIntoView:!0,userEvent:"input.type"})}function nodeStart(state,pos){let tree=syntaxTree(state).resolveInner(pos+1);return tree.parent&&tree.from==pos}function canStartStringAt(state,pos,prefixes){let charCat=state.charCategorizer(pos);if(charCat(state.sliceDoc(pos-1,pos))!=CharCategory.Word)return pos;for(let prefix of prefixes){let start=pos-prefix.length;if(state.sliceDoc(start,pos)==prefix&&charCat(state.sliceDoc(start-1,start))!=CharCategory.Word)return start}return-1}let pascalWithContext=parser.configure({props:[styleTags({StartProgram:tags.keyword,EndProgram:tags.keyword,DefineType:tags.definitionKeyword,PrototipoType:tags.definitionKeyword,As:tags.controlKeyword,StartExecution:tags.moduleKeyword,EndExecution:tags.moduleKeyword,ProgramClass:tags.className,ProgramMain:tags.function(tags.variableName),Comment:tags.comment,obr:tags.bracket,cbr:tags.bracket,Identifier:tags.variableName,Number:tags.integer,While:tags.controlKeyword,If:tags.controlKeyword,Else:tags.controlKeyword,Iterate:tags.controlKeyword,Then:tags.controlKeyword,Do:tags.controlKeyword,Times:tags.controlKeyword,Begin:tags.brace,End:tags.brace,BoolFunc:tags.atom,Ifzero:tags.atom,And:tags.operator,Not:tags.operator,Or:tags.operator,LT:tags.operator,LTE:tags.operator,COMP:tags.operator,BlockComment:tags.blockComment,BlockComment2:tags.blockComment,BuiltIn:tags.function(tags.variableName),Succ:tags.operator,Pred:tags.operator,Continue:tags.controlKeyword,Break:tags.controlKeyword,Return:tags.controlKeyword,Import:tags.keyword,Globals:tags.constant(tags.variableName),Modules:tags.constant(tags.variableName),Annotation:tags.constant(tags.variableName),Annotation2:tags.constant(tags.variableName)}),indentNodeProp.add({Function:continuedIndent({except:/^\s*(inicio\b)/}),WhileStatement:continuedIndent({except:/^\s*(inicio\b)/}),IterateStatement:continuedIndent({except:/^\s*(inicio\b)/}),IfStatement:continuedIndent({except:/^\s*(inicio|sino|si\-no)\b/}),Block:context=>{let after=context.textAfter,closed=/^\s*fin\b/.test(after);return context.baseIndent+(closed?0:context.unit)},Script:context=>/^\s*(iniciar\-programa|finalizar\-programa)\b/.test(context.textAfter)?0:context.unit,Execution:delimitedIndent({closing:"termina-ejecucion"})}),foldNodeProp.add({Block:foldInside,Execution:foldInside})]});const pascalLanguage=LRLanguage.define({parser:pascalWithContext,languageData:{commentTokens:{block:{open:"{",close:"}"}},indentOnInput:/^\s*(inicio|fin|sino|si\-no)\b$/}}),pascalCompletion=pascalLanguage.data.of({autocomplete:function(list){let options=list.map((o=>"string"==typeof o?{label:o}:o)),[validFor,match]=options.every((o=>/^\w+$/.test(o.label)))?[/\w*$/,/\w+$/]:function(options){let first=Object.create(null),rest=Object.create(null);for(let{label:label}of options){first[label[0]]=!0;for(let i=1;i<label.length;i++)rest[label[i]]=!0}let source=toSet(first)+toSet(rest)+"*$";return[new RegExp("^"+source),new RegExp(source)]}(options);return context=>{let token=context.matchBefore(match);return token||context.explicit?{from:token?token.from:context.pos,options:options,validFor:validFor}:null}}([{label:"define-nuevo-prototipo",type:"keyword"},{label:"define-nueva-instruccion",type:"keyword"},{label:"salir-de-instruccion",type:"keyword"},{label:"si",type:"keyword"},{label:"entonces",type:"keyword"},{label:"sino",type:"keyword"},{label:"si-no",type:"keyword"},{label:"repetir",type:"keyword"},{label:"veces",type:"keyword"},{label:"mientras",type:"keyword"},{label:"hacer",type:"keyword"},{label:"sucede",type:"function"},{label:"precede",type:"function"},{label:"avanza",type:"function"},{label:"gira-izquierda",type:"function"},{label:"apagate",type:"function"},{label:"deja-zumbador",type:"function"},{label:"inicio",type:"keyword"},{label:"fin",type:"keyword"}])});function kpascal(){return new LanguageSupport(pascalLanguage,[pascalCompletion])}const classicHighlight={color:"var(--bs-body-color)",backgroundColor:"rgba(var(--bs-body-bg-rgb), var(--bs-bg-opacity))",gutterBackgroundColor:"var(--bs-secondary-bg)",gutterColor:"var(--bs-emphasis-color)",extensions:syntaxHighlighting(HighlightStyle.define([{tag:tags.atom,color:"rgb(6, 150, 14)"},{tag:tags.keyword,color:"rgb(147, 15, 128)"},{tag:tags.className,color:"rgb(147, 15, 128)"},{tag:tags.brace,color:"rgb(60, 76, 114)"},{tag:tags.number,color:"rgb(0, 0, 205)"},{tag:tags.operator,color:"rgb(104, 118, 135)"},{tag:tags.operator,color:"rgb(104, 118, 135)"},{tag:tags.blockComment,color:"rgb(104, 118, 135)",fontStyle:"italic"},{tag:tags.comment,color:"rgb(104, 118, 135)",fontStyle:"italic"},{tag:tags.function(tags.variableName),color:"rgb(49, 132, 149)"},{tag:tags.constant(tags.variableName),color:"#060bbd"}]))};let highlightedLine=new Compartment;const karelLineTheme=EditorView.baseTheme({".cm-karelLine.cm-activeLine":{backgroundColor:"rgba(255, 255, 0, 0.5)"},".cm-karelLine":{backgroundColor:"#22872a44"}}),karelLineFacet=Facet.define({combine:values=>values.length?Math.min(...values):-1}),lineHighlight=Decoration.line({attributes:{class:"cm-karelLine"}});function lineHighlightDeco(view){let pos=view.state.facet(karelLineFacet),builder=new RangeSetBuilder;if(-1!==pos){let line=view.state.doc.line(pos);builder.add(line.from,line.from,lineHighlight)}return builder.finish()}const lineHighlighting=ViewPlugin.fromClass(class{constructor(view){this.decorations=lineHighlightDeco(view)}update(update){update.startState.facet(karelLineFacet)!=update.state.facet(karelLineFacet)&&(this.decorations=lineHighlightDeco(update.view))}},{decorations:v=>v.decorations});let executionCursor=new Compartment;const karelColumnFacet=Facet.define({combine:values=>values.length?Math.min(...values):-1});class CursorWidget extends WidgetType{constructor(){super()}eq(other){return!0}toDOM(){let wrap=document.createElement("small");wrap.setAttribute("aria-hidden","true"),wrap.className="cm-execution-cursor";let icon=wrap.appendChild(document.createElement("i"));return icon.classList.add("bi"),icon.classList.add("bi-caret-right-fill"),wrap}ignoreEvent(){return!0}}const columnCursorPlugin=ViewPlugin.fromClass(class{constructor(view){this.decorations=Decoration.none}update(update){update.startState.facet(karelColumnFacet)===update.state.facet(karelColumnFacet)&&update.startState.facet(karelLineFacet)===update.state.facet(karelLineFacet)||(this.decorations=function(view){let line=view.state.facet(karelLineFacet),column=view.state.facet(karelColumnFacet);if(-1===column||-1===line)return Decoration.none;const deco=Decoration.widget({widget:new CursorWidget,side:-1});return Decoration.set([deco.range(view.state.doc.line(line).from+column)])}(update.view))}},{decorations:v=>v.decorations});function HighlightKarelInstruction(editor,line,column){editor.dispatch({effects:[highlightedLine.reconfigure(karelLineFacet.of(line)),executionCursor.reconfigure(karelColumnFacet.of(column))]})}const breakpointEffect=StateEffect.define({map:(val,mapping)=>({pos:mapping.mapPos(val.pos),on:val.on})}),breakpointMarker=new class extends GutterMarker{toDOM(){return document.createTextNode("🔴")}},breakpointState=StateField.define({create:()=>RangeSet.empty,update(set,transaction){set=set.map(transaction.changes);for(let e of transaction.effects)e.is(breakpointEffect)&&(set=e.value.on?set.update({add:[breakpointMarker.range(e.value.pos)]}):set.update({filter:from=>from!=e.value.pos}));return set}});const breakpointGutter=[breakpointState,gutter({class:"cm-breakpoint-gutter",markers:v=>v.state.field(breakpointState),initialSpacer:()=>breakpointMarker,domEventHandlers:{mousedown:(view,line)=>(function(view,pos){let breakpoints=view.state.field(breakpointState),hasBreakpoint=!1;breakpoints.between(pos,pos,(()=>{hasBreakpoint=!0})),view.dispatch({effects:breakpointEffect.of({pos:pos,on:!hasBreakpoint})})}(view,line.from),!0)}}),EditorView.baseTheme({".cm-breakpoint-gutter .cm-gutterElement":{color:"red",paddingLeft:"2px",cursor:"default",fontSize:"var(--editor-font-size)"}})];function crelt(){var elt=arguments[0];"string"==typeof elt&&(elt=document.createElement(elt));var i=1,next=arguments[1];if(next&&"object"==typeof next&&null==next.nodeType&&!Array.isArray(next)){for(var name in next)if(Object.prototype.hasOwnProperty.call(next,name)){var value=next[name];"string"==typeof value?elt.setAttribute(name,value):null!=value&&(elt[name]=value)}i++}for(;i<arguments.length;i++)add(elt,arguments[i]);return elt}function add(elt,child){if("string"==typeof child)elt.appendChild(document.createTextNode(child));else if(null==child);else if(null!=child.nodeType)elt.appendChild(child);else{if(!Array.isArray(child))throw new RangeError("Unsupported child node: "+child);for(var i=0;i<child.length;i++)add(elt,child[i])}}const basicNormalize="function"==typeof String.prototype.normalize?x=>x.normalize("NFKD"):x=>x;class SearchCursor{constructor(text,query,from=0,to=text.length,normalize,test){this.test=test,this.value={from:0,to:0},this.done=!1,this.matches=[],this.buffer="",this.bufferPos=0,this.iter=text.iterRange(from,to),this.bufferStart=from,this.normalize=normalize?x=>normalize(basicNormalize(x)):basicNormalize,this.query=this.normalize(query)}peek(){if(this.bufferPos==this.buffer.length){if(this.bufferStart+=this.buffer.length,this.iter.next(),this.iter.done)return-1;this.bufferPos=0,this.buffer=this.iter.value}return codePointAt(this.buffer,this.bufferPos)}next(){for(;this.matches.length;)this.matches.pop();return this.nextOverlapping()}nextOverlapping(){for(;;){let next=this.peek();if(next<0)return this.done=!0,this;let str=fromCodePoint(next),start=this.bufferStart+this.bufferPos;this.bufferPos+=codePointSize(next);let norm=this.normalize(str);for(let i=0,pos=start;;i++){let code=norm.charCodeAt(i),match=this.match(code,pos);if(match)return this.value=match,this;if(i==norm.length-1)break;pos==start&&i<str.length&&str.charCodeAt(i)==code&&pos++}}}match(code,pos){let match=null;for(let i=0;i<this.matches.length;i+=2){let index=this.matches[i],keep=!1;this.query.charCodeAt(index)==code&&(index==this.query.length-1?match={from:this.matches[i+1],to:pos+1}:(this.matches[i]++,keep=!0)),keep||(this.matches.splice(i,2),i-=2)}return this.query.charCodeAt(0)==code&&(1==this.query.length?match={from:pos,to:pos+1}:this.matches.push(1,pos)),match&&this.test&&!this.test(match.from,match.to,this.buffer,this.bufferPos)&&(match=null),match}}"undefined"!=typeof Symbol&&(SearchCursor.prototype[Symbol.iterator]=function(){return this});const empty={from:-1,to:-1,match:/.*/.exec("")},baseFlags="gm"+(null==/x/.unicode?"":"u");class RegExpCursor{constructor(text,query,options,from=0,to=text.length){if(this.text=text,this.to=to,this.curLine="",this.done=!1,this.value=empty,/\\[sWDnr]|\n|\r|\[\^/.test(query))return new MultilineRegExpCursor(text,query,options,from,to);this.re=new RegExp(query,baseFlags+((null==options?void 0:options.ignoreCase)?"i":"")),this.test=null==options?void 0:options.test,this.iter=text.iter();let startLine=text.lineAt(from);this.curLineStart=startLine.from,this.matchPos=toCharEnd(text,from),this.getLine(this.curLineStart)}getLine(skip){this.iter.next(skip),this.iter.lineBreak?this.curLine="":(this.curLine=this.iter.value,this.curLineStart+this.curLine.length>this.to&&(this.curLine=this.curLine.slice(0,this.to-this.curLineStart)),this.iter.next())}nextLine(){this.curLineStart=this.curLineStart+this.curLine.length+1,this.curLineStart>this.to?this.curLine="":this.getLine(0)}next(){for(let off=this.matchPos-this.curLineStart;;){this.re.lastIndex=off;let match=this.matchPos<=this.to&&this.re.exec(this.curLine);if(match){let from=this.curLineStart+match.index,to=from+match[0].length;if(this.matchPos=toCharEnd(this.text,to+(from==to?1:0)),from==this.curLineStart+this.curLine.length&&this.nextLine(),(from<to||from>this.value.to)&&(!this.test||this.test(from,to,match)))return this.value={from:from,to:to,match:match},this;off=this.matchPos-this.curLineStart}else{if(!(this.curLineStart+this.curLine.length<this.to))return this.done=!0,this;this.nextLine(),off=0}}}}const flattened=new WeakMap;class FlattenedDoc{constructor(from,text){this.from=from,this.text=text}get to(){return this.from+this.text.length}static get(doc,from,to){let cached=flattened.get(doc);if(!cached||cached.from>=to||cached.to<=from){let flat=new FlattenedDoc(from,doc.sliceString(from,to));return flattened.set(doc,flat),flat}if(cached.from==from&&cached.to==to)return cached;let{text:text,from:cachedFrom}=cached;return cachedFrom>from&&(text=doc.sliceString(from,cachedFrom)+text,cachedFrom=from),cached.to<to&&(text+=doc.sliceString(cached.to,to)),flattened.set(doc,new FlattenedDoc(cachedFrom,text)),new FlattenedDoc(from,text.slice(from-cachedFrom,to-cachedFrom))}}class MultilineRegExpCursor{constructor(text,query,options,from,to){this.text=text,this.to=to,this.done=!1,this.value=empty,this.matchPos=toCharEnd(text,from),this.re=new RegExp(query,baseFlags+((null==options?void 0:options.ignoreCase)?"i":"")),this.test=null==options?void 0:options.test,this.flat=FlattenedDoc.get(text,from,this.chunkEnd(from+5e3))}chunkEnd(pos){return pos>=this.to?this.to:this.text.lineAt(pos).to}next(){for(;;){let off=this.re.lastIndex=this.matchPos-this.flat.from,match=this.re.exec(this.flat.text);if(match&&!match[0]&&match.index==off&&(this.re.lastIndex=off+1,match=this.re.exec(this.flat.text)),match){let from=this.flat.from+match.index,to=from+match[0].length;if((this.flat.to>=this.to||match.index+match[0].length<=this.flat.text.length-10)&&(!this.test||this.test(from,to,match)))return this.value={from:from,to:to,match:match},this.matchPos=toCharEnd(this.text,to+(from==to?1:0)),this}if(this.flat.to==this.to)return this.done=!0,this;this.flat=FlattenedDoc.get(this.text,this.flat.from,this.chunkEnd(this.flat.from+2*this.flat.text.length))}}}function toCharEnd(text,pos){if(pos>=text.length)return pos;let next,line=text.lineAt(pos);for(;pos<line.to&&(next=line.text.charCodeAt(pos-line.from))>=56320&&next<57344;)pos++;return pos}function createLineDialog(view){let input=crelt("input",{class:"cm-textfield",name:"line"});function go(){let match=/^([+-])?(\d+)?(:\d+)?(%)?$/.exec(input.value);if(!match)return;let{state:state}=view,startLine=state.doc.lineAt(state.selection.main.head),[,sign,ln,cl,percent]=match,col=cl?+cl.slice(1):0,line=ln?+ln:startLine.number;if(ln&&percent){let pc=line/100;sign&&(pc=pc*("-"==sign?-1:1)+startLine.number/state.doc.lines),line=Math.round(state.doc.lines*pc)}else ln&&sign&&(line=line*("-"==sign?-1:1)+startLine.number);let docLine=state.doc.line(Math.max(1,Math.min(state.doc.lines,line)));view.dispatch({effects:dialogEffect.of(!1),selection:EditorSelection.cursor(docLine.from+Math.max(0,Math.min(col,docLine.length))),scrollIntoView:!0}),view.focus()}return{dom:crelt("form",{class:"cm-gotoLine",onkeydown:event=>{27==event.keyCode?(event.preventDefault(),view.dispatch({effects:dialogEffect.of(!1)}),view.focus()):13==event.keyCode&&(event.preventDefault(),go())},onsubmit:event=>{event.preventDefault(),go()}},crelt("label",view.state.phrase("Go to line"),": ",input)," ",crelt("button",{class:"cm-button",type:"submit"},view.state.phrase("go")))}}"undefined"!=typeof Symbol&&(RegExpCursor.prototype[Symbol.iterator]=MultilineRegExpCursor.prototype[Symbol.iterator]=function(){return this});const dialogEffect=StateEffect.define(),dialogField=StateField.define({create:()=>!0,update(value,tr){for(let e of tr.effects)e.is(dialogEffect)&&(value=e.value);return value},provide:f=>showPanel.from(f,(val=>val?createLineDialog:null))}),baseTheme$1=EditorView.baseTheme({".cm-panel.cm-gotoLine":{padding:"2px 6px 4px","& label":{fontSize:"80%"}}}),defaultHighlightOptions={highlightWordAroundCursor:!1,minSelectionLength:1,maxMatches:100,wholeWords:!1},highlightConfig=Facet.define({combine:options=>combineConfig(options,defaultHighlightOptions,{highlightWordAroundCursor:(a,b)=>a||b,minSelectionLength:Math.min,maxMatches:Math.min})});function highlightSelectionMatches(options){let ext=[defaultTheme,matchHighlighter];return options&&ext.push(highlightConfig.of(options)),ext}const matchDeco=Decoration.mark({class:"cm-selectionMatch"}),mainMatchDeco=Decoration.mark({class:"cm-selectionMatch cm-selectionMatch-main"});function insideWordBoundaries(check,state,from,to){return!(0!=from&&check(state.sliceDoc(from-1,from))==CharCategory.Word||to!=state.doc.length&&check(state.sliceDoc(to,to+1))==CharCategory.Word)}const matchHighlighter=ViewPlugin.fromClass(class{constructor(view){this.decorations=this.getDeco(view)}update(update){(update.selectionSet||update.docChanged||update.viewportChanged)&&(this.decorations=this.getDeco(update.view))}getDeco(view){let conf=view.state.facet(highlightConfig),{state:state}=view,sel=state.selection;if(sel.ranges.length>1)return Decoration.none;let query,range=sel.main,check=null;if(range.empty){if(!conf.highlightWordAroundCursor)return Decoration.none;let word=state.wordAt(range.head);if(!word)return Decoration.none;check=state.charCategorizer(range.head),query=state.sliceDoc(word.from,word.to)}else{let len=range.to-range.from;if(len<conf.minSelectionLength||len>200)return Decoration.none;if(conf.wholeWords){if(query=state.sliceDoc(range.from,range.to),check=state.charCategorizer(range.head),!insideWordBoundaries(check,state,range.from,range.to)||!function(check,state,from,to){return check(state.sliceDoc(from,from+1))==CharCategory.Word&&check(state.sliceDoc(to-1,to))==CharCategory.Word}(check,state,range.from,range.to))return Decoration.none}else if(query=state.sliceDoc(range.from,range.to).trim(),!query)return Decoration.none}let deco=[];for(let part of view.visibleRanges){let cursor=new SearchCursor(state.doc,query,part.from,part.to);for(;!cursor.next().done;){let{from:from,to:to}=cursor.value;if((!check||insideWordBoundaries(check,state,from,to))&&(range.empty&&from<=range.from&&to>=range.to?deco.push(mainMatchDeco.range(from,to)):(from>=range.to||to<=range.from)&&deco.push(matchDeco.range(from,to)),deco.length>conf.maxMatches))return Decoration.none}}return Decoration.set(deco)}},{decorations:v=>v.decorations}),defaultTheme=EditorView.baseTheme({".cm-selectionMatch":{backgroundColor:"#99ff7780"},".cm-searchMatch .cm-selectionMatch":{backgroundColor:"transparent"}});const searchConfigFacet=Facet.define({combine:configs=>combineConfig(configs,{top:!1,caseSensitive:!1,literal:!1,wholeWord:!1,createPanel:view=>new SearchPanel(view)})});class SearchQuery{constructor(config){this.search=config.search,this.caseSensitive=!!config.caseSensitive,this.literal=!!config.literal,this.regexp=!!config.regexp,this.replace=config.replace||"",this.valid=!!this.search&&(!this.regexp||function(source){try{return new RegExp(source,baseFlags),!0}catch(_a){return!1}}(this.search)),this.unquoted=this.unquote(this.search),this.wholeWord=!!config.wholeWord}unquote(text){return this.literal?text:text.replace(/\\([nrt\\])/g,((_,ch)=>"n"==ch?"\n":"r"==ch?"\r":"t"==ch?"\t":"\\"))}eq(other){return this.search==other.search&&this.replace==other.replace&&this.caseSensitive==other.caseSensitive&&this.regexp==other.regexp&&this.wholeWord==other.wholeWord}create(){return this.regexp?new RegExpQuery(this):new StringQuery(this)}getCursor(state,from=0,to){let st=state.doc?state:EditorState.create({doc:state});return null==to&&(to=st.doc.length),this.regexp?regexpCursor(this,st,from,to):stringCursor(this,st,from,to)}}class QueryType{constructor(spec){this.spec=spec}}function stringCursor(spec,state,from,to){return new SearchCursor(state.doc,spec.unquoted,from,to,spec.caseSensitive?void 0:x=>x.toLowerCase(),spec.wholeWord?function(doc,categorizer){return(from,to,buf,bufPos)=>((bufPos>from||bufPos+buf.length<to)&&(bufPos=Math.max(0,from-2),buf=doc.sliceString(bufPos,Math.min(doc.length,to+2))),!(categorizer(charBefore(buf,from-bufPos))==CharCategory.Word&&categorizer(charAfter(buf,from-bufPos))==CharCategory.Word||categorizer(charAfter(buf,to-bufPos))==CharCategory.Word&&categorizer(charBefore(buf,to-bufPos))==CharCategory.Word))}(state.doc,state.charCategorizer(state.selection.main.head)):void 0)}class StringQuery extends QueryType{constructor(spec){super(spec)}nextMatch(state,curFrom,curTo){let cursor=stringCursor(this.spec,state,curTo,state.doc.length).nextOverlapping();return cursor.done&&(cursor=stringCursor(this.spec,state,0,curFrom).nextOverlapping()),cursor.done?null:cursor.value}prevMatchInRange(state,from,to){for(let pos=to;;){let start=Math.max(from,pos-1e4-this.spec.unquoted.length),cursor=stringCursor(this.spec,state,start,pos),range=null;for(;!cursor.nextOverlapping().done;)range=cursor.value;if(range)return range;if(start==from)return null;pos-=1e4}}prevMatch(state,curFrom,curTo){return this.prevMatchInRange(state,0,curFrom)||this.prevMatchInRange(state,curTo,state.doc.length)}getReplacement(_result){return this.spec.unquote(this.spec.replace)}matchAll(state,limit){let cursor=stringCursor(this.spec,state,0,state.doc.length),ranges=[];for(;!cursor.next().done;){if(ranges.length>=limit)return null;ranges.push(cursor.value)}return ranges}highlight(state,from,to,add){let cursor=stringCursor(this.spec,state,Math.max(0,from-this.spec.unquoted.length),Math.min(to+this.spec.unquoted.length,state.doc.length));for(;!cursor.next().done;)add(cursor.value.from,cursor.value.to)}}function regexpCursor(spec,state,from,to){return new RegExpCursor(state.doc,spec.search,{ignoreCase:!spec.caseSensitive,test:spec.wholeWord?(categorizer=state.charCategorizer(state.selection.main.head),(_from,_to,match)=>!match[0].length||(categorizer(charBefore(match.input,match.index))!=CharCategory.Word||categorizer(charAfter(match.input,match.index))!=CharCategory.Word)&&(categorizer(charAfter(match.input,match.index+match[0].length))!=CharCategory.Word||categorizer(charBefore(match.input,match.index+match[0].length))!=CharCategory.Word)):void 0},from,to);var categorizer}function charBefore(str,index){return str.slice(findClusterBreak(str,index,!1),index)}function charAfter(str,index){return str.slice(index,findClusterBreak(str,index))}class RegExpQuery extends QueryType{nextMatch(state,curFrom,curTo){let cursor=regexpCursor(this.spec,state,curTo,state.doc.length).next();return cursor.done&&(cursor=regexpCursor(this.spec,state,0,curFrom).next()),cursor.done?null:cursor.value}prevMatchInRange(state,from,to){for(let size=1;;size++){let start=Math.max(from,to-1e4*size),cursor=regexpCursor(this.spec,state,start,to),range=null;for(;!cursor.next().done;)range=cursor.value;if(range&&(start==from||range.from>start+10))return range;if(start==from)return null}}prevMatch(state,curFrom,curTo){return this.prevMatchInRange(state,0,curFrom)||this.prevMatchInRange(state,curTo,state.doc.length)}getReplacement(result){return this.spec.unquote(this.spec.replace.replace(/\$([$&\d+])/g,((m,i)=>"$"==i?"$":"&"==i?result.match[0]:"0"!=i&&+i<result.match.length?result.match[i]:m)))}matchAll(state,limit){let cursor=regexpCursor(this.spec,state,0,state.doc.length),ranges=[];for(;!cursor.next().done;){if(ranges.length>=limit)return null;ranges.push(cursor.value)}return ranges}highlight(state,from,to,add){let cursor=regexpCursor(this.spec,state,Math.max(0,from-250),Math.min(to+250,state.doc.length));for(;!cursor.next().done;)add(cursor.value.from,cursor.value.to)}}const setSearchQuery=StateEffect.define(),togglePanel=StateEffect.define(),searchState=StateField.define({create:state=>new SearchState(defaultQuery(state).create(),null),update(value,tr){for(let effect of tr.effects)effect.is(setSearchQuery)?value=new SearchState(effect.value.create(),value.panel):effect.is(togglePanel)&&(value=new SearchState(value.query,effect.value?createSearchPanel:null));return value},provide:f=>showPanel.from(f,(val=>val.panel))});class SearchState{constructor(query,panel){this.query=query,this.panel=panel}}const matchMark=Decoration.mark({class:"cm-searchMatch"}),selectedMatchMark=Decoration.mark({class:"cm-searchMatch cm-searchMatch-selected"}),searchHighlighter=ViewPlugin.fromClass(class{constructor(view){this.view=view,this.decorations=this.highlight(view.state.field(searchState))}update(update){let state=update.state.field(searchState);(state!=update.startState.field(searchState)||update.docChanged||update.selectionSet||update.viewportChanged)&&(this.decorations=this.highlight(state))}highlight({query:query,panel:panel}){if(!panel||!query.spec.valid)return Decoration.none;let{view:view}=this,builder=new RangeSetBuilder;for(let i=0,ranges=view.visibleRanges,l=ranges.length;i<l;i++){let{from:from,to:to}=ranges[i];for(;i<l-1&&to>ranges[i+1].from-500;)to=ranges[++i].to;query.highlight(view.state,from,to,((from,to)=>{let selected=view.state.selection.ranges.some((r=>r.from==from&&r.to==to));builder.add(from,to,selected?selectedMatchMark:matchMark)}))}return builder.finish()}},{decorations:v=>v.decorations});function searchCommand(f){return view=>{let state=view.state.field(searchState,!1);return state&&state.query.spec.valid?f(view,state):openSearchPanel(view)}}const findNext=searchCommand(((view,{query:query})=>{let{to:to}=view.state.selection.main,next=query.nextMatch(view.state,to,to);return!!next&&(view.dispatch({selection:{anchor:next.from,head:next.to},scrollIntoView:!0,effects:announceMatch(view,next),userEvent:"select.search"}),!0)})),findPrevious=searchCommand(((view,{query:query})=>{let{state:state}=view,{from:from}=state.selection.main,range=query.prevMatch(state,from,from);return!!range&&(view.dispatch({selection:{anchor:range.from,head:range.to},scrollIntoView:!0,effects:announceMatch(view,range),userEvent:"select.search"}),!0)})),selectMatches=searchCommand(((view,{query:query})=>{let ranges=query.matchAll(view.state,1e3);return!(!ranges||!ranges.length)&&(view.dispatch({selection:EditorSelection.create(ranges.map((r=>EditorSelection.range(r.from,r.to)))),userEvent:"select.search.matches"}),!0)})),replaceNext=searchCommand(((view,{query:query})=>{let{state:state}=view,{from:from,to:to}=state.selection.main;if(state.readOnly)return!1;let next=query.nextMatch(state,from,from);if(!next)return!1;let selection,replacement,changes=[],announce=[];if(next.from==from&&next.to==to&&(replacement=state.toText(query.getReplacement(next)),changes.push({from:next.from,to:next.to,insert:replacement}),next=query.nextMatch(state,next.from,next.to),announce.push(EditorView.announce.of(state.phrase("replaced match on line $",state.doc.lineAt(from).number)+"."))),next){let off=0==changes.length||changes[0].from>=next.to?0:next.to-next.from-replacement.length;selection={anchor:next.from-off,head:next.to-off},announce.push(announceMatch(view,next))}return view.dispatch({changes:changes,selection:selection,scrollIntoView:!!selection,effects:announce,userEvent:"input.replace"}),!0})),replaceAll=searchCommand(((view,{query:query})=>{if(view.state.readOnly)return!1;let changes=query.matchAll(view.state,1e9).map((match=>{let{from:from,to:to}=match;return{from:from,to:to,insert:query.getReplacement(match)}}));if(!changes.length)return!1;let announceText=view.state.phrase("replaced $ matches",changes.length)+".";return view.dispatch({changes:changes,effects:EditorView.announce.of(announceText),userEvent:"input.replace.all"}),!0}));function createSearchPanel(view){return view.state.facet(searchConfigFacet).createPanel(view)}function defaultQuery(state,fallback){var _a,_b,_c,_d;let sel=state.selection.main,selText=sel.empty||sel.to>sel.from+100?"":state.sliceDoc(sel.from,sel.to);if(fallback&&!selText)return fallback;let config=state.facet(searchConfigFacet);return new SearchQuery({search:(null!==(_a=null==fallback?void 0:fallback.literal)&&void 0!==_a?_a:config.literal)?selText:selText.replace(/\n/g,"\\n"),caseSensitive:null!==(_b=null==fallback?void 0:fallback.caseSensitive)&&void 0!==_b?_b:config.caseSensitive,literal:null!==(_c=null==fallback?void 0:fallback.literal)&&void 0!==_c?_c:config.literal,wholeWord:null!==(_d=null==fallback?void 0:fallback.wholeWord)&&void 0!==_d?_d:config.wholeWord})}const openSearchPanel=view=>{let state=view.state.field(searchState,!1);if(state&&state.panel){let panel=getPanel(view,createSearchPanel);if(!panel)return!1;let searchInput=panel.dom.querySelector("[main-field]");if(searchInput&&searchInput!=view.root.activeElement){let query=defaultQuery(view.state,state.query.spec);query.valid&&view.dispatch({effects:setSearchQuery.of(query)}),searchInput.focus(),searchInput.select()}}else view.dispatch({effects:[togglePanel.of(!0),state?setSearchQuery.of(defaultQuery(view.state,state.query.spec)):StateEffect.appendConfig.of(searchExtensions)]});return!0},closeSearchPanel=view=>{let state=view.state.field(searchState,!1);if(!state||!state.panel)return!1;let panel=getPanel(view,createSearchPanel);return panel&&panel.dom.contains(view.root.activeElement)&&view.focus(),view.dispatch({effects:togglePanel.of(!1)}),!0},searchKeymap=[{key:"Mod-f",run:openSearchPanel,scope:"editor search-panel"},{key:"F3",run:findNext,shift:findPrevious,scope:"editor search-panel",preventDefault:!0},{key:"Mod-g",run:findNext,shift:findPrevious,scope:"editor search-panel",preventDefault:!0},{key:"Escape",run:closeSearchPanel,scope:"editor search-panel"},{key:"Mod-Shift-l",run:({state:state,dispatch:dispatch})=>{let sel=state.selection;if(sel.ranges.length>1||sel.main.empty)return!1;let{from:from,to:to}=sel.main,ranges=[],main=0;for(let cur=new SearchCursor(state.doc,state.sliceDoc(from,to));!cur.next().done;){if(ranges.length>1e3)return!1;cur.value.from==from&&(main=ranges.length),ranges.push(EditorSelection.range(cur.value.from,cur.value.to))}return dispatch(state.update({selection:EditorSelection.create(ranges,main),userEvent:"select.search.matches"})),!0}},{key:"Alt-g",run:view=>{let panel=getPanel(view,createLineDialog);if(!panel){let effects=[dialogEffect.of(!0)];null==view.state.field(dialogField,!1)&&effects.push(StateEffect.appendConfig.of([dialogField,baseTheme$1])),view.dispatch({effects:effects}),panel=getPanel(view,createLineDialog)}return panel&&panel.dom.querySelector("input").focus(),!0}},{key:"Mod-d",run:({state:state,dispatch:dispatch})=>{let{ranges:ranges}=state.selection;if(ranges.some((sel=>sel.from===sel.to)))return(({state:state,dispatch:dispatch})=>{let{selection:selection}=state,newSel=EditorSelection.create(selection.ranges.map((range=>state.wordAt(range.head)||EditorSelection.cursor(range.head))),selection.mainIndex);return!newSel.eq(selection)&&(dispatch(state.update({selection:newSel})),!0)})({state:state,dispatch:dispatch});let searchedText=state.sliceDoc(ranges[0].from,ranges[0].to);if(state.selection.ranges.some((r=>state.sliceDoc(r.from,r.to)!=searchedText)))return!1;let range=function(state,query){let{main:main,ranges:ranges}=state.selection,word=state.wordAt(main.head),fullWord=word&&word.from==main.from&&word.to==main.to;for(let cycled=!1,cursor=new SearchCursor(state.doc,query,ranges[ranges.length-1].to);;){if(cursor.next(),!cursor.done){if(cycled&&ranges.some((r=>r.from==cursor.value.from)))continue;if(fullWord){let word=state.wordAt(cursor.value.from);if(!word||word.from!=cursor.value.from||word.to!=cursor.value.to)continue}return cursor.value}if(cycled)return null;cursor=new SearchCursor(state.doc,query,0,Math.max(0,ranges[ranges.length-1].from-1)),cycled=!0}}(state,searchedText);return!!range&&(dispatch(state.update({selection:state.selection.addRange(EditorSelection.range(range.from,range.to),!1),effects:EditorView.scrollIntoView(range.to)})),!0)},preventDefault:!0}];class SearchPanel{constructor(view){this.view=view;let query=this.query=view.state.field(searchState).query.spec;function button(name,onclick,content){return crelt("button",{class:"cm-button",name:name,onclick:onclick,type:"button"},content)}this.commit=this.commit.bind(this),this.searchField=crelt("input",{value:query.search,placeholder:phrase(view,"Find"),"aria-label":phrase(view,"Find"),class:"cm-textfield",name:"search",form:"","main-field":"true",onchange:this.commit,onkeyup:this.commit}),this.replaceField=crelt("input",{value:query.replace,placeholder:phrase(view,"Replace"),"aria-label":phrase(view,"Replace"),class:"cm-textfield",name:"replace",form:"",onchange:this.commit,onkeyup:this.commit}),this.caseField=crelt("input",{type:"checkbox",name:"case",form:"",checked:query.caseSensitive,onchange:this.commit}),this.reField=crelt("input",{type:"checkbox",name:"re",form:"",checked:query.regexp,onchange:this.commit}),this.wordField=crelt("input",{type:"checkbox",name:"word",form:"",checked:query.wholeWord,onchange:this.commit}),this.dom=crelt("div",{onkeydown:e=>this.keydown(e),class:"cm-search"},[this.searchField,button("next",(()=>findNext(view)),[phrase(view,"next")]),button("prev",(()=>findPrevious(view)),[phrase(view,"previous")]),button("select",(()=>selectMatches(view)),[phrase(view,"all")]),crelt("label",null,[this.caseField,phrase(view,"match case")]),crelt("label",null,[this.reField,phrase(view,"regexp")]),crelt("label",null,[this.wordField,phrase(view,"by word")]),...view.state.readOnly?[]:[crelt("br"),this.replaceField,button("replace",(()=>replaceNext(view)),[phrase(view,"replace")]),button("replaceAll",(()=>replaceAll(view)),[phrase(view,"replace all")])],crelt("button",{name:"close",onclick:()=>closeSearchPanel(view),"aria-label":phrase(view,"close"),type:"button"},["×"])])}commit(){let query=new SearchQuery({search:this.searchField.value,caseSensitive:this.caseField.checked,regexp:this.reField.checked,wholeWord:this.wordField.checked,replace:this.replaceField.value});query.eq(this.query)||(this.query=query,this.view.dispatch({effects:setSearchQuery.of(query)}))}keydown(e){var view,event,scope;view=this.view,event=e,scope="search-panel",runHandlers(getKeymap(view.state),event,view,scope)?e.preventDefault():13==e.keyCode&&e.target==this.searchField?(e.preventDefault(),(e.shiftKey?findPrevious:findNext)(this.view)):13==e.keyCode&&e.target==this.replaceField&&(e.preventDefault(),replaceNext(this.view))}update(update){for(let tr of update.transactions)for(let effect of tr.effects)effect.is(setSearchQuery)&&!effect.value.eq(this.query)&&this.setQuery(effect.value)}setQuery(query){this.query=query,this.searchField.value=query.search,this.replaceField.value=query.replace,this.caseField.checked=query.caseSensitive,this.reField.checked=query.regexp,this.wordField.checked=query.wholeWord}mount(){this.searchField.select()}get pos(){return 80}get top(){return this.view.state.facet(searchConfigFacet).top}}function phrase(view,phrase){return view.state.phrase(phrase)}const AnnounceMargin=30,Break=/[\s\.,:;?!]/;function announceMatch(view,{from:from,to:to}){let line=view.state.doc.lineAt(from),lineEnd=view.state.doc.lineAt(to).to,start=Math.max(line.from,from-AnnounceMargin),end=Math.min(lineEnd,to+AnnounceMargin),text=view.state.sliceDoc(start,end);if(start!=line.from)for(let i=0;i<AnnounceMargin;i++)if(!Break.test(text[i+1])&&Break.test(text[i])){text=text.slice(i);break}if(end!=lineEnd)for(let i=text.length-1;i>text.length-AnnounceMargin;i--)if(!Break.test(text[i-1])&&Break.test(text[i])){text=text.slice(0,i);break}return EditorView.announce.of(`${view.state.phrase("current match")}. ${text} ${view.state.phrase("on line")} ${line.number}.`)}const baseTheme=EditorView.baseTheme({".cm-panel.cm-search":{padding:"2px 6px 4px",position:"relative","& [name=close]":{position:"absolute",top:"0",right:"4px",backgroundColor:"inherit",border:"none",font:"inherit",padding:0,margin:0},"& input, & button, & label":{margin:".2em .6em .2em 0"},"& input[type=checkbox]":{marginRight:".2em"},"& label":{fontSize:"80%",whiteSpace:"pre"}},"&light .cm-searchMatch":{backgroundColor:"#ffff0054"},"&dark .cm-searchMatch":{backgroundColor:"#00ffff8a"},"&light .cm-searchMatch-selected":{backgroundColor:"#ff6a0054"},"&dark .cm-searchMatch-selected":{backgroundColor:"#ff00ff8a"}}),searchExtensions=[searchState,Prec.lowest(searchHighlighter),baseTheme];let language=new Compartment,tabSize=new Compartment,theme=new Compartment,readOnly=new Compartment;function freezeEditors(editor){editor.dispatch({effects:readOnly.reconfigure(EditorState.readOnly.of(!0))})}function setLanguage(editor,lan){"java"===lan?editor.dispatch({effects:language.reconfigure(new LanguageSupport(javaLanguage,[javaCompletion]))}):editor.dispatch({effects:language.reconfigure(kpascal())})}const onEditorTextSet=[];function SetText(editor,message){let transaction=editor.state.update({changes:{from:0,to:editor.state.doc.length,insert:message}});editor.dispatch(transaction);for(const callback of onEditorTextSet)callback()}function SetEditorTheme(extension,editor){try{editor.dispatch({effects:theme.reconfigure(extension)})}catch(_a){console.log("ERROR loading extension")}}class WorldRenderer{constructor(canvasContext,style,scale){this.canvasContext=canvasContext,this.origin={r:1,c:1},this.CellSize=28,this.margin=8,this.GutterSize=28,this.style=style,this.world=void 0,this.scale=scale,this.mode="normal",this.snapped=!0}GetOrigin(){return this.origin}GetWidth(){return this.canvasContext.canvas.width/this.scale}GetHeight(){return this.canvasContext.canvas.height/this.scale}GetRowCount(mode="ceil"){switch(mode){case"ceil":return Math.ceil((this.GetHeight()-this.GutterSize)/this.CellSize)+(this.snapped?0:1);case"floor":return Math.floor((this.GetHeight()-this.GutterSize)/this.CellSize);case"noRounding":return(this.GetHeight()-this.GutterSize)/this.CellSize}}GetColCount(mode="ceil"){switch(mode){case"ceil":return Math.ceil((this.GetWidth()-this.GutterSize)/this.CellSize)+(this.snapped?0:1);case"floor":return Math.floor((this.GetWidth()-this.GutterSize)/this.CellSize);case"noRounding":return(this.GetWidth()-this.GutterSize)/this.CellSize}}ErrorMode(){this.mode="error"}NormalMode(){this.mode="normal"}GetWorldRowCount(){return this.world.h}GetWorldColCount(){return this.world.w}DrawVerticalGutter(selection=null){this.ResetTransform();let h=this.GetHeight();this.GetWidth(),this.canvasContext.fillStyle=this.style.gutterBackgroundColor,this.canvasContext.fillRect(0,0,this.GutterSize-1,h-this.GutterSize);let rows=this.GetRowCount();this.canvasContext.strokeStyle=this.style.gridBorderColor;let r1=-1,r2=-1;if(null!=selection){r1=Math.min(selection.r,selection.r+(selection.rows-1)*selection.dr)-this.origin.r,r2=Math.max(selection.r,selection.r+(selection.rows-1)*selection.dr)-this.origin.r;let sr1=h-(this.GutterSize+r1*this.CellSize),sr2=h-(this.GutterSize+(r2+1)*this.CellSize);this.canvasContext.fillStyle=this.style.gutterSelectionBackgroundColor,this.canvasContext.fillRect(0,sr2,this.GutterSize-1,sr1-sr2)}this.TranslateOffset(!0,!1),this.canvasContext.beginPath();for(let i=0;i<rows;i++)this.canvasContext.moveTo(0,h-(this.GutterSize+(i+1)*this.CellSize)+.5),this.canvasContext.lineTo(this.GutterSize-1,h-(this.GutterSize+(i+1)*this.CellSize)+.5);this.canvasContext.stroke(),this.canvasContext.fillStyle=this.style.gutterColor,this.canvasContext.font=Math.min(this.CellSize,this.GutterSize)-this.margin+"px monospace",this.canvasContext.textAlign="center",this.canvasContext.textBaseline="middle";for(let i=0;i<rows;i++){let r=i+Math.floor(this.origin.r);this.canvasContext.fillStyle=i<r1||i>r2?this.style.gutterColor:this.style.gutterSelectionColor,r<=this.GetWorldRowCount()&&this.DrawTextVerticallyAlign(`${r}`,this.GutterSize/2,h-(this.GutterSize+(i+.5)*this.CellSize),this.GutterSize-this.margin)}}DrawHorizontalGutter(selection=null){this.ResetTransform();let h=this.GetHeight(),w=this.GetWidth();this.canvasContext.fillStyle=this.style.gutterBackgroundColor,this.canvasContext.fillRect(this.GutterSize,h-this.GutterSize+1,w,this.GutterSize);let cols=this.GetColCount();this.canvasContext.strokeStyle=this.style.gridBorderColor;let c1=-1,c2=-1;if(null!=selection){c1=Math.min(selection.c,selection.c+(selection.cols-1)*selection.dc)-this.origin.c,c2=Math.max(selection.c,selection.c+(selection.cols-1)*selection.dc)-this.origin.c;let sc1=this.GutterSize+c1*this.CellSize,sc2=this.GutterSize+(c2+1)*this.CellSize;this.canvasContext.fillStyle=this.style.gutterSelectionBackgroundColor,this.canvasContext.fillRect(sc1,h-this.GutterSize+1,sc2-sc1,this.GutterSize)}this.TranslateOffset(!1,!0),this.canvasContext.beginPath();for(let i=0;i<cols;i++)this.canvasContext.moveTo(this.GutterSize+(i+1)*this.CellSize-.5,h),this.canvasContext.lineTo(this.GutterSize+(i+1)*this.CellSize-.5,h-this.GutterSize+1);this.canvasContext.stroke(),this.canvasContext.fillStyle=this.style.gutterColor,this.canvasContext.font=Math.min(this.CellSize,this.GutterSize)-this.margin+"px monospace",this.canvasContext.textAlign="center",this.canvasContext.textBaseline="middle";for(let i=0;i<cols;i++){this.canvasContext.fillStyle=i<c1||i>c2?this.style.gutterColor:this.style.gutterSelectionColor;const c=i+Math.floor(this.origin.c);c<=this.GetWorldColCount()&&this.DrawTextVerticallyAlign(`${c}`,this.GutterSize+i*this.CellSize+.5*this.CellSize,h-this.GutterSize/2,this.CellSize-this.margin)}}DrawGutters(selection=null){let h=this.GetHeight();this.GetWidth(),this.DrawVerticalGutter(selection),this.DrawHorizontalGutter(selection),this.ResetTransform(),this.canvasContext.fillStyle=this.style.gridBorderColor,this.canvasContext.fillRect(0,h-this.GutterSize,this.GutterSize,this.GutterSize)}DrawGrid(){let h=this.GetHeight(),w=this.GetWidth(),cols=this.GetColCount(),rows=this.GetRowCount();this.ResetTransform(),this.TranslateOffset(!0,!0),this.canvasContext.strokeStyle=this.style.gridBorderColor,"error"===this.mode&&(this.canvasContext.strokeStyle=this.style.errorGridBorderColor),this.canvasContext.beginPath();for(let i=0;i<rows;i++)this.canvasContext.moveTo(this.GutterSize,h-(this.GutterSize+(i+1)*this.CellSize)+.5),this.canvasContext.lineTo(w+this.CellSize,h-(this.GutterSize+(i+1)*this.CellSize)+.5);for(let i=0;i<cols;i++)this.canvasContext.moveTo(this.GutterSize+(i+1)*this.CellSize-.5,-this.CellSize),this.canvasContext.lineTo(this.GutterSize+(i+1)*this.CellSize-.5,h-this.GutterSize);this.canvasContext.stroke()}DrawBackground(){let h=this.GetHeight(),w=this.GetWidth();this.canvasContext.fillStyle=this.style.gridBackgroundColor,"error"===this.mode&&(this.canvasContext.fillStyle=this.style.errorGridBackgroundColor),this.canvasContext.fillRect(0,0,w,h)}DrawKarel(r,c,orientation="north"){if(this.ResetTransform(),r-this.origin.r<-1||r-this.origin.r>=this.GetRowCount())return;if(c-this.origin.c<-1||c-this.origin.c>=this.GetColCount())return;let h=this.GetHeight(),x=this.GutterSize+this.CellSize*(c-this.origin.c)+this.CellSize/2,y=h-(this.GutterSize+this.CellSize*(r-this.origin.r)+this.CellSize/2);switch(this.canvasContext.translate(x-.5,y+.5),this.canvasContext.fillStyle=this.style.karelColor,this.canvasContext.beginPath(),orientation){case"east":this.canvasContext.rotate(Math.PI/2);break;case"south":this.canvasContext.rotate(Math.PI);break;case"west":this.canvasContext.rotate(3*Math.PI/2)}this.canvasContext.moveTo(0,-this.CellSize/2),this.canvasContext.lineTo(this.CellSize/2,0),this.canvasContext.lineTo(this.CellSize/4,0),this.canvasContext.lineTo(this.CellSize/4,this.CellSize/2),this.canvasContext.lineTo(-this.CellSize/4,this.CellSize/2),this.canvasContext.lineTo(-this.CellSize/4,0),this.canvasContext.lineTo(-this.CellSize/2,0),this.canvasContext.lineTo(0,-this.CellSize/2),this.canvasContext.fill(),this.ResetTransform()}ResetTransform(){this.canvasContext.setTransform(1,0,0,1,0,0),this.canvasContext.scale(this.scale,this.scale)}TranslateOffset(rows,cols){let offsetC=this.GetColumnOffset(),offsetR=this.GetRowOffset();cols&&this.canvasContext.translate(-offsetC,0),rows&&this.canvasContext.translate(0,offsetR)}ColorCell(r,c,color){this.ResetTransform(),this.TranslateOffset(!0,!0);let h=this.GetHeight(),x=c*this.CellSize+this.GutterSize,y=h-((r+1)*this.CellSize+this.GutterSize);this.canvasContext.fillStyle=color,this.canvasContext.fillRect(x,y,this.CellSize,this.CellSize)}DrawTextVerticallyAlign(text,x,y,maxWidth){this.canvasContext.textAlign="center",this.canvasContext.textBaseline="alphabetic";let hs=this.canvasContext.measureText(text).actualBoundingBoxAscent-this.canvasContext.measureText(text).actualBoundingBoxDescent;this.canvasContext.fillText(text,x,y+hs/2,maxWidth)}SetBeeperFont(scale){this.canvasContext.textBaseline="alphabetic",this.canvasContext.font=scale*this.CellSize/2+"px monospace"}DrawTextCell(r,c,text){let h=this.GetHeight(),x=c*this.CellSize+this.GutterSize+this.CellSize/2,y=h-((r+.5)*this.CellSize+this.GutterSize);this.DrawTextVerticallyAlign(text,x,y,2*this.CellSize)}DrawBeeperSquare({r:r,c:c,ammount:ammount,background:background,color:color}){let h=this.GetHeight(),x=c*this.CellSize+this.GutterSize,y=h-((r+1)*this.CellSize+this.GutterSize),text=-1!==ammount?String(ammount):"∞";this.SetBeeperFont(-1!==ammount?1:1.5);let measure=this.canvasContext.measureText(text),textH=measure.actualBoundingBoxAscent+4,textW=Math.min(measure.width+4,this.CellSize-5);this.canvasContext.fillStyle=background,this.canvasContext.fillRect(x+this.CellSize/2-textW/2,y+this.CellSize/2-textH/2,textW,textH),this.canvasContext.fillStyle=color,this.DrawTextCell(r,c,text)}DrawWall(r,c,type){let h=this.GetHeight(),x=this.GutterSize+(c+.5)*this.CellSize,y=h-(this.GutterSize+(r+.5)*this.CellSize);switch(this.TranslateOffset(!0,!0),this.canvasContext.translate(x,y),type){case"north":break;case"east":this.canvasContext.rotate(Math.PI/2);break;case"south":this.canvasContext.rotate(Math.PI);break;case"west":this.canvasContext.rotate(3*Math.PI/2)}let lineOr=this.canvasContext.lineWidth;this.canvasContext.strokeStyle=this.style.wallColor,this.canvasContext.lineWidth=2,this.canvasContext.beginPath(),this.canvasContext.moveTo(-this.CellSize/2,-this.CellSize/2+.5),this.canvasContext.lineTo(this.CellSize/2,-this.CellSize/2+.5),this.canvasContext.stroke(),this.canvasContext.lineWidth=lineOr,this.ResetTransform()}DrawWalls(){for(let i=0;i<this.GetRowCount();i++)for(let j=0;j<this.GetColCount();j++){let r=i+Math.floor(this.origin.r),c=j+Math.floor(this.origin.c),walls=this.world.walls(r,c);for(let k=0;k<4;k++)walls&1<<k&&this.DrawWall(i,j,this.GetOrientation(k))}}DrawBeepers(){this.ResetTransform(),this.TranslateOffset(!0,!0);for(let i=0;i<this.GetRowCount();i++)for(let j=0;j<this.GetColCount();j++){let r=i+Math.floor(this.origin.r),c=j+Math.floor(this.origin.c),buzzers=this.world.buzzers(r,c);0!==buzzers&&this.DrawBeeperSquare({r:i,c:j,ammount:buzzers,background:this.style.beeperBackgroundColor,color:this.style.beeperColor})}}DrawDumpCells(){for(let i=0;i<this.GetRowCount();i++)for(let j=0;j<this.GetColCount();j++){let r=i+Math.floor(this.origin.r),c=j+Math.floor(this.origin.c);this.world.getDumpCell(r,c)&&this.ColorCell(i,j,this.style.exportCellBackground)}}Draw(world,selection=null){this.world=world,this.ResetTransform();let h=this.GetHeight(),w=this.GetWidth();this.canvasContext.clearRect(0,0,w,h),this.DrawBackground(),this.DrawDumpCells(),this.DrawGrid(),this.DrawKarel(world.i,world.j,this.GetOrientation(world.orientation)),this.DrawWalls(),this.DrawBeepers(),this.DrawGutters(selection),this.ResetTransform()}GetOrientation(n){switch(n){case 0:return"west";case 1:return"north";case 2:return"east";case 3:return"south"}return"north"}PointToCell(x,y,precise=!1){x+=this.GetColumnOffset(),y-=this.GetRowOffset();let c=(x-this.GutterSize)/this.CellSize,r=(this.GetHeight()-y-this.GutterSize)/this.CellSize;return precise?{r:r+Math.floor(this.origin.r),c:c+Math.floor(this.origin.c)}:c<0||r<0?{r:-1,c:-1}:{r:Math.round(Math.floor(r)+Math.floor(this.origin.r)),c:Math.round(Math.floor(c)+Math.floor(this.origin.c))}}CellToPoint(r,c){return{x:(this.GutterSize+(c-this.origin.c)*this.CellSize)*this.scale/window.devicePixelRatio,y:(this.GetHeight()-(this.GutterSize+(r-this.origin.r+1)*this.CellSize))*this.scale/window.devicePixelRatio}}Snap(){this.origin.r=Math.round(this.origin.r),this.origin.c=Math.round(this.origin.c);const performedSnapped=!this.snapped;return this.snapped=!0,performedSnapped}SmoothlySetOrigin(coord){this.origin=coord,this.snapped=!1}SnappySetOrigin(coord){this.SmoothlySetOrigin(coord),this.Snap()}GetColumnOffset(){return(this.origin.c-Math.floor(this.origin.c))*this.CellSize}GetRowOffset(){return(this.origin.r-Math.floor(this.origin.r))*this.CellSize}}var kareljava=function(){var o=function(k,v,o,l){for(o=o||{},l=k.length;l--;o[k[l]]=v);return o},$V0=[1,5],$V1=[4,16],$V2=[1,19],$V3=[1,20],$V4=[1,21],$V5=[5,28,29,30],$V6=[1,29],$V7=[8,9,18,27,53,54,55,56,57],$V8=[1,39],$V9=[6,11,18,19,32,33,34,35,36,37,38,44,47,50,51],$Va=[9,27],$Vb=[1,71],$Vc=[1,58],$Vd=[1,59],$Ve=[1,60],$Vf=[1,61],$Vg=[1,62],$Vh=[1,63],$Vi=[1,64],$Vj=[1,72],$Vk=[1,74],$Vl=[1,75],$Vm=[1,76],$Vn=[6,11,18,19,32,33,34,35,36,37,38,44,47,49,50,51],$Vo=[1,93],$Vp=[1,95],$Vq=[1,100],$Vr=[1,101],$Vs=[1,102],$Vt=[1,103],$Vu=[1,104],$Vv=[1,105],$Vw=[1,106],$Vx=[1,107],$Vy=[1,108],$Vz=[1,109],$VA=[1,110],$VB=[1,111],$VC=[1,112],$VD=[1,113],$VE=[1,114],$VF=[1,115],$VG=[1,116],$VH=[1,117],$VI=[1,119],$VJ=[1,120],$VK=[1,121],$VL=[1,122],$VM=[1,135],$VN=[1,136],$VO=[1,137],$VP=[1,138],$VQ=[1,139],$VR=[1,140],$VS=[9,18,27,53,54,55,56,57],$VT=[9,18,27,53,54],$VU=[9,18,27,53,54,55],parser={trace:function(){},yy:{},symbols_:{error:2,program:3,CLASS:4,PROG:5,BEGIN:6,def_list:7,"(":8,")":9,block:10,END:11,EOF:12,import_list:13,expr_list:14,import:15,IMPORT:16,package:17,";":18,VAR:19,".":20,"*":21,def:22,funct_type:23,var:24,paramList:25,param:26,",":27,DEF:28,INT:29,BOOL:30,expr:31,FORWARD:32,LEFT:33,PICKBUZZER:34,LEAVEBUZZER:35,HALT:36,CONTINUE:37,BREAK:38,return:39,call:40,cond:41,loop:42,repeat:43,RET:44,term:45,int_termList:46,IF:47,bool_term:48,ELSE:49,WHILE:50,REPEAT:51,int_term:52,OR:53,AND:54,"==":55,"<":56,"<=":57,NOT:58,clause:59,IFZ:60,bool_fun:61,integer:62,IFNFWALL:63,IFFWALL:64,IFNLWALL:65,IFLWALL:66,IFNRWALL:67,IFRWALL:68,IFWBUZZER:69,IFNWBUZZER:70,IFBBUZZER:71,IFNBBUZZER:72,IFW:73,IFN:74,IFE:75,IFS:76,IFNW:77,IFNN:78,IFNE:79,IFNS:80,int_literal:81,INC:82,DEC:83,NUM:84,$accept:0,$end:1},terminals_:{2:"error",4:"CLASS",5:"PROG",6:"BEGIN",8:"(",9:")",11:"END",12:"EOF",16:"IMPORT",18:";",19:"VAR",20:".",21:"*",27:",",28:"DEF",29:"INT",30:"BOOL",32:"FORWARD",33:"LEFT",34:"PICKBUZZER",35:"LEAVEBUZZER",36:"HALT",37:"CONTINUE",38:"BREAK",44:"RET",47:"IF",49:"ELSE",50:"WHILE",51:"REPEAT",53:"OR",54:"AND",55:"==",56:"<",57:"<=",58:"NOT",60:"IFZ",63:"IFNFWALL",64:"IFFWALL",65:"IFNLWALL",66:"IFLWALL",67:"IFNRWALL",68:"IFRWALL",69:"IFWBUZZER",70:"IFNWBUZZER",71:"IFBBUZZER",72:"IFNBBUZZER",73:"IFW",74:"IFN",75:"IFE",76:"IFS",77:"IFNW",78:"IFNN",79:"IFNE",80:"IFNS",82:"INC",83:"DEC",84:"NUM"},productions_:[0,[3,10],[3,9],[3,11],[3,10],[10,3],[13,2],[13,1],[15,3],[17,3],[17,3],[7,2],[7,1],[22,5],[22,6],[25,3],[25,1],[26,1],[23,1],[23,1],[23,1],[14,2],[14,0],[31,4],[31,4],[31,4],[31,4],[31,4],[31,2],[31,2],[31,2],[31,2],[31,1],[31,1],[31,1],[31,1],[31,1],[39,3],[39,1],[39,2],[40,3],[40,4],[46,3],[46,1],[41,5],[41,7],[42,5],[43,5],[45,3],[45,3],[45,3],[45,3],[45,3],[45,2],[45,3],[45,1],[48,1],[52,1],[59,4],[59,1],[59,3],[59,1],[59,1],[59,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[61,1],[62,1],[62,4],[62,4],[62,6],[62,6],[81,1],[24,1]],performAction:function(yytext,yyleng,yylineno,yy,yystate,$$,_$){var $0=$$.length-1;switch(yystate){case 1:return resetCompiler(),{compiler:COMPILER,language:LANG,variablesCanBeFunctions:VarsAsFuncs,requieresFunctionPrototypes:reqsPrototypes,packages:[],functions:$$[$0-6],program:$$[$0-2].concat([["LINE",yylineno,0],["HALT"]]),yy:yy};case 2:return resetCompiler(),{compiler:COMPILER,language:LANG,requieresFunctionPrototypes:reqsPrototypes,variablesCanBeFunctions:VarsAsFuncs,packages:[],functions:[],program:$$[$0-2].concat([["LINE",yylineno,0],["HALT"]]),yy:yy};case 3:return resetCompiler(),{compiler:COMPILER,language:LANG,requieresFunctionPrototypes:reqsPrototypes,variablesCanBeFunctions:VarsAsFuncs,packages:$$[$0-10],functions:$$[$0-6],program:$$[$0-2].concat([["LINE",yylineno,0],["HALT"]]),yy:yy};case 4:return resetCompiler(),{compiler:COMPILER,language:LANG,packages:$$[$0-9],requieresFunctionPrototypes:reqsPrototypes,variablesCanBeFunctions:VarsAsFuncs,functions:[],program:$$[$0-2].concat([["LINE",yylineno,0],["HALT"]]),yy:yy};case 5:case 30:case 31:this.$=$$[$0-1];break;case 6:case 11:case 21:this.$=$$[$0-1].concat($$[$0]);break;case 7:case 12:case 16:case 32:case 33:case 34:case 35:case 55:this.$=$$[$0];break;case 8:this.$=[[$$[$0-1],_$[$0-1]]];break;case 9:this.$=$$[$0-2]+"."+$$[$0];break;case 10:this.$=$$[$0-2]+".*";break;case 13:this._$.first_line=_$[$0-4].first_line,this._$.first_column=_$[$0-4].first_column,this._$.last_line=_$[$0-2].last_line,this._$.last_column=_$[$0-2].last_column,this.$=[{name:$$[$0-3],code:[locToIR(_$[$0-3]),...$$[$0],["RET","__DEFAULT",{first_line:_$[$0].last_line,first_column:_$[$0].last_column-1,last_line:_$[$0].last_line,last_column:_$[$0].last_column}]],params:[],loc:this._$,returnType:$$[$0-4]}];break;case 14:this._$.first_line=_$[$0-5].first_line,this._$.first_column=_$[$0-5].first_column,this._$.last_line=_$[$0-3].last_line,this._$.last_column=_$[$0-3].last_column;let result=[locToIR(_$[$0-4]),...$$[$0],["RET","__DEFAULT",{first_line:_$[$0].last_line,first_column:_$[$0].last_column-1,last_line:_$[$0].last_line,last_column:_$[$0].last_column}]];$$[$0-1],this.$=[{name:$$[$0-4],code:result,params:$$[$0-2],loc:this._$,returnType:$$[$0-5]}];break;case 15:this.$=$$[$0-2].concat($$[$0]);break;case 17:this.$=[{name:$$[$0],loc:_$[$0]}];break;case 18:this.$="VOID";break;case 19:this.$="INT";break;case 20:this.$="BOOL";break;case 22:case 36:this.$=[];break;case 23:this.$=[locToIR(_$[$0-3]),["FORWARD"]];break;case 24:this.$=[locToIR(_$[$0-3]),["LEFT"]];break;case 25:this.$=[locToIR(_$[$0-3]),["PICKBUZZER"]];break;case 26:this.$=[locToIR(_$[$0-3]),["LEAVEBUZZER"]];break;case 27:this.$=[locToIR(_$[$0-3]),["HALT"]];break;case 28:this.$=[locToIR(_$[$0-1]),["CONTINUE",_$[$0-1]]];break;case 29:this.$=[locToIR(_$[$0-1]),["BREAK",_$[$0-1]]];break;case 37:this.$=[["RET",{term:{operation:"ATOM",instructions:[["LOAD",0]],dataType:"VOID",atomType:"IMPLICIT.0"},loc:_$[$0-2]}]];break;case 38:this.$=[["RET",{term:{operation:"ATOM",instructions:[["LOAD",0]],dataType:"VOID",atomType:"IMPLICIT.0"},loc:_$[$0]}]];break;case 39:this.$=[["RET",{term:$$[$0],loc:_$[$0-1]}]];break;case 40:var loc={first_line:_$[$0-1].first_line,first_column:_$[$0-1].first_column,last_line:_$[$0].last_line,last_column:_$[$0].last_column};this.$=[["CALL",{target:$$[$0-2],params:[],nameLoc:_$[$0-2],argLoc:loc}]];break;case 41:this._$.first_column=_$[$0-3].first_column,this._$.first_line=_$[$0-3].first_line,this._$.last_column=_$[$0].last_column,this._$.last_line=_$[$0].last_line,this.$=[["CALL",{target:$$[$0-3],params:$$[$0-1],nameLoc:_$[$0-3],argLoc:loc}]];break;case 42:this.$=$$[$0-2].concat([{term:$$[$0],operation:"PASS",dataType:"INT",loc:$$[$0].loc,totalLoc:$$[$0].totalLoc}]);break;case 43:this.$=[{term:$$[$0],operation:"PASS",dataType:"INT",loc:$$[$0].loc,totalLoc:$$[$0].totalLoc}];break;case 44:const skipTag=UniqueTag("iskip");this.$=[["IF",{condition:$$[$0-2][0],line:locToIR(_$[$0-4]),skipTrueTag:skipTag,trueCase:$$[$0]}]];break;case 45:const toElse=UniqueTag("ielse"),skipElse=UniqueTag("iskipelse");this.$=[["IF",{condition:$$[$0-4][0],line:locToIR(_$[$0-6]),skipTrueTag:toElse,skipFalseTag:skipElse,trueCase:$$[$0-2],falseCase:$$[$0]}]];break;case 46:const repeatTag=UniqueTag("lrepeat"),endTag=UniqueTag("lend");this.$=[["WHILE",{condition:$$[$0-2][0],line:locToIR(_$[$0-4]),repeatTag:repeatTag,endTag:endTag,instructions:$$[$0]}]];break;case 47:const repeatEnd=UniqueTag("rend"),repeatLoop=UniqueTag("rloop"),continueLoop=UniqueTag("rcontinue");this.$=[["REPEAT",{line:locToIR(_$[$0-4]),loopCount:$$[$0-2][0],repeatTag:repeatLoop,continueTag:continueLoop,endTag:repeatEnd,instructions:$$[$0]}]];break;case 48:this._$=mergeLocs(_$[$0-2],_$[$0]),this.$={left:$$[$0-2],right:$$[$0],operation:"OR",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 49:this._$=mergeLocs(_$[$0-2],_$[$0]),this.$={left:$$[$0-2],right:$$[$0],operation:"AND",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 50:this._$=mergeLocs(_$[$0-2],_$[$0]),this.$={left:$$[$0-2],right:$$[$0],operation:"EQ",loc:_$[$0-1],totalLoc:this._$,dataType:"BOOL"};break;case 51:this._$=mergeLocs(_$[$0-2],_$[$0]),this.$={left:$$[$0-2],right:$$[$0],operation:"LT",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 52:this._$=mergeLocs(_$[$0-2],_$[$0]),this.$={left:$$[$0-2],right:$$[$0],operation:"LTE",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 53:this._$=mergeLocs(_$[$0-1],_$[$0]),this.$={term:$$[$0],operation:"NOT",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 54:this.$={term:$$[$0-1],operation:"PARENTHESIS",dataType:$$[$0-1].dataType,loc:$$[$0-1].loc,totalLoc:this._$};break;case 56:this.$=[["TERM",{term:$$[$0],operation:"PASS",dataType:"BOOL",loc:$$[$0].loc,totalLoc:$$[$0].totalLoc}]];break;case 57:this.$=[["TERM",{term:$$[$0],operation:"PASS",dataType:"INT",loc:$$[$0].loc,totalLoc:$$[$0].totalLoc}]];break;case 58:this._$=mergeLocs(_$[$0-3],_$[$0]),this.$={operation:"ATOM",instructions:$$[$0-1].concat([["NOT"]]),dataType:"BOOL",atomType:"IS_ZERO",loc:_$[$0-3],totalLoc:this._$};break;case 59:this._$=_$[$0],this.$={operation:"ATOM",instructions:$$[$0].code,atomType:$$[$0].name,dataType:"BOOL",loc:this._$,totalLoc:this._$};break;case 60:this._$=mergeLocs(_$[$0-2],_$[$0]),this.$={operation:"ATOM",instructions:$$[$0-2].code,atomType:$$[$0-2].name,dataType:"BOOL",loc:_$[$0-2],totalLoc:this._$};break;case 61:this._$=_$[$0],this.$={operation:"ATOM",instructions:$$[$0].code,atomType:$$[$0].data,dataType:"INT",loc:_$[$0],totalLoc:_$[$0]};break;case 62:const callIR=$$[$0],callData=callIR[0][1];this.$={operation:"ATOM",instructions:[...callIR,["LRET"]],dataType:"$"+callData.target,atomType:"CALL",loc:_$[$0],totalLoc:_$[$0]};break;case 63:const ir=[["VAR",{target:$$[$0],loc:_$[$0],couldBeFunction:!1}]];this._$=_$[$0],this.$={operation:"ATOM",instructions:ir,dataType:"$"+$$[$0],atomType:`VAR.${$$[$0]}`,loc:_$[$0],totalLoc:_$[$0]};break;case 64:this.$={name:"IFNFWALL",code:[["WORLDWALLS"],["ORIENTATION"],["MASK"],["AND"],["NOT"]]};break;case 65:this.$={name:"IFFWALL",code:[["WORLDWALLS"],["ORIENTATION"],["MASK"],["AND"]]};break;case 66:this.$={name:"IFNLWALL",code:[["WORLDWALLS"],["ORIENTATION"],["ROTL"],["MASK"],["AND"],["NOT"]]};break;case 67:this.$={name:"IFLWALL",code:[["WORLDWALLS"],["ORIENTATION"],["ROTL"],["MASK"],["AND"]]};break;case 68:this.$={name:"IFNRWALL",code:[["WORLDWALLS"],["ORIENTATION"],["ROTR"],["MASK"],["AND"],["NOT"]]};break;case 69:this.$={name:"IFRWALL",code:[["WORLDWALLS"],["ORIENTATION"],["ROTR"],["MASK"],["AND"]]};break;case 70:this.$={name:"IFWBUZZER",code:[["WORLDBUZZERS"],["LOAD",0],["EQ"],["NOT"]]};break;case 71:this.$={name:"IFNWBUZZER",code:[["WORLDBUZZERS"],["NOT"]]};break;case 72:this.$={name:"IFBBUZZER",code:[["BAGBUZZERS"],["LOAD",0],["EQ"],["NOT"]]};break;case 73:this.$={name:"IFNBBUZZER",code:[["BAGBUZZERS"],["NOT"]]};break;case 74:this.$={name:"IFW",code:[["ORIENTATION"],["LOAD",0],["EQ"]]};break;case 75:this.$={name:"IFN",code:[["ORIENTATION"],["LOAD",1],["EQ"]]};break;case 76:this.$={name:"IFE",code:[["ORIENTATION"],["LOAD",2],["EQ"]]};break;case 77:this.$={name:"IFS",code:[["ORIENTATION"],["LOAD",3],["EQ"]]};break;case 78:this.$={name:"IFNW",code:[["ORIENTATION"],["LOAD",0],["EQ"],["NOT"]]};break;case 79:this.$={name:"IFNN",code:[["ORIENTATION"],["LOAD",1],["EQ"],["NOT"]]};break;case 80:this.$={name:"IFNE",code:[["ORIENTATION"],["LOAD",2],["EQ"],["NOT"]]};break;case 81:this.$={name:"IFNS",code:[["ORIENTATION"],["LOAD",3],["EQ"],["NOT"]]};break;case 82:this.$={data:`NUMBER.${$$[$0]}`,code:[["LOAD",$$[$0]]]};break;case 83:this.$={data:"INC",code:$$[$0-1].concat([["INC",1]])};break;case 84:this.$={data:"DEC",code:$$[$0-1].concat([["DEC",1]])};break;case 85:this.$={data:`INC.${$$[$0-1]}`,code:$$[$0-3].concat([["INC",$$[$0-1]]])};break;case 86:this.$={data:`DEC.${$$[$0-1]}`,code:$$[$0-3].concat([["DEC",$$[$0-1]]])};break;case 87:this.$=parseInt(yytext);break;case 88:this.$=yytext}},table:[{3:1,4:[1,2],13:3,15:4,16:$V0},{1:[3]},{5:[1,6]},{4:[1,7],15:8,16:$V0},o($V1,[2,7]),{17:9,19:[1,10]},{6:[1,11]},{5:[1,12]},o($V1,[2,6]),{18:[1,13]},{20:[1,14]},{5:[1,16],7:15,22:17,23:18,28:$V2,29:$V3,30:$V4},{6:[1,22]},o($V1,[2,8]),{19:[1,23],21:[1,24]},{5:[1,25],22:26,23:18,28:$V2,29:$V3,30:$V4},{8:[1,27]},o($V5,[2,12]),{19:$V6,24:28},{19:[2,18]},{19:[2,19]},{19:[2,20]},{5:[1,31],7:30,22:17,23:18,28:$V2,29:$V3,30:$V4},{18:[2,9]},{18:[2,10]},{8:[1,32]},o($V5,[2,11]),{9:[1,33]},{8:[1,34]},o($V7,[2,88]),{5:[1,35],22:26,23:18,28:$V2,29:$V3,30:$V4},{8:[1,36]},{9:[1,37]},{6:$V8,10:38},{9:[1,40],19:$V6,24:43,25:41,26:42},{8:[1,44]},{9:[1,45]},{6:$V8,10:46},{11:[1,47]},o($V9,[2,22],{14:48}),{6:$V8,10:49},{9:[1,50]},{9:[2,16],27:[1,51]},o($Va,[2,17]),{9:[1,52]},{6:$V8,10:53},{11:[1,54]},{12:[1,55]},{6:$V8,10:70,11:[1,56],18:$Vb,19:$V6,24:73,31:57,32:$Vc,33:$Vd,34:$Ve,35:$Vf,36:$Vg,37:$Vh,38:$Vi,39:65,40:66,41:67,42:68,43:69,44:$Vj,47:$Vk,50:$Vl,51:$Vm},o($V5,[2,13]),{6:$V8,10:77},{19:$V6,24:43,25:78,26:42},{6:$V8,10:79},{11:[1,80]},{12:[1,81]},{1:[2,2]},o([5,6,11,18,19,28,29,30,32,33,34,35,36,37,38,44,47,49,50,51],[2,5]),o($V9,[2,21]),{8:[1,82]},{8:[1,83]},{8:[1,84]},{8:[1,85]},{8:[1,86]},{18:[1,87]},{18:[1,88]},{18:[1,89]},{18:[1,90]},o($Vn,[2,32]),o($Vn,[2,33]),o($Vn,[2,34]),o($Vn,[2,35]),o($Vn,[2,36]),{8:[1,91],18:[2,38],19:$V6,24:99,40:98,45:92,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{8:$VL},{8:[1,123]},{8:[1,124]},{8:[1,125]},o($V5,[2,14]),{9:[2,15]},{11:[1,126]},{12:[1,127]},{1:[2,1]},{9:[1,128]},{9:[1,129]},{9:[1,130]},{9:[1,131]},{9:[1,132]},o($Vn,[2,28]),o($Vn,[2,29]),o($Vn,[2,30]),o($Vn,[2,31]),{8:$VM,9:[1,133],19:$V6,24:99,40:98,45:134,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{18:[2,39],53:$VN,54:$VO,55:$VP,56:$VQ,57:$VR},{8:$VM,19:$V6,24:99,40:98,45:141,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},o($VS,[2,55]),{8:[1,142]},o($VS,[2,59],{8:[1,143]}),o($VS,[2,61]),o($VS,[2,62]),o($VS,[2,63],{8:$VL}),o($V7,[2,64]),o($V7,[2,65]),o($V7,[2,66]),o($V7,[2,67]),o($V7,[2,68]),o($V7,[2,69]),o($V7,[2,70]),o($V7,[2,71]),o($V7,[2,72]),o($V7,[2,73]),o($V7,[2,74]),o($V7,[2,75]),o($V7,[2,76]),o($V7,[2,77]),o($V7,[2,78]),o($V7,[2,79]),o($V7,[2,80]),o($V7,[2,81]),o($VS,[2,82]),{8:[1,144]},{8:[1,145]},o($VS,[2,87]),{8:$VM,9:[1,146],19:$V6,24:99,40:98,45:148,46:147,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{8:$VM,19:$V6,24:99,40:98,45:150,48:149,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{8:$VM,19:$V6,24:99,40:98,45:150,48:151,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{8:$VM,19:$V6,24:99,40:98,45:153,52:152,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{12:[1,154]},{1:[2,4]},{18:[1,155]},{18:[1,156]},{18:[1,157]},{18:[1,158]},{18:[1,159]},{18:[2,37]},{9:[1,160],53:$VN,54:$VO,55:$VP,56:$VQ,57:$VR},{8:$VM,19:$V6,24:99,40:98,45:134,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{8:$VM,19:$V6,24:99,40:98,45:161,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{8:$VM,19:$V6,24:99,40:98,45:162,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{8:$VM,19:$V6,24:99,40:98,45:163,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{8:$VM,19:$V6,24:99,40:98,45:164,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{8:$VM,19:$V6,24:99,40:98,45:165,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},o($VS,[2,53]),{8:$VM,19:$V6,24:99,40:98,45:153,52:166,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{9:[1,167]},{8:$VM,19:$V6,24:99,40:98,45:153,52:168,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{8:$VM,19:$V6,24:99,40:98,45:153,52:169,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},o($VS,[2,40]),{9:[1,170],27:[1,171]},o($Va,[2,43],{53:$VN,54:$VO,55:$VP,56:$VQ,57:$VR}),{9:[1,172]},{9:[2,56],53:$VN,54:$VO,55:$VP,56:$VQ,57:$VR},{9:[1,173]},{9:[1,174]},o($Va,[2,57],{53:$VN,54:$VO,55:$VP,56:$VQ,57:$VR}),{1:[2,3]},o($Vn,[2,23]),o($Vn,[2,24]),o($Vn,[2,25]),o($Vn,[2,26]),o($Vn,[2,27]),o($VS,[2,54]),o([9,18,27,53],[2,48],{54:$VO,55:$VP,56:$VQ,57:$VR}),o($VT,[2,49],{55:$VP,56:$VQ,57:$VR}),o($VT,[2,50],{56:$VQ,57:$VR}),o($VU,[2,51]),o($VU,[2,52]),{9:[1,175]},o($VS,[2,60]),{9:[1,176],27:[1,177]},{9:[1,178],27:[1,179]},o($VS,[2,41]),{8:$VM,19:$V6,24:99,40:98,45:180,58:$Vo,59:94,60:$Vp,61:96,62:97,63:$Vq,64:$Vr,65:$Vs,66:$Vt,67:$Vu,68:$Vv,69:$Vw,70:$Vx,71:$Vy,72:$Vz,73:$VA,74:$VB,75:$VC,76:$VD,77:$VE,78:$VF,79:$VG,80:$VH,81:118,82:$VI,83:$VJ,84:$VK},{6:$V8,10:70,18:$Vb,19:$V6,24:73,31:181,32:$Vc,33:$Vd,34:$Ve,35:$Vf,36:$Vg,37:$Vh,38:$Vi,39:65,40:66,41:67,42:68,43:69,44:$Vj,47:$Vk,50:$Vl,51:$Vm},{6:$V8,10:70,18:$Vb,19:$V6,24:73,31:182,32:$Vc,33:$Vd,34:$Ve,35:$Vf,36:$Vg,37:$Vh,38:$Vi,39:65,40:66,41:67,42:68,43:69,44:$Vj,47:$Vk,50:$Vl,51:$Vm},{6:$V8,10:70,18:$Vb,19:$V6,24:73,31:183,32:$Vc,33:$Vd,34:$Ve,35:$Vf,36:$Vg,37:$Vh,38:$Vi,39:65,40:66,41:67,42:68,43:69,44:$Vj,47:$Vk,50:$Vl,51:$Vm},o($VS,[2,58]),o($VS,[2,83]),{81:184,84:$VK},o($VS,[2,84]),{81:185,84:$VK},o($Va,[2,42],{53:$VN,54:$VO,55:$VP,56:$VQ,57:$VR}),o($V9,[2,44],{49:[1,186]}),o($Vn,[2,46]),o($Vn,[2,47]),{9:[1,187]},{9:[1,188]},{6:$V8,10:70,18:$Vb,19:$V6,24:73,31:189,32:$Vc,33:$Vd,34:$Ve,35:$Vf,36:$Vg,37:$Vh,38:$Vi,39:65,40:66,41:67,42:68,43:69,44:$Vj,47:$Vk,50:$Vl,51:$Vm},o($VS,[2,85]),o($VS,[2,86]),o($Vn,[2,45])],defaultActions:{19:[2,18],20:[2,19],21:[2,20],23:[2,9],24:[2,10],55:[2,2],78:[2,15],81:[2,1],127:[2,4],133:[2,37],154:[2,3]},parseError:function(str,hash){if(!hash.recoverable){var error=new Error(str);throw error.hash=hash,error}this.trace(str)},parse:function(input){var self=this,stack=[0],vstack=[null],lstack=[],table=this.table,yytext="",yylineno=0,yyleng=0,args=lstack.slice.call(arguments,1),lexer=Object.create(this.lexer),sharedState={yy:{}};for(var k in this.yy)Object.prototype.hasOwnProperty.call(this.yy,k)&&(sharedState.yy[k]=this.yy[k]);lexer.setInput(input,sharedState.yy),sharedState.yy.lexer=lexer,sharedState.yy.parser=this,void 0===lexer.yylloc&&(lexer.yylloc={});var yyloc=lexer.yylloc;lstack.push(yyloc);var ranges=lexer.options&&lexer.options.ranges;"function"==typeof sharedState.yy.parseError?this.parseError=sharedState.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var symbol,state,action,r,p,len,newState,expected,token,yyval={};;){if(state=stack[stack.length-1],this.defaultActions[state]?action=this.defaultActions[state]:(null==symbol&&(token=void 0,"number"!=typeof(token=lexer.lex()||1)&&(token=self.symbols_[token]||token),symbol=token),action=table[state]&&table[state][symbol]),void 0===action||!action.length||!action[0]){var errStr="";for(p in expected=[],table[state])this.terminals_[p]&&p>2&&expected.push("'"+this.terminals_[p]+"'");errStr=lexer.showPosition?"Parse error on line "+(yylineno+1)+":\n"+lexer.showPosition()+"\nExpecting "+expected.join(", ")+", got '"+(this.terminals_[symbol]||symbol)+"'":"Parse error on line "+(yylineno+1)+": Unexpected "+(1==symbol?"end of input":"'"+(this.terminals_[symbol]||symbol)+"'"),this.parseError(errStr,{text:lexer.match,token:this.terminals_[symbol]||symbol,line:lexer.yylineno,loc:lexer.yylloc,expected:expected})}if(action[0]instanceof Array&&action.length>1)throw new Error("Parse Error: multiple actions possible at state: "+state+", token: "+symbol);switch(action[0]){case 1:stack.push(symbol),vstack.push(lexer.yytext),lstack.push(lexer.yylloc),stack.push(action[1]),symbol=null,yyleng=lexer.yyleng,yytext=lexer.yytext,yylineno=lexer.yylineno,yyloc=lexer.yylloc;break;case 2:if(len=this.productions_[action[1]][1],yyval.$=vstack[vstack.length-len],yyval._$={first_line:lstack[lstack.length-(len||1)].first_line,last_line:lstack[lstack.length-1].last_line,first_column:lstack[lstack.length-(len||1)].first_column,last_column:lstack[lstack.length-1].last_column},ranges&&(yyval._$.range=[lstack[lstack.length-(len||1)].range[0],lstack[lstack.length-1].range[1]]),void 0!==(r=this.performAction.apply(yyval,[yytext,yyleng,yylineno,sharedState.yy,action[1],vstack,lstack].concat(args))))return r;len&&(stack=stack.slice(0,-1*len*2),vstack=vstack.slice(0,-1*len),lstack=lstack.slice(0,-1*len)),stack.push(this.productions_[action[1]][0]),vstack.push(yyval.$),lstack.push(yyval._$),newState=table[stack[stack.length-2]][stack[stack.length-1]],stack.push(newState);break;case 3:return!0}}return!0}};const COMPILER="RKJ 1.0.0",LANG="ReKarel Java",VarsAsFuncs=!1,reqsPrototypes=!1;let tagCnt=1;function UniqueTag(tag){return`${tag}.${tagCnt++}`}function resetCompiler(tag){tagCnt=1}function mergeLocs(first,second){return{first_line:first.first_line,first_column:first.first_column,last_line:second.last_line,last_column:second.last_column}}function locToIR(loc){return["LINE",loc.first_line-1,loc.first_column]}var lexer=function(){var lexer={EOF:1,parseError:function(str,hash){if(!this.yy.parser)throw new Error(str);this.yy.parser.parseError(str,hash)},setInput:function(input,yy){return this.yy=yy||this.yy||{},this._input=input,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var ch=this._input[0];return this.yytext+=ch,this.yyleng++,this.offset++,this.match+=ch,this.matched+=ch,ch.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),ch},unput:function(ch){var len=ch.length,lines=ch.split(/(?:\r\n?|\n)/g);this._input=ch+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-len),this.offset-=len;var oldLines=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),lines.length-1&&(this.yylineno-=lines.length-1);var r=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:lines?(lines.length===oldLines.length?this.yylloc.first_column:0)+oldLines[oldLines.length-lines.length].length-lines[0].length:this.yylloc.first_column-len},this.options.ranges&&(this.yylloc.range=[r[0],r[0]+this.yyleng-len]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(n){this.unput(this.match.slice(n))},pastInput:function(){var past=this.matched.substr(0,this.matched.length-this.match.length);return(past.length>20?"...":"")+past.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var next=this.match;return next.length<20&&(next+=this._input.substr(0,20-next.length)),(next.substr(0,20)+(next.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var pre=this.pastInput(),c=new Array(pre.length+1).join("-");return pre+this.upcomingInput()+"\n"+c+"^"},test_match:function(match,indexed_rule){var token,lines,backup;if(this.options.backtrack_lexer&&(backup={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(backup.yylloc.range=this.yylloc.range.slice(0))),(lines=match[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=lines.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:lines?lines[lines.length-1].length-lines[lines.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+match[0].length},this.yytext+=match[0],this.match+=match[0],this.matches=match,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(match[0].length),this.matched+=match[0],token=this.performAction.call(this,this.yy,this,indexed_rule,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),token)return token;if(this._backtrack){for(var k in backup)this[k]=backup[k];return!1}return!1},next:function(){if(this.done)return this.EOF;var token,match,tempMatch,index;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var rules=this._currentRules(),i=0;i<rules.length;i++)if((tempMatch=this._input.match(this.rules[rules[i]]))&&(!match||tempMatch[0].length>match[0].length)){if(match=tempMatch,index=i,this.options.backtrack_lexer){if(!1!==(token=this.test_match(tempMatch,rules[i])))return token;if(this._backtrack){match=!1;continue}return!1}if(!this.options.flex)break}return match?!1!==(token=this.test_match(match,rules[index]))&&token:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var r=this.next();return r||this.lex()},begin:function(condition){this.conditionStack.push(condition)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(n){return(n=this.conditionStack.length-1-Math.abs(n||0))>=0?this.conditionStack[n]:"INITIAL"},pushState:function(condition){this.begin(condition)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(yy,yy_,$avoiding_name_collisions,YY_START){switch($avoiding_name_collisions){case 0:case 1:case 2:break;case 3:return 4;case 4:return 5;case 5:case 7:return 28;case 6:return 16;case 8:return 29;case 9:return 30;case 10:return 44;case 11:return 36;case 12:return 33;case 13:return 32;case 14:return 34;case 15:return 35;case 16:return 37;case 17:return 38;case 18:return 50;case 19:return 51;case 20:return 83;case 21:return 82;case 22:return 60;case 23:return 63;case 24:return 64;case 25:return 65;case 26:return 66;case 27:return 67;case 28:return 68;case 29:return 69;case 30:return 70;case 31:return 71;case 32:return 72;case 33:return 74;case 34:return 76;case 35:return 75;case 36:return 73;case 37:return 78;case 38:return 80;case 39:return 79;case 40:return 77;case 41:return 49;case 42:return 47;case 43:return 58;case 44:return 53;case 45:case 46:return 54;case 47:return 8;case 48:return 9;case 49:return 6;case 50:return 11;case 51:return 18;case 52:return 20;case 53:return 21;case 54:return 27;case 55:return 55;case 56:return 57;case 57:return 56;case 58:return 84;case 59:return 19;case 60:return 12}},rules:[/^(?:\s+)/,/^(?:\/\/[^\n]*)/,/^(?:\/\*(?:[^*]|\*(?!\/))*\*\/)/,/^(?:class\b)/,/^(?:program\b)/,/^(?:define\b)/,/^(?:import\b)/,/^(?:void\b)/,/^(?:int\b)/,/^(?:bool\b)/,/^(?:return\b)/,/^(?:turnoff\b)/,/^(?:turnleft\b)/,/^(?:move\b)/,/^(?:pickbeeper\b)/,/^(?:putbeeper\b)/,/^(?:continue\b)/,/^(?:break\b)/,/^(?:while\b)/,/^(?:iterate\b)/,/^(?:pred\b)/,/^(?:succ\b)/,/^(?:iszero\b)/,/^(?:frontIsClear\b)/,/^(?:frontIsBlocked\b)/,/^(?:leftIsClear\b)/,/^(?:leftIsBlocked\b)/,/^(?:rightIsClear\b)/,/^(?:rightIsBlocked\b)/,/^(?:nextToABeeper\b)/,/^(?:notNextToABeeper\b)/,/^(?:anyBeepersInBeeperBag\b)/,/^(?:noBeepersInBeeperBag\b)/,/^(?:facingNorth\b)/,/^(?:facingSouth\b)/,/^(?:facingEast\b)/,/^(?:facingWest\b)/,/^(?:notFacingNorth\b)/,/^(?:notFacingSouth\b)/,/^(?:notFacingEast\b)/,/^(?:notFacingWest\b)/,/^(?:else\b)/,/^(?:if\b)/,/^(?:!)/,/^(?:\|\|)/,/^(?:&&)/,/^(?:&)/,/^(?:\()/,/^(?:\))/,/^(?:\{)/,/^(?:\})/,/^(?:;)/,/^(?:\.)/,/^(?:\*)/,/^(?:,)/,/^(?:==)/,/^(?:<=)/,/^(?:<)/,/^(?:[0-9]+)/,/^(?:[A-Za-zÀ-ÖØ-öø-ÿ_][A-Za-zÀ-ÖØ-öø-ÿ0-9_-]*)/,/^(?:$)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60],inclusive:!0}}};return lexer}();function Parser(){this.yy={}}return parser.lexer=lexer,Parser.prototype=parser,parser.Parser=Parser,new Parser}();var karelpascal=function(){var o=function(k,v,o,l){for(o=o||{},l=k.length;l--;o[k[l]]=v);return o},$V0=[1,5],$V1=[1,16],$V2=[1,17],$V3=[1,18],$V4=[1,13],$V5=[1,14],$V6=[1,15],$V7=[5,13],$V8=[9,15],$V9=[2,28],$Va=[1,47],$Vb=[1,28],$Vc=[1,29],$Vd=[1,30],$Ve=[1,31],$Vf=[1,32],$Vg=[1,33],$Vh=[1,34],$Vi=[1,40],$Vj=[1,41],$Vk=[1,44],$Vl=[1,45],$Vm=[1,46],$Vn=[1,58],$Vo=[9,15,50],$Vp=[9,15,50,58],$Vq=[1,62],$Vr=[1,61],$Vs=[1,64],$Vt=[1,69],$Vu=[1,70],$Vv=[1,71],$Vw=[1,72],$Vx=[1,73],$Vy=[1,74],$Vz=[1,75],$VA=[1,76],$VB=[1,77],$VC=[1,78],$VD=[1,79],$VE=[1,80],$VF=[1,81],$VG=[1,82],$VH=[1,83],$VI=[1,84],$VJ=[1,85],$VK=[1,86],$VL=[1,88],$VM=[1,89],$VN=[1,90],$VO=[1,91],$VP=[7,30,31,32,33,34,35],$VQ=[1,108],$VR=[1,109],$VS=[1,110],$VT=[1,111],$VU=[1,112],$VV=[9,15,24,29,50,57,58,60,63,64,65,66,67,68],$VW=[24,29],$VX=[9,15,24,29,50,57,58,60,63,64,65],$VY=[9,15,24,29,50,57,58,60,63,64,65,66],parser={trace:function(){},yy:{},symbols_:{error:2,program:3,import_list:4,BEGINPROG:5,def_list:6,BEGINEXEC:7,expr_list:8,ENDEXEC:9,ENDPROG:10,EOF:11,import:12,IMPORT:13,package:14,";":15,VAR:16,".":17,"*":18,def:19,prototype_type:20,var:21,"(":22,paramList:23,")":24,funct_type:25,AS:26,expr:27,param:28,",":29,DEF_INT:30,DEF_BOOL:31,DEF:32,PROTO_INT:33,PROTO_BOOL:34,PROTO:35,genexpr:36,FORWARD:37,LEFT:38,PICKBUZZER:39,LEAVEBUZZER:40,HALT:41,CONTINUE:42,BREAK:43,return:44,call:45,cond:46,loop:47,repeat:48,BEGIN:49,END:50,RET:51,term:52,parameteredCall:53,int_termList:54,IF:55,bool_term:56,THEN:57,ELSE:58,WHILE:59,DO:60,REPEAT:61,int_term:62,TIMES:63,OR:64,AND:65,"==":66,"<":67,"<=":68,NOT:69,clause:70,IFZ:71,bool_fun:72,integer:73,IFNFWALL:74,IFFWALL:75,IFNLWALL:76,IFLWALL:77,IFNRWALL:78,IFRWALL:79,IFWBUZZER:80,IFNWBUZZER:81,IFBBUZZER:82,IFNBBUZZER:83,IFW:84,IFN:85,IFE:86,IFS:87,IFNW:88,IFNN:89,IFNE:90,IFNS:91,int_literal:92,INC:93,DEC:94,NUM:95,$accept:0,$end:1},terminals_:{2:"error",5:"BEGINPROG",7:"BEGINEXEC",9:"ENDEXEC",10:"ENDPROG",11:"EOF",13:"IMPORT",15:";",16:"VAR",17:".",18:"*",22:"(",24:")",26:"AS",29:",",30:"DEF_INT",31:"DEF_BOOL",32:"DEF",33:"PROTO_INT",34:"PROTO_BOOL",35:"PROTO",37:"FORWARD",38:"LEFT",39:"PICKBUZZER",40:"LEAVEBUZZER",41:"HALT",42:"CONTINUE",43:"BREAK",49:"BEGIN",50:"END",51:"RET",55:"IF",57:"THEN",58:"ELSE",59:"WHILE",60:"DO",61:"REPEAT",63:"TIMES",64:"OR",65:"AND",66:"==",67:"<",68:"<=",69:"NOT",71:"IFZ",74:"IFNFWALL",75:"IFFWALL",76:"IFNLWALL",77:"IFLWALL",78:"IFNRWALL",79:"IFRWALL",80:"IFWBUZZER",81:"IFNWBUZZER",82:"IFBBUZZER",83:"IFNBBUZZER",84:"IFW",85:"IFN",86:"IFE",87:"IFS",88:"IFNW",89:"IFNN",90:"IFNE",91:"IFNS",93:"INC",94:"DEC",95:"NUM"},productions_:[0,[3,8],[3,7],[3,7],[3,6],[4,2],[4,1],[12,3],[14,3],[14,3],[6,3],[6,2],[19,2],[19,5],[19,4],[19,7],[23,3],[23,1],[28,1],[25,1],[25,1],[25,1],[20,1],[20,1],[20,1],[8,3],[8,1],[36,1],[36,0],[27,1],[27,1],[27,1],[27,1],[27,1],[27,1],[27,1],[27,1],[27,1],[27,1],[27,1],[27,1],[27,3],[44,1],[44,2],[45,1],[45,1],[53,4],[54,3],[54,1],[46,4],[46,6],[47,4],[48,4],[52,3],[52,3],[52,3],[52,3],[52,3],[52,2],[52,3],[52,1],[56,1],[62,1],[70,4],[70,1],[70,1],[70,1],[70,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[72,1],[73,1],[73,4],[73,4],[73,6],[73,6],[92,1],[21,1]],performAction:function(yytext,yyleng,yylineno,yy,yystate,$$,_$){var $0=$$.length-1;switch(yystate){case 1:return resetCompiler(),{compiler:COMPILER,language:LANG,requieresFunctionPrototypes:reqsPrototypes,variablesCanBeFunctions:VarsAsFuncs,packages:$$[$0-7],functions:$$[$0-5],program:$$[$0-3].concat([["LINE",yylineno,0],["HALT"]]),yy:yy};case 2:return resetCompiler(),{compiler:COMPILER,language:LANG,requieresFunctionPrototypes:reqsPrototypes,variablesCanBeFunctions:VarsAsFuncs,packages:$$[$0-6],functions:[],program:$$[$0-3].concat([["LINE",yylineno,0],["HALT"]]),yy:yy};case 3:return resetCompiler(),{compiler:COMPILER,language:LANG,requieresFunctionPrototypes:reqsPrototypes,variablesCanBeFunctions:VarsAsFuncs,packages:[],functions:$$[$0-5],program:$$[$0-3].concat([["LINE",yylineno,0],["HALT"]]),yy:yy};case 4:return resetCompiler(),{compiler:COMPILER,language:LANG,requieresFunctionPrototypes:reqsPrototypes,variablesCanBeFunctions:VarsAsFuncs,packages:[],functions:[],program:$$[$0-3].concat([["LINE",yylineno,0],["HALT"]]),yy:yy};case 5:this.$=$$[$0-1].concat($$[$0]);break;case 6:case 17:case 26:case 27:case 36:case 37:case 38:case 39:case 40:case 45:case 60:this.$=$$[$0];break;case 7:this.$=[[$$[$0-1],_$[$0-1]]];break;case 8:this.$=$$[$0-2]+"."+$$[$0];break;case 9:this.$=$$[$0-2]+".*";break;case 10:this.$=$$[$0-2].concat($$[$0-1]);break;case 11:case 41:this.$=$$[$0-1];break;case 12:this._$.first_line=_$[$0-1].first_line,this._$.first_column=_$[$0-1].first_column,this._$.last_line=_$[$0].last_line,this._$.last_column=_$[$0].last_column,this.$=[{name:$$[$0].toLowerCase(),code:null,params:[],loc:this._$,returnType:$$[$0-1]}];break;case 13:this._$.first_line=_$[$0-4].first_line,this._$.first_column=_$[$0-4].first_column,this._$.last_line=_$[$0].last_line,this._$.last_column=_$[$0].last_column,this.$=[{name:$$[$0-3].toLowerCase(),code:null,params:$$[$0-1],loc:this._$,returnType:$$[$0-4]}];break;case 14:this._$.first_line=_$[$0-3].first_line,this._$.first_column=_$[$0-3].first_column,this._$.last_line=_$[$0-2].last_line,this._$.last_column=_$[$0-2].last_column,this.$=[{name:$$[$0-2].toLowerCase(),code:[locToIR(_$[$0-2]),...$$[$0],["RET","__DEFAULT",{first_line:_$[$0].last_line,first_column:_$[$0].last_column,last_line:_$[$0].last_line,last_column:_$[$0].last_column}]],params:[],loc:this._$,returnType:$$[$0-3]}];break;case 15:this._$.first_line=_$[$0-6].first_line,this._$.first_column=_$[$0-6].first_column,this._$.last_line=_$[$0-5].last_line,this._$.last_column=_$[$0-5].last_column,this.$=[{name:$$[$0-5].toLowerCase(),code:[locToIR(_$[$0-5]),...$$[$0],["RET","__DEFAULT",{first_line:_$[$0].last_line,first_column:_$[$0].last_column,last_line:_$[$0].last_line,last_line:_$[$0].last_column}]],params:$$[$0-3],loc:this._$,returnType:$$[$0-6]}];break;case 16:case 25:this.$=$$[$0-2].concat($$[$0]);break;case 18:this.$=[{name:$$[$0],loc:_$[$0]}];break;case 19:case 22:this.$="INT";break;case 20:case 23:this.$="BOOL";break;case 21:case 24:this.$="VOID";break;case 28:this.$=[];break;case 29:this.$=[locToIR(_$[$0]),["FORWARD"]];break;case 30:this.$=[locToIR(_$[$0]),["LEFT"]];break;case 31:this.$=[locToIR(_$[$0]),["PICKBUZZER"]];break;case 32:this.$=[locToIR(_$[$0]),["LEAVEBUZZER"]];break;case 33:this.$=[locToIR(_$[$0]),["HALT"]];break;case 34:this.$=[locToIR(_$[$0]),["CONTINUE",_$[$0]]];break;case 35:this.$=[locToIR(_$[$0]),["BREAK",_$[$0]]];break;case 42:this.$=[["RET",{term:{operation:"ATOM",instructions:[["LOAD",0]],atomType:"IMPLICIT.0",dataType:"VOID"},loc:_$[$0]}]];break;case 43:this.$=[["RET",{term:$$[$0],loc:_$[$0-1]}]];break;case 44:this.$=[["CALL",{target:$$[$0].toLowerCase(),params:[],nameLoc:_$[$0],argLoc:_$[$0]}]];break;case 46:this.$=[["CALL",{target:$$[$0-3].toLowerCase(),params:$$[$0-1],nameLoc:_$[$0-3],argLoc:_$[$0-1]}]];break;case 47:this.$=$$[$0-2].concat([{term:$$[$0],operation:"PASS",dataType:"INT",loc:_$[$0],totalLoc:_$[$0]}]);break;case 48:this.$=[{term:$$[$0],operation:"PASS",dataType:"INT",loc:_$[$0],totalLoc:_$[$0]}];break;case 49:const skipTag=UniqueTag("iskip");this.$=[["IF",{condition:$$[$0-2][0],line:locToIR(_$[$0-3]),skipTrueTag:skipTag,trueCase:$$[$0]}]];break;case 50:const toElse=UniqueTag("ielse"),skipElse=UniqueTag("iskipelse");this.$=[["IF",{condition:$$[$0-4][0],line:locToIR(_$[$0-5]),skipTrueTag:toElse,skipFalseTag:skipElse,trueCase:$$[$0-2],falseCase:$$[$0]}]];break;case 51:const repeatTag=UniqueTag("lrepeat"),endTag=UniqueTag("lend");this.$=[["WHILE",{condition:$$[$0-2][0],line:locToIR(_$[$0-3]),repeatTag:repeatTag,endTag:endTag,instructions:$$[$0]}]];break;case 52:const repeatEnd=UniqueTag("rend"),repeatLoop=UniqueTag("rloop"),continueLoop=UniqueTag("rcontinue");this.$=[["REPEAT",{line:locToIR(_$[$0-3]),loopCount:$$[$0-2][0],repeatTag:repeatLoop,endTag:repeatEnd,continueTag:continueLoop,instructions:$$[$0]}]];break;case 53:this.$={left:$$[$0-2],right:$$[$0],operation:"OR",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 54:this.$={left:$$[$0-2],right:$$[$0],operation:"AND",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 55:this.$={left:$$[$0-2],right:$$[$0],operation:"EQ",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 56:this.$={left:$$[$0-2],right:$$[$0],operation:"LT",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 57:this.$={left:$$[$0-2],right:$$[$0],operation:"LTE",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 58:this.$={term:$$[$0],operation:"NOT",dataType:"BOOL",loc:_$[$0-1],totalLoc:this._$};break;case 59:this.$={term:$$[$0-1],operation:"PARENTHESIS",dataType:$$[$0-1].dataType,loc:$$[$0-1].loc,totalLoc:this._$};break;case 61:this.$=[["TERM",{term:$$[$0],operation:"PASS",dataType:"BOOL",loc:_$[$0],totalLoc:_$[$0]}]];break;case 62:this.$=[["TERM",{term:$$[$0],operation:"PASS",dataType:"INT",loc:_$[$0],totalLoc:_$[$0]}]];break;case 63:this.$={operation:"ATOM",instructions:$$[$0-1].concat([["NOT"]]),dataType:"BOOL",atomType:"IS_ZERO",loc:_$[$0-3],totalLoc:this._$};break;case 64:this.$={operation:"ATOM",instructions:$$[$0].code,atomType:$$[$0].name,dataType:"BOOL",loc:_$[$0],totalLoc:_$[$0]};break;case 65:this.$={operation:"ATOM",instructions:$$[$0].code,atomType:$$[$0].data,dataType:"INT",loc:_$[$0],totalLoc:_$[$0]};break;case 66:const ir=[["VAR",{target:$$[$0].toLowerCase(),loc:_$[$0],couldBeFunction:!0}]];this.$={operation:"ATOM",instructions:ir,dataType:"$"+$$[$0].toLowerCase(),atomType:`VAR.${$$[$0].toLowerCase()}`,loc:_$[$0],totalLoc:_$[$0]};break;case 67:const callIR=$$[$0],callData=callIR[0][1];this.$={operation:"ATOM",instructions:[...callIR,["LRET"]],dataType:"$"+callData.target,atomType:"CALL",loc:_$[$0],totalLoc:_$[$0]};break;case 68:this.$={name:"IFNFWALL",code:[["WORLDWALLS"],["ORIENTATION"],["MASK"],["AND"],["NOT"]]};break;case 69:this.$={name:"IFFWALL",code:[["WORLDWALLS"],["ORIENTATION"],["MASK"],["AND"]]};break;case 70:this.$={name:"IFNLWALL",code:[["WORLDWALLS"],["ORIENTATION"],["ROTL"],["MASK"],["AND"],["NOT"]]};break;case 71:this.$={name:"IFLWALL",code:[["WORLDWALLS"],["ORIENTATION"],["ROTL"],["MASK"],["AND"]]};break;case 72:this.$={name:"IFNRWALL",code:[["WORLDWALLS"],["ORIENTATION"],["ROTR"],["MASK"],["AND"],["NOT"]]};break;case 73:this.$={name:"IFRWALL",code:[["WORLDWALLS"],["ORIENTATION"],["ROTR"],["MASK"],["AND"]]};break;case 74:this.$={name:"IFWBUZZER",code:[["WORLDBUZZERS"],["LOAD",0],["EQ"],["NOT"]]};break;case 75:this.$={name:"IFNWBUZZER",code:[["WORLDBUZZERS"],["NOT"]]};break;case 76:this.$={name:"IFBBUZZER",code:[["BAGBUZZERS"],["LOAD",0],["EQ"],["NOT"]]};break;case 77:this.$={name:"IFNBBUZZER",code:[["BAGBUZZERS"],["NOT"]]};break;case 78:this.$={name:"IFW",code:[["ORIENTATION"],["LOAD",0],["EQ"]]};break;case 79:this.$={name:"IFN",code:[["ORIENTATION"],["LOAD",1],["EQ"]]};break;case 80:this.$={name:"IFE",code:[["ORIENTATION"],["LOAD",2],["EQ"]]};break;case 81:this.$={name:"IFS",code:[["ORIENTATION"],["LOAD",3],["EQ"]]};break;case 82:this.$={name:"IFNW",code:[["ORIENTATION"],["LOAD",0],["EQ"],["NOT"]]};break;case 83:this.$={name:"IFNN",code:[["ORIENTATION"],["LOAD",1],["EQ"],["NOT"]]};break;case 84:this.$={name:"IFNE",code:[["ORIENTATION"],["LOAD",2],["EQ"],["NOT"]]};break;case 85:this.$={name:"IFNS",code:[["ORIENTATION"],["LOAD",3],["EQ"],["NOT"]]};break;case 86:this.$={data:`NUMBER.${$$[$0]}`,code:[["LOAD",$$[$0]]]};break;case 87:this.$={data:"INC",code:$$[$0-1].concat([["INC",1]])};break;case 88:this.$={data:"DEC",code:$$[$0-1].concat([["DEC",1]])};break;case 89:this.$={data:`INC.${$$[$0-1]}`,code:$$[$0-3].concat([["INC",$$[$0-1]]])};break;case 90:this.$={data:`DEC.${$$[$0-1]}`,code:$$[$0-3].concat([["DEC",$$[$0-1]]])};break;case 91:this.$=parseInt(yytext);break;case 92:this.$=yytext}},table:[{3:1,4:2,5:[1,3],12:4,13:$V0},{1:[3]},{5:[1,6],12:7,13:$V0},{6:8,7:[1,9],19:10,20:11,25:12,30:$V1,31:$V2,32:$V3,33:$V4,34:$V5,35:$V6},o($V7,[2,6]),{14:19,16:[1,20]},{6:21,7:[1,22],19:10,20:11,25:12,30:$V1,31:$V2,32:$V3,33:$V4,34:$V5,35:$V6},o($V7,[2,5]),{7:[1,23],19:24,20:11,25:12,30:$V1,31:$V2,32:$V3,33:$V4,34:$V5,35:$V6},o($V8,$V9,{8:25,36:26,27:27,44:35,45:36,46:37,47:38,48:39,21:42,53:43,16:$Va,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,49:$Vi,51:$Vj,55:$Vk,59:$Vl,61:$Vm}),{15:[1,48]},{16:$Va,21:49},{16:$Va,21:50},{16:[2,22]},{16:[2,23]},{16:[2,24]},{16:[2,19]},{16:[2,20]},{16:[2,21]},{15:[1,51]},{17:[1,52]},{7:[1,53],19:24,20:11,25:12,30:$V1,31:$V2,32:$V3,33:$V4,34:$V5,35:$V6},o($V8,$V9,{36:26,27:27,44:35,45:36,46:37,47:38,48:39,21:42,53:43,8:54,16:$Va,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,49:$Vi,51:$Vj,55:$Vk,59:$Vl,61:$Vm}),o($V8,$V9,{36:26,27:27,44:35,45:36,46:37,47:38,48:39,21:42,53:43,8:55,16:$Va,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,49:$Vi,51:$Vj,55:$Vk,59:$Vl,61:$Vm}),{15:[1,56]},{9:[1,57],15:$Vn},o($Vo,[2,26]),o($Vo,[2,27]),o($Vp,[2,29]),o($Vp,[2,30]),o($Vp,[2,31]),o($Vp,[2,32]),o($Vp,[2,33]),o($Vp,[2,34]),o($Vp,[2,35]),o($Vp,[2,36]),o($Vp,[2,37]),o($Vp,[2,38]),o($Vp,[2,39]),o($Vp,[2,40]),o([15,50],$V9,{36:26,27:27,44:35,45:36,46:37,47:38,48:39,21:42,53:43,8:59,16:$Va,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,49:$Vi,51:$Vj,55:$Vk,59:$Vl,61:$Vm}),o($Vp,[2,42],{52:60,70:63,72:65,73:66,21:67,53:68,92:87,16:$Va,22:$Vq,69:$Vr,71:$Vs,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,93:$VL,94:$VM,95:$VN}),o($Vp,[2,44],{22:$VO}),o($Vp,[2,45]),{16:$Va,21:67,22:$Vq,52:93,53:68,56:92,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{16:$Va,21:67,22:$Vq,52:93,53:68,56:94,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{16:$Va,21:67,22:$Vq,52:96,53:68,62:95,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},o([9,15,22,24,26,29,50,57,58,60,63,64,65,66,67,68],[2,92]),o($VP,[2,11]),{15:[2,12],22:[1,97]},{22:[1,99],26:[1,98]},o($V7,[2,7]),{16:[1,100],18:[1,101]},o($V8,$V9,{36:26,27:27,44:35,45:36,46:37,47:38,48:39,21:42,53:43,8:102,16:$Va,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,49:$Vi,51:$Vj,55:$Vk,59:$Vl,61:$Vm}),{9:[1,103],15:$Vn},{9:[1,104],15:$Vn},o($VP,[2,10]),{10:[1,105]},o($Vo,$V9,{27:27,44:35,45:36,46:37,47:38,48:39,21:42,53:43,36:106,16:$Va,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,49:$Vi,51:$Vj,55:$Vk,59:$Vl,61:$Vm}),{15:$Vn,50:[1,107]},o($Vp,[2,43],{64:$VQ,65:$VR,66:$VS,67:$VT,68:$VU}),{16:$Va,21:67,22:$Vq,52:113,53:68,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{16:$Va,21:67,22:$Vq,52:114,53:68,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},o($VV,[2,60]),{22:[1,115]},o($VV,[2,64]),o($VV,[2,65]),o($VV,[2,66],{22:$VO}),o($VV,[2,67]),o($VV,[2,68]),o($VV,[2,69]),o($VV,[2,70]),o($VV,[2,71]),o($VV,[2,72]),o($VV,[2,73]),o($VV,[2,74]),o($VV,[2,75]),o($VV,[2,76]),o($VV,[2,77]),o($VV,[2,78]),o($VV,[2,79]),o($VV,[2,80]),o($VV,[2,81]),o($VV,[2,82]),o($VV,[2,83]),o($VV,[2,84]),o($VV,[2,85]),o($VV,[2,86]),{22:[1,116]},{22:[1,117]},o($VV,[2,91]),{16:$Va,21:67,22:$Vq,52:119,53:68,54:118,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{57:[1,120]},o([57,60],[2,61],{64:$VQ,65:$VR,66:$VS,67:$VT,68:$VU}),{60:[1,121]},{63:[1,122]},o([24,29,63],[2,62],{64:$VQ,65:$VR,66:$VS,67:$VT,68:$VU}),{16:$Va,21:125,23:123,28:124},{16:$Va,21:42,27:126,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,44:35,45:36,46:37,47:38,48:39,49:$Vi,51:$Vj,53:43,55:$Vk,59:$Vl,61:$Vm},{16:$Va,21:125,23:127,28:124},{15:[2,8]},{15:[2,9]},{9:[1,128],15:$Vn},{10:[1,129]},{10:[1,130]},{11:[1,131]},o($Vo,[2,25]),o($Vp,[2,41]),{16:$Va,21:67,22:$Vq,52:132,53:68,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{16:$Va,21:67,22:$Vq,52:133,53:68,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{16:$Va,21:67,22:$Vq,52:134,53:68,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{16:$Va,21:67,22:$Vq,52:135,53:68,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{16:$Va,21:67,22:$Vq,52:136,53:68,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},o($VV,[2,58]),{24:[1,137],64:$VQ,65:$VR,66:$VS,67:$VT,68:$VU},{16:$Va,21:67,22:$Vq,52:96,53:68,62:138,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{16:$Va,21:67,22:$Vq,52:96,53:68,62:139,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{16:$Va,21:67,22:$Vq,52:96,53:68,62:140,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},{24:[1,141],29:[1,142]},o($VW,[2,48],{64:$VQ,65:$VR,66:$VS,67:$VT,68:$VU}),{16:$Va,21:42,27:143,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,44:35,45:36,46:37,47:38,48:39,49:$Vi,51:$Vj,53:43,55:$Vk,59:$Vl,61:$Vm},{16:$Va,21:42,27:144,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,44:35,45:36,46:37,47:38,48:39,49:$Vi,51:$Vj,53:43,55:$Vk,59:$Vl,61:$Vm},{16:$Va,21:42,27:145,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,44:35,45:36,46:37,47:38,48:39,49:$Vi,51:$Vj,53:43,55:$Vk,59:$Vl,61:$Vm},{24:[1,146]},{24:[2,17],29:[1,147]},o($VW,[2,18]),{15:[2,14]},{24:[1,148]},{10:[1,149]},{11:[1,150]},{11:[1,151]},{1:[2,4]},o([9,15,24,29,50,57,58,60,63,64],[2,53],{65:$VR,66:$VS,67:$VT,68:$VU}),o($VX,[2,54],{66:$VS,67:$VT,68:$VU}),o($VX,[2,55],{67:$VT,68:$VU}),o($VY,[2,56]),o($VY,[2,57]),o($VV,[2,59]),{24:[1,152]},{24:[1,153],29:[1,154]},{24:[1,155],29:[1,156]},o($VV,[2,46]),{16:$Va,21:67,22:$Vq,52:157,53:68,69:$Vr,70:63,71:$Vs,72:65,73:66,74:$Vt,75:$Vu,76:$Vv,77:$Vw,78:$Vx,79:$Vy,80:$Vz,81:$VA,82:$VB,83:$VC,84:$VD,85:$VE,86:$VF,87:$VG,88:$VH,89:$VI,90:$VJ,91:$VK,92:87,93:$VL,94:$VM,95:$VN},o($Vo,[2,49],{58:[1,158]}),o($Vp,[2,51]),o($Vp,[2,52]),{15:[2,13]},{16:$Va,21:125,23:159,28:124},{26:[1,160]},{11:[1,161]},{1:[2,2]},{1:[2,3]},o($VV,[2,63]),o($VV,[2,87]),{92:162,95:$VN},o($VV,[2,88]),{92:163,95:$VN},o($VW,[2,47],{64:$VQ,65:$VR,66:$VS,67:$VT,68:$VU}),{16:$Va,21:42,27:164,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,44:35,45:36,46:37,47:38,48:39,49:$Vi,51:$Vj,53:43,55:$Vk,59:$Vl,61:$Vm},{24:[2,16]},{16:$Va,21:42,27:165,37:$Vb,38:$Vc,39:$Vd,40:$Ve,41:$Vf,42:$Vg,43:$Vh,44:35,45:36,46:37,47:38,48:39,49:$Vi,51:$Vj,53:43,55:$Vk,59:$Vl,61:$Vm},{1:[2,1]},{24:[1,166]},{24:[1,167]},o($Vp,[2,50]),{15:[2,15]},o($VV,[2,89]),o($VV,[2,90])],defaultActions:{13:[2,22],14:[2,23],15:[2,24],16:[2,19],17:[2,20],18:[2,21],100:[2,8],101:[2,9],126:[2,14],131:[2,4],146:[2,13],150:[2,2],151:[2,3],159:[2,16],161:[2,1],165:[2,15]},parseError:function(str,hash){if(!hash.recoverable){var error=new Error(str);throw error.hash=hash,error}this.trace(str)},parse:function(input){var self=this,stack=[0],vstack=[null],lstack=[],table=this.table,yytext="",yylineno=0,yyleng=0,args=lstack.slice.call(arguments,1),lexer=Object.create(this.lexer),sharedState={yy:{}};for(var k in this.yy)Object.prototype.hasOwnProperty.call(this.yy,k)&&(sharedState.yy[k]=this.yy[k]);lexer.setInput(input,sharedState.yy),sharedState.yy.lexer=lexer,sharedState.yy.parser=this,void 0===lexer.yylloc&&(lexer.yylloc={});var yyloc=lexer.yylloc;lstack.push(yyloc);var ranges=lexer.options&&lexer.options.ranges;"function"==typeof sharedState.yy.parseError?this.parseError=sharedState.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var symbol,state,action,r,p,len,newState,expected,token,yyval={};;){if(state=stack[stack.length-1],this.defaultActions[state]?action=this.defaultActions[state]:(null==symbol&&(token=void 0,"number"!=typeof(token=lexer.lex()||1)&&(token=self.symbols_[token]||token),symbol=token),action=table[state]&&table[state][symbol]),void 0===action||!action.length||!action[0]){var errStr="";for(p in expected=[],table[state])this.terminals_[p]&&p>2&&expected.push("'"+this.terminals_[p]+"'");errStr=lexer.showPosition?"Parse error on line "+(yylineno+1)+":\n"+lexer.showPosition()+"\nExpecting "+expected.join(", ")+", got '"+(this.terminals_[symbol]||symbol)+"'":"Parse error on line "+(yylineno+1)+": Unexpected "+(1==symbol?"end of input":"'"+(this.terminals_[symbol]||symbol)+"'"),this.parseError(errStr,{text:lexer.match,token:this.terminals_[symbol]||symbol,line:lexer.yylineno,loc:lexer.yylloc,expected:expected})}if(action[0]instanceof Array&&action.length>1)throw new Error("Parse Error: multiple actions possible at state: "+state+", token: "+symbol);switch(action[0]){case 1:stack.push(symbol),vstack.push(lexer.yytext),lstack.push(lexer.yylloc),stack.push(action[1]),symbol=null,yyleng=lexer.yyleng,yytext=lexer.yytext,yylineno=lexer.yylineno,yyloc=lexer.yylloc;break;case 2:if(len=this.productions_[action[1]][1],yyval.$=vstack[vstack.length-len],yyval._$={first_line:lstack[lstack.length-(len||1)].first_line,last_line:lstack[lstack.length-1].last_line,first_column:lstack[lstack.length-(len||1)].first_column,last_column:lstack[lstack.length-1].last_column},ranges&&(yyval._$.range=[lstack[lstack.length-(len||1)].range[0],lstack[lstack.length-1].range[1]]),void 0!==(r=this.performAction.apply(yyval,[yytext,yyleng,yylineno,sharedState.yy,action[1],vstack,lstack].concat(args))))return r;len&&(stack=stack.slice(0,-1*len*2),vstack=vstack.slice(0,-1*len),lstack=lstack.slice(0,-1*len)),stack.push(this.productions_[action[1]][0]),vstack.push(yyval.$),lstack.push(yyval._$),newState=table[stack[stack.length-2]][stack[stack.length-1]],stack.push(newState);break;case 3:return!0}}return!0}};const COMPILER="RKP 1.0.0",LANG="ReKarel Pascal",VarsAsFuncs=!0,reqsPrototypes=!1;let tagCnt=1;function UniqueTag(tag){return`${tag}.${tagCnt++}`}function resetCompiler(tag){tagCnt=1}function locToIR(loc){return["LINE",loc.first_line-1,loc.first_column]}var lexer=function(){var lexer={EOF:1,parseError:function(str,hash){if(!this.yy.parser)throw new Error(str);this.yy.parser.parseError(str,hash)},setInput:function(input,yy){return this.yy=yy||this.yy||{},this._input=input,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var ch=this._input[0];return this.yytext+=ch,this.yyleng++,this.offset++,this.match+=ch,this.matched+=ch,ch.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),ch},unput:function(ch){var len=ch.length,lines=ch.split(/(?:\r\n?|\n)/g);this._input=ch+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-len),this.offset-=len;var oldLines=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),lines.length-1&&(this.yylineno-=lines.length-1);var r=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:lines?(lines.length===oldLines.length?this.yylloc.first_column:0)+oldLines[oldLines.length-lines.length].length-lines[0].length:this.yylloc.first_column-len},this.options.ranges&&(this.yylloc.range=[r[0],r[0]+this.yyleng-len]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(n){this.unput(this.match.slice(n))},pastInput:function(){var past=this.matched.substr(0,this.matched.length-this.match.length);return(past.length>20?"...":"")+past.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var next=this.match;return next.length<20&&(next+=this._input.substr(0,20-next.length)),(next.substr(0,20)+(next.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var pre=this.pastInput(),c=new Array(pre.length+1).join("-");return pre+this.upcomingInput()+"\n"+c+"^"},test_match:function(match,indexed_rule){var token,lines,backup;if(this.options.backtrack_lexer&&(backup={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(backup.yylloc.range=this.yylloc.range.slice(0))),(lines=match[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=lines.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:lines?lines[lines.length-1].length-lines[lines.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+match[0].length},this.yytext+=match[0],this.match+=match[0],this.matches=match,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(match[0].length),this.matched+=match[0],token=this.performAction.call(this,this.yy,this,indexed_rule,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),token)return token;if(this._backtrack){for(var k in backup)this[k]=backup[k];return!1}return!1},next:function(){if(this.done)return this.EOF;var token,match,tempMatch,index;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var rules=this._currentRules(),i=0;i<rules.length;i++)if((tempMatch=this._input.match(this.rules[rules[i]]))&&(!match||tempMatch[0].length>match[0].length)){if(match=tempMatch,index=i,this.options.backtrack_lexer){if(!1!==(token=this.test_match(tempMatch,rules[i])))return token;if(this._backtrack){match=!1;continue}return!1}if(!this.options.flex)break}return match?!1!==(token=this.test_match(match,rules[index]))&&token:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var r=this.next();return r||this.lex()},begin:function(condition){this.conditionStack.push(condition)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(n){return(n=this.conditionStack.length-1-Math.abs(n||0))>=0?this.conditionStack[n]:"INITIAL"},pushState:function(condition){this.begin(condition)},stateStackSize:function(){return this.conditionStack.length},options:{flex:!0},performAction:function(yy,yy_,$avoiding_name_collisions,YY_START){switch($avoiding_name_collisions){case 0:case 1:case 2:break;case 3:return 5;case 4:case 5:return 7;case 6:case 7:return 9;case 8:return 10;case 9:case 10:case 11:return 32;case 12:return 13;case 13:case 14:return 35;case 15:case 16:return 33;case 17:case 18:return 30;case 19:case 20:return 34;case 21:case 22:return 31;case 23:case 24:case 25:return 51;case 26:return 26;case 27:case 28:return 41;case 29:return 38;case 30:return 37;case 31:return 39;case 32:return 40;case 33:case 34:return 42;case 35:return 43;case 36:return 49;case 37:return 50;case 38:return 57;case 39:return 59;case 40:return 60;case 41:return 61;case 42:return 63;case 43:return 94;case 44:return 93;case 45:case 46:return 71;case 47:return 74;case 48:return 75;case 49:return 76;case 50:return 77;case 51:return 78;case 52:return 79;case 53:return 80;case 54:return 81;case 55:case 56:return 82;case 57:case 58:return 83;case 59:return 85;case 60:return 87;case 61:return 86;case 62:return 84;case 63:return 89;case 64:return 91;case 65:return 90;case 66:return 88;case 67:case 68:return 58;case 69:return 55;case 70:return 69;case 71:case 72:return 64;case 73:case 74:return 65;case 75:return 22;case 76:return 24;case 77:return 15;case 78:return 17;case 79:return 29;case 80:return 18;case 81:return 66;case 82:return 68;case 83:return 67;case 84:return 95;case 85:return 16;case 86:return 11;case 87:console.log(yy_.yytext)}},rules:[/^(?:\s+)/,/^(?:\{[^}]*\})/,/^(?:\(\*(?:[^*]|\*(?!\)))*\*\))/,/^(?:iniciar-programa)/,/^(?:inicia-ejecucion)/,/^(?:inicia-ejecución)/,/^(?:termina-ejecucion)/,/^(?:termina-ejecución)/,/^(?:finalizar-programa)/,/^(?:define-nueva-instruccion)/,/^(?:define-nueva-instrucción)/,/^(?:define)/,/^(?:usa)/,/^(?:define-prototipo-instruccion)/,/^(?:define-prototipo-instrucción)/,/^(?:define-prototipo-calculo)/,/^(?:define-prototipo-cálculo)/,/^(?:define-calculo)/,/^(?:define-cálculo)/,/^(?:define-prototipo-condicion)/,/^(?:define-prototipo-condición)/,/^(?:define-condicion)/,/^(?:define-condición)/,/^(?:sal-de-instruccion)/,/^(?:sal-de-instrucción)/,/^(?:regresa)/,/^(?:como)/,/^(?:apagate)/,/^(?:apágate)/,/^(?:gira-izquierda)/,/^(?:avanza)/,/^(?:coge-zumbador)/,/^(?:deja-zumbador)/,/^(?:continua)/,/^(?:continúa)/,/^(?:rompe)/,/^(?:inicio)/,/^(?:fin)/,/^(?:entonces)/,/^(?:mientras)/,/^(?:hacer)/,/^(?:repetir)/,/^(?:veces)/,/^(?:precede)/,/^(?:sucede)/,/^(?:si-es-cero)/,/^(?:es-cero)/,/^(?:frente-libre)/,/^(?:frente-bloqueado)/,/^(?:izquierda-libre)/,/^(?:izquierda-bloqueada)/,/^(?:derecha-libre)/,/^(?:derecha-bloqueada)/,/^(?:junto-a-zumbador)/,/^(?:no-junto-a-zumbador)/,/^(?:algun-zumbador-en-la-mochila)/,/^(?:algún-zumbador-en-la-mochila)/,/^(?:ningun-zumbador-en-la-mochila)/,/^(?:ningún-zumbador-en-la-mochila)/,/^(?:orientado-al-norte)/,/^(?:orientado-al-sur)/,/^(?:orientado-al-este)/,/^(?:orientado-al-oeste)/,/^(?:no-orientado-al-norte)/,/^(?:no-orientado-al-sur)/,/^(?:no-orientado-al-este)/,/^(?:no-orientado-al-oeste)/,/^(?:sino)/,/^(?:si-no)/,/^(?:si)/,/^(?:no)/,/^(?:o)/,/^(?:u)/,/^(?:y)/,/^(?:e)/,/^(?:\()/,/^(?:\))/,/^(?:;)/,/^(?:\.)/,/^(?:,)/,/^(?:\*)/,/^(?:==)/,/^(?:<=)/,/^(?:<)/,/^(?:[0-9]+)/,/^(?:[A-Za-zÀ-ÖØ-öø-ÿ_][A-Za-zÀ-ÖØ-öø-ÿ0-9_-]*)/,/^(?:$)/,/^(?:.)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87],inclusive:!0}}};return lexer}();function Parser(){this.yy={}}return parser.lexer=lexer,Parser.prototype=parser,parser.Parser=Parser,new Parser}();function pascalParser$1(){return karelpascal.parse.apply(karelpascal,arguments)}function UnitePackages(packages){const booleans=new Map,numbers=new Map;for(const pack of packages)pack.numberVariables.forEach(((value,key,_)=>{numbers.set(key,value)})),pack.booleanVariables.forEach(((value,key,_)=>{booleans.set(key,value)}));return{booleanVariables:booleans,numberVariables:numbers}}const javaNumbers=new Map,javaBooleans=new Map;javaNumbers.set("beepersInBeeperBag",[["BAGBUZZERS"]]),javaNumbers.set("beepersOnFloor",[["WORLDBUZZERS"]]),javaNumbers.set("currentRow",[["ROW"]]),javaNumbers.set("currentColumn",[["COLUMN"]]),javaBooleans.set("true",[["LOAD",1]]),javaBooleans.set("false",[["LOAD",0]]);const rekarelGlobalsJava={booleanVariables:javaBooleans,numberVariables:javaNumbers},pascalNumbers=new Map,pascalBooleans=new Map;pascalNumbers.set("zumbadores-en-la-mochila",[["BAGBUZZERS"]]),pascalNumbers.set("zumbadores-del-piso",[["WORLDBUZZERS"]]),pascalNumbers.set("columna-actual",[["COLUMN"]]),pascalNumbers.set("fila-actual",[["ROW"]]),pascalBooleans.set("verdadero",[["LOAD",1]]),pascalBooleans.set("falso",[["LOAD",0]]);const rekarelGlobalsPascal={booleanVariables:pascalBooleans,numberVariables:pascalNumbers},JavaPackages={"rekarel.globals":rekarelGlobalsJava,"rekarel.*":UnitePackages([rekarelGlobalsJava])},PascalPackages={"rekarel.globales":rekarelGlobalsPascal,"rekarel.*":UnitePackages([rekarelGlobalsPascal])};class DefinitionTable{constructor(variablesCanBeFunctions){this.functions=new Map,this.variables=new Map,this.variablesCanBeFunctions=variablesCanBeFunctions,this.tagCounter=0}getType(identifier){return this.variables.has(identifier)?this.variables.get(identifier).dataType:this.functions.has(identifier)?this.functions.get(identifier).returnType:"undefined"}registerFunction(func){this.functions.set(func.name,{arguments:func.params,location:0,returnType:func.returnType})}hasFunction(name){return this.functions.has(name)}getFunction(name){return this.functions.get(name)}setFunctionLoc(target,location){this.functions.get(target).location=location}registerVar(name,val){this.variables.set(name,val)}hasVar(name){return this.variables.has(name)}getVar(name){return this.variables.get(name)}getUniqueTag(name){return`${name}.${this.tagCounter++}`}}var CompilationError;function resolveTerm(tree,definitions,scope,target,tags,yy){if("ATOM"===tree.operation){if(resolveListWithASTs(tree.instructions,definitions,scope,target,tags,yy),tree.dataType.startsWith("$")){const termType=tree.dataType.substring(1);return scope.parameters.some((e=>e.name===termType))?"INT":definitions.getType(tree.dataType.substring(1))}return tree.dataType}if("AND"===tree.operation||"OR"===tree.operation){const leftType=resolveTerm(tree.left,definitions,scope,target,tags,yy);target.push(["DUP"]),"OR"===tree.operation&&target.push(["NOT"]);const shortCircuit=definitions.getUniqueTag("shortCircuit");target.push(["TJZ",shortCircuit]);const rightType=resolveTerm(tree.right,definitions,scope,target,tags,yy);return"BOOL"!==leftType&&yy.parser.parseError(`${tree.operation} operator uses booleans terms only, left is of type: ${leftType}`,{error:CompilationError.Errors.BINARY_OPERATOR_TYPE_ERROR,operator:tree.operation,loc:tree.loc,line:tree.loc.first_line-1,expectedType:"BOOL",actualType:leftType,direction:"LEFT"}),"BOOL"!==rightType&&yy.parser.parseError(`${tree.operation} operator uses booleans terms only, right is of type: ${rightType}`,{error:CompilationError.Errors.BINARY_OPERATOR_TYPE_ERROR,operator:tree.operation,loc:tree.loc,line:tree.loc.first_line-1,expectedType:"BOOL",actualType:rightType,direction:"RIGHT"}),target.push([tree.operation]),resolveListWithASTs([["TAG",shortCircuit]],definitions,scope,target,tags,yy),tree.dataType}if("EQ"===tree.operation){const leftType=resolveTerm(tree.left,definitions,scope,target,tags,yy),rightType=resolveTerm(tree.right,definitions,scope,target,tags,yy);return leftType!==rightType&&yy.parser.parseError(`An equality comparison cannot be performed between type ${leftType} and ${rightType}`,{error:CompilationError.Errors.COMPARISON_TYPE,loc:tree.loc,line:tree.loc.first_line-1,leftType:leftType,rightType:rightType}),"VOID"===leftType&&yy.parser.parseError("An equality comparison cannot be performed on VOID",{error:CompilationError.Errors.VOID_COMPARISON,loc:tree.loc,line:tree.loc.first_line-1,leftType:leftType,rightType:rightType}),target.push([tree.operation]),tree.dataType}if("LT"===tree.operation||"LTE"===tree.operation){const leftType=resolveTerm(tree.left,definitions,scope,target,tags,yy),rightType=resolveTerm(tree.right,definitions,scope,target,tags,yy);return"INT"!==leftType&&yy.parser.parseError(`${tree.operation} operator uses integer terms only, left is of type: ${leftType}`,{error:CompilationError.Errors.BINARY_OPERATOR_TYPE_ERROR,loc:tree.loc,operator:tree.operation,line:tree.loc.first_line-1,direction:"LEFT",expectedType:"INT",actualType:leftType}),"INT"!==rightType&&yy.parser.parseError(`${tree.operation} operator uses integer terms only, right is of type: ${rightType}`,{error:CompilationError.Errors.BINARY_OPERATOR_TYPE_ERROR,loc:tree.loc,operator:tree.operation,direction:"RIGHT",line:tree.loc.first_line-1,expectedType:"INT",actualType:rightType}),target.push([tree.operation]),tree.dataType}if("NOT"===tree.operation){const termType=resolveTerm(tree.term,definitions,scope,target,tags,yy);return"BOOL"!==termType&&yy.parser.parseError(`${tree.operation} operator uses a boolean terms only, but tried to negate a term of type: ${termType}`,{error:CompilationError.Errors.UNARY_OPERATOR_TYPE_ERROR,loc:tree.loc,operator:tree.operation,line:tree.loc.first_line-1,expectedType:"BOOL",actualType:termType}),target.push([tree.operation]),tree.dataType}if("PASS"===tree.operation){const termType=resolveTerm(tree.term,definitions,scope,target,tags,yy);return termType!==tree.dataType&&yy.parser.parseError(`Expected a term of type ${tree.dataType}, but got ${termType}`,{error:CompilationError.Errors.TYPE_ERROR,loc:tree.totalLoc,line:tree.totalLoc.first_line-1,expectedType:tree.dataType,actualType:termType}),tree.dataType}if("PARENTHESIS"===tree.operation){return resolveTerm(tree.term,definitions,scope,target,tags,yy)}}function resolveVar(data,definitions,scope,target,yy){const parameterIdx=scope.parameters.findIndex((e=>data.target===e.name));if(-1===parameterIdx)if(definitions.hasVar(data.target)){const IRs=definitions.getVar(data.target).instructions;for(const instruction of IRs)target.push(instruction)}else{if(data.couldBeFunction)return resolveCall$2({nameLoc:data.loc,params:[],target:data.target,expectedType:data.expectedType},definitions,scope,target,{},yy),void target.push(["LRET"]);yy.parser.parseError("Unknown variable or parameter: "+data.target,{error:CompilationError.Errors.UNKNOWN_VARIABLE,variable:data.target,line:data.loc.first_line-1,loc:data.loc})}else target.push(["PARAM",scope.parameters.length-parameterIdx-1])}function resolveCall$2(data,definitions,scope,target,tags,yy){for(const parameter of data.params)resolveTerm(parameter,definitions,scope,target,tags,yy);if(target.push(["LOAD",data.params.length]),target.push(["LINE",data.nameLoc.first_line-1,data.nameLoc.first_column]),!definitions.hasFunction(data.target))return yy.parser.parseError("Undefined function: "+data.target,{error:CompilationError.Errors.UNDEFINED_FUNCTION,functionName:data.target,line:data.nameLoc.first_line-1,loc:data.nameLoc}),null;target.push(["CALL",data]),target.push(["LINE",data.nameLoc.first_line-1,data.nameLoc.first_column+data.target.length])}function resolveReturn(data,definitions,scope,target,tags,yy){const retType=resolveTerm(data.term,definitions,scope,target,tags,yy);scope.expectedReturn!==retType&&yy.parser.parseError(`Cannot return a type: ${retType}, in a function of type: ${scope.expectedReturn}`,{error:CompilationError.Errors.RETURN_TYPE,line:data.loc.first_line-1,loc:data.loc,expectedType:scope.expectedReturn,actualType:retType}),target.push(["SRET"]),target.push(["LINE",data.loc.first_line-1,data.loc.first_column]),target.push(["RET",data])}function resolveRepeat(data,definitions,scope,target,tags,yy){target.push(data.line),resolveTerm(data.loopCount[1],definitions,scope,target,tags,yy),resolveListWithASTs([["TAG",data.repeatTag],["DUP"],["LOAD",0],["EQ"],["NOT"],["TJZ",data.endTag]],definitions,scope,target,tags,yy);const loopScope=scope.withContinueBreakTarget(data.continueTag,data.endTag);resolveListWithASTs(data.instructions,definitions,loopScope,target,tags,yy),resolveListWithASTs([["TAG",data.continueTag],["DEC",1],["TJMP",data.repeatTag],["TAG",data.endTag],["POP"]],definitions,scope,target,tags,yy)}function resolveWhile(data,definitions,scope,target,tags,yy){resolveListWithASTs([["TAG",data.repeatTag]],definitions,scope,target,tags,yy),target.push(data.line),resolveTerm(data.condition[1],definitions,scope,target,tags,yy),resolveListWithASTs([["TJZ",data.endTag]],definitions,scope,target,tags,yy);const whileScope=scope.withContinueBreakTarget(data.repeatTag,data.endTag);resolveListWithASTs(data.instructions,definitions,whileScope,target,tags,yy),resolveListWithASTs([["TJMP",data.repeatTag],["TAG",data.endTag]],definitions,scope,target,tags,yy)}function resolveConditional(data,definitions,scope,target,tags,yy){let trueReturns=!1,falseReturns=!1;return target.push(data.line),resolveTerm(data.condition[1],definitions,scope,target,tags,yy),resolveListWithASTs([["TJZ",data.skipTrueTag]],definitions,scope,target,tags,yy),trueReturns=resolveListWithASTs(data.trueCase,definitions,scope,target,tags,yy).explicitReturn,data.skipFalseTag&&resolveListWithASTs([["TJMP",data.skipFalseTag]],definitions,scope,target,tags,yy),resolveListWithASTs([["TAG",data.skipTrueTag]],definitions,scope,target,tags,yy),data.skipFalseTag&&data.falseCase&&(falseReturns=resolveListWithASTs(data.falseCase,definitions,scope,target,tags,yy).explicitReturn,resolveListWithASTs([["TAG",data.skipFalseTag]],definitions,scope,target,tags,yy)),{explicitReturn:trueReturns&&falseReturns}}function resolveListWithASTs(IRInstructions,definitions,scope,target,tags,yy){const info={explicitReturn:!1};for(const instruction of IRInstructions)if("VAR"!==instruction[0])if("FORWARD"!==instruction[0])if("PICKBUZZER"!==instruction[0])if("LEAVEBUZZER"!==instruction[0])if("TERM"!==instruction[0])if("TAG"!==instruction[0])if("CALL"!==instruction[0])if("RET"!==instruction[0])if("REPEAT"!==instruction[0])if("WHILE"!==instruction[0])if("IF"!==instruction[0])"CONTINUE"!==instruction[0]?"BREAK"!==instruction[0]?target.push(instruction):(null==scope.breakTarget&&yy.parser.parseError("Cannot use break in this scope",{error:CompilationError.Errors.ILLEGAL_BREAK,loc:instruction[1],line:instruction[1].first_line-1}),target.push(["TJMP",scope.breakTarget])):(null==scope.continueTarget&&yy.parser.parseError("Cannot use continue in this scope",{error:CompilationError.Errors.ILLEGAL_CONTINUE,loc:instruction[1],line:instruction[1].first_line-1}),target.push(["TJMP",scope.continueTarget]));else{resolveConditional(instruction[1],definitions,scope,target,tags,yy).explicitReturn&&(info.explicitReturn=!0)}else resolveWhile(instruction[1],definitions,scope,target,tags,yy);else resolveRepeat(instruction[1],definitions,scope,target,tags,yy);else{if("__DEFAULT"===instruction[1]){target.push(["LOAD",0]),target.push(["SRET"]),target.push(["LINE",instruction[2].first_line-1,instruction[2].first_column]),target.push(instruction);continue}resolveReturn(instruction[1],definitions,scope,target,tags,yy),info.explicitReturn=!0}else resolveCall$2(instruction[1],definitions,scope,target,tags,yy);else tags[instruction[1]]=target.length;else resolveTerm(instruction[1],definitions,scope,target,tags,yy);else target.push(["BAGBUZZERS"]),target.push(["EZ","BAGUNDERFLOW"]),target.push(instruction);else target.push(["WORLDBUZZERS"]),target.push(["EZ","WORLDUNDERFLOW"]),target.push(instruction);else target.push(["WORLDWALLS"]),target.push(["ORIENTATION"]),target.push(["MASK"]),target.push(["AND"]),target.push(["NOT"]),target.push(["EZ","WALL"]),target.push(instruction);else resolveVar(instruction[1],definitions,scope,target,yy);return info}!function(CompilationError){var Errors;(Errors=CompilationError.Errors||(CompilationError.Errors={}))[Errors.BINARY_OPERATOR_TYPE_ERROR=0]="BINARY_OPERATOR_TYPE_ERROR",Errors[Errors.CALL_TYPE=1]="CALL_TYPE",Errors[Errors.COMPARISON_TYPE=2]="COMPARISON_TYPE",Errors[Errors.FUNCTION_ILLEGAL_NAME=3]="FUNCTION_ILLEGAL_NAME",Errors[Errors.FUNCTION_REDEFINITION=4]="FUNCTION_REDEFINITION",Errors[Errors.ILLEGAL_BREAK=5]="ILLEGAL_BREAK",Errors[Errors.ILLEGAL_CONTINUE=6]="ILLEGAL_CONTINUE",Errors[Errors.NO_EXPLICIT_RETURN=7]="NO_EXPLICIT_RETURN",Errors[Errors.PARAMETER_ILLEGAL_NAME=8]="PARAMETER_ILLEGAL_NAME",Errors[Errors.PARAMETER_REDEFINITION=9]="PARAMETER_REDEFINITION",Errors[Errors.PROTOTYPE_PARAMETERS_MISS_MATCH=10]="PROTOTYPE_PARAMETERS_MISS_MATCH",Errors[Errors.PROTOTYPE_TYPE_MISS_MATCH=11]="PROTOTYPE_TYPE_MISS_MATCH",Errors[Errors.PROTOTYPE_REDEFINITION=12]="PROTOTYPE_REDEFINITION",Errors[Errors.RETURN_TYPE=13]="RETURN_TYPE",Errors[Errors.TOO_FEW_PARAMS_IN_CALL=14]="TOO_FEW_PARAMS_IN_CALL",Errors[Errors.TOO_MANY_PARAMS_IN_CALL=15]="TOO_MANY_PARAMS_IN_CALL",Errors[Errors.TYPE_ERROR=16]="TYPE_ERROR",Errors[Errors.UNDEFINED_FUNCTION=17]="UNDEFINED_FUNCTION",Errors[Errors.UNDEFINED_FUNCTION_OR_VARIABLE=18]="UNDEFINED_FUNCTION_OR_VARIABLE",Errors[Errors.UNARY_OPERATOR_TYPE_ERROR=19]="UNARY_OPERATOR_TYPE_ERROR",Errors[Errors.UNKNOWN_MODULE=20]="UNKNOWN_MODULE",Errors[Errors.UNKNOWN_PACKAGE=21]="UNKNOWN_PACKAGE",Errors[Errors.UNKNOWN_SYNTAX=22]="UNKNOWN_SYNTAX",Errors[Errors.UNKNOWN_VARIABLE=23]="UNKNOWN_VARIABLE",Errors[Errors.VOID_COMPARISON=24]="VOID_COMPARISON"}(CompilationError||(CompilationError={}));class Scope{constructor(data){this.parameters=data.parameters,this.expectedReturn=data.expectedReturn,this.continueTarget=data.continueTarget,this.breakTarget=data.breakTarget}withContinueTarget(continueTarget){return new Scope({parameters:this.parameters,expectedReturn:this.expectedReturn,continueTarget:continueTarget,breakTarget:this.breakTarget})}withBreakTarget(breakTarget){return new Scope({parameters:this.parameters,expectedReturn:this.expectedReturn,continueTarget:this.continueTarget,breakTarget:breakTarget})}withContinueBreakTarget(continueTarget,breakTarget){return new Scope({parameters:this.parameters,expectedReturn:this.expectedReturn,continueTarget:continueTarget,breakTarget:breakTarget})}}const MAIN_SCOPE=new Scope({expectedReturn:"VOID",parameters:[]});class DebugData{}function resolveComplexIR(IRInstructions,yy,definitions,scope,func){let result=[];const tags={};let info=resolveListWithASTs(IRInstructions,definitions,scope,result,tags,yy);return"VOID"===scope.expectedReturn||info.explicitReturn||yy.parser.parseError(`Explicit return is required in function ${func.name}`,{error:CompilationError.Errors.NO_EXPLICIT_RETURN,loc:func.loc,line:func.loc.first_line-1,functionName:func.name,returnType:scope.expectedReturn}),result.map(((instruction,idx)=>{if("TJMP"===instruction[0]){return["JMP",tags[instruction[1]]-idx-1]}if("TJZ"===instruction[0]){return["JZ",tags[instruction[1]]-idx-1]}return instruction}))}function generateOpcodesFromIR(data,exportDebug){const definitions=new DefinitionTable(data.variablesCanBeFunctions),debugData=new DebugData;if(function(data,definitions){const compPackages="ReKarel Java"===data.language?JavaPackages:PascalPackages,yy=data.yy;for(const pack of data.packages){const packageName=pack[0].split(".")[0],moduleName=pack[0].split(".")[1];"rekarel"!==packageName&&yy.parser.parseError("Package not recognized: "+pack[0],{error:CompilationError.Errors.UNKNOWN_PACKAGE,package:packageName,module:moduleName,full:pack[0],loc:pack[1],line:pack[1].first_line-1}),compPackages[pack[0]]||yy.parser.parseError("Module not found: "+pack[0],{error:CompilationError.Errors.UNKNOWN_MODULE,package:packageName,module:moduleName,full:pack[0],loc:pack[1],line:pack[1].first_line-1});const packObject=compPackages[pack[0]];for(let[varName,varVal]of packObject.numberVariables)definitions.registerVar(varName,{instructions:varVal,dataType:"INT"});for(let[varName,varVal]of packObject.booleanVariables)definitions.registerVar(varName,{instructions:varVal,dataType:"BOOL"})}}(data,definitions),!function(data,definitionTable){const yy=data.yy,prototypes=new Map;for(const func of data.functions){for(const parameter of func.params)if(definitionTable.hasVar(parameter.name))return yy.parser.parseError("Cannot name a parameter as a global variable",{error:CompilationError.Errors.PARAMETER_ILLEGAL_NAME,parameterName:parameter.name,line:parameter.loc.first_line-1,loc:parameter.loc}),!1;if(definitionTable.hasVar(func.name))return yy.parser.parseError("Cannot name a function as a global variable",{error:CompilationError.Errors.FUNCTION_ILLEGAL_NAME,functionName:func.name,line:func.loc.first_line-1,loc:func.loc}),!1;if(null==func.code){if(prototypes.has(func.name))return yy.parser.parseError("Prototype redefinition: "+func.name,{error:CompilationError.Errors.PROTOTYPE_REDEFINITION,prototypeName:func.name,line:func.loc.first_line-1,loc:func.loc}),!1;prototypes.set(func.name,{argCount:func.params.length,defined:!1,returnType:func.returnType});continue}prototypes.has(func.name)||prototypes.set(func.name,{argCount:func.params.length,defined:!1,returnType:func.returnType});const proto=prototypes.get(func.name);if(proto.defined)return yy.parser.parseError("Function redefinition: "+func.name,{error:CompilationError.Errors.FUNCTION_REDEFINITION,functionName:func.name,line:func.loc.first_line-1,loc:func.loc}),!1;if(proto.argCount!==func.params.length)return yy.parser.parseError("Prototype parameter mismatch: "+func.name,{error:CompilationError.Errors.PROTOTYPE_PARAMETERS_MISS_MATCH,line:func.loc.first_line-1,loc:func.loc,functionName:func.name,functionParamCount:func.params.length,prototypeParamCount:proto.argCount}),!1;if(proto.returnType!==func.returnType)return yy.parser.parseError("Prototype type mismatch: "+func.name,{error:CompilationError.Errors.PROTOTYPE_TYPE_MISS_MATCH,line:func.loc.first_line-1,loc:func.loc,functionName:func.name,functionType:func.returnType,prototypeType:proto.returnType}),!1;prototypes.set(func.name,{argCount:func.params.length,defined:!0,returnType:func.returnType}),definitionTable.registerFunction(func);for(const instruction of func.code)if(data.requieresFunctionPrototypes&&"CALL"===instruction[0]){const data=instruction[1];if(!prototypes.has(data.target))return yy.parser.parseError("Undefined function: "+data.target,{error:CompilationError.Errors.UNDEFINED_FUNCTION,functionName:data.target,line:data.nameLoc.first_line-1,loc:data.nameLoc}),!1}}for(const func of data.functions)func.params.forEach(((param,idx)=>{(definitionTable.hasVar(param.name)||definitionTable.hasFunction(param.name))&&yy.parser.parseError(`Cannot name parameter ${param.name} as it is already used by a variable or function`,{error:CompilationError.Errors.PARAMETER_ILLEGAL_NAME,line:param.loc.first_line-1,loc:param.loc,parameterName:param.name}),func.params.findIndex((p=>p.name===param.name))!==idx&&yy.parser.parseError(`Parameter ${param.name} was already declared in the function`,{error:CompilationError.Errors.PARAMETER_REDEFINITION,line:param.loc.first_line-1,loc:param.loc,parameterName:param.name})}));return!0}(data,definitions))throw new Error("This should not be reachable, it should have thrown before");let IRProgram=resolveComplexIR(data.program,data.yy,definitions,MAIN_SCOPE);for(const func of data.functions){if(null==func.code)continue;definitions.setFunctionLoc(func.name,IRProgram.length);const functionScope=new Scope({parameters:func.params,expectedReturn:func.returnType}),code=resolveComplexIR(func.code,data.yy,definitions,functionScope,func);IRProgram=IRProgram.concat(code)}const program=[];for(const instruction of IRProgram)if("CALL"!==instruction[0])"RET"!==instruction[0]?program.push(instruction):program.push(["RET"]);else{const iData=instruction[1];if(!definitions.hasFunction(iData.target))return data.yy.parser.parseError("Undefined function: "+iData.target,{error:CompilationError.Errors.UNDEFINED_FUNCTION,functionName:iData.target,line:iData.nameLoc.first_line-1,loc:iData.nameLoc}),null;const targetFunc=definitions.getFunction(iData.target);if(targetFunc.arguments.length<iData.params.length){const extraParam=iData.params[iData.params.length-targetFunc.arguments.length-1];data.yy.parser.parseError(`Too many parameters in call to function ${iData.target}, expected ${targetFunc.arguments.length}, got ${iData.params.length}`,{error:CompilationError.Errors.TOO_MANY_PARAMS_IN_CALL,line:extraParam.totalLoc.first_line-1,loc:extraParam.totalLoc,functionName:iData.target,expectedParams:iData.params.length,actualParams:targetFunc.arguments.length})}targetFunc.arguments.length>iData.params.length&&data.yy.parser.parseError(`Too few parameters in call to function ${iData.target}, expected ${targetFunc.arguments.length}, got ${iData.params.length}`,{error:CompilationError.Errors.TOO_FEW_PARAMS_IN_CALL,line:iData.nameLoc.first_line-1,loc:iData.nameLoc,funcName:iData.target,expectedParams:iData.params.length,actualParams:targetFunc.arguments.length}),null!=iData.expectedType&&iData.expectedType!==targetFunc.returnType&&data.yy.parser.parseError(`Expected a function of type ${iData.expectedType}, but ${iData.target} is ${targetFunc.returnType}`,{error:CompilationError.Errors.CALL_TYPE,line:iData.nameLoc.first_line-1,loc:iData.nameLoc,funcName:iData.target,expectedCallType:iData.expectedType,functionType:targetFunc.returnType}),program.push(["CALL",targetFunc.location,iData.target])}return exportDebug?(debugData.definitions=definitions,[program,debugData]):[program,null]}const javaParser=function(){return kareljava.parse.apply(kareljava,arguments)},pascalParser=pascalParser$1;function detectLanguage(code){let rules=[/^\s+/,/^\/\/[^\n]*/,/^#[^\n]*/,/^(?:\/\*(?:[^*]|\*[^)])*\*\/)/,/^{[^}]*}/,/^\(\*([^*]|\*[^)])*\*\)/,/^[^a-zA-Z0-9_-]+/,/^[a-zA-Z0-9_-]+/],i=0;for(;i<code.length;)for(let j=0;j<rules.length;j++){let m=rules[j].exec(code.substring(i));if(null!==m){if(j==rules.length-1)return"class"==m[0]||"import"==m[0]?"java":"iniciar-programa"==m[0].toLowerCase()||"usa"==m[0].toLowerCase()?"pascal":"unknown";i+=m[0].length;break}}return"unknown"}function javaCompiler(code,exportDebug=!1){return generateOpcodesFromIR(javaParser(code),exportDebug)}function pascalCompiler(code,exportDebug=!1){return generateOpcodesFromIR(pascalParser(code),exportDebug)}class KarelRuntimeEvent extends Event{constructor(type,runtime,details){super(type),this.details=details,this.runtime=runtime}}class KarelRuntimeEventTarget{constructor(){this.listeners={}}addEventListener(type,callback){this.listeners.hasOwnProperty(type)||(this.listeners[type]=[]),this.listeners[type].push(callback)}dispatchEvent(event){if(!this.listeners.hasOwnProperty(event.type))return!1;for(const listener of this.listeners[event.type])listener(event);return!0}removeEventListener(type,callback){if(!this.listeners.hasOwnProperty(type))return;const index=this.listeners[type].indexOf(callback);-1!==index&&(this.listeners[type]=this.listeners[type].splice(index,1))}fireEvent(type,runtime,data){const evt=new KarelRuntimeEvent(type,runtime,data);this.dispatchEvent(evt)}}var OpCodeID,ErrorType,DumpTypes,ERROR_MAPPING;function getOpCodeID(literal){return literal in OpCodeID?OpCodeID[literal]:-1}!function(OpCodeID){OpCodeID[OpCodeID.HALT=0]="HALT",OpCodeID[OpCodeID.LINE=1]="LINE",OpCodeID[OpCodeID.LEFT=2]="LEFT",OpCodeID[OpCodeID.WORLDWALLS=3]="WORLDWALLS",OpCodeID[OpCodeID.ORIENTATION=4]="ORIENTATION",OpCodeID[OpCodeID.ROTL=5]="ROTL",OpCodeID[OpCodeID.ROTR=6]="ROTR",OpCodeID[OpCodeID.MASK=7]="MASK",OpCodeID[OpCodeID.NOT=8]="NOT",OpCodeID[OpCodeID.AND=9]="AND",OpCodeID[OpCodeID.OR=10]="OR",OpCodeID[OpCodeID.EQ=11]="EQ",OpCodeID[OpCodeID.EZ=12]="EZ",OpCodeID[OpCodeID.JZ=13]="JZ",OpCodeID[OpCodeID.JMP=14]="JMP",OpCodeID[OpCodeID.FORWARD=15]="FORWARD",OpCodeID[OpCodeID.WORLDBUZZERS=16]="WORLDBUZZERS",OpCodeID[OpCodeID.BAGBUZZERS=17]="BAGBUZZERS",OpCodeID[OpCodeID.PICKBUZZER=18]="PICKBUZZER",OpCodeID[OpCodeID.LEAVEBUZZER=19]="LEAVEBUZZER",OpCodeID[OpCodeID.LOAD=20]="LOAD",OpCodeID[OpCodeID.POP=21]="POP",OpCodeID[OpCodeID.DUP=22]="DUP",OpCodeID[OpCodeID.DEC=23]="DEC",OpCodeID[OpCodeID.INC=24]="INC",OpCodeID[OpCodeID.CALL=25]="CALL",OpCodeID[OpCodeID.RET=26]="RET",OpCodeID[OpCodeID.PARAM=27]="PARAM",OpCodeID[OpCodeID.SRET=28]="SRET",OpCodeID[OpCodeID.LRET=29]="LRET",OpCodeID[OpCodeID.LT=30]="LT",OpCodeID[OpCodeID.LTE=31]="LTE",OpCodeID[OpCodeID.COLUMN=32]="COLUMN",OpCodeID[OpCodeID.ROW=33]="ROW"}(OpCodeID||(OpCodeID={})),function(ErrorType){ErrorType.INSTRUCTION="INSTRUCTION",ErrorType.INSTRUCTION_LEFT="INSTRUCTION_LEFT",ErrorType.INSTRUCTION_FORWARD="INSTRUCTION_FORWARD",ErrorType.INSTRUCTION_PICKBUZZER="INSTRUCTION_PICKBUZZER",ErrorType.INSTRUCTION_LEAVEBUZZER="INSTRUCTION_LEAVEBUZZER",ErrorType.STACK="STACK",ErrorType.WALL="WALL",ErrorType.WORLDUNDERFLOW="WORLDUNDERFLOW",ErrorType.BAGUNDERFLOW="BAGUNDERFLOW",ErrorType.INVALIDOPCODE="INVALIDOPCODE",ErrorType.STACKMEMORY="STACKMEMORY",ErrorType.CALLSIZE="CALLSIZE"}(ErrorType||(ErrorType={}));class Runtime{constructor(world){this.world=world,this.debug=!1,this.disableStackEvents=!1,this.eventController=new KarelRuntimeEventTarget,this.load([["HALT"]])}load(opcodes){let error_mapping=["WALL","WORLDUNDERFLOW","BAGUNDERFLOW","INSTRUCTION"];this.rawOpcodes=opcodes;let function_map={};this.functionNames=[];let function_idx=0;this.program=new Int32Array(new ArrayBuffer(3*opcodes.length*4));for(let i=0;i<opcodes.length;i++){const currentOpcode=opcodes[i];if(this.program[3*i]=getOpCodeID(currentOpcode[0]),currentOpcode.length>1&&(this.program[3*i+1]=currentOpcode[1]),"LINE"==currentOpcode[0]&&(this.program[3*i+2]=currentOpcode[2]),"CALL"==currentOpcode[0])function_map.hasOwnProperty(currentOpcode[2])||(function_map[currentOpcode[2]]=function_idx,this.functionNames[function_idx++]=currentOpcode[2]),this.program[3*i+2]=function_map[currentOpcode[2]];else if("EZ"==currentOpcode[0]&&(this.program[3*i+1]=error_mapping.indexOf(currentOpcode[1]),-1==this.program[3*i+1]))throw new Error("Invalid error: "+currentOpcode[1])}this.reset()}start(){this.eventController.fireEvent("start",this,{type:"start",target:this,world:this.world})}reset(){this.state={pc:0,sp:-1,fp:-1,line:-1,column:-1,ic:0,ret:0,stack:new Int32Array(new ArrayBuffer(4194400)),stackSize:0,stackMemory:0,moveCount:0,turnLeftCount:0,pickBuzzerCount:0,leaveBuzzerCount:0,jumped:!1,running:!0},this.debug&&this.eventController.fireEvent("debug",this,{type:"debug",target:this,message:JSON.stringify(this.rawOpcodes),debugType:"program"})}step(){for(;this.state.running;)try{if(this.program[3*this.state.pc]==OpCodeID.LINE){this.next();break}this.next()}finally{this.state.running||this.eventController.fireEvent("stop",this,{type:"stop",target:this,world:this.world})}return this.state.running}next(){if(!this.state.running)return;let rot,world=this.world;if(this.state.ic>=world.maxInstructions)return this.state.running=!1,this.state.error=ErrorType.INSTRUCTION,!1;if(this.state.stackSize>=this.world.maxStackSize)return this.state.running=!1,this.state.error=ErrorType.STACK,!1;let paramCount,newSP,op1,op2,fname,params,line,fromFName,npc,di=[0,1,0,-1],dj=[-1,0,1,0];try{switch(this.debug&&this.eventController.fireEvent("debug",this,{type:"debug",target:this,message:JSON.stringify(this.program[3*this.state.pc]+" "+this.rawOpcodes[this.state.pc]),debugType:"opcode"}),this.program[3*this.state.pc]){case OpCodeID.HALT:this.state.running=!1;break;case OpCodeID.LINE:this.state.line=this.program[3*this.state.pc+1],this.state.column=this.program[3*this.state.pc+2];break;case OpCodeID.LEFT:this.state.ic++,this.world.orientation--,this.world.orientation<0&&(this.world.orientation=3),this.world.dirty=!0,this.state.turnLeftCount++,this.world.maxTurnLeft>=0&&this.state.turnLeftCount>this.world.maxTurnLeft&&(this.state.running=!1,this.state.error=ErrorType.INSTRUCTION_LEFT,this.state.errorData={type:ErrorType.INSTRUCTION,instruction:"LEFT"});break;case OpCodeID.WORLDWALLS:this.state.stack[++this.state.sp]=world.walls(world.i,world.j);break;case OpCodeID.ORIENTATION:this.state.stack[++this.state.sp]=world.orientation;break;case OpCodeID.ROTL:rot=this.state.stack[this.state.sp]-1,rot<0&&(rot=3),this.state.stack[this.state.sp]=rot;break;case OpCodeID.ROTR:rot=this.state.stack[this.state.sp]+1,rot>3&&(rot=0),this.state.stack[this.state.sp]=rot;break;case OpCodeID.MASK:this.state.stack[this.state.sp]=1<<this.state.stack[this.state.sp];break;case OpCodeID.NOT:this.state.stack[this.state.sp]=0===this.state.stack[this.state.sp]?1:0;break;case OpCodeID.AND:op2=this.state.stack[this.state.sp--],op1=this.state.stack[this.state.sp--],this.state.stack[++this.state.sp]=op1&op2?1:0;break;case OpCodeID.OR:op2=this.state.stack[this.state.sp--],op1=this.state.stack[this.state.sp--],this.state.stack[++this.state.sp]=op1|op2?1:0;break;case OpCodeID.EQ:op2=this.state.stack[this.state.sp--],op1=this.state.stack[this.state.sp--],this.state.stack[++this.state.sp]=op1==op2?1:0;break;case OpCodeID.EZ:0===this.state.stack[this.state.sp--]&&(this.state.error=[ErrorType.WALL,ErrorType.WORLDUNDERFLOW,ErrorType.BAGUNDERFLOW][this.program[3*this.state.pc+1]],this.state.running=!1);break;case OpCodeID.JZ:this.state.ic++,0===this.state.stack[this.state.sp--]&&(this.state.pc+=this.program[3*this.state.pc+1]);break;case OpCodeID.JMP:this.state.ic++,this.state.pc+=this.program[3*this.state.pc+1];break;case OpCodeID.FORWARD:this.state.ic++,this.world.i+=di[this.world.orientation],this.world.j+=dj[this.world.orientation],this.world.dirty=!0,this.state.moveCount++,this.world.maxMove>=0&&this.state.moveCount>this.world.maxMove&&(this.state.running=!1,this.state.error=ErrorType.INSTRUCTION_FORWARD,this.state.errorData={type:ErrorType.INSTRUCTION,instruction:"FORWARD"});break;case OpCodeID.WORLDBUZZERS:this.state.stack[++this.state.sp]=this.world.buzzers(world.i,world.j);break;case OpCodeID.BAGBUZZERS:this.state.stack[++this.state.sp]=this.world.bagBuzzers;break;case OpCodeID.PICKBUZZER:this.state.ic++,this.world.pickBuzzer(this.world.i,this.world.j),this.state.pickBuzzerCount++,this.world.maxPickBuzzer>=0&&this.state.pickBuzzerCount>this.world.maxPickBuzzer&&(this.state.running=!1,this.state.error=ErrorType.INSTRUCTION_PICKBUZZER,this.state.errorData={type:ErrorType.INSTRUCTION,instruction:"PICKBUZZER"});break;case OpCodeID.LEAVEBUZZER:this.state.ic++,this.world.leaveBuzzer(this.world.i,this.world.j),this.state.leaveBuzzerCount++,this.world.maxLeaveBuzzer>=0&&this.state.leaveBuzzerCount>this.world.maxLeaveBuzzer&&(this.state.running=!1,this.state.error=ErrorType.INSTRUCTION_LEAVEBUZZER,this.state.errorData={type:ErrorType.INSTRUCTION,instruction:"LEAVEBUZZER"});break;case OpCodeID.LOAD:this.state.stack[++this.state.sp]=this.program[3*this.state.pc+1];break;case OpCodeID.POP:this.state.sp--;break;case OpCodeID.DUP:this.state.stack[++this.state.sp]=this.state.stack[this.state.sp-1];break;case OpCodeID.DEC:this.state.stack[this.state.sp]-=this.program[3*this.state.pc+1];break;case OpCodeID.INC:this.state.stack[this.state.sp]+=this.program[3*this.state.pc+1];break;case OpCodeID.CALL:this.state.ic++,paramCount=this.state.stack[this.state.sp--],newSP=this.state.sp-paramCount,fname=this.functionNames[this.program[3*this.state.pc+2]],this.state.stack[++this.state.sp]=this.state.fp,this.state.stack[++this.state.sp]=newSP,this.state.stack[++this.state.sp]=this.state.pc,this.state.stack[++this.state.sp]=paramCount,this.state.fp=newSP+1+paramCount,this.state.pc=this.program[3*this.state.pc+1],this.state.jumped=!0,this.state.stackSize++,this.state.stackMemory+=Math.max(1,paramCount),this.state.stackSize>=this.world.maxStackSize?(this.state.running=!1,this.state.error=ErrorType.STACK):this.state.stackMemory>=this.world.maxStackMemory?(this.state.running=!1,this.state.error=ErrorType.STACKMEMORY):paramCount>this.world.maxCallSize?(this.state.running=!1,this.state.error=ErrorType.CALLSIZE):this.disableStackEvents||this.eventController.fireEvent("call",this,{type:"call",function:fname,params:this.state.stack.subarray(this.state.fp-paramCount,this.state.fp),line:this.state.line,target:this});break;case OpCodeID.RET:if(this.state.fp<0){this.state.running=!1;break}paramCount=this.state.stack[this.state.fp+3],this.state.pc=this.state.stack[this.state.fp+2],this.state.sp=this.state.stack[this.state.fp+1],this.state.fp=this.state.stack[this.state.fp],this.state.stackSize--,this.state.stackMemory-=Math.max(1,paramCount),this.disableStackEvents||(params=this.state.stack.subarray(0,0),fromFName=this.functionNames[this.program[3*this.state.pc+2]],fname="N/A",line=-2,this.state.stackSize>=1&&(npc=this.state.stack[this.state.fp+2],fname=this.functionNames[this.program[3*npc+2]],line=this.program[3*(npc+1)+1],paramCount=this.state.stack[this.state.fp+3],params=this.state.stack.subarray(this.state.fp-paramCount,this.state.fp)),this.eventController.fireEvent("return",this,{type:"return",target:this,params:params,function:fname,fromFunction:fromFName,line:line,returnValue:this.state.ret}));break;case OpCodeID.PARAM:this.state.stack[++this.state.sp]=this.state.stack[this.state.fp-1-this.program[3*this.state.pc+1]];break;case OpCodeID.SRET:this.state.ret=this.state.stack[this.state.sp--];break;case OpCodeID.LRET:this.state.stack[++this.state.sp]=this.state.ret;break;case OpCodeID.LT:op2=this.state.stack[this.state.sp--],op1=this.state.stack[this.state.sp--],this.state.stack[++this.state.sp]=op1<op2?1:0;break;case OpCodeID.LTE:op2=this.state.stack[this.state.sp--],op1=this.state.stack[this.state.sp--],this.state.stack[++this.state.sp]=op1<=op2?1:0;break;case OpCodeID.ROW:this.state.stack[++this.state.sp]=this.world.i;break;case OpCodeID.COLUMN:this.state.stack[++this.state.sp]=this.world.j;break;default:return this.state.running=!1,this.debug&&this.eventController.fireEvent("debug",this,{type:"debug",target:this,message:"Missing opcode "+this.rawOpcodes[this.state.pc][0],debugType:"opcode"}),this.state.error=ErrorType.INVALIDOPCODE,this.state.errorData={type:ErrorType.INSTRUCTION,instruction:OpCodeID[this.program[3*this.state.pc]]},!1}if(this.state.jumped?this.state.jumped=!1:this.state.pc++,this.debug){let copy={pc:this.state.pc,stackSize:this.state.stackSize,expressionStack:Array.from(this.state.stack.slice(this.state.fp+4,this.state.sp+1)),line:this.state.line,ic:this.state.ic,running:this.state.running};this.eventController.fireEvent("debug",this,{type:"debug",target:this,message:JSON.stringify(copy),debugType:"state"})}}catch(e){throw this.state.running=!1,console.error(e),console.log(e.stack),e}return!0}}!function(DumpTypes){DumpTypes.DUMP_WORLD="mundo",DumpTypes.DUMP_POSITION="posicion",DumpTypes.DUMP_ORIENTATION="orientacion",DumpTypes.DUMP_INSTRUCTIONS="instrucciones",DumpTypes.DUMP_ALL_BUZZERS="universo",DumpTypes.DUMP_BAG="mochila",DumpTypes.DUMP_MOVE="avanza",DumpTypes.DUMP_LEFT="gira_izquierda",DumpTypes.DUMP_PICK_BUZZER="coge_zumbador",DumpTypes.DUMP_LEAVE_BUZZER="deja_zumbador"}(DumpTypes||(DumpTypes={})),function(ERROR_MAPPING){ERROR_MAPPING.BAGUNDERFLOW="ZUMBADOR INVALIDO MOCHILA",ERROR_MAPPING.WALL="MOVIMIENTO INVALIDO",ERROR_MAPPING.WORLDUNDERFLOW="ZUMBADOR INVALIDO MUNDO",ERROR_MAPPING.STACK="STACK OVERFLOW",ERROR_MAPPING.INSTRUCTION="LIMITE DE INSTRUCCIONES GENERAL",ERROR_MAPPING.INSTRUCTION_LEFT="LIMITE DE INSTRUCCIONES IZQUIERDA",ERROR_MAPPING.INSTRUCTION_FORWARD="LIMITE DE INSTRUCCIONES AVANZA",ERROR_MAPPING.INSTRUCTION_PICKBUZZER="LIMITE DE INSTRUCCIONES COGE_ZUMBADOR",ERROR_MAPPING.INSTRUCTION_LEAVEBUZZER="LIMITE DE INSTRUCCIONES DEJA_ZUMBADOR",ERROR_MAPPING.STACKMEMORY="LIMITE DE MEMORIA DEL STACK",ERROR_MAPPING.CALLSIZE="LIMITE DE LONGITUD DE LLAMADA"}(ERROR_MAPPING||(ERROR_MAPPING={}));class World{constructor(w,h){this.setWallMask=function(i,j,wallMask){let newMask=wallMask;wallMask<0||wallMask>=16||1>i||i>this.h||1>j||j>this.w||(1==j&&(newMask|=1),1==i&&(newMask|=8),i==this.h&&(newMask|=2),j==this.w&&(newMask|=4),this.wallMap[this.w*i+j]=newMask)},this.init(w,h)}init(w,h){this.w=w,this.h=h,this.runtime=new Runtime(this),this.createMaps(),this.clear()}createMaps(){if(ArrayBuffer){let len=(this.w+2)*(this.h+2);this.map=new Int32Array(new ArrayBuffer(4*len)),this.currentMap=new Int32Array(new ArrayBuffer(4*len)),this.wallMap=new Uint8Array(new ArrayBuffer(len))}else{this.map=[],this.currentMap=[],this.wallMap=[];for(let i=0;i<=this.h;i++)for(let j=0;j<=this.w;j++)this.map.push(0),this.currentMap.push(0),this.wallMap.push(0)}}resize(w,h){for(let i=1;i<=this.h;i++)this.wallMap[this.w*i+1]&=-2,this.wallMap[this.w*(i+1)]&=-5;for(let j=1;j<=this.w;j++)this.wallMap[this.w*this.h+j]&=-3,this.wallMap[this.w+j]&=-9;let oldW=this.w,oldH=this.h,oldMap=this.map,oldWallMap=this.wallMap,oldDumpCells=this.dumpCells;this.w=w,this.h=h,this.createMaps(),this.addBorderWalls();for(let i=1;i<=oldH;i++)for(let j=1;j<=oldW;j++)this.setCellWalls(i,j,oldWallMap[oldW*i+j]),this.setBuzzers(i,j,oldMap[oldW*i+j]);this.dumpCells=[];for(let dumpPos=0;dumpPos<oldDumpCells.length;dumpPos++)oldDumpCells[dumpPos][0]<=this.h&&oldDumpCells[dumpPos][1]<=this.w&&this.setDumpCell(oldDumpCells[dumpPos][0],oldDumpCells[dumpPos][1],!0);this.start_i>this.h&&(this.start_i=this.i=this.h),this.start_j>this.w&&(this.start_j=this.j=this.w),this.dirty=!0}clear(){for(let i=0;i<this.wallMap.length;i++)this.wallMap[i]=0;for(let i=0;i<this.map.length;i++)this.map[i]=this.currentMap[i]=0;this.addBorderWalls(),this.orientation=1,this.startOrientation=1,this.start_i=1,this.i=1,this.start_j=1,this.j=1,this.startBagBuzzers=0,this.bagBuzzers=0,this.dumps={},this.dumpCells=[],this.maxInstructions=1e7,this.maxMove=-1,this.maxTurnLeft=-1,this.maxPickBuzzer=-1,this.maxLeaveBuzzer=-1,this.maxStackSize=65e3,this.maxStackMemory=65e3,this.maxCallSize=5,this.worldName="mundo_0",this.programName="p1",this.dirty=!0}walls(i,j){return 0>i||i>this.h||0>j||j>this.w?0:this.wallMap[this.w*i+j]}toggleWall(i,j,orientation){1==j&&0===orientation||1==i&&3==orientation||i==this.h&&1==orientation||j==this.w&&2==orientation||orientation<0||orientation>=4||1>i||i>this.h||1>j||j>this.w||(this.wallMap[this.w*i+j]^=1<<orientation,0===orientation&&j>1?this.wallMap[this.w*i+(j-1)]^=4:1===orientation&&i<this.h?this.wallMap[this.w*(i+1)+j]^=8:2===orientation&&j<this.w?this.wallMap[this.w*i+(j+1)]^=1:3===orientation&&i>1&&(this.wallMap[this.w*(i-1)+j]^=2),this.dirty=!0)}addBorderWalls(){for(let i=1;i<=this.h;i++)this.addWall(i,1,0),this.addWall(i,this.w,2);for(let j=1;j<=this.w;j++)this.addWall(this.h,j,1),this.addWall(1,j,3)}setCellWalls(i,j,wallMask){for(let pos=0;pos<4;pos++)wallMask&1<<pos&&this.addWall(i,j,pos)}addWall(i,j,orientation){orientation<0||orientation>=4||1>i||i>this.h||1>j||j>this.w||(this.wallMap[this.w*i+j]|=1<<orientation,0===orientation&&j>1?this.wallMap[this.w*i+(j-1)]|=4:1===orientation&&i<this.h?this.wallMap[this.w*(i+1)+j]|=8:2===orientation&&j<this.w?this.wallMap[this.w*i+(j+1)]|=1:3===orientation&&i>1&&(this.wallMap[this.w*(i-1)+j]|=2),this.dirty=!0)}setBuzzers(i,j,count){0>=i||i>this.h||0>=j||j>this.w||(this.map[this.w*i+j]=this.currentMap[this.w*i+j]=65535==count?-1:count,this.dirty=!0)}buzzers(i,j){return 0>=i||i>this.h||0>=j||j>this.w?0:this.currentMap[this.w*i+j]}startBuzzers(i,j){return 0>=i||i>this.h||0>=j||j>this.w?0:this.map[this.w*i+j]}pickBuzzer(i,j){0>=i||i>this.h||0>=j||j>this.w||(-1!=this.currentMap[this.w*i+j]&&this.currentMap[this.w*i+j]--,-1!=this.bagBuzzers&&this.bagBuzzers++,this.dirty=!0)}leaveBuzzer(i,j){0>=i||i>this.h||0>=j||j>this.w||(-1!=this.currentMap[this.w*i+j]&&this.currentMap[this.w*i+j]++,-1!=this.bagBuzzers&&this.bagBuzzers--,this.dirty=!0)}setDumpCell(i,j,dumpState){let dumpPos=-1;if(!(0>=i||i>this.h||0>=j||j>this.w)){for(dumpPos=0;dumpPos<this.dumpCells.length&&(this.dumpCells[dumpPos][0]!=i||this.dumpCells[dumpPos][1]!=j);dumpPos++);if(dumpPos<this.dumpCells.length){if(dumpState)return;this.dumpCells.splice(dumpPos,1)}else{if(!dumpState)return;this.dumpCells.push([i,j])}this.dumps[DumpTypes.DUMP_WORLD]=0!==this.dumpCells.length}}toggleDumpCell(i,j){let dumpPos=0;if(!(0>=i||i>=this.h||0>=j||j>=this.w)){for(;dumpPos<this.dumpCells.length&&(this.dumpCells[dumpPos][0]!=i||this.dumpCells[dumpPos][1]!=j);dumpPos++);dumpPos<this.dumpCells.length?this.dumpCells.splice(dumpPos,1):this.dumpCells.push([i,j]),this.dumps[DumpTypes.DUMP_WORLD]=0!==this.dumpCells.length}}getDumpCell(i,j){let dumpPos=-1;for(dumpPos=0;dumpPos<this.dumpCells.length;dumpPos++)if(this.dumpCells[dumpPos][0]==i&&this.dumpCells[dumpPos][1]==j)return!0;return!1}getDumps(dumpFlag){return this.dumps.hasOwnProperty(dumpFlag.toLowerCase())&&this.dumps[dumpFlag]}setDumps(dumpFlag,flagValue){this.dumps[dumpFlag]=flagValue}toggleDumps(dumpFlag){this.setDumps(dumpFlag,!this.getDumps(dumpFlag))}load(doc){const self=this;self.clear();let rules={mundo:function(mundo){let alto=mundo.getAttribute("alto"),ancho=mundo.getAttribute("ancho");alto&&ancho&&(alto=parseInt(alto,10),ancho=parseInt(ancho,10),alto&&ancho&&self.resize(ancho,alto))},condiciones:function(condiciones){self.maxInstructions=parseInt(condiciones.getAttribute("instruccionesMaximasAEjecutar"),10)||1e7,self.maxStackSize=parseInt(condiciones.getAttribute("longitudStack"),10)||65e3,self.maxStackMemory=parseInt(condiciones.getAttribute("memoriaStack"),10)||65e3,self.maxCallSize=parseInt(condiciones.getAttribute("llamadaMaxima"),10)||5},comando:function(comando){let name=comando.getAttribute("nombre"),val=parseInt(comando.getAttribute("maximoNumeroDeEjecuciones"),10);name&&val&&("AVANZA"==name?self.maxMove=val:"GIRA_IZQUIERDA"==name?self.maxTurnLeft=val:"COGE_ZUMBADOR"==name?self.maxPickBuzzer=val:"DEJA_ZUMBADOR"==name&&(self.maxLeaveBuzzer=val))},monton:function(monton){let i=parseInt(monton.getAttribute("y"),10),j=parseInt(monton.getAttribute("x"),10),zumbadores=monton.getAttribute("zumbadores");"INFINITO"==zumbadores?zumbadores=-1:(zumbadores=parseInt(zumbadores,10),isNaN(zumbadores)&&(zumbadores=0)),self.setBuzzers(i,j,zumbadores)},pared:function(pared){let i=parseInt(pared.getAttribute("y1"),10)+1,j=parseInt(pared.getAttribute("x1"),10)+1;if(pared.getAttribute("x2")){let j2=parseInt(pared.getAttribute("x2"),10)+1;j2>j?self.addWall(i,j,3):self.addWall(i,j2,3)}else if(pared.getAttribute("y2")){let i2=parseInt(pared.getAttribute("y2"),10)+1;i2>i?self.addWall(i,j,0):self.addWall(i2,j,0)}},despliega:function(despliega){self.dumps[despliega.getAttribute("tipo").toLowerCase()]=!0},posicionDump:function(dump){self.dumpCells.push([parseInt(dump.getAttribute("y"),10),parseInt(dump.getAttribute("x"),10)])},programa:function(programa){let xKarel=parseInt(programa.getAttribute("xKarel")||programa.getAttribute("xkarel"),10),yKarel=parseInt(programa.getAttribute("yKarel")||programa.getAttribute("ykarel"),10);self.rotate(programa.getAttribute("direccionKarel")||programa.getAttribute("direccionkarel")),self.worldName=programa.getAttribute("mundoDeEjecucion")||programa.getAttribute("mundodeejecucion"),self.programName=programa.getAttribute("nombre"),self.move(yKarel,xKarel);let bagBuzzers=programa.getAttribute("mochilaKarel")||programa.getAttribute("mochilakarel")||0;"INFINITO"==bagBuzzers?self.setBagBuzzers(-1):self.setBagBuzzers(parseInt(bagBuzzers))}};!function traverse(node){let type=node.nodeName;rules.hasOwnProperty(type)&&rules[type](node);for(let i=0;i<node.childNodes.length;i++)node.childNodes.item(i).nodeType===(node.ELEMENT_NODE||Node.ELEMENT_NODE)&&traverse(node.childNodes.item(i))}(doc),self.reset()}serialize(node,name,indentation){let result="";for(let i=0;i<indentation;i++)result+="\t";if("string"==typeof node||"number"==typeof node)return result+node;if(Array.isArray(node)){result="";for(let i=0;i<node.length;i++)result+=this.serialize(node[i],name,indentation)}else{let childResult="";for(let p in node)if(node.hasOwnProperty(p)){if("#"==p[0])continue;childResult+=this.serialize(node[p],p,indentation+1)}if(result+="<"+name,node.hasOwnProperty("#attributes"))for(let p in node["#attributes"])node["#attributes"].hasOwnProperty(p)&&(result+=" "+p+'="'+node["#attributes"][p]+'"');if(node.hasOwnProperty("#text"))result+=">"+node["#text"]+"</"+name+">\n";else if(""==childResult)result+="/>\n";else{result+=">\n",result+=childResult;for(let i=0;i<indentation;i++)result+="\t";result+="</"+name+">\n"}}return result}save(targetState){let result={condiciones:{"#attributes":{instruccionesMaximasAEjecutar:this.maxInstructions,longitudStack:this.maxStackSize,memoriaStack:this.maxStackMemory,llamadaMaxima:this.maxCallSize},comando:[]},mundos:{mundo:{"#attributes":{nombre:this.worldName,ancho:this.w,alto:this.h},monton:[],pared:[],posicionDump:[]}},programas:{"#attributes":{tipoEjecucion:"CONTINUA",intruccionesCambioContexto:1,milisegundosParaPasoAutomatico:0},programa:{"#attributes":{nombre:this.programName,ruta:"{$2$}",mundoDeEjecucion:this.worldName,xKarel:"start"===targetState?this.start_j:this.j,yKarel:"start"===targetState?this.start_i:this.i,direccionKarel:["OESTE","NORTE","ESTE","SUR"]["start"===targetState?this.startOrientation:this.orientation],mochilaKarel:-1==this.bagBuzzers?"INFINITO":"start"===targetState?this.startBagBuzzers:this.bagBuzzers},despliega:[]}}};for(let i=1;i<=this.h;i++)for(let j=1;j<=this.w;j++){let buzzers="start"===targetState?this.startBuzzers(i,j):this.buzzers(i,j);0!==buzzers&&result.mundos.mundo.monton.push({"#attributes":{x:j,y:i,zumbadores:-1==buzzers?"INFINITO":buzzers}})}-1!==this.maxMove&&result.condiciones.comando.push({"#attributes":{nombre:"AVANZA",maximoNumeroDeEjecuciones:this.maxMove}}),-1!==this.maxTurnLeft&&result.condiciones.comando.push({"#attributes":{nombre:"GIRA_IZQUIERDA",maximoNumeroDeEjecuciones:this.maxTurnLeft}}),-1!==this.maxLeaveBuzzer&&result.condiciones.comando.push({"#attributes":{nombre:"DEJA_ZUMBADOR",maximoNumeroDeEjecuciones:this.maxLeaveBuzzer}}),-1!==this.maxPickBuzzer&&result.condiciones.comando.push({"#attributes":{nombre:"COGE_ZUMBADOR",maximoNumeroDeEjecuciones:this.maxPickBuzzer}});for(let i=1;i<=this.h;i++)for(let j=1;j<=this.w;j++){let walls=this.walls(i,j);for(let k=2;k<8;k<<=1)i==this.h&&2==k||j==this.w&&4==k||(walls&k)==k&&(2==k?result.mundos.mundo.pared.push({"#attributes":{x1:j-1,y1:i,x2:j}}):4==k&&result.mundos.mundo.pared.push({"#attributes":{x1:j,y1:i-1,y2:i}}))}for(let i=0;i<this.dumpCells.length;i++)result.mundos.mundo.posicionDump.push({"#attributes":{x:this.dumpCells[i][1],y:this.dumpCells[i][0]}});for(let p in this.dumps)this.dumps.hasOwnProperty(p)&&this.dumps[p]&&result.programas.programa.despliega.push({"#attributes":{tipo:p.toUpperCase()}});return this.serialize(result,"ejecucion",0)}output(){let result={};if(this.dumps[DumpTypes.DUMP_WORLD]||this.dumps[DumpTypes.DUMP_ALL_BUZZERS]){result.mundos={mundo:{"#attributes":{nombre:this.worldName},linea:[]}};let dumpCells={};for(let i=0;i<this.dumpCells.length;i++)dumpCells.hasOwnProperty(this.dumpCells[i][0])||(dumpCells[this.dumpCells[i][0]]={}),dumpCells[this.dumpCells[i][0]][this.dumpCells[i][1]]=!0;for(let i=this.h;i>0;i--){let printCoordinate=!0,line="";for(let j=1;j<=this.w;j++)(dumpCells[i]&&dumpCells[i][j]||this.dumps[DumpTypes.DUMP_ALL_BUZZERS])&&(0!==this.buzzers(i,j)&&(printCoordinate&&(line+="("+j+") "),line+=(65535&this.buzzers(i,j))+" "),printCoordinate=0==this.buzzers(i,j));""!==line&&result.mundos.mundo.linea.push({"#attributes":{fila:i,compresionDeCeros:"true"},"#text":line})}}return result.programas={programa:{"#attributes":{nombre:this.programName}}},result.programas.programa["#attributes"].resultadoEjecucion=this.errorMap(this.runtime.state.error),this.dumps[DumpTypes.DUMP_POSITION]&&(result.programas.programa.karel={"#attributes":{x:this.j,y:this.i}}),this.dumps[DumpTypes.DUMP_ORIENTATION]&&(result.programas.programa.karel=result.programas.programa.karel||{"#attributes":{}},result.programas.programa.karel["#attributes"].direccion=["OESTE","NORTE","ESTE","SUR"][this.orientation]),this.dumps[DumpTypes.DUMP_BAG]&&(result.programas.programa.karel=result.programas.programa.karel||{"#attributes":{}},result.programas.programa.karel["#attributes"].mochila=-1==this.bagBuzzers?"INFINITO":this.bagBuzzers),this.dumps[DumpTypes.DUMP_MOVE]&&(result.programas.programa.instrucciones=result.programas.programa.instrucciones||{"#attributes":{}},result.programas.programa.instrucciones["#attributes"].avanza=this.runtime.state.moveCount),this.dumps[DumpTypes.DUMP_LEFT]&&(result.programas.programa.instrucciones=result.programas.programa.instrucciones||{"#attributes":{}},result.programas.programa.instrucciones["#attributes"].gira_izquierda=this.runtime.state.turnLeftCount),this.dumps[DumpTypes.DUMP_PICK_BUZZER]&&(result.programas.programa.instrucciones=result.programas.programa.instrucciones||{"#attributes":{}},result.programas.programa.instrucciones["#attributes"].coge_zumbador=this.runtime.state.pickBuzzerCount),this.dumps[DumpTypes.DUMP_LEAVE_BUZZER]&&(result.programas.programa.instrucciones=result.programas.programa.instrucciones||{"#attributes":{}},result.programas.programa.instrucciones["#attributes"].deja_zumbador=this.runtime.state.leaveBuzzerCount),this.serialize(result,"resultados",0)}move(i,j){this.i=this.start_i=i,this.j=this.start_j=j,this.dirty=!0}rotate(orientation){let orientations=["OESTE","NORTE","ESTE","SUR"];orientation||(orientation=orientations[(this.orientation+3)%4]),this.orientation=this.startOrientation=Math.max(0,orientations.indexOf(orientation)),this.dirty=!0}setBagBuzzers(buzzers){isNaN(buzzers)&&(buzzers=0),this.bagBuzzers=this.startBagBuzzers=65535==buzzers?-1:buzzers,this.dirty=!0}reset(){this.orientation=this.startOrientation,this.move(this.start_i,this.start_j),this.bagBuzzers=this.startBagBuzzers;for(let i=0;i<this.currentMap.length;i++)this.currentMap[i]=this.map[i];this.runtime.reset(),this.dirty=!0}errorMap(s){return s?ERROR_MAPPING.hasOwnProperty(s)?ERROR_MAPPING[s]:s:"FIN PROGRAMA"}}function tabs(indentation){let result="";for(let i=0;i<indentation;i++)result+="\t";return result}function resolveCall$1(data,transpilerData){const params=data.params.map((param=>processTerm$1(param,transpilerData))).join(", ");return`${data.target} (${params})`}function translatePackages$1(packName){return"rekarel.globales"===packName?"rekarel.globals":packName}function processTerm$1(term,data){return"ATOM"===term.operation?function(atom,data){const atomType=atom.atomType.split(".")[0],boolFunctions={IFNFWALL:"frontIsClear",IFFWALL:"frontIsBlocked",IFNLWALL:"leftIsClear",IFLWALL:"leftIsBlocked",IFNRWALL:"rightIsClear",IFRWALL:"rightIsBlocked",IFWBUZZER:"nextToABeeper",IFNWBUZZER:"notNextToABeeper",IFBBUZZER:"anyBeepersInBeeperBag",IFNBBUZZER:"noBeepersInBeeperBag",IFN:"facingNorth",IFS:"facingSouth",IFE:"facingEast",IFW:"facingWest",IFNN:"notFacingNorth",IFNS:"notFacingSouth",IFNE:"notFacingEast",IFNW:"notFacingWest"};if("IMPLICIT"===atomType)return"";if("IS_ZERO"===atomType)return`iszero(${processTerm$1(atom.instructions[0][1],data)})`;if("NUMBER"===atomType)return atom.atomType.split(".")[1];if("INC"===atomType){const term=processTerm$1(atom.instructions[0][1],data);return atomType===atom.atomType?`succ(${term})`:`succ(${term}, ${atom.atomType.split(".")[1]})`}if("DEC"===atomType){const term=processTerm$1(atom.instructions[0][1],data);return atomType===atom.atomType?`pred(${term})`:`pred(${term}, ${atom.atomType.split(".")[1]})`}if("VAR"===atomType)return function(word,data){if(data.hasGlobals){if("zumbadores-del-piso"===word)return"beepersOnFloor";if("zumbadores-en-la-mochila"===word)return"beepersInBeeperBag";if("verdadero"===word)return"true";if("falso"===word)return"false";if("fila-actual"===word)return"currentRow";if("columna-actual"===word)return"currentColumn"}return word}(atom.atomType.split(".")[1],data);return"CALL"===atomType?resolveCall$1(atom.instructions[0][1],data):atomType in boolFunctions?boolFunctions[atomType]:`/* UNKNOWN ATOM TYPE ${atomType}*/`}(term,data):"PASS"===term.operation?processTerm$1(term.term,data):"PARENTHESIS"===term.operation?`(${processTerm$1(term.term,data)})`:"AND"===term.operation?`${processTerm$1(term.left,data)} && ${processTerm$1(term.right,data)}`:"OR"===term.operation?`${processTerm$1(term.left,data)} || ${processTerm$1(term.right,data)}`:"NOT"===term.operation?`!${processTerm$1(term.term,data)}`:"EQ"===term.operation?`${processTerm$1(term.left,data)} == ${processTerm$1(term.right,data)}`:"LT"===term.operation?`${processTerm$1(term.left,data)} < ${processTerm$1(term.right,data)}`:"LTE"===term.operation?`${processTerm$1(term.left,data)} <= ${processTerm$1(term.right,data)}`:void 0}function processIf$1(conditional,indentation,data){let result=[];const condition=processTerm$1(conditional.condition[1],data);return result.push(`${tabs(indentation)}if (${condition}) {`),result=result.concat(processInstructions$1(conditional.trueCase,indentation+1,data)),null==conditional.skipFalseTag?(result.push(`${tabs(indentation)}}`),result):(result.push(`${tabs(indentation)}} else {`),result=result.concat(processInstructions$1(conditional.falseCase,indentation+1,data)),result.push(`${tabs(indentation)}}`),result)}function processRepeat$1(conditional,indentation,data){let result=[];const iterations=processTerm$1(conditional.loopCount[1],data);return result.push(`${tabs(indentation)}iterate (${iterations}) {`),result=result.concat(processInstructions$1(conditional.instructions,indentation+1,data)),result.push(`${tabs(indentation)}}`),result}function processWhile$1(conditional,indentation,data){let result=[];const condition=processTerm$1(conditional.condition[1],data);return result.push(`${tabs(indentation)}while (${condition}) {`),result=result.concat(processInstructions$1(conditional.instructions,indentation+1,data)),result.push(`${tabs(indentation)}}`),result}function processInstructions$1(instructions,indentation,transpilerData){let result=[];for(const instruction of instructions)if("LINE"!==instruction[0])if("HALT"!==instruction[0])if("LEFT"!==instruction[0])if("FORWARD"!==instruction[0])if("PICKBUZZER"!==instruction[0])if("LEAVEBUZZER"!==instruction[0])if("CALL"!==instruction[0])if("RET"!==instruction[0])if("IF"!==instruction[0])if("REPEAT"!==instruction[0])if("WHILE"!==instruction[0]){if("CONTINUE"===instruction[0]){result.push(`${tabs(indentation)}continue;`);break}if("BREAK"===instruction[0]){result.push(`${tabs(indentation)}break;`);break}result.push(`${tabs(indentation)}/** @PARSER Unknown intruction ${instruction[0]}*/`)}else result=result.concat(processWhile$1(instruction[1],indentation,transpilerData));else result=result.concat(processRepeat$1(instruction[1],indentation,transpilerData));else result=result.concat(processIf$1(instruction[1],indentation,transpilerData));else{if("__DEFAULT"===instruction[1])continue;const term=processTerm$1(instruction[1].term,transpilerData);""===term?result.push(`${tabs(indentation)}return;`):result.push(`${tabs(indentation)}return ${term};`)}else{const data=instruction[1];result.push(`${tabs(indentation)}${resolveCall$1(data,transpilerData)};`)}else result.push(`${tabs(indentation)}putbeeper();`);else result.push(`${tabs(indentation)}pickbeeper();`);else result.push(`${tabs(indentation)}move();`);else result.push(`${tabs(indentation)}turnleft();`);else result.push(`${tabs(indentation)}turnoff();`);return result}function generateJavaFromIR(data){let transpilerData={hasGlobals:-1!==data.packages.findIndex((val=>"rekarel.globals"===translatePackages$1(val[0])))},functions=data.functions.filter((func=>null!=func.code)).map((func=>function(func,transpilerData){let body=processInstructions$1(func.code,2,transpilerData).join("\n"),func_type="define";"INT"===func.returnType?func_type="int":"BOOL"===func.returnType&&(func_type="bool");let params=func.params.map((param=>param.name)).join(", ");return`\t${func_type} ${func.name} (${params}) {\n${body}\n\t}\n`}(func,transpilerData))).join("\n");let mainBody=processInstructions$1(data.program.slice(0,-1),2,transpilerData).join("\n");return`${data.packages.map((packImport=>`import ${translatePackages$1(packImport[0])};\n`)).join()}class program {\n${functions}\n\tprogram() {\n${mainBody}\n\t}   \n\n}`}function resolveCall(data,transpilerData){if(data.params.length>0){const params=data.params.map((param=>processTerm(param,transpilerData))).join(", ");return`${data.target}(${params})`}return`${data.target}`}function translatePackages(packName){return"rekarel.globals"===packName?"rekarel.globales":packName}function processTerm(term,data){return"ATOM"===term.operation?function(atom,data){const atomType=atom.atomType.split(".")[0],boolFunctions={IFNFWALL:"frente-libre",IFFWALL:"frente-bloqueado",IFNLWALL:"izquierda-libre",IFLWALL:"izquierda-bloqueada",IFNRWALL:"derecha-libre",IFRWALL:"derecha-bloqueada",IFWBUZZER:"junto-a-zumbador",IFNWBUZZER:"no-junto-a-zumbador",IFBBUZZER:"algun-zumbador-en-la-mochila",IFNBBUZZER:"ningun-zumbador-en-la-mochila",IFN:"orientado-al-norte",IFS:"orientado-al-sur",IFE:"orientado-al-este",IFW:"orientado-al-oeste",IFNN:"no-orientado-al-norte",IFNS:"no-orientado-al-sur",IFNE:"no-orientado-al-este",IFNW:"no-orientado-al-oeste"};if("IMPLICIT"===atomType)return"";if("IS_ZERO"===atomType)return`es-cero(${processTerm(atom.instructions[0][1],data)})`;if("NUMBER"===atomType)return atom.atomType.split(".")[1];if("INC"===atomType){const term=processTerm(atom.instructions[0][1],data);return atomType===atom.atomType?`sucede(${term})`:`sucede(${term}, ${atom.atomType.split(".")[1]})`}if("DEC"===atomType){const term=processTerm(atom.instructions[0][1],data);return atomType===atom.atomType?`precede(${term})`:`precede(${term}, ${atom.atomType.split(".")[1]})`}if("VAR"===atomType)return function(word,data){if(data.hasGlobals){if("beepersOnFloor"===word)return"zumbadores-del-piso";if("beepersInBeeperBag"===word)return"zumbadores-en-la-mochila";if("true"===word)return"verdadero";if("false"===word)return"falso";if("currentRow"===word)return"fila-actual";if("currentColumn"===word)return"columna-actual"}return word}(atom.atomType.split(".")[1],data);return"CALL"===atomType?resolveCall(atom.instructions[0][1],data):atomType in boolFunctions?boolFunctions[atomType]:`/* UNKNOWN ATOM TYPE ${atomType}*/`}(term,data):"PASS"===term.operation?processTerm(term.term,data):"PARENTHESIS"===term.operation?`(${processTerm(term.term,data)})`:"AND"===term.operation?`${processTerm(term.left,data)} y ${processTerm(term.right,data)}`:"OR"===term.operation?`${processTerm(term.left,data)} o ${processTerm(term.right,data)}`:"NOT"===term.operation?`no ${processTerm(term.term,data)}`:"EQ"===term.operation?`${processTerm(term.left,data)} == ${processTerm(term.right,data)}`:"LT"===term.operation?`${processTerm(term.left,data)} < ${processTerm(term.right,data)}`:"LTE"===term.operation?`${processTerm(term.left,data)} <= ${processTerm(term.right,data)}`:void 0}function processIf(conditional,indentation,data){let result=[];const condition=processTerm(conditional.condition[1],data);return result.push(`${tabs(indentation)}si ${condition} entonces`),result.push(`${tabs(indentation)}inicio`),result=result.concat(processInstructions(conditional.trueCase,indentation+1,data)),null==conditional.skipFalseTag?(result.push(`${tabs(indentation)}fin;`),result):(result.push(`${tabs(indentation)}fin`),result.push(`${tabs(indentation)}sino`),result.push(`${tabs(indentation)}inicio`),result=result.concat(processInstructions(conditional.falseCase,indentation+1,data)),result.push(`${tabs(indentation)}fin;`),result)}function processRepeat(conditional,indentation,data){let result=[];const iterations=processTerm(conditional.loopCount[1],data);return result.push(`${tabs(indentation)}repetir ${iterations} veces`),result.push(`${tabs(indentation)}inicio`),result=result.concat(processInstructions(conditional.instructions,indentation+1,data)),result.push(`${tabs(indentation)}fin;`),result}function processWhile(conditional,indentation,data){let result=[];const condition=processTerm(conditional.condition[1],data);return result.push(`${tabs(indentation)}mientras ${condition} hacer`),result.push(`${tabs(indentation)}inicio`),result=result.concat(processInstructions(conditional.instructions,indentation+1,data)),result.push(`${tabs(indentation)}fin;`),result}function processInstructions(instructions,indentation,transpilerData){let result=[];for(const instruction of instructions)if("LINE"!==instruction[0])if("HALT"!==instruction[0])if("LEFT"!==instruction[0])if("FORWARD"!==instruction[0])if("PICKBUZZER"!==instruction[0])if("LEAVEBUZZER"!==instruction[0])if("CALL"!==instruction[0])if("RET"!==instruction[0])if("IF"!==instruction[0])if("REPEAT"!==instruction[0])if("WHILE"!==instruction[0]){if("CONTINUE"===instruction[0]){result.push(`${tabs(indentation)}continua;`);break}if("BREAK"===instruction[0]){result.push(`${tabs(indentation)}rompe;`);break}result.push(`${tabs(indentation)}/** @PARSER Instruccion desconocida ${instruction[0]}*/`)}else result=result.concat(processWhile(instruction[1],indentation,transpilerData));else result=result.concat(processRepeat(instruction[1],indentation,transpilerData));else result=result.concat(processIf(instruction[1],indentation,transpilerData));else{if("__DEFAULT"===instruction[1])continue;const term=processTerm(instruction[1].term,transpilerData);""===term?result.push(`${tabs(indentation)}regresa;`):result.push(`${tabs(indentation)}regresa ${term};`)}else{const data=instruction[1];result.push(`${tabs(indentation)}${resolveCall(data,transpilerData)};`)}else result.push(`${tabs(indentation)}deja-zumbador;`);else result.push(`${tabs(indentation)}coge-zumbador;`);else result.push(`${tabs(indentation)}avanza;`);else result.push(`${tabs(indentation)}gira-izquierda;`);else result.push(`${tabs(indentation)}apagate;`);return result}function generatePascalFromIR(data){let transpilerData={hasGlobals:-1!==data.packages.findIndex((val=>"rekarel.globales"===translatePackages(val[0])))},functions=data.functions.filter((func=>null!=func.code)).map((func=>function(func,transpilerData){let body=processInstructions(func.code,2,transpilerData).join("\n"),func_type="define";"INT"===func.returnType?func_type="define-calculo":"BOOL"===func.returnType&&(func_type="define-condicion");let head=`${func_type} ${func.name}`;func.params.length>0&&(head+=` (${func.params.map((param=>param.name)).join(", ")})`);return`\t${head} como\n\tinicio\n${body}\n\tfin;\n`}(func,transpilerData))).join("\n");let mainBody=processInstructions(data.program.slice(0,-1),2,transpilerData).join("\n");return`${data.packages.map((packImport=>`usa ${translatePackages(packImport[0])};\n`)).join()}iniciar-programa\n${functions}\n\tinicia-ejecucion\n${mainBody}\n\ttermina-ejecucion   \nfinalizar-programa`}const ERRORCODES={WALL:"Karel ha chocado con un muro!",WORLDUNDERFLOW:"Karel intentó tomar zumbadores en una posición donde no había!",BAGUNDERFLOW:"Karel intentó dejar un zumbador pero su mochila estaba vacía!",INSTRUCTION:"Karel ha superado el límite de instrucciones!",STACK:"La pila de karel se ha desbordado!"};const DefaultWRStyle={disabled:"#4f4f4f",exportCellBackground:"#f5f7a8",karelColor:"#3E6AC1",gridBackgroundColor:"#ffffff",errorGridBackgroundColor:"#f5d5d5",gridBorderColor:"#c4c4c4",errorGridBorderColor:"#a8838f",gutterBackgroundColor:"#e6e6e6",gutterColor:"#444444",beeperBackgroundColor:"#0ADB23",beeperColor:"#000000",wallColor:"#000000",waffleColor:"#0d6dfd",gutterSelectionBackgroundColor:"#86afd5",gutterSelectionColor:"#000000"},WR_CLEAN={disabled:"#4f4f4f",exportCellBackground:"#f5f7a8",karelColor:"#3E6AC1",gridBackgroundColor:"#ffffff",errorGridBackgroundColor:"#f5d5d5",gridBorderColor:"#c4c4c4",errorGridBorderColor:"#a8838f",gutterBackgroundColor:"#e6e6e6",gutterColor:"#444444",beeperBackgroundColor:"#ffffff",beeperColor:"#000000",wallColor:"#000000",waffleColor:"#0d6dfd",gutterSelectionBackgroundColor:"#86afd5",gutterSelectionColor:"#000000"},WR_DARK={disabled:"#4f4f4f",exportCellBackground:"#f5f7a8",karelColor:"#328EAD",gridBackgroundColor:"#282828",errorGridBackgroundColor:"#5D3D3D",gridBorderColor:"#565656",errorGridBorderColor:"#565656",gutterBackgroundColor:"#3B3B3B",gutterColor:"#E8E8E8",beeperBackgroundColor:"#005608",beeperColor:"#ffffff",wallColor:"#f1f1f1",waffleColor:"#82e8ff",gutterSelectionBackgroundColor:"#352f7f",gutterSelectionColor:"#FCFCFC"},WR_CONTRAST={disabled:"#4f4f4f",exportCellBackground:"#f5f7a8",karelColor:"#3F69DB",gridBackgroundColor:"#ffffff",errorGridBackgroundColor:"#5D3D3D",gridBorderColor:"#565656",errorGridBorderColor:"#565656",gutterBackgroundColor:"#e3e3e3",gutterColor:"#000000",beeperBackgroundColor:"#000000",beeperColor:"#ffffff",wallColor:"#000000",waffleColor:"#ff0000",gutterSelectionBackgroundColor:"#000000",gutterSelectionColor:"#ffffff"};let appSettings={version:"0.7.0",interface:"desktop",autoInputMode:!0,editorTheme:"classic",editorFontSize:12,theme:"system",worldRendererStyle:DefaultWRStyle,slowExecutionLimit:2e5};function SetSettings(settings){appSettings=settings}function GetCurrentSetting(){return appSettings}var __awaiter$1=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};const throbber=new class{constructor(element){this.element=element,this.shouldBeVisible=!1,this.visible=!1,this.hide()}show(){this.element.show(),this.visible=!0}hide(){this.shouldBeVisible=!1,this.visible=!1,this.element.hide()}showInSeconds(seconds){this.shouldBeVisible=!0,setTimeout((()=>{this.shouldBeVisible&&this.show()}),1e3*seconds)}performTask(task){return __awaiter$1(this,void 0,void 0,(function*(){const iter=task();let curr=iter.next(),last=curr.value;const startTime=Date.now();for(;!curr.done&&Date.now()-startTime<1e3;)last=curr.value,curr=iter.next();if(curr.done)return last;this.show();return new Promise(((resolve,reject)=>setTimeout((()=>{for(;!curr.done;)last=curr.value,curr=iter.next();this.hide(),resolve(last)}))))}))}}($("#throbber"));let editors=function(){let startState=EditorState.create({doc:"usa rekarel.globales;\niniciar-programa\n\tinicia-ejecucion\n\t\t{ TODO poner codigo aqui }\n\t\tapagate;\n\ttermina-ejecucion\nfinalizar-programa",extensions:[language.of(kpascal()),theme.of(classicHighlight.extensions),syntaxHighlighting(defaultHighlightStyle,{fallback:!0}),breakpointGutter,[karelLineTheme,highlightedLine.of(karelLineFacet.of(-1)),executionCursor.of(karelColumnFacet.of(-1)),lineHighlighting,columnCursorPlugin],history(),drawSelection(),lineNumbers(),activeLineHighlighter,foldGutter(),bracketMatching(),rectangularSelection(),crosshairCursor(),[inputHandler,bracketState],EditorState.transactionFilter.of((tr=>{if(!tr.docChanged||!tr.isUserEvent("input.type")&&!tr.isUserEvent("input.complete"))return tr;let rules=tr.startState.languageDataAt("indentOnInput",tr.startState.selection.main.head);if(!rules.length)return tr;let doc=tr.newDoc,{head:head}=tr.newSelection.main,line=doc.lineAt(head);if(head>line.from+200)return tr;let lineStart=doc.sliceString(line.from,head);if(!rules.some((r=>r.test(lineStart))))return tr;let{state:state}=tr,last=-1,changes=[];for(let{head:head}of state.selection.ranges){let line=state.doc.lineAt(head);if(line.from==last)continue;last=line.from;let indent=getIndentation(state,line.from);if(null==indent)continue;let cur=/^\s*/.exec(line.text)[0],norm=indentString(state,indent);cur!=norm&&changes.push({from:line.from,to:line.from+cur.length,insert:norm})}return changes.length?[tr,{changes:changes,sequential:!0}]:tr})),highlightSelectionMatches(),indentUnit.of("\t"),readOnly.of(EditorState.readOnly.of(!1)),tabSize.of(EditorState.tabSize.of(4)),keymap.of([indentWithTab,...defaultKeymap,...historyKeymap,...searchKeymap])]});return[new EditorView({state:startState,parent:document.querySelector("#splitter-left-top-pane")})]}();function getEditors(){return editors}const parseErrorState=StateEffect.define({map:({from:from,to:to},change)=>({from:change.mapPos(from),to:change.mapPos(to)})}),underlineMark=Decoration.mark({class:"cm-underline"}),parseErrorField=StateField.define({create:()=>Decoration.none,update(underlines,tr){underlines=underlines.map(tr.changes);for(let e of tr.effects)e.is(parseErrorState)&&(underlines=-1===e.value.from?RangeSet.empty:underlines.update({add:[underlineMark.range(e.value.from,e.value.to)]}));return underlines},provide:f=>EditorView.decorations.from(f)}),underlineTheme=EditorView.baseTheme({".cm-underline":{backgroundImage:'url(\'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="6" height="3">%3Cpath%20d%3D%22m0%202.5%20l2%20-1.5%20l1%200%20l2%201.5%20l1%200%22%20stroke%3D%22%23d11%22%20fill%3D%22none%22%20stroke-width%3D%22.9%22%2F%3E</svg>\')',backgroundPosition:"left bottom",backgroundRepeat:"repeat-x",paddingBottom:"0.7px"}});class Operation{constructor(){this.commits=[]}forward(){for(let c of this.commits)c.forward()}backward(){for(let c of this.commits)c.backward()}addCommit(commit){this.commits.push(commit)}}class KarelHistory{constructor(){this.operations=[],this.currentOperation=null,this.size=0,this.head=0}StartOperation(){return this.EndOperation(),this.currentOperation=new Operation,this.currentOperation}EndOperation(){if(null!=this.currentOperation&&0!==this.currentOperation.commits.length){for(;this.head<this.operations.length;)this.size-=this.operations[this.operations.length-1].commits.length,this.operations.pop();this.operations.push(this.currentOperation),this.size+=this.currentOperation.commits.length,this.head++,this.currentOperation=null,this.TrimHistory()}}Clear(){this.size=0,this.operations=[]}Undo(){return!(this.head<=0)&&(this.head--,this.operations[this.head].backward(),!0)}Redo(){if(this.head>=this.operations.length)return!1;this.operations[this.head].forward(),this.head++}TrimHistory(){for(;this.operations.length>1&&this.size>1e3;)this.size-=this.operations[0].commits.length,this.operations.shift(),this.head--}}const ERROR_TOKENS={pascal:{BEGINPROG:'"iniciar-programa"',BEGINEXEC:'"inicia-ejecución"',ENDEXEC:'"termina-ejecución"',ENDPROG:'"finalizar-programa"',DEF:'"define-nueva-instrucción"',PROTO:'"define-prototipo-instrucción"',RET:'"sal-de-instrucción"',AS:'"como"',HALT:'"apágate"',LEFT:'"gira-izquierda"',FORWARD:'"avanza"',PICKBUZZER:'"coge-zumbador"',LEAVEBUZZER:'"deja-zumbador"',BEGIN:'"inicio"',END:'"fin"',THEN:'"entonces"',WHILE:'"mientras"',DO:'"hacer"',REPEAT:'"repetir"',TIMES:'"veces"',DEC:'"precede"',INC:'"sucede"',IFZ:'"si-es-cero"',IFNFWALL:'"frente-libre"',IFFWALL:'"frente-bloqueado"',IFNLWALL:'"izquierda-libre"',IFLWALL:'"izquierda-bloqueada"',IFNRWALL:'"derecha-libre"',IFRWALL:'"derecha-bloqueada"',IFWBUZZER:'"junto-a-zumbador"',IFNWBUZZER:'"no-junto-a-zumbador"',IFBBUZZER:'"algún-zumbador-en-la-mochila"',IFNBBUZZER:'"ningún-zumbador-en-la-mochila"',IFN:'"orientado-al-norte"',IFS:'"orientado-al-sur"',IFE:'"orientado-al-este"',IFW:'"orientado-al-oeste"',IFNN:'"no-orientado-al-norte"',IFNS:'"no-orientado-al-sur"',IFNE:'"no-orientado-al-este"',IFNW:'"no-orientado-al-oeste"',ELSE:'"si-no"',IF:'"si"',NOT:'"no"',OR:'"o"',AND:'"y"',"(":'"("',")":'")"',";":'";"',NUM:"un número",VAR:"un nombre",EOF:"el final del programa"},java:{CLASS:'"class"',PROG:'"program"',DEF:'"define"',RET:'"return"',HALT:'"turnoff"',LEFT:'"turnleft"',FORWARD:'"move"',PICKBUZZER:'"pickbeeper"',LEAVEBUZZER:'"putbeeper"',WHILE:'"while"',REPEAT:'"iterate"',DEC:'"pred"',INC:'"succ"',IFZ:'"iszero"',IFNFWALL:'"frontIsClear"',IFFWALL:'"frontIsBlocked"',IFNLWALL:'"leftIsClear"',IFLWALL:'"leftIsBlocked"',IFNRWALL:'"rightIsClear"',IFRWALL:'"rightIsBlocked"',IFWBUZZER:'"nextToABeeper"',IFNWBUZZER:'"notNextToABeeper"',IFBBUZZER:'"anyBeepersInBeeperBag"',IFNBBUZZER:'"noBeepersInBeeperBag"',IFN:'"facingNorth"',IFS:'"facingSouth"',IFE:'"facingEast"',IFW:'"facingWest"',IFNN:'"notFacingNorth"',IFNS:'"notFacingSouth"',IFNE:'"notFacingEast"',IFNW:'"notFacingWest"',ELSE:'"else"',IF:'"if"',NOT:'"!"',OR:'"||"',AND:'"&&"',"(":'"("',")":'")"',BEGIN:'"{"',END:'"}"',";":'";"',NUM:"un número",VAR:"un nombre",EOF:"el final del programa"}},operatorsJava={AND:"&#38;&#38;",OR:"||",LT:"<",LTE:"<=",NOT:"!"},operatorsPascal={AND:"y",OR:"o",LT:"<",LTE:"<=",NOT:"no"};function decodeError(e,lan){var _a;if("ruby"===lan||"none"===lan)return"Error de compilación, no se puede reconocer el lenguaje";let status=e.hash;if(console.log(JSON.stringify(e)),console.log(e),null==status)return"Error de compilación";const errorString=`${e}`;let message=`Error de compilación en  la ${function(line,column){let c=column;return null==column&&(c=0),`<a class="text-decoration-underline" href="#" title="Haz clic para ir al error" onclick="karel.MoveEditorCursorToLine(${line}, ${c})">línea ${line}</a>`}(status.line+1,null===(_a=status.loc)||void 0===_a?void 0:_a.first_column)}\n<br>\n<div class="card"><div class="card-body">`;if(status.expected){let expectations=status.expected.map((x=>ERROR_TOKENS[lan][x.replace(/^'+/,"").replace(/'+$/,"")]));message+=`Se encontró "${status.text}" cuando se esperaba ${expectations.join(", ")}`}else null!=status.error?message+=function(status,lan){if(status.error===CompilationError.Errors.BINARY_OPERATOR_TYPE_ERROR){const direction="LEFT"===status.direction?"izquierdo":"derecho";return`Para el operador <b>${"java"===lan?operatorsJava[status.operator]:operatorsPascal[status.operator]}</b> no puede utilizar un termino ${direction} de tipo ${status.actualType}, necesita ${status.expectedType}.`}if(status.error===CompilationError.Errors.CALL_TYPE)return`Se llamó a <b>${status.funcName}</b> en un lugar donde se esperaba un tipo ${status.expectedCallType}, pero la función es de tipo ${status.functionType}.`;if(status.error===CompilationError.Errors.COMPARISON_TYPE)return`Se intento comparar un tipo <b>${status.leftType}</b> contra un tipo <b>${status.rightType}</b> . Solo se pueden comparar los mismos tipos`;if(status.error===CompilationError.Errors.FUNCTION_ILLEGAL_NAME)return`La función no se puede llamar como una variable global: ${status.functionName}`;if(status.error===CompilationError.Errors.FUNCTION_REDEFINITION)return`La función <b>${status.functionName}</b> ya fue definida previamente`;if(status.error===CompilationError.Errors.ILLEGAL_BREAK)return`No se puede usar la instrucción <b>${"java"===lan?"break":"rompe"}</b> en este lugar`;if(status.error===CompilationError.Errors.ILLEGAL_CONTINUE)return`No se puede usar la instrucción <b>${"java"===lan?"continue":"continua"}</b> en este lugar`;if(status.error===CompilationError.Errors.NO_EXPLICIT_RETURN)return`La función ${status.functionName} es de tipo ${status.returnType}, pero no siempre retorna un valor`;if(status.error===CompilationError.Errors.PARAMETER_ILLEGAL_NAME)return`No se puede llamar a un parámetro <b>${status.parameterName}</b> porque ya esta siendo usado por otra función o variable global`;if(status.error===CompilationError.Errors.PARAMETER_REDEFINITION)return`El parámetro <b>${status.parameterName}</b> ya fue definido`;if(status.error===CompilationError.Errors.PROTOTYPE_PARAMETERS_MISS_MATCH)return`El prototipo de <b>${status.functionName}</b> no concuerda con su definición.<br> El prototipo tiene ${status.prototypeParamCount} parámetros, pero su definición tiene ${status.functionParamCount}`;if(status.error===CompilationError.Errors.PROTOTYPE_REDEFINITION)return`El prototipo <b>${status.prototypeName}</b> ya fue definido previamente`;if(status.error===CompilationError.Errors.PROTOTYPE_TYPE_MISS_MATCH)return`El prototipo de <b>${status.functionName}</b> no concuerda con su definición.<br> El prototipo es de tipo ${status.prototypeType}, pero su definición es ${status.functionType}`;if(status.error===CompilationError.Errors.RETURN_TYPE)return`No se puede retornar un tipo  <b>${status.actualType}</b>, porque la función es de tipo ${status.expectedType}`;if(status.error===CompilationError.Errors.TOO_FEW_PARAMS_IN_CALL)return`Se llamó a <b>${status.funcName}</b> con menos parámetros de los necesarios.<br> La llamada tiene ${status.actualParams}, pero su definición necesita ${status.expectedParams}`;if(status.error===CompilationError.Errors.TOO_MANY_PARAMS_IN_CALL)return`Se llamó a <b>${status.functionName}</b> con menos parámetros de los necesarios.<br> La llamada tiene ${status.actualParams}, pero su definición necesita ${status.expectedParams}`;if(status.error===CompilationError.Errors.TYPE_ERROR)return`No se puede utilizar el tipo ${status.actualType} donde se requiere un tipo ${status.expectedType}`;if(status.error===CompilationError.Errors.UNARY_OPERATOR_TYPE_ERROR)return`Para el operador <b>${"java"===lan?operatorsJava[status.operator]:operatorsPascal[status.operator]}</b> no puede utilizar un termino de tipo ${status.actualType}, necesita ${status.expectedType}.`;return status.error===CompilationError.Errors.UNDEFINED_FUNCTION?`La función <b>${status.functionName}</b> no está definida`:status.error===CompilationError.Errors.UNKNOWN_MODULE?`No se reconoce el módulo <b>${status.module}</b> en la importación de ${status.full}`:status.error===CompilationError.Errors.UNKNOWN_PACKAGE?`No se reconoce el paquete <b>${status.package}</b> en la importación de ${status.full}`:status.error===CompilationError.Errors.UNKNOWN_VARIABLE?`El parámetro o variable <b>${status.variable}</b> no está definido`:status.error===CompilationError.Errors.VOID_COMPARISON?"No se pueden comparar dos expresiones de tipo VOID.":status.error===CompilationError.Errors.UNKNOWN_SYNTAX?"Error de compilación, no se puede reconocer el lenguaje":`Error de compilación desconocido:  ${JSON.stringify(status)}`}(status,lan):errorString.includes("Unrecognized text")?message+="Se encontró un token ilegal":message+="Error desconocido";return message+="</div></div>",message}var AppVars,__awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class KarelController{constructor(world){this.world=world,this.running=!1,this.onMessage=[],this.onStateChange=[],this.onStep=[],this.onReset=[],this.onNewWorld=[],this.onCompile=[],this.onSlowMode=[],this.state="unstarted",this.endedOnError=!1,this.autoStepInterval=0,this.autoStepping=!1,this.futureStepping=!1,KarelController.instance=this,this.history=new KarelHistory}static GetInstance(){return KarelController.instance}GetHistory(){return this.history}GetDebugData(){return this.debugData}Compile(notifyOnSuccess=!0){const mainEditor=getEditors()[0];let code=mainEditor.state.doc.toString(),language=detectLanguage(code);"java"!==language&&"pascal"!==language||setLanguage(mainEditor,language);let response=null;try{!function(view){let effects=[parseErrorState.of({from:-1,to:-1})];view.state.field(parseErrorField,!1)||effects.push(StateEffect.appendConfig.of([parseErrorField,underlineTheme])),view.dispatch({effects:effects})}(mainEditor),response=function(code,exportDebug=!1){let compiler=null;switch(detectLanguage(code)){case"java":compiler=javaCompiler;break;case"pascal":compiler=pascalCompiler;break;default:let errorStatus={error:CompilationError.Errors.UNKNOWN_SYNTAX,line:0,loc:{first_column:0,first_line:1,last_column:0,last_line:1}},error=new Error("Unknown syntax, the start of the file must be either 'class' or 'iniciar-programa'");throw error.hash=errorStatus,error}return compiler(code,exportDebug)}(code,!0),notifyOnSuccess&&this.SendMessage("Programa compilado correctamente","info"),this.NotifyCompile(!0,language)}catch(e){if(this.SendMessage(decodeError(e,language),"error"),e.hash.loc){const status=e.hash;!function(view,line,from,to){if(from===to)return;let real_from=view.state.doc.line(line).from+from,real_to=view.state.doc.line(line).from+to,effects=[parseErrorState.of({from:real_from,to:real_to})];view.state.field(parseErrorField,!1)||effects.push(StateEffect.appendConfig.of([parseErrorField,underlineTheme])),view.dispatch({effects:effects})}(mainEditor,status.loc.first_line,status.loc.first_column,status.loc.last_column)}return this.NotifyCompile(!1,language),null}return this.debugData=response[1],response[0]}validatorCallbacks(message){console.log("validator said this: ",message)}IsAutoStepping(){return this.autoStepping}GetState(){return this.state}Reset(){this.endedOnError=!1,this.world.reset(),this.running=!1,this.ChangeState("unstarted"),this.NotifyReset()}GetRuntime(){return this.world.runtime}StartRun(){this.endedOnError=!1,this.SendMessage("<hr>","raw");let compiled=this.Compile();if(null==compiled)return!1;this.Reset();let runtime=this.GetRuntime();return runtime.load(compiled),runtime.disableStackEvents=!1,runtime.start(),this.running=!0,this.ChangeState("running"),!0}Pause(){"running"===this.state&&(this.StopAutoStep(),this.ChangeState("paused"))}CheckForBreakPointOnCurrentLine(){let runtime=this.GetRuntime();if(runtime.state.line>=0){let hasBreakpoint=function(editor,line){let codeLine=editor.state.doc.line(line);codeLine.from;let breakpoints=editor.state.field(breakpointState),hasBreakpoint=!1;return breakpoints.between(codeLine.from,codeLine.from,(()=>{hasBreakpoint=!0})),hasBreakpoint}(getEditors()[0],runtime.state.line+1);return hasBreakpoint&&this.BreakPointMessage(runtime.state.line+1),hasBreakpoint}return!1}Step(){if(!this.StartStep())return;let runtime=this.GetRuntime();runtime.step();!function(editor,line){const text=editor.state.doc.line(line).text;return/\@saltatela/g.test(text)||/\@autoSkip/g.test(text)}(getEditors()[0],0!==runtime.state.line?runtime.state.line:1)?this.EndStep():this.StepOut()}StepOver(){if(!this.StartStep())return;const runtime=this.GetRuntime(),startWStackSize=runtime.state.stackSize;runtime.step(),runtime.state.stackSize>startWStackSize?throbber.performTask(function*(){for(;this.PerformAutoStep()&&runtime.state.stackSize>startWStackSize;)yield;runtime.step()}.bind(this)).then((()=>this.EndStep())):this.EndStep()}StepOut(){if(!this.StartStep())return;const runtime=this.GetRuntime(),startWStackSize=runtime.state.stackSize;0!==startWStackSize?(this.futureStepping=!0,throbber.performTask(function*(){for(;this.PerformAutoStep()&&runtime.state.stackSize>=startWStackSize;)yield;this.futureStepping=!1}.bind(this)).then((_=>this.EndStep()))):this.RunTillEnd()}StartAutoStep(delay){return this.StopAutoStep(),"finished"!==this.state&&(this.autoStepping=!0,!(!this.running&&!this.StartRun())&&("running"!==this.state&&this.ChangeState("running"),this.autoStepInterval=window.setInterval((()=>{this.running?this.futureStepping||this.Step():this.StopAutoStep()}),delay),!0))}ChangeAutoStepDelay(delay){this.IsAutoStepping()&&this.StartAutoStep(delay)}StopAutoStep(){this.autoStepping=!1,0!==this.autoStepInterval&&(clearInterval(this.autoStepInterval),this.autoStepInterval=0)}EndedOnError(){return this.endedOnError}RunTillEnd(ignoreBreakpoints=!1){return __awaiter(this,void 0,void 0,(function*(){if("finished"===this.state)return;if(!this.running&&!this.StartRun())return;this.futureStepping=!0;let runtime=this.GetRuntime();yield throbber.performTask(function*(){for(;this.PerformAutoStep(ignoreBreakpoints);)yield}.bind(this)).then((()=>{this.futureStepping=!1,runtime.state.running?this.Pause():(this.EndMessage(),this.ChangeState("finished")),this.NotifyStep()}))}))}RegisterMessageCallback(callback){this.onMessage.push(callback)}RegisterStateChangeObserver(callback){this.onStateChange.push(callback)}RegisterResetObserver(callback){this.onReset.push(callback)}RegisterNewWorldObserver(callback){this.onNewWorld.push(callback)}RegisterStepController(callback){this.onStep.push(callback)}RegisterCompileObserver(callback){this.onCompile.push(callback)}RegisterSlowModeObserver(callback){this.onSlowMode.push(callback)}Resize(w,h){this.Reset(),this.world.resize(w,h),this.NotifyNewWorld(!1)}NewWorld(){this.Reset();const w=this.world.w,h=this.world.h;this.world=new World(w,h),this.NotifyNewWorld(!0)}LoadWorld(world){this.world.load(world),this.NotifyNewWorld(!1)}StartStep(){return"finished"!==this.state&&!(!this.running&&!this.StartRun())}EndStep(){if(this.GetRuntime().state.running||(this.EndMessage(),this.ChangeState("finished")),this.CheckForBreakPointOnCurrentLine())return this.Pause(),void this.NotifyStep();this.NotifyStep()}PerformAutoStep(ignoreBreakpoints=!1){const runtime=this.GetRuntime(),result=runtime.step(),slowLimit=GetCurrentSetting().slowExecutionLimit;return runtime.state.ic>=slowLimit&&!runtime.disableStackEvents&&(runtime.disableStackEvents=!0,this.SendMessage(`Karel alcanzó las ${slowLimit.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")} instrucciones, Karel cambiará al modo rápido de ejecución, la pila de llamadas dejará de actualizarse`,"warning"),this.NotifySlowMode(slowLimit)),result&&(ignoreBreakpoints||!this.CheckForBreakPointOnCurrentLine())}SendMessage(message,type){this.onMessage.forEach((callback=>callback(message,type)))}NotifyStateChange(){this.onStateChange.forEach((callback=>callback(this,this.state)))}NotifyReset(){this.onReset.forEach((callback=>callback(this)))}NotifyNewWorld(usedNewInstance){this.onNewWorld.forEach((callback=>callback(this,this.world,usedNewInstance)))}NotifyStep(){this.onStep.forEach((callback=>callback(this,this.state)))}NotifyCompile(success,language){this.onCompile.forEach((callback=>callback(this,success,language)))}NotifySlowMode(limit){this.onSlowMode.forEach((callback=>callback(this,limit)))}ChangeState(nextState){this.state=nextState,this.NotifyStateChange()}EndMessage(){let state=this.GetRuntime().state;if(state.error)return this.SendMessage((error=state.error,limits={maxInstructions:this.world.maxInstructions,stackSize:this.world.maxStackSize,callMaxParam:this.world.maxCallSize,stackMemory:this.world.maxStackMemory},"INSTRUCTION"===error?`Karel ha superado el límite de ${limits.maxInstructions.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")} instrucciones!`:"STACK"===error?`La pila de karel se ha desbordado! El tamaño de la pila es de ${limits.stackSize.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}`:"CALLMEMORY"===error?`Límite de parámetros superados.<br>Solo puedes llamar con a lo más ${limits.callMaxParam.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}`:"STACKMEMORY"===error?`El límite de memoria del stack a sido superado.<br>Limite de memoria: ${limits.stackMemory.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}<br>El costo de una función es igual al mayor entre uno y la cantidad de parámetros que usa.`:error in ERRORCODES?ERRORCODES[error]:`Karel tubo un error de ejecución desconocido: ${error}`),"error"),void(this.endedOnError=!0);var error,limits;this.SendMessage("Ejecucion terminada exitosamente!","success");let inner="";this.world.getDumps(DumpTypes.DUMP_MOVE)&&(inner+=`<li class="list-group-item d-flex justify-content-between align-items-start"><div class="ms-2 me-auto">Avanza </div><span class="badge bg-primary rounded-pill">${state.moveCount}</span></li>`),this.world.getDumps(DumpTypes.DUMP_LEFT)&&(inner+=`<li class="list-group-item d-flex justify-content-between align-items-start"><div class="ms-2 me-auto">Gira izquierda </div><span class="badge bg-primary rounded-pill">${state.turnLeftCount}</span></li>`),this.world.getDumps(DumpTypes.DUMP_PICK_BUZZER)&&(inner+=`<li class="list-group-item d-flex justify-content-between align-items-start"><div class="ms-2 me-auto">Coge zumbador </div><span class="badge bg-primary rounded-pill">${state.pickBuzzerCount}</span></li>`),this.world.getDumps(DumpTypes.DUMP_LEAVE_BUZZER)&&(inner+=`<li class="list-group-item d-flex justify-content-between align-items-start"><div class="ms-2 me-auto">Deja zumbador</div> <span class="badge bg-primary rounded-pill">${state.leaveBuzzerCount}</span></li>`),""!==inner&&this.SendMessage('<ul class="list-group list-group-flush">'+inner+"</ul>","raw")}BreakPointMessage(line){this.SendMessage(`🔴 ${line}) Breakpoint `,"info")}}class SelectionWaffle{constructor(box){this.box=box}UpdateWaffle(selection,renderer){let point={r:selection.r,c:selection.c},point2={r:selection.r+(selection.rows-1)*selection.dr,c:selection.c+(selection.cols-1)*selection.dc};if(point2.r>point.r){let r=point.r;point.r=point2.r,point2.r=r}if(point2.c<point.c){let c=point.c;point.c=point2.c,point2.c=c}let coords=renderer.CellToPoint(point.r,point.c),coords2=renderer.CellToPoint(point2.r-1,point2.c+1),selectionBox=this.box.main;selectionBox.style.top=`${coords.y}px`,selectionBox.style.left=`${coords.x}px`;const ww=coords2.x-coords.x,hh=coords2.y-coords.y,width=`${ww}px`,height=`${hh}px`;selection.dc>0?this.box.cursor.style.left="-2.75px":this.box.cursor.style.left=ww-2.75+"px",selection.dr<0?this.box.cursor.style.top="-2.75px":this.box.cursor.style.top=hh-2.75+"px",this.box.top.style.maxWidth=width,this.box.top.style.minWidth=width,this.box.bottom.style.maxWidth=width,this.box.bottom.style.minWidth=width,this.box.right.style.left=width,this.box.left.style.maxHeight=height,this.box.left.style.minHeight=height,this.box.right.style.maxHeight=height,this.box.right.style.minHeight=height,this.box.bottom.style.top=height}}class CellSelection{GetData(){return{r:this.r,c:this.c,rows:this.rows,cols:this.cols,dr:this.dr,dc:this.dc,state:this.state}}SetData(data){this.r=data.r,this.c=data.c,this.rows=data.rows,this.cols=data.cols,this.dr=data.dr,this.dc=data.dc,this.state=data.state}GetSecondAnchor(){return{r:this.r+(this.rows-1)*this.dr,c:this.c+(this.cols-1)*this.dc}}forEach(callback){for(let i=0;i<this.rows;i++)for(let j=0;j<this.cols;j++)callback(this.r+i*this.dr,this.c+j*this.dc)}}class WorldViewController{constructor(renderer,karelController,container,gizmos){WorldViewController._instance=this,this.renderer=renderer,this.container=container,this.lock=!1,this.karelController=karelController,this.selection=new CellSelection,this.selection.SetData({r:1,c:1,rows:1,cols:1,dr:1,dc:1,state:"normal"}),this.state={cursorX:0,cursorY:0,cellPair:{r:0,c:0}},this.gizmos=gizmos,this.scale=1,this.karelController.RegisterResetObserver(this.OnReset.bind(this)),this.karelController.RegisterNewWorldObserver(this.OnNewWorld.bind(this)),this.karelController.RegisterStepController(this.onStep.bind(this)),this.waffle=new SelectionWaffle(gizmos.selectionBox),this.clickMode="normal",this.pinch={pointers:[],prevDiff:-1,startZoom:1,freed:!1,cell:{r:1,c:1},proportions:{left:0,bottom:0}},this.followScroll=!0,this.onBeepersChangeListeners=[]}static GetInstance(){return WorldViewController._instance}SetClickMode(mode){this.clickMode=mode}Lock(){this.lock=!0}UnLock(){this.lock=!1}GetBeepersInBag(){return this.karelController.world.bagBuzzers}SetBeepersInBag(amount){this.karelController.world.setBagBuzzers(amount),this.NotifyBeeperBagUpdate(amount)}RegisterBeeperBagListener(listener){this.onBeepersChangeListeners.push(listener)}CheckUpdate(){this.karelController.world.dirty&&this.Update()}ErrorMode(){this.renderer.ErrorMode(),this.Update()}NormalMode(){this.renderer.NormalMode(),this.Update()}Select(r,c,r2,c2,state="normal"){r>this.karelController.world.h||c>this.karelController.world.w||r<1||c<1||(this.selection.SetData({r:r,c:c,rows:Math.abs(r-r2)+1,cols:Math.abs(c-c2)+1,dr:r<=r2?1:-1,dc:c<=c2?1:-1,state:state}),this.UpdateGutter(),this.UpdateWaffle())}GetCoords2(){return{r2:this.selection.r+(this.selection.rows-1)*this.selection.dr,c2:this.selection.c+(this.selection.cols-1)*this.selection.dc}}MoveSelection(dr,dc,moveSecond=!1){let{r2:r2,c2:c2}=this.GetCoords2(),r=this.selection.r,c=this.selection.c;moveSecond?(r2+=dr,c2+=dc):(r+=dr,c+=dc,r2=r,c2=c),r<1||c<1||r>this.karelController.world.h||c>this.karelController.world.w||r2<1||c2<1||r2>this.karelController.world.h||c2>this.karelController.world.w||(this.TrackFocus(r2,c2),this.Select(r,c,r2,c2))}UpdateWaffle(){this.waffle.UpdateWaffle(this.selection,this.renderer)}SetScale(scale,updateScroll=!0){this.renderer.scale=scale,this.scale=scale,this.UpdateWaffle(),this.Update(),this.UpdateScrollElements(),updateScroll&&this.ReFocusCurrentElement()}RecalculateScale(){this.renderer.scale=this.scale,this.UpdateWaffle(),this.Update(),this.UpdateScrollElements()}ClientXYToStateXY(clientX,clientY){let canvas=this.renderer.canvasContext.canvas,boundingBox=canvas.getBoundingClientRect(),x=(clientX-boundingBox.left)*canvas.width/boundingBox.width,y=(clientY-boundingBox.top)*canvas.height/boundingBox.height;return x/=this.renderer.scale,y/=this.renderer.scale,{x:x,y:y}}ClientXYToProportions(clientX,clientY){let boundingBox=this.renderer.canvasContext.canvas.getBoundingClientRect();return{left:(clientX-boundingBox.left)/boundingBox.width,bottom:1-(clientY-boundingBox.top)/boundingBox.height}}TrackMouse(e){let{x:x,y:y}=this.ClientXYToStateXY(e.clientX,e.clientY);if(this.state.cursorX=x,this.state.cursorY=y,this.state.cellPair=this.renderer.PointToCell(this.state.cursorX,this.state.cursorY),"selecting"===this.selection.state){let cell=this.state.cellPair;this.ExtendSelection(cell.r,cell.c,"selecting")}}ExtendSelection(r,c,state="normal"){r<0||r>KarelController.GetInstance().world.h||c<0||c>KarelController.GetInstance().world.w||this.Select(this.selection.r,this.selection.c,r,c,state)}ClickUp(e){let cell=this.renderer.PointToCell(this.state.cursorX,this.state.cursorY);"selecting"===this.selection.state&&(this.selection.state="normal","normal"===this.clickMode?this.ExtendSelection(cell.r,cell.c):this.Select(cell.r,cell.c,this.selection.r,this.selection.c))}ClickDown(e){if(e.preventDefault(),this.renderer.canvasContext.canvas.focus(),"normal"===this.clickMode){let cell=this.renderer.PointToCell(this.state.cursorX,this.state.cursorY);if(cell.r<0)return;e.shiftKey?this.Select(this.selection.r,this.selection.c,cell.r,cell.c,"selecting"):this.Select(cell.r,cell.c,cell.r,cell.c,"selecting")}else this.selection.state="selecting";$(":focus").blur()}PointerDown(e){this.pinch.pointers.push(e)}PointerUp(e){const index=this.pinch.pointers.findIndex((cachedEv=>cachedEv.pointerId===e.pointerId));-1!==index&&this.pinch.pointers.splice(index,1),this.pinch.pointers.length<2&&(this.pinch.prevDiff=-1,this.renderer.Snap()&&(this.Update(),this.UpdateWaffle()),this.followScroll=!0)}PointerMove(e){const index=this.pinch.pointers.findIndex((cachedEv=>cachedEv.pointerId===e.pointerId));if(-1!==index&&(this.pinch.pointers[index]=e),2===this.pinch.pointers.length){let cX=(this.pinch.pointers[0].clientX+this.pinch.pointers[1].clientX)/2,cY=(this.pinch.pointers[0].clientY+this.pinch.pointers[1].clientY)/2;this.pinch.proportions=this.ClientXYToProportions(cX,cY);const diffX=Math.abs(this.pinch.pointers[0].clientX-this.pinch.pointers[1].clientX),diffY=Math.abs(this.pinch.pointers[0].clientY-this.pinch.pointers[1].clientY);let curDiff=Math.sqrt(diffX*diffX+diffY*diffY);if(this.pinch.prevDiff>0){let delta=curDiff/this.pinch.prevDiff;if(!this.pinch.freed){if(.9<delta&&delta<1.1)return;.8<delta&&delta<1?delta=2*(delta-.8)+.8:1<delta&&delta<1.2?delta=2*(delta-1.1)+1.1:this.pinch.freed=!0}let newZoom=this.pinch.startZoom*delta;newZoom<.5&&(newZoom=.5),newZoom>8&&(newZoom=8),this.SetScale(newZoom,!1),this.FocusCellToScreenPortion(this.pinch.cell.r,this.pinch.cell.c,this.pinch.proportions.left,this.pinch.proportions.bottom,!1)}else{this.pinch.prevDiff=curDiff,this.pinch.startZoom=this.scale,this.pinch.freed=!1;let{x:x,y:y}=this.ClientXYToStateXY(cX,cY);this.pinch.cell=this.renderer.PointToCell(x,y,!0),this.followScroll=!1}}}SetKarelOnSelection(direction="north"){if(!this.lock){switch(this.karelController.world.move(this.selection.r,this.selection.c),direction){case"north":this.karelController.world.rotate("NORTE");break;case"east":this.karelController.world.rotate("ESTE");break;case"south":this.karelController.world.rotate("SUR");break;case"west":this.karelController.world.rotate("OESTE")}this.Update()}}ChangeBeepers(delta){if(this.lock)return;if(0===delta)return;const history=KarelController.GetInstance().GetHistory(),op=history.StartOperation();let rmin=Math.min(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),rmax=Math.max(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),cmin=Math.min(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc),cmax=Math.max(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc);for(let i=rmin;i<=rmax;i++)for(let j=cmin;j<=cmax;j++){const oriBuzzers=this.karelController.world.buzzers(i,j);let buzzers=this.karelController.world.buzzers(i,j);buzzers<0&&delta<0||(buzzers+=delta,buzzers<0&&(buzzers=0),this.karelController.world.setBuzzers(i,j,buzzers),op.addCommit({forward:()=>{this.karelController.world.setBuzzers(i,j,buzzers)},backward:()=>{this.karelController.world.setBuzzers(i,j,oriBuzzers)}}))}history.EndOperation(),this.Update()}SetRandomBeepers(minimum,maximum){if(this.lock)return;const history=KarelController.GetInstance().GetHistory(),op=history.StartOperation();let rmin=Math.min(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),rmax=Math.max(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),cmin=Math.min(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc),cmax=Math.max(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc);for(let i=rmin;i<=rmax;i++)for(let j=cmin;j<=cmax;j++){let amount=Math.round(Math.random()*(maximum-minimum)+minimum);const oriBuzzers=this.karelController.world.buzzers(i,j);oriBuzzers!==amount&&(op.addCommit({forward:()=>this.karelController.world.setBuzzers(i,j,amount),backward:()=>this.karelController.world.setBuzzers(i,j,oriBuzzers)}),this.karelController.world.setBuzzers(i,j,amount))}history.EndOperation(),this.Update()}SetBeepers(amount){if(this.lock)return;const history=KarelController.GetInstance().GetHistory(),op=history.StartOperation();let rmin=Math.min(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),rmax=Math.max(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),cmin=Math.min(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc),cmax=Math.max(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc);for(let i=rmin;i<=rmax;i++)for(let j=cmin;j<=cmax;j++){const oriBuzzers=this.karelController.world.buzzers(i,j);oriBuzzers!==amount&&(op.addCommit({forward:()=>this.karelController.world.setBuzzers(i,j,amount),backward:()=>this.karelController.world.setBuzzers(i,j,oriBuzzers)}),this.karelController.world.setBuzzers(i,j,amount))}history.EndOperation(),this.Update()}AppendUnitToBeepers(amount){const history=KarelController.GetInstance().GetHistory(),op=history.StartOperation();this.selection.forEach(((r,c)=>{let beepers=this.karelController.world.buzzers(r,c),nextBeepers=10*beepers+amount;-1!==beepers&&(op.addCommit({forward:()=>this.karelController.world.setBuzzers(r,c,nextBeepers),backward:()=>this.karelController.world.setBuzzers(r,c,beepers)}),this.karelController.world.setBuzzers(r,c,nextBeepers))})),history.EndOperation(),this.Update()}DivideBeepers(divider){const history=KarelController.GetInstance().GetHistory(),op=history.StartOperation();this.selection.forEach(((r,c)=>{let beepers=this.karelController.world.buzzers(r,c);if(-1===beepers)return;let nextBeepers=Math.trunc(beepers/divider);op.addCommit({forward:()=>this.karelController.world.setBuzzers(r,c,nextBeepers),backward:()=>this.karelController.world.setBuzzers(r,c,beepers)}),this.karelController.world.setBuzzers(r,c,nextBeepers)})),history.EndOperation(),this.Update()}SetCellEvaluation(state){const world=this.karelController.world;let rmin=Math.min(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),rmax=Math.max(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),cmin=Math.min(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc),cmax=Math.max(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc);for(let i=rmin;i<=rmax;i++)for(let j=cmin;j<=cmax;j++)world.setDumpCell(i,j,state);this.Update()}ToggleKarelPosition(rotate=!1){if(this.lock)return;const history=KarelController.GetInstance().GetHistory(),op=history.StartOperation(),world=this.karelController.world;if(world.start_i!==this.selection.r||world.start_j!==this.selection.c){const orI=world.start_i,orJ=world.start_j;op.addCommit({forward:()=>world.move(this.selection.r,this.selection.c),backward:()=>world.move(orI,orJ)}),world.move(this.selection.r,this.selection.c)}if(rotate){function doRotation(){world.rotate()}op.addCommit({forward:()=>doRotation(),backward:()=>world.rotate()}),doRotation()}history.EndOperation(),this.Update()}FocusOrigin(){this.container.scrollLeft=0,this.container.scrollTop=this.container.scrollHeight-this.container.clientHeight}FocusKarel(){let r=this.karelController.world.i,c=this.karelController.world.j;this.FocusCellToScreenPortion(r,c,.5,.5,!0)}FocusSelection(){let r1=this.selection.r,c1=this.selection.c,{r:r,c:c}=this.selection.GetSecondAnchor(),cR=(r1+r)/2,cC=(c1+c)/2;this.FocusCellToScreenPortion(cR,cC,.5,.5),this.TrackFocus(r1,c1)}ReFocusCurrentElement(){const origin=this.renderer.GetOrigin();this.FocusTo(origin.r,origin.c)}FocusCellToScreenPortion(r,c,leftRatio,bottomRatio,snap=!0){const cols=this.renderer.GetColCount("noRounding"),rows=this.renderer.GetRowCount("noRounding"),w=this.karelController.world.w,h=this.karelController.world.h;let target_c=c-leftRatio*cols,target_r=r-bottomRatio*rows;target_c<1&&(target_c=1),target_r<1&&(target_r=1),target_c>w&&(target_c=w),target_r>h&&(target_r=h),this.FocusTo(target_r,target_c,snap)}TrackFocus(r,c){let origin=this.renderer.GetOrigin(),rows=this.renderer.GetRowCount("floor"),cols=this.renderer.GetColCount("floor");if(rows*cols==0)return void this.FocusKarel();if(origin.c<=c&&c<origin.c+cols&&origin.r<=r&&r<origin.r+rows)return;let tr=origin.r,tc=origin.c;r<tr?tr=r:r>=tr+rows&&(tr=r-rows+1),c<tc?tc=c:c>=tc+cols&&(tc=c-cols+1),this.FocusTo(tr,tc)}TrackFocusToKarel(){this.TrackFocus(this.karelController.world.i,this.karelController.world.j)}FocusTo(r,c,snap=!0){this.karelController.world.w;let worldHeight=this.karelController.world.h,left=(c-1+.1)/(this.karelController.world.w-this.renderer.GetColCount("floor")+1);left<0?(c=1,left=0):left>1&&(c=worldHeight-this.renderer.GetRowCount("floor")+1+1,left=1);let top=(r-1+.01)/(this.karelController.world.h-this.renderer.GetRowCount("floor")+1);top<0?(r=1,top=0):top>1&&(r=worldHeight-this.renderer.GetRowCount("floor")+1+1,top=1),snap?this.renderer.SnappySetOrigin({c:c,r:r}):this.renderer.SmoothlySetOrigin({c:c,r:r}),this.container.scrollLeft=left*(this.container.scrollWidth-this.container.clientWidth),this.container.scrollTop=(1-top)*(this.container.scrollHeight-this.container.clientHeight)}ToggleWall(which,reversible=!0){if(this.lock)return;if(reversible){const history=KarelController.GetInstance().GetHistory(),op=history.StartOperation(),opSelection=this.selection.GetData();op.addCommit({forward:()=>{const prevSelection=this.selection.GetData();this.selection.SetData(opSelection),this.ToggleWall(which,!1),this.selection.SetData(prevSelection)},backward:()=>{const prevSelection=this.selection.GetData();this.selection.SetData(opSelection),this.ToggleWall(which,!1),this.selection.SetData(prevSelection)}}),history.EndOperation()}let r=this.selection.r,c=this.selection.c;switch(which){case"north":r=Math.max(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr);for(let i=0;i<this.selection.cols;i++)c=this.selection.c+this.selection.dc*i,this.karelController.world.toggleWall(r,c,1);break;case"south":r=Math.min(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr);for(let i=0;i<this.selection.cols;i++)c=this.selection.c+this.selection.dc*i,this.karelController.world.toggleWall(r,c,3);break;case"west":c=Math.min(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc);for(let i=0;i<this.selection.rows;i++)r=this.selection.r+i*this.selection.dr,this.karelController.world.toggleWall(r,c,0);break;case"east":c=Math.max(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc);for(let i=0;i<this.selection.rows;i++)r=this.selection.r+i*this.selection.dr,this.karelController.world.toggleWall(r,c,2);break;case"outer":let rmin=Math.min(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),rmax=Math.max(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),cmin=Math.min(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc),cmax=Math.max(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc);for(let i=0;i<this.selection.cols;i++)c=this.selection.c+i*this.selection.dc,this.karelController.world.toggleWall(rmin,c,3),this.karelController.world.toggleWall(rmax,c,1);for(let i=0;i<this.selection.rows;i++)r=this.selection.r+i*this.selection.dr,this.karelController.world.toggleWall(r,cmin,0),this.karelController.world.toggleWall(r,cmax,2)}this.Update()}Undo(){if(this.lock)return;KarelController.GetInstance().GetHistory().Undo(),this.Update()}Redo(){if(this.lock)return;KarelController.GetInstance().GetHistory().Redo(),this.Update()}RemoveEverything(){if(this.lock)return;const history=KarelController.GetInstance().GetHistory(),op=history.StartOperation();let rmin=Math.min(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),rmax=Math.max(this.selection.r,this.selection.r+(this.selection.rows-1)*this.selection.dr),cmin=Math.min(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc),cmax=Math.max(this.selection.c,this.selection.c+(this.selection.cols-1)*this.selection.dc);const world=this.karelController.world;for(let i=rmin;i<=rmax;i++)for(let j=cmin;j<=cmax;j++){const oriBuzzers=world.buzzers(i,j),oriWalls=world.walls(i,j);0!=oriBuzzers&&(world.setBuzzers(i,j,0),op.addCommit({forward:()=>world.setBuzzers(i,j,0),backward:()=>world.setBuzzers(i,j,oriBuzzers)})),world.setDumpCell(i,j,!1),world.setWallMask(i,j,0);world.walls(i,j)!==oriWalls&&op.addCommit({forward:()=>world.setWallMask(i,j,0),backward:()=>world.setWallMask(i,j,oriWalls)})}for(let i=rmin;i<=rmax;i++){if(1!=cmin){const oriWalls=world.walls(i,cmin-1),nextWalls=-5&oriWalls;world.setWallMask(i,cmin-1,nextWalls),oriWalls!=nextWalls&&op.addCommit({forward:()=>world.setWallMask(i,cmin-1,nextWalls),backward:()=>world.setWallMask(i,cmin-1,oriWalls)})}if(cmax!=world.w){const oriWalls=world.walls(i,cmax+1),nextWalls=-2&oriWalls;world.setWallMask(i,cmax+1,nextWalls),oriWalls!=nextWalls&&op.addCommit({forward:()=>world.setWallMask(i,cmax+1,nextWalls),backward:()=>world.setWallMask(i,cmax+1,oriWalls)})}}for(let j=cmin;j<=cmax;j++){if(1!=rmin){const oriWalls=world.walls(rmin-1,j),nextWalls=-3&oriWalls;world.setWallMask(rmin-1,j,nextWalls),oriWalls!=nextWalls&&op.addCommit({forward:()=>world.setWallMask(rmin-1,j,nextWalls),backward:()=>world.setWallMask(rmin-1,j,oriWalls)})}if(rmax!=world.h){const oriWalls=world.walls(rmax+1,j),nextWalls=-9&oriWalls;world.setWallMask(rmax+1,j,nextWalls),oriWalls!=nextWalls&&op.addCommit({forward:()=>world.setWallMask(rmax+1,j,nextWalls),backward:()=>world.setWallMask(rmax+1,j,oriWalls)})}}history.EndOperation(),this.Update()}ChangeOriginFromScroll(left,top){if(!this.followScroll)return;let worldWidth=this.karelController.world.w,worldHeight=this.karelController.world.h;this.renderer.SnappySetOrigin({r:1+Math.max(0,(worldHeight-this.renderer.GetRowCount("floor")+1)*top),c:1+Math.max(0,(worldWidth-this.renderer.GetColCount("floor")+1)*left)})}UpdateScroll(left,top){this.ChangeOriginFromScroll(left,top),this.Update(),this.UpdateWaffle()}Update(){this.karelController.world.dirty=!1,this.renderer.Draw(this.karelController.world,this.selection)}UpdateGutter(){this.renderer.DrawGutters(this.selection)}UpdateScrollElements(){let c=this.renderer.CellSize,h=(this.karelController.world.h*this.scale*c+this.renderer.GutterSize)/window.devicePixelRatio,w=(this.karelController.world.w*this.scale*c+this.renderer.GutterSize)/window.devicePixelRatio;this.gizmos.HorizontalScrollElement.css("width",`${w}px`),this.gizmos.VerticalScrollElement.css("height",`${h}px`)}onStep(caller,state){this.TrackFocusToKarel(),this.Update()}OnReset(caller){this.Update(),this.TrackFocusToKarel()}OnNewWorld(caller,world){this.Select(1,1,1,1),this.Update(),this.FocusKarel(),this.UpdateScrollElements()}NotifyBeeperBagUpdate(amount){for(const callback of this.onBeepersChangeListeners)callback(amount)}}!function(AppVars){const onDelayChangeListeners=[];AppVars.randomBeeperMinimum=1,AppVars.randomBeeperMaximum=99;let delay=300;AppVars.getDelay=function(){return delay},AppVars.setDelay=function(_delay){delay=_delay;for(const listener of onDelayChangeListeners)listener(delay)},AppVars.registerDelayChangeListener=function(listener){onDelayChangeListeners.push(listener)}}(AppVars||(AppVars={}));class WorldBar{constructor(ui){this.data=ui}Connect(){const worldController=WorldViewController.GetInstance();this.data.beepers.addOne.on("click",(()=>worldController.ChangeBeepers(1))),this.data.beepers.removeOne.on("click",(()=>worldController.ChangeBeepers(-1))),this.data.beepers.infinite.on("click",(()=>worldController.SetBeepers(-1))),this.data.beepers.clear.on("click",(()=>worldController.SetBeepers(0))),this.data.beepers.random.on("click",(()=>worldController.SetRandomBeepers(AppVars.randomBeeperMinimum,AppVars.randomBeeperMaximum))),this.data.karel.north.on("click",(()=>worldController.SetKarelOnSelection("north"))),this.data.karel.east.on("click",(()=>worldController.SetKarelOnSelection("east"))),this.data.karel.south.on("click",(()=>worldController.SetKarelOnSelection("south"))),this.data.karel.west.on("click",(()=>worldController.SetKarelOnSelection("west"))),this.data.wall.north.on("click",(()=>worldController.ToggleWall("north"))),this.data.wall.east.on("click",(()=>worldController.ToggleWall("east"))),this.data.wall.south.on("click",(()=>worldController.ToggleWall("south"))),this.data.wall.west.on("click",(()=>worldController.ToggleWall("west"))),this.data.wall.outside.on("click",(()=>worldController.ToggleWall("outer")))}OnClick(event){this.data.beepers.addOne.on("click",event),this.data.beepers.removeOne.on("click",event),this.data.beepers.infinite.on("click",event),this.data.beepers.clear.on("click",event),this.data.beepers.random.on("click",event),this.data.karel.north.on("click",event),this.data.karel.east.on("click",event),this.data.karel.south.on("click",event),this.data.karel.west.on("click",event),this.data.wall.north.on("click",event),this.data.wall.east.on("click",event),this.data.wall.south.on("click",event),this.data.wall.west.on("click",event),this.data.wall.outside.on("click",event)}}class DesktopContextMenu{constructor(data,worldCanvas,worldController){this.toggler=data.toggler,this.container=data.container,this.worldBar=new WorldBar(data.worldBar),this.evaluate=data.evaluate,this.Hook(worldCanvas,worldController)}Hook(worldCanvas,worldController){worldCanvas.on("contextmenu",(e=>{new bootstrap.Dropdown(this.toggler[0]).hide(),this.container[0].style.setProperty("top",`${e.pageY}px`),this.container[0].style.setProperty("left",`${e.pageX}px`),this.ToggleContextMenu(),e.preventDefault()}));const ContextAction=(target,method)=>{target.on("click",(()=>{this.ToggleContextMenu(),method()}).bind(this))};this.worldBar.Connect(),this.worldBar.OnClick((()=>{this.ToggleContextMenu()}).bind(this)),ContextAction(this.evaluate.evaluate,(()=>worldController.SetCellEvaluation(!0))),ContextAction(this.evaluate.ignore,(()=>worldController.SetCellEvaluation(!1)))}ToggleContextMenu(){const dropmenu=new bootstrap.Dropdown(this.toggler[0]);"false"===this.toggler.attr("aria-expanded")?dropmenu.show():dropmenu.hide()}}class CallStack{constructor(data){this.panel=data.panel,this.lastReturn=data.lastReturn,KarelController.GetInstance().RegisterNewWorldObserver(((a,_,newInstance)=>{newInstance&&this.OnStackChanges()})),this.OnStackChanges(),KarelController.GetInstance().RegisterResetObserver((_=>this.clearStack())),KarelController.GetInstance().RegisterSlowModeObserver(((_,limit)=>this.slowMode(limit)))}getCollapsedHTML(evt){let runtime=KarelController.GetInstance().GetRuntime(),msg=this.getCallInfo(evt);return 651===runtime.state.stackSize||(msg+=`<br><span class="text-primary">651 - ${runtime.state.stackSize-1}</span><span> Funciones ocultas </span><br/><span>Hay demasiadas funciones en la pila, las más recientes no se muestran en la interfaz, pero estan ahí </span>`),msg}getCallInfo(evt){let runtime=KarelController.GetInstance().GetRuntime();const onclick=`karel.MoveEditorCursorToLine(${evt.details.line+1})`;let params="";if(evt.details.params.length>0){const len=evt.details.params.length;params+=`${evt.details.params[0]}`;for(let i=1;i<len;i++)params+=`, ${evt.details.params[i]}`}return`<span class="text-info">${runtime.state.stackSize}</span> - `+evt.details.function+" ("+`<span class="text-primary"><b>${params}</b></span>`+`) <a href="#" class="badge bg-primary text-decoration-none" onclick="${onclick}"> Desde línea `+(evt.details.line+1)+"</a>"}OnStackChanges(){const karelController=KarelController.GetInstance();let runtime=karelController.GetRuntime();runtime.eventController.addEventListener("call",(evt=>{651!=runtime.state.stackSize?runtime.state.stackSize>650?this.panel.find(">:first-child").html(this.getCollapsedHTML(evt)):this.panel.prepend('<div class="well well-small">'+this.getCallInfo(evt)+"</div>"):this.panel.prepend('<div class="alert alert-warning">'+this.getCollapsedHTML(evt)+"</div>")})),runtime.eventController.addEventListener("return",(evt=>{if("return"===evt.details.type){const returnType=karelController.GetDebugData().definitions.getFunction(evt.details.fromFunction).returnType;"VOID"===returnType?this.lastReturn.text("La última función no regresa ningún valor."):"INT"===returnType?this.lastReturn.text(`Último valor retornado: ${evt.details.returnValue}`):"BOOL"===returnType?this.lastReturn.text("Último valor retornado: "+(0===evt.details.returnValue?"falso":"verdadero")):this.lastReturn.text(`Último valor retornado: (tipo desconocido) ${evt.details.returnValue}`)}else this.lastReturn.text(`(ERROR INTERNO) Último valor retornado: ${runtime.state.ret}`);runtime.state.stackSize>650?this.panel.find(">:first-child").html(this.getCollapsedHTML(evt)):this.panel.find(">:first-child").remove()})),runtime.eventController.addEventListener("start",(evt=>{this.clearStack()}))}clearStack(){this.lastReturn.text(""),this.panel.empty()}slowMode(limit){const txt=limit.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");this.panel.prepend(`<div class="alert alert-danger"><span> <i class="bi bi-exclamation-triangle-fill"></i> Se ejecutaron más de ${txt} instrucciones,por lo que se activo el modo de ejecución rápido, así que la pila muestra el estado en el que se encontraba hasta la instrucción ${txt} </span><br><span>Esto se puede cambiar en la configuración de ReKarel</span></div>`)}}class KarelConsole{constructor(data){this.consoleTab=data,this.consoleTab.clear.on("click",(()=>this.ClearConsole())),this.unreadMessages=0,this.consoleTab.tab.on("show.bs.tab",(()=>{console.log("???"),this.unreadMessages=0,this.UpdateUnreadPill()})),KarelConsole.instance=this}SendMessageToConsole(message,style){if(this.IsShown()?this.unreadMessages=0:this.unreadMessages++,this.UpdateUnreadPill(),"raw"!==style){const currentDate=new Date,html=`<div style="text-wrap: wrap;"><span class="text-${style}">[${currentDate.getHours()%12||12}:${currentDate.getMinutes()}:${currentDate.getSeconds()} ${currentDate.getHours()<12?"AM":"PM"}]</span> ${message}</div>`;return this.consoleTab.console.prepend(html),void this.ScrollToBottom()}const html=`<div>${message}</div>`;this.consoleTab.console.prepend(html),this.ScrollToBottom()}ClearConsole(){this.unreadMessages=0,this.UpdateUnreadPill(),this.consoleTab.console.empty()}UpdateUnreadPill(){this.consoleTab.consoleMessageCount.text(this.unreadMessages)}IsShown(){return!1===this.consoleTab.console.is(":hidden")}ScrollToBottom(){this.IsShown()&&this.consoleTab.parent.scrollTop(this.consoleTab.parent.prop("scrollHeight"))}static GetInstance(){return KarelConsole.instance}}class ControlBar{constructor(ui,worldController){this.ui=ui,this.worldController=worldController,this.isControlInPlayMode=!1}Init(){KarelController.GetInstance().RegisterStateChangeObserver(this.OnKarelControllerStateChange.bind(this)),WorldViewController.GetInstance().RegisterBeeperBagListener((()=>{this.UpdateBeeperBag()})),AppVars.registerDelayChangeListener((amount=>this.ui.delayInput.val(amount))),this.ConnectExecutionButtonGroup()}ConnectExecutionButtonGroup(){const exec=this.ui.execution,controller=KarelController.GetInstance();exec.compile.on("click",(()=>controller.Compile())),exec.reset.on("click",(()=>this.ResetExecution())),exec.step.on("click",(()=>this.Step())),exec.stepOver.on("click",(()=>this.StepOver())),exec.stepOut.on("click",(()=>this.StepOut())),exec.future.on("click",(()=>this.RunTillEnd())),exec.run.on("click",(()=>{this.isControlInPlayMode?this.PauseStep():this.AutoStep()})),this.ui.delayInput.on("change",(()=>{let delay=parseInt(this.ui.delayInput.val());AppVars.setDelay(delay),KarelController.GetInstance().ChangeAutoStepDelay(delay)})),this.ui.delayAdd.on("click",(()=>{let delay=parseInt(this.ui.delayInput.val());delay+=50,this.ui.delayInput.val(delay),this.ui.delayInput.trigger("change")})),this.ui.delayRemove.on("click",(()=>{let delay=parseInt(this.ui.delayInput.val());delay-=50,delay=delay<0?0:delay,this.ui.delayInput.val(delay),this.ui.delayInput.trigger("change")})),this.ui.beeperInput.on("change",(()=>this.OnBeeperInputChange())),this.ui.infiniteBeeperInput.on("click",(()=>this.ToggleInfiniteBeepers())),KarelController.GetInstance().RegisterStepController(((_ctr,_state)=>{this.UpdateBeeperBag()})),KarelController.GetInstance().RegisterNewWorldObserver(((_ctr,_state,_newInstance)=>{this.UpdateBeeperBag()}))}AutoStep(){let delay=AppVars.getDelay();KarelController.GetInstance().StartAutoStep(delay)&&this.SetPlayMode()}PauseStep(){KarelController.GetInstance().Pause()}RunTillEnd(){KarelController.GetInstance().RunTillEnd(),this.UpdateBeeperBag()}ResetExecution(){KarelController.GetInstance().Reset(),this.UpdateBeeperBag()}Step(){KarelController.GetInstance().Step(),this.UpdateBeeperBag()}StepOver(){KarelController.GetInstance().StepOver(),this.UpdateBeeperBag()}StepOut(){KarelController.GetInstance().StepOut(),this.UpdateBeeperBag()}OnBeeperInputChange(){if("unstarted"!==KarelController.GetInstance().GetState())return;let beeperAmmount=parseInt(this.ui.beeperInput.val());this.worldController.SetBeepersInBag(beeperAmmount)}ToggleInfiniteBeepers(){-1!==this.worldController.GetBeepersInBag()?(this.ActivateInfiniteBeepers(),this.worldController.SetBeepersInBag(-1)):(this.DeactivateInfiniteBeepers(),this.worldController.SetBeepersInBag(0),this.UpdateBeeperBag())}UpdateBeeperBag(){const amount=this.worldController.GetBeepersInBag();this.ui.beeperInput.val(amount),-1===amount?this.ActivateInfiniteBeepers():this.DeactivateInfiniteBeepers()}ActivateInfiniteBeepers(){bootstrap.Collapse.getOrCreateInstance(this.ui.beeperCollapse[0],{toggle:!0}).hide(),this.ui.infiniteBeeperInput.removeClass("btn-body"),this.ui.infiniteBeeperInput.addClass("btn-info")}DeactivateInfiniteBeepers(){bootstrap.Collapse.getOrCreateInstance(this.ui.beeperCollapse[0],{toggle:!1}).show(),this.ui.infiniteBeeperInput.removeClass("btn-info"),this.ui.infiniteBeeperInput.addClass("btn-body")}SetPlayMode(){this.isControlInPlayMode=!0,this.ui.execution.compile.attr("disabled",""),this.ui.execution.step.attr("disabled",""),this.ui.execution.stepOver.attr("disabled",""),this.ui.execution.stepOut.attr("disabled",""),this.ui.execution.future.attr("disabled",""),this.ui.beeperInput.attr("disabled",""),this.ui.infiniteBeeperInput.attr("disabled",""),this.ui.execution.run.html('<i class="bi bi-pause-fill"></i>')}SetPauseMode(){this.isControlInPlayMode=!1,this.ui.execution.compile.attr("disabled",""),this.ui.beeperInput.attr("disabled",""),this.ui.infiniteBeeperInput.attr("disabled",""),this.ui.execution.step.removeAttr("disabled"),this.ui.execution.stepOver.removeAttr("disabled"),this.ui.execution.stepOut.removeAttr("disabled"),this.ui.execution.future.removeAttr("disabled"),this.ui.execution.run.removeAttr("disabled"),this.ui.execution.run.html('<i class="bi bi-play-fill"></i>')}DisableControlBar(){this.ui.execution.compile.attr("disabled",""),this.ui.execution.run.attr("disabled",""),this.ui.execution.step.attr("disabled",""),this.ui.execution.stepOver.attr("disabled",""),this.ui.execution.stepOut.attr("disabled",""),this.ui.execution.future.attr("disabled",""),this.ui.beeperInput.attr("disabled",""),this.ui.infiniteBeeperInput.attr("disabled","")}EnableControlBar(){this.ui.execution.compile.removeAttr("disabled"),this.ui.execution.run.removeAttr("disabled"),this.ui.execution.step.removeAttr("disabled"),this.ui.execution.stepOver.removeAttr("disabled"),this.ui.execution.stepOut.removeAttr("disabled"),this.ui.execution.future.removeAttr("disabled"),this.ui.beeperInput.removeAttr("disabled"),this.ui.infiniteBeeperInput.removeAttr("disabled"),this.ui.execution.run.html('<i class="bi bi-play-fill"></i>')}OnKarelControllerStateChange(sender,state){"running"===state&&this.SetPauseMode(),"finished"===state?(this.isControlInPlayMode=!1,this.DisableControlBar()):"unstarted"===state?(this.isControlInPlayMode=!1,this.EnableControlBar(),this.worldController.NormalMode(),this.UpdateBeeperBag()):"paused"===state&&this.SetPauseMode()}}class FocusBar{constructor(ui){this.data=ui}Connect(){const worldController=WorldViewController.GetInstance();this.data.karel.on("click",(()=>worldController.FocusKarel())),this.data.origin.on("click",(()=>worldController.FocusOrigin())),this.data.selector.on("click",(()=>worldController.FocusSelection()))}}class ToastController{constructor(ui){this.compileSuccess=new bootstrap.Toast(ui.compileSuccess[0]),this.compileError=new bootstrap.Toast(ui.compileError[0]),this.breakpoint=new bootstrap.Toast(ui.breakpoint[0]),this.runtimeError=new bootstrap.Toast(ui.runtimeError[0]),this.runtimeSuccess=new bootstrap.Toast(ui.runtimeSuccess[0]),KarelController.GetInstance().RegisterCompileObserver(((_,success,__)=>{try{success?this.compileSuccess.show():this.compileError.show()}catch(e){console.log(e)}})),KarelController.GetInstance().RegisterStateChangeObserver(((_,state)=>{try{if("finished"!==state)return;KarelController.GetInstance().EndedOnError()?this.runtimeError.show():this.runtimeSuccess.show()}catch(e){console.log(e)}}))}}class DesktopController{constructor(elements,karelController){this.editor=elements.desktopEditor,this.worldContainer=elements.worldContainer,this.worldCanvas=elements.worldCanvas,this.lessZoom=elements.lessZoom,this.moreZoom=elements.moreZoom,this.beeperBagInput=elements.controlBar.beeperInput,this.infiniteBeeperInput=elements.controlBar.infiniteBeeperInput,this.delayInput=elements.controlBar.delayInput,this.delayAdd=elements.controlBar.delayAdd,this.delayRemove=elements.controlBar.delayRemove,this.inputModeToolbar=elements.inputMode,this.worldBar=new WorldBar(elements.worldToolbar),this.evaluateToolbar=elements.evaluate,this.focusControlBar=new FocusBar(elements.focus),this.historyToolbar=elements.history,this.console=new KarelConsole(elements.console),this.karelController=karelController,this.worldController=new WorldViewController(new WorldRenderer(this.worldCanvas[0].getContext("2d"),DefaultWRStyle,1),karelController,elements.worldContainer[0],elements.gizmos),this.contextMenu=new DesktopContextMenu(elements.context,elements.worldCanvas,this.worldController),this.karelController.RegisterStateChangeObserver(this.OnKarelControllerStateChange.bind(this)),this.isControlInPlayMode=!1,this.callStack=new CallStack(elements.callStack),this.controlbar=new ControlBar(elements.controlBar,this.worldController),this.toasts=new ToastController(elements.toast),DesktopController._instance=this}static GetInstance(){return DesktopController._instance}Init(){var callback;$(window).on("resize",this.ResizeCanvas.bind(this)),$(window).on("focus",this.ResizeCanvas.bind(this)),$(window).on("keydown",this.HotKeys.bind(this)),this.worldContainer.on("scroll",this.calculateScroll.bind(this)),$("body").on("mouseup",this.worldController.ClickUp.bind(this.worldController)),this.worldCanvas.on("mousemove",this.worldController.TrackMouse.bind(this.worldController)),this.worldCanvas.on("mousedown",this.worldController.ClickDown.bind(this.worldController)),this.worldCanvas.on("touchstart",(()=>{!0===GetCurrentSetting().autoInputMode&&this.SetAlternativeInput()})),this.worldCanvas.on("pointerdown",this.worldController.PointerDown.bind(this.worldController)),this.worldCanvas.on("pointerup pointercancel pointerout pointerleave",this.worldController.PointerUp.bind(this.worldController)),this.worldCanvas.on("pointermove",this.worldController.PointerMove.bind(this.worldController)),this.lessZoom.on("click",(()=>{let scale=this.worldController.scale/1.41421356;scale<.25&&(scale=.25),this.worldController.SetScale(scale)})),this.moreZoom.on("click",(()=>{let scale=1.41421356*this.worldController.scale;scale>8&&(scale=8),this.worldController.SetScale(scale)})),this.controlbar.Init(),this.ConnectToolbar(),this.ResizeCanvas(),this.worldController.FocusKarel(),this.ConnectConsole(),callback=()=>{this.karelController.Reset()},onEditorTextSet.push(callback)}OnKarelControllerStateChange(sender,state){"running"===state&&(freezeEditors(this.editor),this.worldController.Lock()),"finished"===state?(this.karelController.EndedOnError()&&this.worldController.ErrorMode(),freezeEditors(this.editor),this.worldController.Lock()):"unstarted"===state&&(this.editor.dispatch({effects:readOnly.reconfigure(EditorState.readOnly.of(!1))}),this.worldController.UnLock(),this.worldController.NormalMode())}ConnectToolbar(){this.inputModeToolbar.alternate.on("click",(()=>this.SetAlternativeInput())),this.inputModeToolbar.drag.on("click",(()=>this.SetDragInput())),this.worldBar.Connect(),this.focusControlBar.Connect(),this.evaluateToolbar.evaluate.on("click",(()=>this.worldController.SetCellEvaluation(!0))),this.evaluateToolbar.ignore.on("click",(()=>this.worldController.SetCellEvaluation(!1))),this.historyToolbar.undo.on("click",(()=>this.worldController.Undo())),this.historyToolbar.redo.on("click",(()=>this.worldController.Redo()))}SetAlternativeInput(){this.inputModeToolbar.indicator.removeClass("bi-mouse2"),this.inputModeToolbar.indicator.addClass("bi-hand-index-thumb"),this.worldController.SetClickMode("alternate")}SetDragInput(){this.inputModeToolbar.indicator.removeClass("bi-hand-index-thumb"),this.inputModeToolbar.indicator.addClass("bi-mouse2"),this.worldController.SetClickMode("normal")}ConnectConsole(){this.karelController.RegisterMessageCallback(this.ConsoleMessage.bind(this))}ConsoleMessage(message,type="info"){let style="info";switch(type){case"info":style="info";break;case"success":style="success";break;case"error":style="danger";break;case"warning":style="warning";break;case"raw":style="raw"}this.console.SendMessageToConsole(message,style)}HotKeys(e){let tag=e.target.tagName.toLowerCase();if("textbox"==document.activeElement.getAttribute("role")||"input"==tag)return;const overrideShift=new Set([37,38,39,40]),basic={shift:"optional",ctrl:"no",alt:"no"},ctrl={shift:"no",ctrl:"yes",alt:"no"},beeper={shift:"optional",ctrl:"no",alt:"optional"};let placeBeepers=n=>{e.altKey?this.worldController.AppendUnitToBeepers(n):this.worldController.SetBeepers(n)},hotkeys=new Map([[71,[[basic,()=>{this.worldController.ToggleKarelPosition(!0)}]]],[80,[[basic,()=>{this.worldController.ToggleKarelPosition(!1)}]]],[82,[[basic,()=>{e.altKey?bootstrap.Modal.getOrCreateInstance("#randomBeepersModal").show():this.worldController.SetRandomBeepers(AppVars.randomBeeperMinimum,AppVars.randomBeeperMaximum)}]]],[81,[[basic,()=>{this.worldController.ChangeBeepers(-1)}]]],[69,[[basic,()=>{this.worldController.ChangeBeepers(1)}]]],[48,[[beeper,()=>{placeBeepers(0)}]]],[49,[[beeper,()=>{placeBeepers(1)}]]],[50,[[beeper,()=>{placeBeepers(2)}]]],[51,[[beeper,()=>{placeBeepers(3)}]]],[52,[[beeper,()=>{placeBeepers(4)}]]],[53,[[beeper,()=>{placeBeepers(5)}]]],[54,[[beeper,()=>{placeBeepers(6)}]]],[55,[[beeper,()=>{placeBeepers(7)}]]],[56,[[beeper,()=>{placeBeepers(8)}]]],[57,[[beeper,()=>{placeBeepers(9)}]]],[96,[[beeper,()=>{placeBeepers(0)}]]],[97,[[beeper,()=>{placeBeepers(1)}]]],[98,[[beeper,()=>{placeBeepers(2)}]]],[99,[[beeper,()=>{placeBeepers(3)}]]],[100,[[beeper,()=>{placeBeepers(4)}]]],[101,[[beeper,()=>{placeBeepers(5)}]]],[102,[[beeper,()=>{placeBeepers(6)}]]],[103,[[beeper,()=>{placeBeepers(7)}]]],[104,[[beeper,()=>{placeBeepers(8)}]]],[105,[[beeper,()=>{placeBeepers(9)}]]],[67,[[basic,()=>{$("#desktopSetAmmount").trigger("click")}]]],[87,[[basic,()=>{this.worldController.ToggleWall("north")}]]],[68,[[basic,()=>{this.worldController.ToggleWall("east")}]]],[83,[[basic,()=>{this.worldController.ToggleWall("south")}]]],[65,[[basic,()=>{this.worldController.ToggleWall("west")}]]],[88,[[basic,()=>{this.worldController.ToggleWall("outer")}]]],[37,[[basic,()=>{this.worldController.MoveSelection(0,-1,e.shiftKey)}]]],[38,[[basic,()=>{this.worldController.MoveSelection(1,0,e.shiftKey)}]]],[39,[[basic,()=>{this.worldController.MoveSelection(0,1,e.shiftKey)}]]],[40,[[basic,()=>{this.worldController.MoveSelection(-1,0,e.shiftKey)}]]],[84,[[basic,()=>{this.worldController.SetBeepers(-1)}]]],[86,[[basic,()=>{this.worldController.SetCellEvaluation(!1)}]]],[8,[[basic,()=>{this.worldController.RemoveEverything()}],[{shift:"optional",ctrl:"no",alt:"yes"},()=>{this.worldController.DivideBeepers(10)}]]],[46,[[basic,()=>{this.worldController.RemoveEverything()}]]],[89,[[ctrl,()=>{this.worldController.Redo()}]]],[90,[[ctrl,()=>{this.worldController.Undo()}],[basic,()=>{this.worldController.SetCellEvaluation(!0)}]]]]);if(!1===hotkeys.has(e.which))return;if(e.shiftKey&&!overrideShift.has(e.which)){let dummy=new MouseEvent("",{clientX:e.clientX,clientY:e.clientY});this.worldController.ClickDown(dummy),this.worldController.ClickUp(dummy)}const options=hotkeys.get(e.which);for(let option of options)if(("yes"!==option[0].ctrl||e.ctrlKey)&&("no"!==option[0].ctrl||!e.ctrlKey)&&("yes"!==option[0].alt||e.altKey)&&("no"!==option[0].alt||!e.altKey)&&("yes"!==option[0].shift||e.shiftKey)&&("no"!==option[0].shift||!e.shiftKey)){option[1](),e.preventDefault();break}}calculateScroll(){let left=0,top=1;const container=this.worldContainer[0];container.scrollWidth!==container.clientWidth&&(left=container.scrollLeft/(container.scrollWidth-container.clientWidth)),container.scrollHeight!==container.clientHeight&&(top=1-container.scrollTop/(container.scrollHeight-container.clientHeight)),this.worldController.UpdateScroll(left,top)}ResizeCanvas(){this.worldCanvas[0].style.width=`${this.worldContainer[0].clientWidth}px`,this.worldCanvas[0].style.height=`${this.worldContainer[0].clientHeight}px`;let scale=window.devicePixelRatio;this.worldCanvas.attr("width",Math.floor(this.worldContainer[0].clientWidth*scale)),this.worldCanvas.attr("height",Math.floor(this.worldContainer[0].clientHeight*scale)),this.worldController.Update(),this.calculateScroll()}}function activateButton(toolbar,buttonPressed){for(const element in toolbar)$(element).removeClass("text-primary");$(buttonPressed).addClass("text-primary"),toolbar[buttonPressed]()}function replaceWithIndetation(elements,txt){let state=elements.editor.state,head=state.selection.main.head,line=state.doc.lineAt(head),text=line.text.match(/\s*/g)[0]+txt,transaction=state.update({changes:{from:line.from,to:line.to,insert:text}});elements.editor.dispatch(transaction)}function confirmPrompt(evenet){let data=evenet.data;$(data.uiData.confirmModal.titleField).html(data.modalData.title),$(data.uiData.confirmModal.messageField).html(data.modalData.message),$(data.uiData.confirmModal.confirmBtn).on("click",data.modalData.accept),$(data.uiData.confirmModal.rejectBtn).on("click",data.modalData.reject),bootstrap.Modal.getOrCreateInstance($(data.uiData.confirmModal.modal).get(0)).show()}function confirmPromptEnd(event){let data=event.data;$(data.uiData.confirmModal.confirmBtn).off("click",data.modalData.accept),$(data.uiData.confirmModal.rejectBtn).off("click",data.modalData.reject)}const fileRegex$1=/^[a-zA-Z0-9._]+$/;function setFileNameLink$1(modal,editor,changeInput=!1){let newFilename=$(modal.inputField).val(),extension="txt";extension="java"===(null===sessionStorage||void 0===sessionStorage?void 0:sessionStorage.getItem("rekarel:lang"))?"kj":"kp",fileRegex$1.test(newFilename)?$(modal.wrongCodeWarning).attr("hidden",""):(newFilename=`code.${extension}`,changeInput?$(modal.inputField).val(newFilename):$(modal.wrongCodeWarning).removeAttr("hidden"));let blob=new Blob([editor.state.doc.toString()],{type:"text/plain"});$(modal.confirmBtn).attr("href",window.URL.createObjectURL(blob)),$(modal.confirmBtn).attr("download",newFilename)}function hookDownloadModel(modal,editor){$(modal.modal).on("show.bs.modal",(()=>function(modal,editor){let extension="txt";extension="java"===(null===sessionStorage||void 0===sessionStorage?void 0:sessionStorage.getItem("rekarel:lang"))?"kj":"kp";let newFilename=$(modal.inputField).val();(newFilename.endsWith(".kj")||newFilename.endsWith(".kp"))&&(newFilename=newFilename.slice(0,-2)+extension),$(modal.inputField).val(newFilename),setFileNameLink$1(modal,editor,!0)}(modal,editor))),$(modal.inputField).change((()=>setFileNameLink$1(modal,editor)))}function setWorldData(data,textBox,btn,success){const targetText=$(textBox);targetText.val(data);let blob=new Blob([data],{type:"text/plain"});const targetBtn=$(btn);targetBtn.attr("href",window.URL.createObjectURL(blob)),success?(targetText.removeClass("bg-danger-subtle"),targetBtn.removeAttr("aria-disabled").removeClass("btn-secondary").addClass("btn-primary").removeClass("disabled")):(targetText.addClass("bg-danger-subtle"),targetBtn.attr("aria-disabled","true").addClass("btn-secondary").removeClass("btn-primary").addClass("disabled"))}const fileRegex=/^[a-zA-Z0-9._]+$/;function setFileNameLink(modal){let newFilename=$(modal.nameField).val();fileRegex.test(newFilename)?$(modal.wrongNameWaring).attr("hidden",""):($(modal.wrongNameWaring).removeAttr("hidden"),newFilename="mundo"),$(modal.inputBtn).attr("download",newFilename+".in").text("Descargar "+newFilename+".in"),$(modal.outputBtn).attr("download",newFilename+".out").text("Descargar "+newFilename+".out")}function HookWorldSaveModal(modal,karelController){$(modal.modal).on("show.bs.modal",(()=>{$(modal.outputBtn).addClass("disabled").addClass("btn-secondary").removeClass("btn-primary").attr("aria-disabled","true"),$(modal.inputBtn).addClass("disabled").addClass("btn-secondary").removeClass("btn-primary").attr("aria-disabled","true"),setFileNameLink(modal),function(modal,karelController){setWorldData(karelController.world.save("start"),modal.worldDataIn,modal.inputBtn,!0)}(modal,karelController),function(modal,karelController){$(modal.nameField).val();let output,result=KarelController.GetInstance().Compile(!1),success=!1;$(modal.worldDataOut).val("Procesando..."),null==result?(output="ERROR DE COMPILACION",setWorldData(output,modal.worldDataOut,modal.outputBtn,success)):KarelController.GetInstance().RunTillEnd(!1).then((()=>{KarelController.GetInstance().EndedOnError()?output="ERROR DE EJECUCION":(output=karelController.world.output(),success=!0),setWorldData(output,modal.worldDataOut,modal.outputBtn,success)}))}(modal,karelController)})),$(modal.nameField).on("change",(()=>{setFileNameLink(modal)}))}function HookNavbar(navbar,editor,karelController){$(navbar.openCode).on("click",(()=>function(editor){var file=document.createElement("input");file.type="file",file.accept=".kj, .kp",file.addEventListener("change",(function(evt){for(var f,files=evt.target.files,i=0;f=files[i];i++)if(!f.type||f.type.match("text.*")||"application/javascript"==f.type){var reader=new FileReader;reader.onload=function(e){SetText(editor,reader.result)},reader.readAsText(f)}})),file.click()}(editor))),$(navbar.openWorldIn).on("click",(()=>function(karelController){var file=document.createElement("input");file.type="file",file.accept=".in",file.addEventListener("change",(function(evt){for(var f,files=evt.target.files,i=0;f=files[i];i++)if(!f.type||f.type.match("text.*")){var reader=new FileReader;reader.onload=function(e){const result=reader.result;var xml;karelController.LoadWorld((xml=result,(new DOMParser).parseFromString(xml,"text/xml"))),karelController.Reset()},reader.readAsText(f)}})),file.click()}(karelController)))}function applyTheme(theme){SetEditorTheme(theme.extensions,getEditors()[0]);const root=$(":root")[0];root.style.setProperty("--editor-color",theme.color),root.style.setProperty("--editor-background",theme.backgroundColor),root.style.setProperty("--editor-gutter-bg",theme.gutterBackgroundColor),root.style.setProperty("--editor-gutter",theme.gutterColor)}const DarkCodeTheme={color:"#9CDCFE",backgroundColor:"#1F1F1F",gutterBackgroundColor:"#1F1F1F",gutterColor:"#6e7681",extensions:[syntaxHighlighting(HighlightStyle.define([{tag:tags.atom,color:"#DCDCAA"},{tag:tags.className,color:"#4EC9B0"},{tag:tags.keyword,color:"#C586C0"},{tag:tags.controlKeyword,color:"#C586C0"},{tag:tags.definitionKeyword,color:"#569CD6"},{tag:tags.number,color:"#b5cea8"},{tag:tags.operator,color:"#efefef"},{tag:tags.brace,color:"#FFD700"},{tag:tags.blockComment,color:"#6A9955",fontStyle:"italic"},{tag:tags.comment,color:"#6A9955",fontStyle:"italic"},{tag:tags.function(tags.variableName),color:"#DCDCAA"},{tag:tags.constant(tags.variableName),color:"#52C8FF"}])),EditorView.theme({"&.cm-focused .cm-selectionBackground, ::selection":{backgroundColor:"#b3c6c7"}})]},LightCodeTheme={color:"#0000FF",backgroundColor:"#FFFFFF",gutterBackgroundColor:"#F8F8F8",gutterColor:"#6e7681",extensions:[syntaxHighlighting(HighlightStyle.define([{tag:tags.atom,color:"#795E26"},{tag:tags.className,color:"#267F99"},{tag:tags.keyword,color:"#AF00DB"},{tag:tags.controlKeyword,color:"#AF00DB"},{tag:tags.definitionKeyword,color:"#267F99"},{tag:tags.number,color:"#098658"},{tag:tags.operator,color:"#050505"},{tag:tags.brace,color:"#0431FA"},{tag:tags.blockComment,color:"#008000",fontStyle:"italic"},{tag:tags.comment,color:"#008000",fontStyle:"italic"},{tag:tags.function(tags.variableName),color:"#795E26"},{tag:tags.constant(tags.variableName),color:"#004AC2"}])),EditorView.theme({"&.cm-focused .cm-selectionBackground, ::selection":{backgroundColor:"#b3c6c7"}})]},darkClassicHighlight={color:"var(--bs-body-color)",backgroundColor:"rgba(var(--bs-body-bg-rgb), var(--bs-bg-opacity))",gutterBackgroundColor:"var(--bs-secondary-bg)",gutterColor:"var(--bs-emphasis-color)",extensions:[syntaxHighlighting(HighlightStyle.define([{tag:tags.atom,color:"#93bf74"},{tag:tags.keyword,color:"#C586C0"},{tag:tags.className,color:"#C586C0"},{tag:tags.brace,color:"#94a4cb"},{tag:tags.number,color:"#569CD6"},{tag:tags.operator,color:"#77a1d5"},{tag:tags.blockComment,color:"#a0b6b6",fontStyle:"italic"},{tag:tags.comment,color:"#a0b6b6",fontStyle:"italic"},{tag:tags.function(tags.variableName),color:"#9CDCFE"},{tag:tags.constant(tags.variableName),color:"#80e9ed"}])),EditorView.theme({"&.cm-focused .cm-selectionBackground, ::selection":{backgroundColor:"#4e4d48"}})]},OMIHighlight={color:"#FFFF00",backgroundColor:"#000080",gutterBackgroundColor:"#F5F5F5",gutterColor:"#000000",extensions:[syntaxHighlighting(HighlightStyle.define([{tag:tags.atom,color:"#00FFFF"},{tag:tags.keyword,color:"#00FFFF"},{tag:tags.controlKeyword,color:"#00FFFF"},{tag:tags.definitionKeyword,color:"#00FFFF"},{tag:tags.number,color:"#FF00FF"},{tag:tags.operator,color:"#00FFFF"},{tag:tags.brace,color:"#00FFFF"},{tag:tags.function(tags.variableName),color:"#00FFFF"},{tag:tags.constant(tags.variableName),color:"#00FFFF"}])),EditorView.theme({"&.cm-focused .cm-selectionBackground, ::selection":{backgroundColor:"#0000FF"}})]},ReKarelHighlight={color:"#fafafa",backgroundColor:"rgb(var(--bs-body-bg-rgb))",gutterBackgroundColor:"var(--bs-secondary-bg)",gutterColor:"var(--bs-emphasis-color)",extensions:[syntaxHighlighting(HighlightStyle.define([{tag:tags.atom,color:"#ffda6a"},{tag:tags.keyword,color:"#ea868f"},{tag:tags.brace,color:"#ea868f"},{tag:tags.controlKeyword,color:"#6ea8fe"},{tag:tags.definitionKeyword,color:"#6ea8fe"},{tag:tags.number,color:"#ffda6a"},{tag:tags.operator,color:"#77a1d5"},{tag:tags.blockComment,color:"#75b798",fontStyle:"italic"},{tag:tags.comment,color:"#75b798",fontStyle:"italic"},{tag:tags.function(tags.variableName),color:"#6edff6"},{tag:tags.constant(tags.variableName),color:"#ffda6a"}])),EditorView.theme({"&.cm-focused .cm-selectionBackground, ::selection":{backgroundColor:"#4e4d48"}})]},LightReKarelHighlight={color:"#2e2e2e",backgroundColor:"rgb(var(--bs-body-bg-rgb))",gutterBackgroundColor:"var(--bs-secondary-bg)",gutterColor:"var(--bs-emphasis-color)",extensions:[syntaxHighlighting(HighlightStyle.define([{tag:tags.atom,color:"#ff9c07"},{tag:tags.keyword,color:"#c62e3d"},{tag:tags.brace,color:"#c62e3d"},{tag:tags.controlKeyword,color:"#0d6efd "},{tag:tags.definitionKeyword,color:"#0d6efd "},{tag:tags.number,color:"#ff9c07"},{tag:tags.operator,color:"#77a1d5"},{tag:tags.blockComment,color:"#198754",fontStyle:"italic"},{tag:tags.comment,color:"#198754",fontStyle:"italic"},{tag:tags.function(tags.variableName),color:"#24a7db"},{tag:tags.constant(tags.variableName),color:"#ff9c07"}]))]},SepiaTheme={color:"#3a3d42",backgroundColor:"#fffde5",gutterBackgroundColor:"#d9ceb6",gutterColor:"#2d2e3b",extensions:[syntaxHighlighting(HighlightStyle.define([{tag:tags.atom,color:"#707894"},{tag:tags.keyword,color:"#cb3551"},{tag:tags.controlKeyword,color:"#3f9c4f"},{tag:tags.definitionKeyword,color:"#3f9c4f"},{tag:tags.number,color:"#22867e"},{tag:tags.operator,color:"#3f9c4f"},{tag:tags.blockComment,color:"#973d1a",fontStyle:"italic"},{tag:tags.comment,color:"#973d1a",fontStyle:"italic"},{tag:tags.function(tags.variableName),color:"#1f34a1"},{tag:tags.constant(tags.variableName),color:"#a1789a"}])),EditorView.theme({"&.cm-focused .cm-selectionBackground, ::selection":{backgroundColor:"#b3c6c7"}})]},DarkEditorThemes={classic:darkClassicHighlight,rekarel:ReKarelHighlight,sepia:SepiaTheme,omi:OMIHighlight,code:DarkCodeTheme},LightEditorThemes={classic:classicHighlight,rekarel:LightReKarelHighlight,sepia:SepiaTheme,omi:OMIHighlight,code:LightCodeTheme};function SetLightTheme(theme){$(":root").attr("data-bs-theme","light"),applyTheme(LightEditorThemes[theme])}function SetDarkTheme(theme){$(":root").attr("data-bs-theme","dark"),applyTheme(DarkEditorThemes[theme])}let mode="responsive";function clearAllDisplayClasses(element){$(element).removeClass("d-none"),$(element).removeClass("d-lg-block"),$(element).removeClass("d-lg-none")}function hideElement$1(element){$(element).addClass("d-none")}function SetDesktopView(){mode="desktop",clearAllDisplayClasses("#phoneView"),clearAllDisplayClasses("#desktopView"),hideElement$1("#phoneView"),MovePanels("desktop"),previousResponsiveMode="desktop"}const statePanel=$("#stateConsole"),worldPane=$("#worldPane");function MovePanels(target){const editor=getEditors()[0],dom=$(editor.dom);dom.detach(),statePanel.detach(),worldPane.detach(),"mobile"===target?($("#mobileCodePanel").append(dom),$("#mobileWorldPane").prepend(worldPane),$("#mobileStatePanel").append(statePanel)):($("#splitter-left-top-pane").append(dom),$("#splitter-left-bottom-pane").append(statePanel),$("#desktopWorldSlot").prepend(worldPane)),DesktopController.GetInstance().ResizeCanvas(),DesktopController.GetInstance().worldController.FocusKarel()}$("#worldContainer");let DesktopUI$1,previousResponsiveMode="desktop",phoneView=$("#phoneView"),desktopView=$("#desktopView");function checkVisibility(){"responsive"===mode&&("desktop"!==previousResponsiveMode?"mobile"!==previousResponsiveMode||"none"!==desktopView.css("display")&&(previousResponsiveMode="desktop",MovePanels("desktop")):"none"!==phoneView.css("display")&&(previousResponsiveMode="mobile",MovePanels("mobile")))}function applySettings(settings,desktopUI){switch(SetSettings(settings),settings.interface){case"auto":mode="responsive",clearAllDisplayClasses("#desktopView"),clearAllDisplayClasses("#phoneView"),$("#phoneView").addClass("d-lg-none"),$("#desktopView").addClass("d-none"),$("#desktopView").addClass("d-lg-flex"),setTimeout((()=>checkVisibility()));break;case"desktop":default:SetDesktopView();break;case"mobile":mode="mobile",clearAllDisplayClasses("#phoneView"),clearAllDisplayClasses("#desktopView"),hideElement$1("#desktopView"),MovePanels("mobile"),previousResponsiveMode="mobile"}switch(settings.editorTheme in DarkEditorThemes||(settings.editorTheme="classic"),settings.theme){case"system":!function(theme){window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?SetDarkTheme(theme):SetLightTheme(theme)}(settings.editorTheme);break;case"light":SetLightTheme(settings.editorTheme);break;default:SetDarkTheme(settings.editorTheme)}const root=$(":root")[0];root.style.setProperty("--editor-font-size",`${settings.editorFontSize}pt`),root.style.setProperty("--waffle-color",`${settings.worldRendererStyle.waffleColor}`),"desktop"==settings.interface&&desktopUI.ResizeCanvas(),desktopUI.worldController.renderer.style=settings.worldRendererStyle,desktopUI.worldController.Update(),localStorage&&localStorage.setItem("appSettings",JSON.stringify(settings))}function InitSettings(desktopUI){DesktopUI$1=desktopUI,function(){const jsonString=null===localStorage||void 0===localStorage?void 0:localStorage.getItem("appSettings");if(jsonString){const memorySettings=JSON.parse(jsonString);if(null==memorySettings.version)return;if("0.7.0"!==memorySettings.version)return void localStorage.removeItem(memorySettings);SetSettings(memorySettings)}}(),$("#settingsModal").on("show.bs.modal",(e=>{!function(){const appSettings=GetCurrentSetting();$("#settingsInterface").val(appSettings.interface),$("#settingsFontSize").val(appSettings.editorFontSize),$("#settingsTheme").val(appSettings.theme),$("#settingsStyle").val(appSettings.editorTheme),$("#settingsSlowModeLimit").val(appSettings.slowExecutionLimit),$("#settingsAutoInputMode").prop("checked",appSettings.autoInputMode),showOrHideSlowExecutionLimit()}()})),$("#settingsForm").on("submit",(e=>{!function(event,desktopUI){var _a;const appSettings=GetCurrentSetting();let interfaceType=$("#settingsForm select[name=interface]").val(),fontSize=$("#settingsForm input[name=fontSize]").val(),slowModeLimit=$("#settingsSlowModeLimit").val(),theme=$("#settingsForm select[name=theme]").val(),style=$("#settingsForm select[name=editorStyle]").val(),autoInput=null===(_a=$("#settingsAutoInputMode").prop("checked"))||void 0===_a||_a;return["auto","desktop","mobile"].indexOf(interfaceType)>-1&&(appSettings.interface=interfaceType),str=fontSize,6<str&&str<31&&(appSettings.editorFontSize=fontSize),function(str){return["system","light","dark"].indexOf(str)>-1}(theme)&&(appSettings.theme=theme),appSettings.slowExecutionLimit=slowModeLimit,appSettings.editorTheme=style,appSettings.autoInputMode=autoInput,console.log(appSettings),applySettings(appSettings,desktopUI),event.preventDefault(),!1;var str}(e,desktopUI)}))}function showOrHideSlowExecutionLimit(){$("#settingsSlowModeLimit").val()>2e5?$("#slowModeWarning").show():$("#slowModeWarning").hide()}function setFormData(style){$("#disabledColor").val(style.disabled),$("#exportCellBackgroundColor").val(style.exportCellBackground),$("#karelColor").val(style.karelColor),$("#gridBackgroundColor").val(style.gridBackgroundColor),$("#errorGridBackgroundColor").val(style.errorGridBackgroundColor),$("#gridBorderColor").val(style.gridBorderColor),$("#errorGridBorderColor").val(style.errorGridBorderColor),$("#gutterBackgroundColor").val(style.gutterBackgroundColor),$("#gutterColor").val(style.gutterColor),$("#beeperBackgroundColor").val(style.beeperBackgroundColor),$("#beeperColor").val(style.beeperColor),$("#wallColor").val(style.wallColor),$("#waffleColor").val(style.waffleColor),$("#gutterSelectionBackgroundColor").val(style.gutterSelectionBackgroundColor),$("#gutterSelectionColor").val(style.gutterSelectionColor)}function HookStyleModal(view){$("#setKarelStyleBtn").on("click",(()=>{const style={disabled:$("#disabledColor").val(),exportCellBackground:$("#exportCellBackgroundColor").val(),karelColor:$("#karelColor").val(),gridBackgroundColor:$("#gridBackgroundColor").val(),errorGridBackgroundColor:$("#errorGridBackgroundColor").val(),gridBorderColor:$("#gridBorderColor").val(),errorGridBorderColor:$("#errorGridBorderColor").val(),gutterBackgroundColor:$("#gutterBackgroundColor").val(),gutterColor:$("#gutterColor").val(),beeperBackgroundColor:$("#beeperBackgroundColor").val(),beeperColor:$("#beeperColor").val(),wallColor:$("#wallColor").val(),waffleColor:$("#waffleColor").val(),gutterSelectionBackgroundColor:$("#gutterSelectionBackgroundColor").val(),gutterSelectionColor:$("#gutterSelectionColor").val()};console.log(style),view.renderer.style=style,view.Update(),function(style){const appSettings=GetCurrentSetting();appSettings.worldRendererStyle=style,applySettings(appSettings,DesktopUI$1)}(style)})),$("#karelStyleModal").on("show.bs.modal",(()=>{setFormData(view.renderer.style)})),$("#karelStyleLoadPresetBtn").on("click",(()=>{!function(){const val=$("#karelStylePreset").val();"current"!==val?"default"!==val?"clean"!==val?"dark"!==val?"contrast"!==val||setFormData(WR_CONTRAST):setFormData(WR_DARK):setFormData(WR_CLEAN):setFormData(DefaultWRStyle):setFormData(GetCurrentSetting().worldRendererStyle)}()})),$("#karelStyleExport").on("click",(()=>{!function(){const style=GetCurrentSetting().worldRendererStyle,val=JSON.stringify(style);$("#karelStyleJSON").val(val)}()})),$("#karelStyleImport").on("click",(()=>{!function(){const val=$("#karelStyleJSON").val();try{const style=JSON.parse(val);if(!function(obj){if(!obj||"object"!=typeof obj)return!1;const requiredKeys=["disabled","exportCellBackground","karelColor","gridBackgroundColor","errorGridBackgroundColor","gridBorderColor","errorGridBorderColor","gutterBackgroundColor","gutterColor","beeperBackgroundColor","beeperColor","wallColor"];for(const key of requiredKeys)if(!(key in obj)||"string"!=typeof obj[key])return!1;return!0}(style))return;setFormData(style)}catch(error){return}}()}))}function HookEvaluatorModal(ui){ui.modal.on("show.bs.modal",(()=>function(ui){const kcInstance=KarelController.GetInstance();ui.evaluatePosition.prop("checked",kcInstance.world.getDumps(DumpTypes.DUMP_POSITION)),ui.evaluateOrientation.prop("checked",kcInstance.world.getDumps(DumpTypes.DUMP_ORIENTATION)),ui.evaluateBag.prop("checked",kcInstance.world.getDumps(DumpTypes.DUMP_BAG)),ui.evaluateUniverse.prop("checked",kcInstance.world.getDumps(DumpTypes.DUMP_ALL_BUZZERS)),ui.countMoves.prop("checked",kcInstance.world.getDumps(DumpTypes.DUMP_MOVE)),ui.countTurns.prop("checked",kcInstance.world.getDumps(DumpTypes.DUMP_LEFT)),ui.countPicks.prop("checked",kcInstance.world.getDumps(DumpTypes.DUMP_PICK_BUZZER)),ui.countPuts.prop("checked",kcInstance.world.getDumps(DumpTypes.DUMP_LEAVE_BUZZER)),ui.maxInstructions.val(kcInstance.world.maxInstructions),ui.maxStackSize.val(kcInstance.world.maxStackSize),ui.stackMemory.val(kcInstance.world.maxStackMemory),ui.maxCallParam.val(kcInstance.world.maxCallSize),ui.maxMove.val(kcInstance.world.maxMove),ui.maxTurnLeft.val(kcInstance.world.maxTurnLeft),ui.maxPickBuzzer.val(kcInstance.world.maxPickBuzzer),ui.maxLeaveBuzzer.val(kcInstance.world.maxLeaveBuzzer)}(ui))),ui.form.on("submit",(e=>{e.preventDefault(),function(ui){const kcInstance=KarelController.GetInstance();function validateMax(inputVal,min=1){return Number.isInteger(Number(inputVal))&&Number(inputVal)>=min}kcInstance.world.setDumps(DumpTypes.DUMP_POSITION,ui.evaluatePosition.prop("checked")),kcInstance.world.setDumps(DumpTypes.DUMP_ORIENTATION,ui.evaluateOrientation.prop("checked")),kcInstance.world.setDumps(DumpTypes.DUMP_BAG,ui.evaluateBag.prop("checked")),kcInstance.world.setDumps(DumpTypes.DUMP_ALL_BUZZERS,ui.evaluateUniverse.prop("checked")),kcInstance.world.setDumps(DumpTypes.DUMP_MOVE,ui.countMoves.prop("checked")),kcInstance.world.setDumps(DumpTypes.DUMP_LEFT,ui.countTurns.prop("checked")),kcInstance.world.setDumps(DumpTypes.DUMP_PICK_BUZZER,ui.countPicks.prop("checked")),kcInstance.world.setDumps(DumpTypes.DUMP_LEAVE_BUZZER,ui.countPuts.prop("checked"));const maxInstructions=parseInt(`${ui.maxInstructions.val()}`),maxStackSize=parseInt(`${ui.maxStackSize.val()}`),maxMove=parseInt(`${ui.maxMove.val()}`),maxTurnLeft=parseInt(`${ui.maxTurnLeft.val()}`),maxPickBuzzer=parseInt(`${ui.maxPickBuzzer.val()}`),maxLeaveBuzzer=parseInt(`${ui.maxLeaveBuzzer.val()}`),stackMemory=parseInt(`${ui.stackMemory.val()}`),maxCallParam=parseInt(`${ui.maxCallParam.val()}`);validateMax(maxInstructions)&&(kcInstance.world.maxInstructions=maxInstructions),validateMax(maxStackSize)&&(kcInstance.world.maxStackSize=maxStackSize),validateMax(stackMemory)&&(kcInstance.world.maxStackMemory=stackMemory),validateMax(maxCallParam)&&(kcInstance.world.maxCallSize=maxCallParam),validateMax(maxMove,-1)&&(kcInstance.world.maxMove=maxMove),validateMax(maxTurnLeft,-1)&&(kcInstance.world.maxTurnLeft=maxTurnLeft),validateMax(maxPickBuzzer,-1)&&(kcInstance.world.maxPickBuzzer=maxPickBuzzer),validateMax(maxLeaveBuzzer,-1)&&(kcInstance.world.maxLeaveBuzzer=maxLeaveBuzzer)}(ui)}))}function HookSession(){KarelController.GetInstance().RegisterCompileObserver(((_,__,lan)=>function(lang){if(null==sessionStorage)return;let code=getEditors()[0].state.doc.toString();sessionStorage.setItem("rekarel:code",code),sessionStorage.setItem("rekarel:lang",lang);let world=KarelController.GetInstance().world.save("start");sessionStorage.setItem("rekarel:world",world)}(lan)))}function RestoreSession(){if(null==sessionStorage)return;let source=sessionStorage.getItem("rekarel:code");source&&SetText(getEditors()[0],source);let world=sessionStorage.getItem("rekarel:world");var xml;world&&KarelController.GetInstance().LoadWorld((xml=world,(new DOMParser).parseFromString(xml,"text/xml")));let language=sessionStorage.getItem("rekarel:lang");"java"===language&&setLanguage(getEditors()[0],"java"),"pascal"===language&&setLanguage(getEditors()[0],"pascal")}function editorTranspile(target){const editor=getEditors()[0],source=editor.state.doc.toString();try{const response=function(source,target){let parser=null;switch(detectLanguage(source)){case"java":parser=javaParser;break;case"pascal":parser=pascalParser$1;break;default:let errorStatus={error:CompilationError.Errors.UNKNOWN_SYNTAX,line:0,loc:{first_column:0,first_line:1,last_column:0,last_line:1}},error=new Error("Unknown syntax, the start of the file must be either 'class' or 'iniciar-programa'");throw error.hash=errorStatus,error}const result=parser(source);return"java"===target?generateJavaFromIR(result):"pascal"===target?generatePascalFromIR(result):"000"}(source,target);console.log(response),SetText(editor,`${response}`)}catch(e){KarelConsole.GetInstance().SendMessageToConsole("Para cambiar el lenguaje, el código debe compilar","danger")}}class MobileUI{constructor(data){MobileUI._instance=this,this.controlBar=new ControlBar(data.controls,WorldViewController.GetInstance()),this.focusBar=new FocusBar(data.focus),this.worldBar=new WorldBar(data.worldBar),this.startExec=data.startExec,this.previousOpBtn=data.previousOpBtn,this.controlBar.Init(),this.focusBar.Connect(),this.worldBar.Connect(),this.worldBar.OnClick(this.OnWorldOp.bind(this)),KarelController.GetInstance().RegisterStateChangeObserver(((_,state)=>{"unstarted"!==state||"execution"!==this.state?"unstarted"!==state&&"execution"!==this.state&&this.SetState("execution"):this.SetState("world")})),$('*[data-kl-state="world"]').addClass("d-none"),$('*[data-kl-state="execution"]').addClass("d-none"),$('*[data-kl-state="code"]').addClass("d-none"),this.state="world",this.SetState("world"),this.Connect();const editor=getEditors()[0];$(editor.contentDOM).on("focus",(()=>{"execution"!==this.state&&this.SetState("code")})),$("#worldCanvas").on("focus",(()=>{"execution"!==this.state&&this.SetState("world")}))}static GetInstance(){return this._instance}SetState(state){$(`*[data-kl-state="${this.state}"]`).addClass("d-none"),$(`*[data-kl-state2="${this.state}"]`).addClass("d-none"),this.state=state,$(`*[data-kl-state="${this.state}"]`).removeClass("d-none"),$(`*[data-kl-state2="${this.state}"]`).removeClass("d-none")}Connect(){this.startExec.on("click",(()=>{this.SetState("execution")}))}OnWorldOp(e){const target=$(e.target),icon=target.find("i");this.previousOpBtn.empty(),this.previousOpBtn.append(icon.clone()),this.previousOpBtn.off("click.repeat"),this.previousOpBtn.on("click.repeat",(()=>target.trigger("click")))}}let KarelWorld=new World(100,100),karelController=new KarelController(KarelWorld);var[desktopEditor,phoneEditor]=getEditors();function hideElement(element){$(element).addClass("d-none")}function showElement(element){$(element).removeClass("d-none")}!function(){const editor=getEditors()[0],controller=KarelController.GetInstance();controller.RegisterStepController(((_,state)=>{const line=controller.GetRuntime().state.line+1,column=controller.GetRuntime().state.column,codeLine=editor.state.doc.line(line);HighlightKarelInstruction(editor,line,column),editor.dispatch({effects:EditorView.scrollIntoView(codeLine.from)})})),controller.RegisterResetObserver((_=>{HighlightKarelInstruction(editor,-1,-1)}))}();const pascalConfirm={accept:()=>{SetText(desktopEditor,"usa rekarel.globales;\niniciar-programa\n\tinicia-ejecucion\n\t\t{ TODO poner codigo aqui }\n\t\tapagate;\n\ttermina-ejecucion\nfinalizar-programa"),setLanguage(desktopEditor,"pascal")},message:"¡Perderás todo el código no guardado!",title:"Nuevo código Pascal",reject:()=>{}},javaConfirm={accept:()=>{SetText(desktopEditor,"import rekarel.globals;\nclass program {\n\tprogram () {\n\t\t// TODO poner codigo aqui \n\t\tturnoff();\n\t}\n}"),setLanguage(desktopEditor,"java")},message:"¡Perderás todo el código no guardado!",title:"Nuevo código Java",reject:()=>{}},newWorldConfirm={accept:()=>{karelController.NewWorld()},message:"¡Perderás todo lo del mundo no guardado!",title:"Nuevo mundo",reject:()=>{}},code2pascalConfirm={accept:()=>{editorTranspile("pascal")},message:"¿Quieres convertir tu código a Karel Pascal?",title:"Cambiar lenguaje",reject:()=>{}},code2javaConfirm={accept:()=>{editorTranspile("java")},message:"¿Quieres convertir tu código a Karel Java?",title:"Cambiar lenguaje",reject:()=>{}};let DesktopUI=new DesktopController({desktopEditor:desktopEditor,worldCanvas:$("#worldCanvas"),worldContainer:$("#worldContainer"),controlBar:{execution:{reset:$("#desktopResetKarel"),compile:$("#desktopCompileKarel"),run:$("#dekstopRunKarel"),step:$("#desktopStepProgram"),stepOut:$("#desktopStepOutProgram"),stepOver:$("#desktopStepOverProgram"),future:$("#desktopFutureProgram")},beeperInput:$("#beeperBag"),infiniteBeeperInput:$("#infiniteBeepersBtn"),beeperCollapse:$("#beeperInputCollapse"),delayInput:$("#delayPanel"),delayAdd:$("#addDelayBtn"),delayRemove:$("#removeDelayBtn")},inputMode:{indicator:$("#inputModeIndicator"),drag:$("#dragSelectionMode"),alternate:$("#alternateSelectionMode")},worldToolbar:{karel:{north:$("#desktopKarelNorth"),east:$("#desktopKarelEast"),south:$("#desktopKarelSouth"),west:$("#desktopKarelWest")},beepers:{addOne:$("#desktopAddBeeper"),removeOne:$("#desktopDecrementBeeper"),infinite:$("#desktopSetInfinite"),ammount:$("#desktopSetAmmount"),clear:$("#desktopRemoveAll"),random:$("#desktopRandomBeeper")},wall:{north:$("#desktopNorthWall"),east:$("#desktopEastWall"),south:$("#desktopSouthWall"),west:$("#desktopWestWall"),outside:$("#desktopOuterWall")}},focus:{karel:$("#desktopGoKarel"),origin:$("#desktopGoHome"),selector:$("#desktopGoSelection")},history:{undo:$("#desktopUndo"),redo:$("#desktopRedo")},evaluate:{evaluate:$("#desktopEvaluateCell"),ignore:$("#desktopIgnoreCell")},context:{toggler:$("#contextMenuToggler"),container:$("#contextMenuDiv"),worldBar:{beepers:{addOne:$("#contextAddBeeper"),removeOne:$("#contextDecrementBeeper"),infinite:$("#contextSetInfinite"),ammount:$("#contextSetAmmount"),clear:$("#contextRemoveAll"),random:$("#contextRandomBeeper")},karel:{north:$("#contextKarelNorth"),east:$("#contextKarelEast"),south:$("#contextKarelSouth"),west:$("#contextKarelWest")},wall:{north:$("#contextNorthWall"),east:$("#contextEastWall"),south:$("#contextSouthWall"),west:$("#contextWestWall"),outside:$("#contextOuterWall")}},evaluate:{evaluate:$("#contextEvaluateCell"),ignore:$("#contextIgnoreCell")}},gizmos:{selectionBox:{main:$("#desktopBoxSelect")[0],bottom:$("#desktopBoxSelect [name='bottom']")[0],top:$("#desktopBoxSelect [name='top']")[0],left:$("#desktopBoxSelect [name='left']")[0],right:$("#desktopBoxSelect [name='right']")[0],cursor:$("#desktopBoxSelect [name='cursor']")[0]},HorizontalScrollElement:$("#worldScrolledContainerHorizontal"),VerticalScrollElement:$("#worldScrolledContainerVertical")},lessZoom:$("#removeZoomBtn"),moreZoom:$("#addZoomBtn"),console:{console:$("#desktopConsole"),clear:$("#desktopClearConsole"),parent:$("#ExecDataContent"),tab:$("#consoleTab-tab"),consoleMessageCount:$("#consoleMessageCount")},callStack:{panel:$("#stackPanel"),lastReturn:$("#lastReturn")},toast:{breakpoint:$("#toast-breakpoint"),compileError:$("#toast-compile-error"),compileSuccess:$("#toast-compile-success"),runtimeError:$("#toast-runtime-error"),runtimeSuccess:$("#toast-runtime-success")}},karelController);new MobileUI({controls:{beeperInput:$("#phoneBeeperBag"),delayAdd:$(),delayInput:$("#phoneDelayPanel"),delayRemove:$(),infiniteBeeperInput:$("#phoneInfiniteBeepersBtn"),beeperCollapse:$("#beeperInputPhoneCollapse"),execution:{compile:$("#phoneCompileKarel"),reset:$("#phoneResetWorld"),run:$("#phoneRunKarel"),step:$("#phoneStepProgram"),stepOver:$("#phoneStepOverProgram"),stepOut:$("#phoneStepOutProgram"),future:$("#phoneFutureProgram")}},focus:{origin:$("#phoneGoHome"),karel:$("#phoneGoKarel"),selector:$("#phoneGoSelection")},worldBar:{karel:{north:$("#phoneKarelNorth"),east:$("#phoneKarelEast"),south:$("#phoneKarelSouth"),west:$("#phoneKarelWest")},beepers:{addOne:$("#phoneAddBeeper"),removeOne:$("#phoneDecrementBeeper"),infinite:$("#phoneSetInfinite"),ammount:$("#phoneSetAmmount"),clear:$("#phoneRemoveAll"),random:$("#phoneRandomBeeper")},wall:{north:$("#phoneNorthWall"),east:$("#phoneEastWall"),south:$("#phoneSouthWall"),west:$("#phoneWestWall"),outside:$("#phoneOuterWall")}},startExec:$("#phoneExecMode"),previousOpBtn:$("#phoneRepeat")});let PhoneUI=function(elements){let response={changeCodeToolbar:button=>activateButton(elements.codeTab.toolbar,button),changeNavToolbar:button=>activateButton(elements.navToolbar,button),indent:()=>function(elements){let editor=elements.editor,state=editor.state,head=state.selection.main.head,transaction=state.update({changes:{from:state.doc.lineAt(head).from,insert:"\t"}});editor.dispatch(transaction)}(elements),unindent:()=>function(elements){let state=elements.editor.state,head=state.selection.main.head,line=state.doc.lineAt(head),stringOutpt=line.text.replace(/^((\t)|( {0,4}))/,""),transaction=state.update({changes:{from:line.from,to:line.to,insert:stringOutpt}});elements.editor.dispatch(transaction)}(elements),btnSimpleCodeInput:btn=>replaceWithIndetation(elements,elements.codeTab.simpleCodeInputs[btn]()),replaceWithIndetation:txt=>replaceWithIndetation(elements,txt)};for(const btn in elements.navToolbar)$(btn).click((()=>response.changeNavToolbar(btn)));for(const btn in elements.codeTab.toolbar)$(btn).click((()=>response.changeCodeToolbar(btn)));for(const btn in elements.codeTab.simpleCodeInputs)$(btn).click((()=>response.btnSimpleCodeInput(btn)));return $(elements.codeTab.indent).click(response.indent),$(elements.codeTab.unindent).click(response.unindent),$(elements.codeTab.undo).on("click",(()=>{undo(elements.mainEdtior)})),$(elements.codeTab.redo).on("click",(()=>{redo(elements.mainEdtior)})),response}({editor:phoneEditor,mainEdtior:desktopEditor,codeTab:{indent:"#codeIndent",unindent:"#codeUnindent",undo:"#codeUndo",redo:"#codeRedo",toolbar:{"#codeEdit":()=>(hideElement("#editToolbar"),hideElement("#pascalAction"),hideElement("#pascalFlow"),hideElement("#pascalKeyword"),showElement("#editToolbar"),""),"#codeAction":()=>(hideElement("#editToolbar"),hideElement("#pascalAction"),hideElement("#pascalFlow"),hideElement("#pascalKeyword"),showElement("#pascalAction"),""),"#codeFlow":()=>(hideElement("#editToolbar"),hideElement("#pascalAction"),hideElement("#pascalFlow"),hideElement("#pascalKeyword"),showElement("#pascalFlow"),""),"#codeKeyword":()=>(hideElement("#editToolbar"),hideElement("#pascalAction"),hideElement("#pascalFlow"),hideElement("#pascalKeyword"),showElement("#pascalKeyword"),"")},simpleCodeInputs:{"#pAvanza":()=>"avanza;","#pGira":()=>"gira-izquierda;","#pCoge":()=>"coge-zumbador;","#pDeja":()=>"deja-zumbador;","#pApagate":()=>"apagate;","#pSalir":()=>"sal-de-instruccion;"}},navToolbar:{"#codeTabBtn":()=>"","#worldTabBtn":()=>"","#execTabBtn":()=>""}});var uiData,modal,worldController,ResizeCanvas;hookDownloadModel((uiData={editor:desktopEditor,downloadCodeModal:{modal:"#saveCodeModal",confirmBtn:"#downloadCodeBtn",inputField:"#codeName",wrongCodeWarning:"#wrongCodeName"},resizeModal:{modal:"#resizeWorldModal",confirmBtn:"#resizeBtn",rowField:"#rowField",columnField:"#columnField"},evaluatorModal:{modal:$("#evaluatorModal"),form:$("#evaluatorForm"),evaluatePosition:$("#evaluatePosition"),evaluateBag:$("#evaluateBag"),evaluateOrientation:$("#evaluateOrientation"),evaluateUniverse:$("#evaluateUniverse"),countMoves:$("#countMoves"),countPicks:$("#countPicks"),countPuts:$("#countPuts"),countTurns:$("#countTurns"),maxInstructions:$("#maxInstructions"),maxStackSize:$("#maxStack"),stackMemory:$("#stackMemory"),maxCallParam:$("#maxCallParam"),maxMove:$("#maxMove"),maxTurnLeft:$("#maxTurnLeft"),maxPickBuzzer:$("#maxPickBuzzer"),maxLeaveBuzzer:$("#maxLeaveBuzzer")},confirmModal:{modal:"#confirmModal",titleField:"#confirmModalTitle",messageField:"#confirmModalMessage",confirmBtn:"#confirmModalYes",rejectBtn:"#confirmModalNo"},confirmCallers:[{button:"#newJavaCodeNavBtn",data:javaConfirm},{button:"#newPascalCodeNavBtn",data:pascalConfirm},{button:"#newJavaCodeBtn",data:javaConfirm},{button:"#newPascalCodeBtn",data:pascalConfirm},{button:"#newWorldBtn",data:newWorldConfirm},{button:"#java2pascalBtn",data:code2pascalConfirm},{button:"#pascal2javaBtn",data:code2javaConfirm}],amountModal:{modal:"#ammountModal",confirmBtn:"#btnSetAmount",inputField:"#beeperCountInput"},wordSaveModal:{modal:"#downloadWorldModal",inputBtn:"#downloadWorldIn",outputBtn:"#downloadWorldOut",nameField:"#worldName",worldDataIn:"#worldDataIn",worldDataOut:"#worldDataOut",wrongNameWaring:"#wrongWorldName"},navbar:{openCode:"#openCodeBtn",openWorldIn:"#openWorldInBtn"},karelController:karelController,worldController:DesktopUI.worldController}).downloadCodeModal,uiData.editor),modal=uiData.amountModal,worldController=uiData.worldController,$(modal.confirmBtn).on("click",(()=>{const inputValue=$(modal.inputField).val();if(""===inputValue)return;const amount=parseFloat(inputValue);amount<-1||worldController.SetBeepers(amount)})),HookWorldSaveModal(uiData.wordSaveModal,uiData.karelController),HookNavbar(uiData.navbar,uiData.editor,uiData.karelController),HookStyleModal(uiData.worldController),HookEvaluatorModal(uiData.evaluatorModal),$("#randomBeepersModal").on("show.bs.modal",(()=>{$("#minimumRandomBeepers").val(AppVars.randomBeeperMinimum),$("#maximumRandomBeepers").val(AppVars.randomBeeperMaximum)})),$("#randomBeepersForm").on("submit",(e=>{e.preventDefault();const minValue=parseInt(`${$("#minimumRandomBeepers").val()}`),maxValue=parseInt(`${$("#maximumRandomBeepers").val()}`);console.log(minValue,maxValue),isNaN(minValue)||(AppVars.randomBeeperMinimum=Number(minValue)),isNaN(maxValue)||(AppVars.randomBeeperMaximum=Number(maxValue))})),uiData.confirmCallers.forEach((confirmCaller=>{let confirmArgs={uiData:uiData,modalData:confirmCaller.data};$(confirmCaller.button).on("click",null,confirmArgs,confirmPrompt),$(uiData.confirmModal.modal).on("hidden.bs.modal",null,confirmArgs,confirmPromptEnd)})),function(resizeModel,karelController){$(resizeModel.modal).on("show.bs.modal",(()=>{$(resizeModel.rowField).val(karelController.world.h),$(resizeModel.columnField).val(karelController.world.w)})),$(resizeModel.confirmBtn).on("click",(()=>{let w=parseInt($(resizeModel.columnField).val()),h=parseInt($(resizeModel.rowField).val());karelController.Resize(w,h),karelController.Reset()}))}(uiData.resizeModal,uiData.karelController),ResizeCanvas=DesktopUI.ResizeCanvas.bind(DesktopUI),Split(["#splitter-left-pane","#splitter-right-pane"],{sizes:[30,70],onDragEnd:ResizeCanvas,minSize:0}),Split(["#splitter-left-top-pane","#splitter-left-bottom-pane"],{sizes:[70,30],direction:"vertical",minSize:0}),Split(["#mobileCodePanel","#mobileWorldPanel","#mobileStatePanel"],{sizes:[30,40,30],direction:"vertical",onDragEnd:ResizeCanvas,minSize:0,gutterSize:15}),PhoneUI.changeCodeToolbar("#codeAction"),PhoneUI.changeNavToolbar("#codeTabBtn"),$(document).ready((()=>{HookSession(),InitSettings(DesktopUI),$(window).on("resize",checkVisibility),setTimeout((()=>checkVisibility())),DesktopUI.Init(),function(desktopUI){const appSettings=GetCurrentSetting();applySettings(appSettings,desktopUI),$(document).on("keydown",(e=>{if(e.ctrlKey&&75===e.which){let fontSize=appSettings.editorFontSize;return fontSize--,fontSize<7&&(fontSize=7),appSettings.editorFontSize=fontSize,applySettings(appSettings,desktopUI),e.preventDefault(),!1}if(e.ctrlKey&&76===e.which){let fontSize=appSettings.editorFontSize;return fontSize++,fontSize>30&&(fontSize=30),appSettings.editorFontSize=fontSize,applySettings(appSettings,desktopUI),e.preventDefault(),!1}})),$("#settingsSlowModeLimit").on("change",(()=>showOrHideSlowExecutionLimit()))}(DesktopUI),RestoreSession()}));const GetKarelController=KarelController.GetInstance;return exports.GetKarelController=GetKarelController,exports.MoveEditorCursorToLine=function(line,column=0){!function(editor,line,column=0,shouldFocus=!0){const jumpTo=editor.state.doc.line(line).from+column;editor.dispatch({selection:{anchor:jumpTo,head:jumpTo},scrollIntoView:!0}),shouldFocus&&editor.focus()}(desktopEditor,line,column)},exports}({},bootstrap);
//# sourceMappingURL=cindex.js.map
